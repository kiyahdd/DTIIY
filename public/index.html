<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>False Flag Fixer™</title>
<!-- Prevent stale caches during development -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<script>
  // Cache-busting helper: call forceHardReload() to reload with version
  window.__BUILD__ = '2025-11-05-01';
  (function () {
    const params = new URLSearchParams(location.search);
    window.forceHardReload = function () {
      params.set('v', window.__BUILD__);
      location.search = params.toString();
    };
    // Auto one-time refresh if the page URL lacks the current build version
    try {
      const current = params.get('v');
      const key = 'reloadedForVersion-' + window.__BUILD__;
      if (current !== window.__BUILD__ && !sessionStorage.getItem(key)) {
        sessionStorage.setItem(key, '1');
        params.set('v', window.__BUILD__);
        location.replace(location.pathname + '?' + params.toString() + location.hash);
        return; // stop running old page
      }
    } catch (e) {}
    console.log('[FFF] Build', window.__BUILD__, '- if changes don\'t appear, run forceHardReload() in console');
  })();
</script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
<style>
/* ALL YOUR EXISTING CSS STYLES REMAIN EXACTLY THE SAME */
* { box-sizing: border-box; margin: 0; padding: 0; }
html {
  overflow-y: scroll; /* Force scrollbar always visible */
  overflow-x: hidden;
}
body { 
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
  background: linear-gradient(135deg, #0b0646 0%, #1a1f6e 100%); 
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  width: 100%;
  overflow-x: hidden;
  margin: 0;
  padding: 0;
  position: relative;
  scrollbar-gutter: stable;
}

/* Prevent body from shifting when modals appear */
body.modal-open {
  overflow: hidden;
  /* Removed padding-right to prevent layout shift */
}

.panic-banner {
  background: linear-gradient(90deg, #ef4444, #dc2626);
  color: #fff;
  padding: 12px 20px;
  text-align: center;
  font-weight: 700;
  position: sticky;
  top: 0;
  z-index: 999;
  box-shadow: 0 2px 10px rgba(0,0,0,.2);
  display: none;
  width: 100%;
}
.panic-banner a {
  color: #fef3c7;
  text-decoration: underline;
  margin-left: 10px;
  font-weight: 800;
}

.hero-section { 
  text-align: center; 
  padding: 30px 20px 20px; 
  color: #fff;
  width: 100%;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
}
.hero-title { 
  font-size: clamp(2em,5vw,3em); 
  font-weight: 800; 
  margin: 0 0 12px; 
  line-height: 1.1; 
  color: #fff; 
  text-shadow: 2px 2px 4px rgba(0,0,0,.2);
  text-align: center;
  width: 100%;
}
.hero-subtitle { 
  font-size: clamp(1em,2.5vw,1.2em); 
  margin: 0 auto !important; 
  opacity: .95; 
  max-width: 100%;
  text-align: center !important;
  width: 100%;
  display: block;
  box-sizing: border-box; 
  line-height: 1.4; 
  color: #fff;
  position: relative;
  left: 0 !important;
  right: 0 !important;
  transform: translateX(0) !important;
  align-self: center;
}

/* Stabilize the main container */
.main-container {
  width: 100%;
  max-width: 900px; /* Changed from 800px to 900px (WIDER!) */
  margin: 0 auto 30px;
  padding: 0 24px; /* Match Free results wrapper padding for consistent bordered card width */
  background: #fff;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 20px 40px rgba(0,0,0,.2);
  box-sizing: border-box;
  position: static;
  left: auto;
  right: auto;
  transform: none;
}


.input-section {
  padding: 30px;
  background: #f8f9fa;
  position: relative;
  width: 100%;
  box-sizing: border-box;
}


/* Add min-height to prevent collapse */
#quickfixFlow,
#inputSection,
#resultsContainer {
  min-height: 100vh;
  width: 100%;
}

/* Prevent layout shifts on form focus */
input, textarea, button {
  outline: none;
  border: none;
  box-sizing: border-box;
}

input:focus, textarea:focus {
  outline: 2px solid #2ecc71;
  outline-offset: 2px;
}

/* Add min-height to prevent collapse */
.page-wrapper {
  min-height: 100vh;
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  overflow-x: hidden;
  margin: 0;
  padding: 0;
}

/* Modal positioning */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100vh;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}

/* === PRO FLOW STYLES (Steps 7–9) - Fixed to match QuickFix === */

/* Step 6 - Pro Dashboard - FORCE WHITE */
/* Note: .quickfix-step already has display:none by default, and .active makes it visible */

#quickfixStep6 .main-container {
  max-width: 1200px !important;
  background: #ffffff !important;
  background-color: #ffffff !important;
  border-radius: 20px !important;
  box-shadow: 0 20px 40px rgba(0,0,0,.2) !important;
  padding-top: 60px !important;
}

#quickfixStep6 .input-section {
  background: #ffffff !important;
  background-color: #ffffff !important;
  padding-top: 0 !important;
}

  max-width: 1200px !important;
  width: 100% !important;
  margin: 0 auto !important;
}

/* BULLETPROOF - Prevent any horizontal scrolling or layout shifts */
* {
  max-width: 100%;
  box-sizing: border-box;
}


/* Ensure form elements don't cause layout shifts */
textarea, input[type="text"] {
  resize: vertical;
  min-height: 40px;
}

.upload-area {
  border: 3px dashed #0b0646;
  border-radius: 15px;
  padding: 30px 20px;
  text-align: center;
  background: #fff;
  transition: .3s;
  cursor: pointer;
  position: relative;
  animation: pulse 2s infinite;
  margin-bottom: 20px;
}

.upload-area:hover {
  border-color: #090535;
  background: #f7fafc;
  transform: translateY(-2px);
}

@keyframes pulse {
  0%, 100% { border-color: #0b0646; }
  50% { border-color: #2ecc71; }
}

@keyframes pulseRed {
  0%, 100% { 
    border-color: #dc2626;
    box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7);
  }
  50% { 
    border-color: #ef4444;
    box-shadow: 0 0 0 8px rgba(220, 38, 38, 0);
  }
}

.authorship-section-pulse {
  animation: pulseRed 1.5s ease-in-out infinite;
}
#essayInput {
  width: 100%;
  height: 150px;
  padding: 20px;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-family: inherit;
  resize: vertical;
  margin-top: 15px;
  box-shadow: inset 0 2px 8px rgba(0,0,0,.1);
  line-height: 1.6;
}
#essayInput:focus {
  outline: 3px solid #0b0646;
  outline-offset: 2px;
}
.char-counter {
  text-align: right;
  font-size: .9em;
  margin-top: 8px;
  color: #666;
  font-weight: 600;
}
.char-counter.warning { color: #f59e0b; }
.char-counter.danger { color: #ef4444; }
.scans-left {
  text-align: center;
  margin-top: 8px;
  font-size: .9em;
  color: #666;
  font-weight: 600;
}
.scans-left.warning { color: #f59e0b; }
.scans-left.danger { color: #ef4444; }

.button-group {
  display: flex;
  gap: 10px;
  margin-top: 20px;
  flex-wrap: wrap;
}

.scan-button, .emergency-button, .pro-button {
  flex: 1;
  padding: 12px 16px !important;
  border: none;
  border-radius: 12px;
  font-size: 0.95em !important;
  font-weight: 700;
  cursor: pointer;
  transition: .3s;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  min-width: 160px !important;
  position: relative;
  line-height: 1.2 !important;
  height: auto !important;
}

.scan-button {
  background: #00a8e8;
  color: #fff;
  box-shadow: 0 4px 12px rgba(16,185,129,.3);
}
.scan-button:hover:not(:disabled) {
  background: #0087c4;
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(16,185,129,.4);
}
.scan-button:disabled {
  background: #9ca3af;
  cursor: not-allowed;
}

.emergency-button {
  background: #ff6b00;
  color: #fff;
  box-shadow: 0 4px 12px rgba(255,107,0,.3);
}
.emergency-button:hover {
  background: #e55a00;
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(255,107,0,.4);
}

.pro-button {
  background: #00a8e8;
  color: #fff;
  box-shadow: 0 4px 12px rgba(16,185,129,.3);
}
.pro-button:hover {
  background: #0087c4;
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(16,185,129,.4);
}

.results-container {
  display: none;
  padding: 20px;
  background: linear-gradient(135deg, #0b0646 0%, #1a1f6e 100%);
  min-height: 100vh;
  position: relative; /* Changed from fixed */
  width: 100%;
  overflow-x: hidden;
  transform: none;
  will-change: auto;
}
.results-container.show {
  display: block !important;
  /* Temporarily disabled animation to debug bounce */
  /* animation: slideIn .5s ease-out !important; */
  width: 100%;
  margin: 0 auto;
  left: 0;
  right: 0;
}

.results-wrapper {
  width: 100%;
  max-width: 900px; /* Changed from 720px to 900px (WIDER!) */
  margin: 0 auto;
  padding: 24px;
  box-sizing: border-box;
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 12px 30px rgba(15, 23, 42, 0.25);
  display: flex;
  flex-direction: column;
  gap: 20px;
}
@keyframes slideIn {
  from { 
    opacity: 0; 
    transform: translateY(20px);
  }
  to { 
    opacity: 1; 
    transform: translateY(0);
  }
}

.card {
  background: white;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.warning-card { text-align: center; }
.warning-icon { 
  font-size: 40px; 
  margin-bottom: 10px; 
  display: block; 
}
.warning-title {
  font-size: 22px;
  font-weight: 800;
  color: #1f2937;
  margin-bottom: 15px;
}
.score-display {
  font-size: 50px;
  font-weight: 900;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  color: #dc2626;
}

.score-number {
  font-size: 28px !important;
  font-weight: 900 !important;
  color: #dc2626; /* Removed !important so JavaScript can override */
}
.warning-emoji {
  font-size: 50px;
  animation: bounce 2s infinite;
}
@keyframes pointBackForth {
  0%, 100% {
    transform: translateX(0);
  }
  50% {
    transform: translateX(10px);
  }
}

@keyframes bounce {
  0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
  40% { transform: translateY(-8px); }
  60% { transform: translateY(-4px); }
}
.progress-container { margin: 15px 0; }
.progress-bar {
  height: 8px;
  background: linear-gradient(
    to right,
    #00a8e8 0%,
    #00a8e8 30%,
    #eed202 30%,
    #eed202 70%,
    #dc2626 70%,
    #dc2626 100%
  );
  border-radius: 4px;
  position: relative;
  margin-bottom: 8px;
  overflow: visible;
}
.progress-fill {
  height: 100%;
  background: transparent;
  border-radius: 5px;
  transition: width 2s ease;
}
/* The little circle marker that shows the exact score - matches QuickFix style */
.sus-marker {
  position: absolute;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 16px;
  height: 16px;
  background: white;
  border: 3px solid currentColor;
  border-radius: 50%;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  z-index: 10;
  transition: left 0.5s ease, color 0.5s ease;
  pointer-events: none;
}
.sus-marker.high-sus {
  color: #dc2626;
}
.sus-marker.medium-sus {
  color: #eed202;
}
.sus-marker.low-sus {
  color: #00a8e8;
}
.progress-indicator {
  position: absolute;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 16px;
  height: 16px;
  background: white;
  border: 3px solid currentColor;
  border-radius: 50%;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  z-index: 10;
  transition: left 0.5s ease, color 0.5s ease;
}
.progress-indicator.high-sus {
  color: #dc2626;
}
.progress-indicator.medium-sus {
  color: #eed202;
}
.progress-indicator.low-sus {
  color: #2ecc71;
}
.progress-endpoints {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  color: #9ca3af;
  font-weight: 600;
  margin-bottom: 8px;
}
.progress-labels {
  display: flex;
  justify-content: space-between;
  margin-top: 8px;
  font-size: 14px; /* FIX 5: Increased font size */
  font-weight: 700; /* FIX 5: Bolder text */
  color: #6b7280;
  text-align: center;
  padding: 0 5px;
}
.score-label {
  font-size: 22px !important;
  font-weight: 900 !important;
  color: #dc2626;
  letter-spacing: 1px;
  margin: 0;
  white-space: nowrap;
  line-height: 1;
}

.score-label.sus-af {
  color: #dc2626;
}

.score-label.kinda-sus {
  color: #f59e0b;
}

.score-label.sus-free {
  color: #2ecc71;
}

#quickfixScoreLabel {
  font-size: 14px !important;
  font-weight: 600 !important;
}

/* Dynamic quote section colors */
.quote-section {
  padding: 15px;
  margin: 15px 0;
  border-radius: 10px;
  text-align: center;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}
.quote-section.high-risk {
  background: #dc2626;
  color: #fff;
}
.quote-section.medium-risk {
  background: #f59e0b;
  color: #fff;
}
.quote-section.low-risk {
  background: #00a8e8;
  color: #fff;
}
.quote-text { 
  color: inherit; 
  font-style: italic; 
  font-size: 14px; 
  line-height: 1.4; 
  font-weight: 600;
  margin: 0;
}
.essay-content { line-height: 1.6; font-size: 16px; color: #374151; margin: 15px 0; }

.flag-critical {
  background: #fee2e2;
  border: 2px solid #dc2626;
  padding: 2px 6px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: 600;
  color: #991b1b;
  position: relative;
  display: inline-block;
}
.flag-medium {
  background: #fef3c7;
  border: 2px solid #f59e0b;
  padding: 2px 6px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: 600;
  color: #92400e;
  position: relative;
  display: inline-block;
}
.flag-fixed {
  background: #d1fae5;
  border: 2px solid #2ecc71;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: 600;
  color: #065f46;
}

.red-flag {
  display: inline-block;
  font-size: 0.8em;
  margin-left: 3px;
  animation: flagWave 2s ease-in-out infinite;
  vertical-align: top;
}
.red-flag-large {
  display: inline-block;
  font-size: 1em;
  margin-right: 8px;
  animation: flagWave 2s ease-in-out infinite;
}
@keyframes flagWave {
  0%, 100% { transform: rotate(-5deg); }
  50% { transform: rotate(5deg); }
}

.fix-output-card {
  background: #d1fae5;
  border: 2px solid #00a8e8;
  border-radius: 16px;
  padding: 20px;
  margin: 15px 0;
  text-align: center;
}
.fix-output-card h3 {
  color: #065f46;
  margin-bottom: 12px;
  font-size: 18px;
  font-weight: 700;
}
.fixed-text-area {
  width: 100%;
  min-height: 100px;
  padding: 12px;
  border: 2px solid #00a8e8;
  border-radius: 8px;
  background: #fff;
  font-size: 16px;
  line-height: 1.6;
  resize: none;
  margin-bottom: 12px;
}

.upsell-card {
  background: linear-gradient(135deg, #ea580c, #f97316);
  color: #fff;
  text-align: center;
  padding: 20px;
}
.upsell-card h4 {
  color: #fff;
  font-weight: 700;
  font-size: 18px;
  margin-bottom: 12px;
}

.analysis-card h3 {
  font-size: 24px; /* INCREASED FONT SIZE */
  font-weight: 700;
  color: #1f2937;
  margin-bottom: 16px;
  text-align: center;
}
.btn {
  padding: 12px 20px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
  border: none;
  flex: 1;
  min-width: 140px;
  position: relative;
}
.btn-outline {
  background: white;
  color: #374151;
  border: 2px solid #e5e7eb;
  margin-top: 12px;
  width: 100%;
}
.btn-outline:hover { background: #f9fafb; border-color: #d1d5db; }

.btn-secondary { background: #6b7280; color: white; }
.btn-action { 
  background: #ffffff; 
  color: #2ecc71; 
  border: 2px solid #2ecc71;
  width: 100%;
  padding: 14px 20px;
  font-size: 16px;
  font-weight: 700;
  margin-top: 15px;
}
.btn-action:hover {
  background: #2ecc71;
  color: white;
  transform: translateY(-2px);
}

/* FIXED TOOLTIP STYLES */
.tooltip {
  position: fixed;
  background: #1f2937;
  color: white;
  padding: 12px 16px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  max-width: 260px;
  z-index: 10000;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
  pointer-events: none;
  display: none;
  line-height: 1.5;
  text-align: center;
  border: 1px solid #374151;
}

.tooltip.show {
  display: block;
  animation: fadeIn 0.2s ease-in-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes fadeOut {
  from { opacity: 1; }
  to { opacity: 0; }
}

@keyframes slideDown {
  from { opacity: 1; transform: translateY(0); }
  to { opacity: 0; transform: translateY(20px); }
}

.success-message {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #00a8e8;
  color: #fff;
  padding: 15px 25px;
  border-radius: 15px;
  font-weight: 700;
  z-index: 1002;
  box-shadow: 0 4px 20px rgba(16,185,129,.4);
}

/* --- Free Result Overlay Styles --- */
.free-result-container {
  width: 100%;
  max-width: none;
  padding: 20px;
  position: relative;
  background: #fff;
  border-radius: 10px;
  margin-top: 15px;
  overflow: visible;
}

/* Free Results Two-Column Layout */
.free-results-layout {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
  width: 100%;
  max-width: none;
}

.free-results-left {
  width: 100% !important;
  min-width: 0;
}

.free-results-right {
  width: 100% !important;
  min-width: 0;
}

/* Mobile: stack vertically - already using flex column, so this is handled */

/* Free Results Main Structure (NEW) */
.results-card {
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  margin-bottom: 24px;
}

.results-header {
  background: #fff;
  padding: 16px 24px;
  border-bottom: 1px solid #e5e7eb;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 16px;
  font-weight: 600;
  color: #dc2626;
}

.results-warning-bar {
  background: #dc2626;
  color: white;
  padding: 12px 24px;
  font-size: 14px;
  font-weight: 600;
  text-align: center;
}

.free-results-main {
  display: flex !important;
  flex-direction: column !important;
  gap: 24px !important;
  padding: 24px !important;
  width: 100% !important;
  height: auto !important;
  overflow: visible !important;
}

/* Make Free Results use single column like QuickFix/Pro */
.free-results-columns {
  display: flex !important;
  flex-direction: column !important;
  gap: 24px !important;
  width: 100% !important;
  max-width: 900px !important; /* Changed from 800px to 900px (WIDER!) */
  margin: 0 auto !important;
  height: auto !important;
  overflow: visible !important;
  align-items: flex-start;
}

/* AI Flag Pills */
.free-flags-preview {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin: 12px 0;
}

.ai-flag-pill,
.trigger-chip {
  background: #fee2e2;
  border: 2px solid #dc2626;
  color: #991b1b;
  padding: 8px 16px;
  border-radius: 999px;
  font-size: 15px;
  font-weight: 600;
  display: inline-block;
}

.free-flags-heading {
  color: #0b0646;
  font-size: 18px;
  font-weight: 700;
  margin: 0 0 8px 0;
}

.free-flags-subtext {
  color: #6b7280;
  font-size: 14px;
  margin: 0 0 12px 0;
  line-height: 1.5;
}

.upgrade-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(255, 255, 255, 0.5); /* REDUCED OPACITY TO 0.5 */
  color: #1f2937;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  font-size: 16px;
  font-weight: bold;
  padding: 20px;
  border-radius: 10px;
  text-align: center;
  border: 2px dashed #ea580c;
  z-index: 10;
  animation: shimmer 3s infinite;
}

@keyframes shimmer {
  0%, 100% { box-shadow: 0 0 0px rgba(234, 88, 12, 0.3); }
  50% { box-shadow: 0 0 15px rgba(234, 88, 12, 0.6); }
}

.upgrade-overlay button {
  margin-top: 12px;
  padding: 12px 20px;
  border-radius: 8px;
  font-size: 14px;
  cursor: pointer;
  font-weight: 600;
  border: none;
  min-width: 140px;
  position: relative;
}

.upgrade-overlay .quickfix-btn {
  background-color: #ea580c;
  color: #fff;
  margin-right: 10px;
}

.upgrade-overlay .pro-btn {
  background-color: #00a8e8;
  color: #fff;
}

.overlay-button-group {
  display: flex;
  gap: 10px;
  margin-top: 15px;
  flex-wrap: wrap;
  justify-content: center;
}

/* ================== FORCE WIDER LAYOUT FOR FREE RESULTS ONLY ================== */
/* Make Free Results wrapper match QuickFix/Pro width */
#resultsContainer .results-wrapper {
  max-width: 900px !important; /* Changed from 800px to 900px (WIDER!) */
  width: 100% !important;
  margin-left: auto !important;
  margin-right: auto !important;
}

/* Remove the media query or adjust it */
@media (min-width: 1200px) {
  #resultsContainer .results-wrapper {
    max-width: 900px !important; /* Keep it at 900px even on large screens */
  }
}

.upsell-message {
  text-align: center;
  font-style: italic;
  color: #6b7280;
  margin: 15px 0;
  font-size: 14px;
  line-height: 1.5;
  padding: 0 10px;
}

.hidden-content-note {
  text-align: center;
  color: #6b7280;
  font-size: 14px;
  margin-top: 10px;
  font-style: italic;
}

.content-blocked {
  position: relative;
}

.content-blocked::after {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(to bottom, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.7) 100%);
  pointer-events: none;
}

.close-results-button {
  position: absolute;
  top: 5px;
  right: 20px;
  background: #6b7280;
  color: white;
  border: none;
  font-size: 12px;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s;
  z-index: 1001;
}

.close-results-button:hover {
  background: #4b5563;
  transform: translateY(-1px);
}

.hidden-text-preview {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  padding: 20px;
  color: rgba(0, 0, 0, 0.15);
  font-size: 14px;
  line-height: 1.4;
  pointer-events: none;
  z-index: 1;
  overflow: hidden;
}

.stripe-badge {
  text-align: center;
  margin-top: 15px;
  padding: 10px;
  font-size: 12px;
  color: #6b7280;
}

.stripe-logo {
  display: inline-block;
  margin-left: 5px;
  font-weight: 700;
  color: #635bff;
}

/* QuickFix Flow Styles */
.quickfix-flow-container {
  display: none;
  width: 100%;
  max-width: 900px; /* Changed from 800px to 900px (WIDER!) */
  margin: 0 auto; /* Add this line */
  position: relative; /* Changed from fixed */
  overflow-x: hidden;
  transform: none;
  will-change: auto;
}


.quickfix-step {
  display: none !important;
  opacity: 0;
  transform: none;
  transition: opacity 0.3s ease-out;
  visibility: hidden;
}

.quickfix-step.active {
  display: block !important;
  opacity: 1 !important;
  visibility: visible !important;
  transform: none !important;
  animation: slideIn 0.5s ease-out !important;
  width: 100%;
  margin: 0 auto;
  left: 0;
}

/* Extra specificity for Step 6 to ensure it shows */
#quickfixStep6.active {
  display: block !important;
  opacity: 1 !important;
  visibility: visible !important;
}

/* Ensure steps 2, 3, 4 are visible when active (for Pro mode) */
#quickfixStep2.active,
#quickfixStep3.active,
#quickfixStep4.active {
  display: block !important;
  opacity: 1 !important;
  visibility: visible !important;
  padding: 60px 0 40px 0 !important; /* Remove horizontal padding to match Free results width */
  background: #ffffff !important;
  min-height: 100vh;
}

.lil-sus-header {
  text-align: center;
  margin-bottom: 30px;
}

.lil-sus-header h2 {
  font-size: 32px;
  font-weight: 800;
  color: #ff6b00;
  margin-bottom: 10px;
}

.lil-sus-header p {
  color: #6b7280;
  font-size: 16px;
  max-width: 500px;
  margin: 0 auto;
  line-height: 1.5;
  font-style: italic;
}

.flag-list {
  margin: 25px 0;
}

.flag-item {
  background: #fef2f2;
  border: 2px solid #fee2e2;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 12px;
  text-align: left;
}

.flag-severity {
  display: inline-flex;
  align-items: center;
  background: #dc2626;
  color: white;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
  margin-bottom: 8px;
}

.flag-severity.medium {
  background: #f59e0b;
}

.flag-explanation {
  color: #991b1b;
  font-size: 14px;
  font-weight: 600;
}

.quickfix-comparison {
  display: flex;
  flex-direction: column;
  gap: 20px;
  margin: 30px 0;
}

.comparison-box {
  flex: 1;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.original-box {
  background: #fef2f2;
  border: 2px solid #dc2626;
}

.fixed-box {
  background: #f0fdf4;
  border: 2px solid #2ecc71;
}

.box-header {
  display: flex;
  align-items: center;
  margin-bottom: 15px;
  font-weight: 700;
  font-size: 16px;
}
.original-header {
  color: #dc2626;
}

.fixed-header {
  color: #065f46;
}

.box-content {
  line-height: 1.6;
  font-size: 15px;
  min-height: 150px;
  max-height: 350px;
  overflow-y: auto;
  overflow-x: hidden;
  padding-right: 10px;
}

/* NEW: Numbered flag styles */
.flag-highlight-red {
  background: #fee2e2;
  border: 2px solid #dc2626;
  padding: 4px 6px;
  border-radius: 4px;
  font-weight: 600;
  color: #991b1b;
  position: relative;
  display: inline-block;
  margin: 2px;
  cursor: help;
  font-size: 0.85em;
  line-height: 1.5;
}

.flag-highlight-red .flag-number {
  background: #dc2626 !important;
  color: white !important;
}

.flag-highlight-orange {
  background: #fef3c7;
  border: 2px solid #f59e0b;
  padding: 4px 6px;
  border-radius: 4px;
  font-weight: 600;
  color: #92400e;
  position: relative;
  display: inline-block;
  margin: 2px;
  cursor: help;
  font-size: 0.85em;
  line-height: 1.5;
}

.flag-number {
  background: #dc2626;
  color: white;
  border-radius: 50%;
  width: 18px;
  height: 18px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: 700;
  margin-left: 2px;
  vertical-align: super;
  cursor: help;
}

.flag-number:hover {
  transform: scale(1.2);
}

.flag-highlight-orange .flag-number {
  background: none;
  color: #ea580c;
}

.flag-highlight-red .flag-number {
  background: #dc2626;
  color: white !important;
}

.flag-highlight-green {
  background: #d1fae5;
  border: 2px solid #2ecc71;
  border-radius: 4px;
  padding: 2px 6px;
  display: inline-block;
  margin: 0 1px;
  cursor: help;
}

/* FIX 3: Green numbers for fixed version */
.fix-highlight {
  background: #d1fae5;
  border: 2px solid #2ecc71;
  padding: 4px 6px;
  border-radius: 4px;
  font-weight: 600;
  color: #0b0646; /* Changed to navy */
  position: relative;
  display: inline-block;
  margin: 0 1px;
  line-height: 1.5;
}

.fix-highlight .flag-number {
  background: #2ecc71;
  color: white;
}

.quickfix-cta-section {
  text-align: center;
  margin: 30px 0;
}

.lil-sus-footer {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  margin-top: 25px;
  border: 2px dashed #e5e7eb;
}

.lil-sus-footer p {
  color: #6b7280;
  font-size: 14px;
  font-style: italic;
  margin: 0;
  line-height: 1.5;
}

/* NEW: Fix selection styles */
.fix-selection {
  margin: 20px 0 0 0;
}

.fix-option {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  margin-bottom: 15px;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 8px;
  border: 2px solid #e5e7eb;
  transition: all 0.2s;
}

.fix-option.selected {
  background: #f0fdf4;
  border-color: #00a8e8;
}

.fix-checkbox {
  margin-top: 2px;
}
    /* ===== UNIFIED TOOLTIP SYSTEM ===== */
    /* JavaScript-powered tooltip */
    .tooltip {
      position: fixed;
      background: white;
      color: #1e3a8a;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      max-width: 280px;
      z-index: 10000;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      pointer-events: none;
      display: none;
      line-height: 1.5;
      text-align: center;
      word-wrap: break-word;
    }

    .tooltip.show {
      display: block;
      animation: tooltipFadeIn 0.3s ease-in-out;
    }

    @keyframes tooltipFadeIn {
      from {
        opacity: 0;
        transform: translateY(5px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Color-coded borders on left and right */
    .tooltip.blue-border {
      border-left: 4px solid #2ecc71;
      border-right: 4px solid #2ecc71;
    }

    .tooltip.orange-border {
      border-left: 4px solid #ea580c;
      border-right: 4px solid #ea580c;
    }

    .tooltip.green-border {
      border-left: 4px solid #00a8e8;
      border-right: 4px solid #00a8e8;
    }

    @keyframes slideRight {
      0%, 100% {
        transform: translateX(0);
      }
      50% {
        transform: translateX(8px);
      }
    }

    /* ===== UNIFIED BUTTON SYSTEM ===== */
    /* Base button styles */
    button, .btn {
      border: none;
      border-radius: 12px;
      font-size: 0.95em !important;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      padding: 12px 16px !important;
      display: inline-block;
      text-align: center;
      text-decoration: none;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      line-height: 1.2 !important;
      height: auto !important;
    }

    /* Primary Button - Blue */
    .btn-primary, .scan-button {
      background: #2ecc71;
      color: white;
      box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
    }

    .btn-primary:hover, .scan-button:hover {
      background: #27ae60;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
    }

    .btn-primary:active, .scan-button:active {
      transform: translateY(0);
    }

    /* Secondary Button - Orange */
    .btn-secondary, .emergency-button {
      background: #ff6b00;
      color: white;
      box-shadow: 0 4px 12px rgba(255, 107, 0, 0.3);
    }

    .btn-secondary:hover, .emergency-button:hover {
      background: #e55a00;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 0, 0.4);
    }

    .btn-secondary:active, .emergency-button:active {
      transform: translateY(0);
    }

    /* Success Button - Green */
    .btn-success, .pro-button {
      background: #00a8e8;
      color: white;
      box-shadow: 0 4px 12px rgba(0, 168, 232, 0.3);
    }

    .btn-success:hover, .pro-button:hover {
      background: #0087c4;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 168, 232, 0.4);
    }

    .btn-success:active, .pro-button:active {
      transform: translateY(0);
    }

    /* Disabled state */
    button:disabled, .btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      box-shadow: none;
      transform: none !important;
      opacity: 0.7;
    }

    /* Outline Button */
    .btn-outline {
      background: white;
      color: #374151;
      border: 2px solid #e5e7eb;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-outline:hover {
      background: #f9fafb;
      border-color: #d1d5db;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* Size variants */
    .btn-sm {
      padding: 10px 16px;
      font-size: 0.9em;
    }

    .btn-lg {
      padding: 18px 32px;
      font-size: 1.1em;
      min-width: 200px;
    }

    /* Full width */
    .btn-block {
      display: block;
      width: 100%;
    }

    /* Button groups */
    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 20px 0;
    }

    .button-group button, .button-group .btn {
      flex: 1;
      min-width: 160px;
    }

    @media (max-width: 768px) {
      .button-group {
        flex-direction: column;
      }
      
      .button-group button, .button-group .btn {
        width: 100%;
      }
    }

    .fix-option input[type="checkbox"] {
      width: 24px !important;
      height: 24px !important;
      margin-right: 12px !important;
      cursor: pointer !important;
      border-radius: 50% !important;
      appearance: none !important;
      border: 2px solid #d1d5db !important;
      background: #f3f4f6 !important;
      position: relative !important;
      transition: all 0.2s ease !important;
    }

.fix-option input[type="checkbox"]:hover {
  background: #e5e7eb;
  border-color: #9ca3af;
  transform: scale(1.1);
}

.fix-option input[type="checkbox"]:checked {
  background: white !important;
  border-color: #00a8e8 !important;
}

.fix-option input[type="checkbox"]:checked::after {
  content: '✓';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: #00a8e8 !important;
  font-size: 14px;
  font-weight: bold;
}

.fix-content {
  flex: 1;
}

.fix-original {
  color: #dc2626;
  font-weight: 600;
  margin-bottom: 4px;
}

.fix-suggestion {
  color: #065f46;
  font-weight: 600;
}

.fix-explanation {
  color: #6b7280;
  font-size: 14px;
  margin-top: 4px;
  line-height: 1.4;
}

.fix-alternatives {
  color: #2ecc71;
  font-size: 13px;
  margin-top: 4px;
  font-style: italic;
}

.alt-word-btn {
  font-size: 13px !important;
  padding: 6px 12px !important;
}

.disclaimer {
  background: #fef3c7;
  border: 2px solid #f59e0b;
  border-radius: 8px;
  padding: 15px;
  margin: 20px 0;
  text-align: center;
  font-size: 14px;
  color: #92400e;
}

.upsell-section {
  background: #f0f9ff;
  border: 2px dashed #0ea5e9;
  border-radius: 8px;
  padding: 15px;
  margin: 20px 0;
  text-align: center;
}

.upsell-title {
  color: #0369a1;
  font-weight: 600;
  margin-bottom: 8px;
}

.upsell-button {
  background: #00a8e8;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 10px;
  transition: all 0.3s;
  width: 100%;
}

.upsell-button:hover {
  background: #0087c4;
  transform: translateY(-2px);
}

.score-impact {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 8px;
  font-size: 13px;
  color: #6b7280;
}

.score-before, .score-after {
  font-weight: 700;
}

.score-before {
  color: #dc2626;
}

.score-after {
  color: #00a8e8;
}

.apply-selected-fixes {
  background: #00a8e8 !important;
  color: white !important;
  border: none !important;
  padding: 12px 20px !important;
  border-radius: 8px !important;
  font-weight: 600 !important;
  cursor: pointer !important;
  width: 200px !important;
  font-size: 14px !important;
  margin-top: 0 !important;
  transition: all 0.3s;
}

.apply-selected-fixes:hover {
  background: #0087c4 !important;
  transform: translateY(-2px);
}

.apply-all-fixes {
  background: #ff6b00 !important;
  color: white !important;
  border: none !important;
  padding: 12px 20px !important;
  border-radius: 8px !important;
  font-weight: 600 !important;
  cursor: pointer !important;
  width: 200px !important;
  font-size: 14px !important;
  margin-top: 0 !important;
  transition: all 0.3s;
}
.apply-all-fixes:hover {
  background: #0087c4;
  transform: translateY(-2px);
}

/* NEW: FIXED CTA BUTTON STYLES */
.cta-button-group {
  display: flex;
  flex-wrap: nowrap; /* single line */
  gap: 8px;
  justify-content: center;
  margin-top: 16px;
}

/* Make all buttons in CTA group same width */
.cta-button-group button {
  flex: 1;
  min-width: 200px;
}

/* Make bottom CTA container full width to match sections above */
.quickfix-bottom-cta {
  width: 100% !important;
}

.cta-btn {
  padding: 8px 14px;
  font-size: 14px;
  font-weight: 500;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  transition: background-color 0.2s ease;
  white-space: nowrap;
}

.blue-btn {
  background-color: #2e7bff;
  color: #ffffff;
}

.blue-btn:hover {
  background-color: #1a63db;
}

.dark-btn {
  background-color: #333333;
  color: #ffffff;
}

.dark-btn:hover {
  background-color: #222222;
}

.light-btn {
  background-color: #f1f1f1;
  color: #444444;
}

.light-btn:hover {
  background-color: #e2e2e2;
}

.cta-note {
  font-size: 12px;
  color: #666;
  text-align: center;
  margin-top: 10px;
}

/* FIX: Blue Free Rewrite Banner */
.free-rewrite-banner {
  background: linear-gradient(135deg, #2ecc71, #229954);
  color: white;
  padding: 15px;
  border-radius: 10px;
  text-align: center;
  margin: 15px 0;
  border: 2px solid #60a5fa;
  box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
}

/* NEW: QuickFix Bottom CTA Section */
.quickfix-bottom-cta {
  background: white;
  border-radius: 16px;
  padding: 40px 30px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  margin: 30px auto;
  max-width: 1200px;
  width: 100%;
}

.urgency-banner {
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 24px;
  text-align: center;
}

.urgency-banner.high-risk {
  background: linear-gradient(135deg, #fee2e2, #fecaca);
  border-left: 4px solid #dc2626;
}

.urgency-banner.medium-risk {
  background: linear-gradient(135deg, #fef3c7, #fde68a);
  border-left: 4px solid #f59e0b;
}

.urgency-banner.low-risk {
  background: linear-gradient(135deg, #d1fae5, #a7f3d0);
  border-left: 4px solid #00a8e8;
}

.urgency-text {
  font-weight: 700;
  font-size: 16px;
  line-height: 1.4;
}

.urgency-banner.high-risk .urgency-text {
  color: #991b1b;
}

.urgency-banner.medium-risk .urgency-text {
  color: #92400e;
}

.urgency-banner.low-risk .urgency-text {
  color: #065f46;
}

.pitch-section {
  text-align: center;
  margin-bottom: 28px;
  border-bottom: 2px solid #f3f4f6;
  padding-bottom: 24px;
}

.pitch-title {
  font-size: 24px;
  font-weight: 800;
  color: #0b0646;
  margin-bottom: 16px;
  line-height: 1.3;
}

.pitch-copy {
  font-size: 15px;
  color: #6b7280;
  line-height: 1.6;
  margin-bottom: 12px;
}

.score-display {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 14px;
  margin: 16px 0;
  font-size: 14px;
  font-weight: 600;
  color: #374151;
  text-align: center;
}

.score-display span {
  font-size: 18px;
  font-weight: 800;
}

.score-display.high-risk span {
  color: #dc2626;
}

.score-display.medium-risk span {
  color: #f59e0b;
}

.score-display.low-risk span {
  color: #00a8e8;
}

.what-happens {
  background: #f0fdf4;
  border-left: 4px solid #00a8e8;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
}

.what-happens-title {
  font-weight: 700;
  color: #065f46;
  margin-bottom: 12px;
  font-size: 15px;
}

.what-happens-list {
  list-style: none;
}

.what-happens-list li {
  margin: 8px 0;
  padding-left: 0;
  font-size: 14px;
  color: #047857;
  line-height: 1.5;
}

.what-happens-list li:before {
  content: '→';
  display: inline-block;
  margin-right: 8px;
  color: #00a8e8;
  font-weight: bold;
}

.footer-disclaimer {
  text-align: center;
  font-size: 13px;
  color: #6b7280;
  line-height: 1.6;
  padding-top: 16px;
  border-top: 1px solid #e5e7eb;
}

.cta-btn.tertiary {
  background: transparent;
  color: #6b7280;
  border: 2px solid #d1d5db;
  font-weight: 600;
}

.cta-btn.tertiary:hover {
  background: #f9fafb;
  border-color: #9ca3af;
  color: #4b5563;
}

/* FIX: Orange Full Rewrite Button */
.orange-rewrite-btn {
  background: #2ecc71 !important;
  color: white !important;
  border: none !important;
  padding: 12px 20px !important;
  border-radius: 8px !important;
  font-weight: 600 !important;
  cursor: pointer !important;
  width: 200px !important;
  font-size: 14px !important;
  margin-top: 0 !important;
}

.orange-rewrite-btn:hover {
  background: #dc2626 !important;
  transform: translateY(-2px);
}

/* STEP 4 SPECIFIC STYLES */
.mobile-toggle {
  display: none;
}

@media (max-width: 768px) {
  .step4-comparison {
    display: none !important;
  }
  
  .mobile-toggle {
    display: flex;
  }
  
  .stats-grid {
    grid-template-columns: 1fr !important;
  }
  
  .step4-cta-btn {
    min-width: 100% !important;
  }
}

/* Optional: Make Font a Bit Smaller on Mobile */
@media (max-width: 480px) {
  .cta-btn {
    font-size: 13px;
    padding: 6px 10px;
  }
}
/* FIX 12: Mobile Optimization */
@media (max-width: 768px) {
  .button-group {
    flex-direction: column;
  }
  .scan-button, .emergency-button, .pro-button {
    min-width: auto;
    margin-bottom: 10px;
  }
  .overlay-button-group {
    flex-direction: column;
  }
  .overlay-button-group button {
    width: 100%;
    margin-right: 0;
  }
  .close-results-button {
    top: 5px;
    right: 15px;
    font-size: 11px;
    padding: 5px 10px;
  }
  .main-container {
    width: 95%;
    max-width: 95%; /* Add this */
    margin: 0 auto 20px;
    padding: 0 15px; /* Slightly reduce padding on mobile */
  }
  .input-section {
    padding: 20px 15px; /* Consistent padding */
  }
  
  /* Make sure results wrapper is full width on mobile */
  #resultsContainer .results-wrapper,
  .quickfix-flow-container,
  .free-results-layout {
    max-width: 95% !important;
    width: 95% !important;
    margin: 0 auto !important;
  }
  .quickfix-comparison {
    flex-direction: column;
  }
  .fix-option {
    flex-direction: column;
    gap: 8px;
  }
  .cta-button-group {
    flex-direction: column;
  }
  .cta-btn {
    width: 100%;
    margin-bottom: 10px;
  }
  .progress-labels {
    font-size: 12px;
    padding: 0 2px;
  }
}

/* NEW STEP 4 STYLES - ADDED FROM YOUR CODE */
.hero-header {
  text-align: center;
  margin-bottom: 40px;
  padding: 30px 0;
}

.hero-header h1 {
  font-size: 2.5em;
  font-weight: 800;
  color: #0b0646;
  margin-bottom: 15px;
  line-height: 1.2;
}

.hero-header p {
  font-size: 1.2em;
  color: #0b0646; /* Changed to navy for success messages */
  font-style: italic;
}

.rotating-message {
  font-size: 1.8em;
  font-weight: 800;
  color: #0b0646;
  margin-bottom: 15px;
  line-height: 1.2;
  text-align: center;
  min-height: 1.2em;
  transition: opacity 0.5s ease-in-out;
}

.footer-cta {
  font-size: 1.8em !important;
  font-weight: 800 !important;
  color: #2ecc71 !important;
  text-shadow: 2px 2px 4px rgba(46, 204, 113, 0.3) !important;
  margin: 20px 0 !important;
  line-height: 1.3 !important;
  text-align: center !important;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 10px;
  margin: 15px 0;
}

.stat-card {
  padding: 10px;
  border-radius: 8px;
  text-align: center;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.12);
}

.stat-card.green {
  background: linear-gradient(135deg, #00a8e8, #0087c4);
  color: white;
}

.stat-card.blue {
  background: linear-gradient(135deg, #2ecc71, #229954);
  color: white;
}

.stat-card.orange {
  background: linear-gradient(135deg, #f97316, #ea580c);
  color: white;
}

.stat-card.red {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: white;
}

.stat-number {
  font-size: 1.6em;
  font-weight: 800;
  display: block;
  margin-bottom: 3px;
}

.stat-label {
  font-size: 0.9em;
  opacity: 0.95;
}

.score-transformation {
  background: white;
  border-radius: 20px;
  padding: 30px;
  margin: 30px 0;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
}

.score-comparison {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 20px;
  margin-bottom: 25px;
  flex-wrap: wrap;
}

.score-badge {
  padding: 12px 25px;
  border-radius: 25px;
  font-weight: 700;
  font-size: 1.1em;
}

.score-before {
  background: #fee2e2;
  color: #dc2626;
}

.score-after {
  background: #d1fae5;
  color: #00a8e8;
}

.score-arrow {
  font-size: 1.8em;
  color: #00a8e8;
}

.sus-meter {
  background: #f8f9fa;
  padding: 25px;
  border-radius: 15px;
}

.meter-labels {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
  font-size: 12px;
  font-weight: 700;
  color: #6b7280;
}

.meter-bar {
  height: 30px;
  background: #e5e7eb;
  border-radius: 15px;
  overflow: hidden;
  position: relative;
  margin-bottom: 15px;
}

.meter-fill {
  height: 100%;
  background: linear-gradient(90deg, #00a8e8, #4dd0e1);
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding-right: 15px;
  color: white;
  font-weight: 700;
  transition: width 1.5s ease;
}
.meter-message {
  text-align: center;
  color: #00a8e8;
  font-weight: 700;
  font-size: 1.1em;
}

.action-buttons {
  display: flex;
  gap: 12px;
  margin: 30px 0;
  flex-wrap: wrap;
}

.btn {
  flex: 1;
  min-width: 200px;
  padding: 16px;
  font-size: 16px;
  font-weight: 700;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.btn-success {
  background: #00a8e8;
  color: white;
}

.btn-success:hover {
  background: #0087c4;
  transform: translateY(-2px);
}

.btn-primary {
  background: #2ecc71;
  color: white;
}

.btn-primary:hover {
  background: #27ae60;
  transform: translateY(-2px);
}

.btn-warning {
  background: #f46904;
  color: white;
}

.btn-warning:hover {
  background: #dc2626;
  transform: translateY(-2px);
}

.essay-viewer {
  background: white;
  border-radius: 20px;
  padding: 30px;
  margin: 30px 0;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
}

.viewer-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
  flex-wrap: wrap;
  gap: 15px;
}

.viewer-title {
  font-size: 1.5em;
  font-weight: 700;
  color: #1f2937;
}

.toggle-switch {
  display: flex;
  justify-content: center;
  background: #f3f4f6;
  border-radius: 10px;
  padding: 4px;
  gap: 4px;
}

.toggle-btn {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  background: transparent;
  color: #6b7280;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.toggle-btn.active {
  background: white;
  color: #1f2937;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.essay-display {
  position: relative;
  background: #f9fafb;
  border-radius: 12px;
  padding: 25px;
  max-height: 500px;
  overflow-y: auto;
  line-height: 1.8;
  font-size: 16px;
  color: #374151;
}

.essay-content {
  display: none;
  max-height: 400px;
  overflow-y: auto;
  padding: 15px;
  border-radius: 8px;
  background: white;
  border: 1px solid #e5e7eb;
}

.essay-content.active {
  display: block;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.flag-removed {
  background: #fee2e2;
  color: #dc2626;
  padding: 2px 6px;
  border-radius: 4px;
  text-decoration: line-through;
  font-weight: 600;
}

.flag-fixed {
  background: #d1fae5;
  color: #2ecc71;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: 600;
}

.diff-highlight {
  background: #fef3c7;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: 600;
}

.stats-banner {
  background: #f0f9ff;
  border: 2px solid #bae6fd;
  border-radius: 12px;
  padding: 20px;
  margin: 20px 0;
  display: flex;
  justify-content: space-around;
  align-items: center;
  flex-wrap: wrap;
  gap: 15px;
}

.stat-item {
  text-align: center;
}

.stat-value {
  font-size: 2em;
  font-weight: 800;
  color: #0369a1;
  display: block;
}

.stat-text {
  font-size: 0.9em;
  color: #6b7280;
}

.lil-sus-footer {
  background: white;
  padding: 50px 40px;
  border-radius: 20px;
  text-align: center;
  margin-top: 40px;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  border: 3px solid #f97316;
}

.footer-icon {
  font-size: 4em;
  margin-bottom: 20px;
}

.footer-title {
  font-size: 2.2em;
  margin-bottom: 20px;
  font-weight: 900;
  color: #00a8e8;
}

.footer-text {
  margin: 12px 0;
  color: #374151;
  line-height: 1.8;
  font-size: 1.1em;
  font-weight: 500;
}

.footer-cta {
  font-weight: 900;
  font-size: 1.6em;
  margin-top: 25px;
  color: #2ecc71;
  letter-spacing: 0.5px;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  z-index: 10000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.modal.show {
  display: flex;
}

.modal-content {
  background: white;
  border-radius: 20px;
  max-width: 900px; /* Changed from 800px to 900px for consistency */
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
}

.modal-header {
  background: linear-gradient(135deg, #2ecc71, #052e60);
  color: white;
  padding: 30px;
  text-align: center;
  border-radius: 20px 20px 0 0;
}

.modal-close {
  position: absolute;
  top: 10px;
  right: 10px;
  background: none;
  border: none;
  font-size: 32px;
  color: #999;
  cursor: pointer;
  padding: 10px 15px;
  line-height: 1;
  border-radius: 50%;
  transition: all 0.3s;
  z-index: 1;
}

.modal-body {
  padding: 30px;
}

.flag-item {
  display: flex;
  gap: 15px;
  margin-bottom: 25px;
  padding-bottom: 25px;
  border-bottom: 2px solid #f3f4f6;
}

.flag-number {
  flex-shrink: 0;
}

.flag-details {
  flex: 1;
}

.flag-change {
  margin-bottom: 12px;
}

.flag-original {
  background: #fef2f2;
  color: #dc2626;
  padding: 6px 10px;
  border-radius: 6px;
  font-weight: 600;
  display: inline-block;
}

.flag-arrow {
  margin: 0 8px;
  color: #6b7280;
}

.flag-new {
  background: #ecfdf5;
  color: #00a8e8;
  padding: 6px 10px;
  border-radius: 6px;
  font-weight: 600;
  display: inline-block;
}

.flag-explanation {
  background: #f8f9fa;
  padding: 12px;
  border-radius: 8px;
}

.modal-footer {
  padding: 20px;
  background: #f8f9fa;
  display: flex;
  gap: 12px;
  border-radius: 0 0 20px 20px;
}

.success-toast {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  color: #00a8e8;
  border: 3px solid #00a8e8;
  padding: 20px 30px;
  border-radius: 15px;
  font-weight: 700;
  z-index: 10001;
  box-shadow: 0 10px 30px rgba(0, 168, 232, 0.4);
  animation: slideIn 0.3s ease;
  display: none;
}

.download-toast {
  background: white;
  color: #2ecc71;
  border: 3px solid #2ecc71;
  box-shadow: 0 10px 30px rgba(46, 204, 113, 0.4);
}

.success-toast.show {
  display: block;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translate(-50%, -60%);
  }
  to {
    opacity: 1;
    transform: translate(-50%, -50%);
  }
}

@media (max-width: 768px) {
  .action-buttons {
    flex-direction: column;
  }
  
  .btn {
    min-width: auto;
    width: 100%;
  }
  
  .stats-grid {
    grid-template-columns: 1fr;
  }
  
  .score-comparison {
    flex-direction: column;
  }
  
  .viewer-header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .toggle-switch {
    width: 100%;
    justify-content: center;
  }
  
  .toggle-btn {
    flex: 1;
  }
}

/* Pro Feature Modal Classes */
.pro-feature {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 14px;
  border: 2px solid #e5e7eb;
}

.pro-feature-icon {
  font-size: 36px;
  margin-bottom: 10px;
}

.pro-feature-title {
  color: #0b0646;
  margin: 0 0 8px;
  font-size: 16px;
  font-weight: 700;
}

.pro-feature-desc {
  color: #6b7280;
  font-size: 13px;
  line-height: 1.5;
  margin: 0;
}

.modal-title {
  color: #0b0646;
  margin: 0 0 10px;
  font-size: 28px;
  font-weight: 800;
}

.modal-subtitle {
  color: #6b7280;
  font-size: 16px;
  margin: 0;
}

.pro-upgrade-btn {
  padding: 16px 40px;
  font-size: 21px !important;
  font-weight: 700 !important;
  box-shadow: 0 4px 15px rgba(0, 168, 232, 0.3);
  margin-bottom: 15px;
}

.modal-dismiss {
  display: block;
  text-align: center;
  color: #9ca3af;
  font-size: 14px;
  text-decoration: underline;
  cursor: pointer;
  margin-top: 10px;
}
</style>
</head>
<body>
<div class="page-wrapper">
<div class="panic-banner" id="panicBanner" style="display:none;">
  🚨 HIGH AI DECTION RISK - Only <span id="panicScansLeft">99</span> scan(s) left today! 
  <a href="#" onclick="handleProUpgrade(); return false;">Get Pro Now →</a>
</div>
<!-- QuickFix Flow Section -->
<div id="quickfixFlow" class="quickfix-flow-container">
  <div class="hero-section">
    <h1 id="mainHeaderTitle" class="hero-title">False Flag Fixer - <span style="color: #ffffff !important; display: inline-block; text-shadow: 0 0 10px #ffffff, 0 0 20px #ffffff, 0 0 30px #ffffff, 0 0 40px rgba(255, 255, 255, 0.5); filter: grayscale(100%) brightness(2) contrast(1.2) !important; font-weight: bold;">⚡</span> QuickFix</h1>
    <p id="mainHeaderSubtitle" class="hero-subtitle" style="padding-bottom: 24px;">
      Find ALL AI-trigger words and fix them — complete solution for this essay
    </p>
  </div>

  <div class="main-container">
    <div class="input-section">
      <!-- STEP 1: QuickFix Landing -->
      <div id="quickfixStep1" class="quickfix-step active">
        <div class="lil-sus-header">
          <h2><span style="color: #ffeb3b !important; display: inline-block; text-shadow: -2px -2px 0px #666, 2px -2px 0px #666, -2px 2px 0px #666, 2px 2px 0px #666, 0 0 15px #ffeb3b, 0 0 25px #ffeb3b, 0 0 35px #ffeb3b; filter: brightness(1.5) saturate(2) !important; font-weight: bold; -webkit-text-stroke: 1px #666; text-stroke: 1px #666;">⚡</span> QuickFix</h2>
          <p>Got a last-minute essay? I'll find ALL AI-trigger words and fix them — complete solution for $1.99!</p>
        </div>
        
        
        <textarea id="quickfixEssayInput" placeholder="Paste your essay here (up to 5,000 characters)..." maxlength="5000" style="width:100%; height:200px; padding:15px; border:2px solid #e5e7eb; border-radius:10px; font-size:16px; font-family:inherit; resize:vertical; margin-bottom:15px;"></textarea>
        
        <div class="quickfix-char-counter"><span id="quickfixFlowCharCount">0</span>/5000 characters</div>
        
        <button id="startQuickFix" class="btn-secondary btn-block btn-lg" style="margin-top: 20px; font-size: 18px;" data-tooltip="Find ALL AI-trigger words and fix them - $1.99. Scan up to 5000 characters.">
          <span style="color: #ffeb3b !important; display: inline-block; text-shadow: -2px -2px 0px #666, 2px -2px 0px #666, -2px 2px 0px #666, 2px 2px 0px #666, 0 0 15px #ffeb3b, 0 0 25px #ffeb3b, 0 0 35px #ffeb3b; filter: brightness(1.5) saturate(2) !important; font-weight: bold; -webkit-text-stroke: 1px #666; text-stroke: 1px #666;">⚡</span> QuickFix My Essay
        </button>
        
        <div style="text-align:center; margin-top:0; padding:48px 20px 15px 20px; background:#f8f9fa; border-radius:12px;">
          <p style="margin:0 0 14px 0; color:#374151; font-size:20px; font-weight:800; display:block;">🚨 Don't Risk It. Fix It.</p>
          <p style="margin:0 0 15px 0; color:#6b7280; font-size:13px; line-height:1.5;">Get 500 scans/mo • Deeper Fixes • Real-Time Scoring • Fix the AI flags before the AI flags you.</p>
          <button onclick="handleProUpgrade()" style="background:#00a8e8; color:white; border:none; padding:12px 24px; border-radius:8px; font-weight:700; font-size:14px; cursor:pointer; width:100%;">
            💎 Go Pro - $9.99/mo
          </button>
        </div>
        
        <div style="text-align:center; margin-top:15px;">
          <button class="btn-outline" onclick="hideQuickFixFlow()" style="margin-top: 15px;">
            🏠 Back To Main Dashboard
          </button>
        </div>
      </div>
      
      <!-- STEP 2: Analysis Results (Before Fix) - IMPROVED -->
      <div id="quickfixStep2" class="quickfix-step">
        <!-- QuickFix Banner Cards -->
        <!-- HELLA SUS CARD (70-100%) -->
        <div id="quickfixHellaSusCard" class="card warning-card" style="padding: 0; overflow: visible; position: relative; display: none; margin-bottom: 20px;">
          <!-- Your AI Sus Score Title -->
          <div style="text-align: center; margin: -48px 0 48px 0; position: relative; z-index: 10;">
            <h3 style="font-size: 24px; font-weight: 700; color: #374151; margin: 0 0 8px 0; text-align: center; text-transform: uppercase; letter-spacing: 0.5px;">Your AI Sus Score</h3>
            <p style="font-size: 14px; font-weight: 400; color: #6b7280; margin: 0; text-align: center; line-height: 1.4;">How suspicious your writing looks to AI detectors — even though it's 100% human 🙄</p>
          </div>
          <!-- HEADER SECTION - NEW STYLE -->
          <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin: 20px 0; border-left: 8px solid #dc2626; border-right: 8px solid #dc2626;">
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;">
              <div style="width: 60px; height: 60px; background: #fee2e2; border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(220, 38, 38, 0.3); flex-shrink: 0;">
                <span style="font-size: 36px; line-height: 1;">🚩</span>
              </div>
              <div style="text-align: center;">
                <h2 id="quickfixHellaSusWarningTitle" style="font-size: 32px; font-weight: 700; margin: 0; line-height: 1; color: #ff4444;">Hella Sus</h2>
                <p id="quickfixHellaSusLabel" style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #6b7280; margin-top: 6px;">Major red flags detected</p>
              </div>
            </div>
          </div>
        </div>

        <!-- KINDA SUS CARD (30-69%) -->
        <div id="quickfixKindaSusCard" class="card warning-card" style="padding: 0; overflow: visible; position: relative; display: none; margin-bottom: 20px;">
          <!-- Your AI Sus Score Title -->
          <div style="text-align: center; margin: -48px 0 48px 0; position: relative; z-index: 10;">
            <h3 style="font-size: 24px; font-weight: 700; color: #374151; margin: 0 0 8px 0; text-align: center; text-transform: uppercase; letter-spacing: 0.5px;">Your AI Sus Score</h3>
            <p style="font-size: 14px; font-weight: 400; color: #6b7280; margin: 0; text-align: center; line-height: 1.4;">How suspicious your writing looks to AI detectors — even though it's 100% human 🙄</p>
          </div>
          <!-- HEADER SECTION - NEW STYLE -->
          <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin: 20px 0; border-left: 8px solid #f5a623; border-right: 8px solid #f5a623;">
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;">
              <div style="width: 60px; height: 60px; background: #fef3c7; border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(245, 166, 35, 0.3); flex-shrink: 0;">
                <span style="font-size: 36px; line-height: 1;">⚠️</span>
              </div>
              <div style="text-align: center;">
                <h2 id="quickfixKindaSusWarningTitle" style="font-size: 32px; font-weight: 700; margin: 0; line-height: 1; color: #f5a623;">Kinda Sus</h2>
                <p id="quickfixKindaSusLabel" style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #6b7280; margin-top: 6px;">Some wording might come across as AI-generated. Let's fix that.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- YOU'RE GOOD CARD (0-29%) -->
        <div id="quickfixYoureGoodCard" class="card warning-card" style="padding: 0; overflow: visible; position: relative; display: none; margin-bottom: 20px;">
          <!-- Your AI Sus Score Title -->
          <div style="text-align: center; margin: -48px 0 48px 0; position: relative; z-index: 10;">
            <h3 style="font-size: 24px; font-weight: 700; color: #374151; margin: 0 0 8px 0; text-align: center; text-transform: uppercase; letter-spacing: 0.5px;">Your AI Sus Score</h3>
            <p style="font-size: 14px; font-weight: 400; color: #6b7280; margin: 0; text-align: center; line-height: 1.4;">How suspicious your writing looks to AI detectors — even though it's 100% human 🙄</p>
          </div>
          <!-- HEADER SECTION - NEW STYLE -->
          <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin: 20px 0; border-left: 8px solid #2ecc71; border-right: 8px solid #2ecc71;">
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;">
              <div style="width: 60px; height: 60px; background: #d1fae5; border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(46, 204, 113, 0.3); flex-shrink: 0;">
                <span style="font-size: 36px; line-height: 1;">✅</span>
              </div>
              <div style="text-align: center;">
                <h2 id="quickfixYoureGoodWarningTitle" style="font-size: 32px; font-weight: 700; margin: 0; line-height: 1; color: #2ecc71;">Clean - No Sus</h2>
                <p id="quickfixYoureGoodLabel" style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #6b7280; margin-top: 6px;">No AI-trigger words detected</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- FIX 3: Score moved to top -->
        <!-- Score Display - FIXED POSITION -->
        <div style="text-align:center; margin-bottom:30px;">
          <!-- Green CTA box for Clean No Sus - above percentage -->
          <div id="quickfixCleanNoSusCTA" style="display: none; background: #2ecc71; padding: 24px 24px; border-radius: 10px; margin: 24px auto 24px auto; text-align: center; max-width: 600px;">
            <p style="color: #ffffff; font-size: 16px; font-weight: 700; margin: 0; line-height: 1.4;">
              QuickFix didn't clock anything sus<br>
              Vibe check passed ✅ — nothing to tweak.
            </p>
          </div>
          <!-- Yellow CTA box for Kinda Sus - above percentage -->
          <div id="quickfixKindaSusCTA" style="display: none; background: #fbbf24; padding: 24px 24px; border-radius: 10px; margin: 24px auto 24px auto; text-align: center; max-width: 600px;">
            <p style="color: #ffffff; font-size: 16px; font-weight: 700; margin: 0; line-height: 1.4;">
              A couple lines are giving sus. Detectors might side-eye it.
            </p>
          </div>
          <!-- Red CTA box for Hella Sus - above percentage -->
          <div id="quickfixHellaSusCTA" style="display: none; background: #dc2626; padding: 24px 24px; border-radius: 10px; margin: 24px auto 24px auto; text-align: center; max-width: 600px;">
            <p style="color: #ffffff; font-size: 16px; font-weight: 700; margin: 0; line-height: 1.4;">
              Yeah… detectors are definitely side-eyeing this.
            </p>
          </div>
          <div class="score-display" style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
            <span class="score-number" id="quickfixOriginalScore" style="font-size: 72px; font-weight: 700; color: #2ecc71; line-height: 1;">0%</span>
            <span class="score-label" id="quickfixScoreLabel" style="font-size: 14px !important; font-weight: 600 !important; letter-spacing: 0.5px; color: #6b7280 !important; line-height: 1;">Clean - No Sus</span>
          </div>
          <!-- Progress Bar with Dot Indicator -->
          <div class="progress-container">
            <div class="progress-bar" id="quickfixProgressBar" style="height: 8px; background: transparent; border-radius: 4px; position: relative; overflow: hidden; border: 1px solid #ccc;">
              <div class="progress-fill" id="quickfixProgressFill"></div>
              <div class="progress-indicator" id="quickfixProgressIndicator"></div>
            </div>
            <div class="progress-endpoints">
              <span>0%</span>
              <span>100%</span>
            </div>
            <div class="progress-labels">
              <span>✅ Clean - No Sus</span>
              <span>⚠️ Kinda Sus</span>
              <span>🚨 Hella Sus</span>
            </div>
          </div>
        </div>
        
        <!-- Green box for You're Good case - MOVED ABOVE ESSAY SECTION -->
        <div class="upsell-section" id="quickfixUpsellSection" style="background: #d1fae5; border: 1px solid #059669; border-radius: 12px; padding: 40px 30px; margin: 48px 0 30px 0; text-align: center; display: none; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.15);">
          <div style="margin-bottom: 20px;">
            <img src="https://i.postimg.cc/JhsvMWLJ/Lil-Sus-Trans-Bg.png" alt="Lil Sus" style="width: 375px; height: auto; display: block; margin: 0 auto;">
          </div>
          <div style="margin-bottom: 16px;">
            <h2 style="color: #059669; font-size: 32px; font-weight: 800; line-height: 1.3; margin: 0 0 12px 0;">False Flag Fixed <span style="filter: hue-rotate(120deg) saturate(2) brightness(1.2); display: inline-block;">🚩</span></h2>
            <p style="color: #059669; font-size: 24px; font-weight: 700; margin: 0; line-height: 1.4;">Go Ahead. Turn It In!</p>
          </div>
        </div>
        
        <!-- FIX 1: Dynamic flag count heading -->
        <!-- Essay with Numbered Flags -->
        <div id="quickfixEssayContainer" style="background:#f8f9fa; border-radius:12px; padding:20px 20px 10px 20px; margin:20px 0;">
            <!-- Problem Statement -->
            <h3 id="quickfixCountHeading" style="text-align:center; color:#dc2626; font-size:20px; font-weight:700; margin-top:30px; margin-bottom:8px;">
              🚩 QuickFix found <span id="quickfixCount" style="color: #dc2626;">3</span> AI-trigger word<span id="quickfixCountPlural">s</span>.
            </h3>
            <p id="quickfixInstructionText" style="text-align:center; color:#6b7280; font-size:14px; margin-bottom:20px; font-weight:500;">
              Click on any flagged word below to see suggested replacements.
            </p>
            
            <!-- Essay Content -->
            <div id="flaggedEssayContent" class="essay-content" style="line-height:1.8; max-height: 400px; overflow-y: scroll; overflow-x: hidden; border: 1px solid #d1d5db; border-radius: 8px; padding: 20px; background: white; margin-top: 39px; margin-bottom: 0; font-size: 16px;">
            <!-- Flagged content will be inserted here -->
          </div>
          
          <!-- Copy Text CTA for You're Good case - moved right under essay -->
          <div id="quickfixCopyTextCTA" style="display: none; text-align: center; margin: 0; padding: 24px 0 24px 0;">
            <button onclick="copyQuickFixResult()" style="background: white !important; color: #003d7a !important; border: 1px solid #003d7a !important; border-radius: 8px; padding: 12px 24px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; transition: all 0.2s; margin: 0;" onmouseover="this.style.background='#f0f9ff'; this.style.borderColor='#003d7a'; this.style.color='#003d7a';" onmouseout="this.style.background='white'; this.style.borderColor='#003d7a'; this.style.color='#003d7a';">
              📋 Copy Text
            </button>
          </div>
        </div>
        
        <!-- Numbered Flag Explanations with Checkboxes -->
        <div id="flagExplanationsSection" style="max-width: 700px; margin: 24px auto 0 auto;">
          <div class="modern-toggle-container" style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 0;">
            <div class="toggle-header" style="background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); padding: 16px 20px; display: flex; align-items: center; justify-content: space-between; transition: all 0.3s ease; border-bottom: 1px solid #fecaca; border-top: 1px solid #fecaca; border-left: 1px solid #fecaca; border-right: 1px solid #fecaca;">
              <div style="display: flex; align-items: center; gap: 12px; flex: 1; justify-content: center;">
                <div style="text-align: center;">
                  <h4 id="quickfixFixesTitle" style="color:#dc2626; margin:0; font-size: 18px; font-weight: 700;">Choose Your Fixes</h4>
                  <p id="quickfixFixesSubtitle" style="color:#6b7280; margin:4px 0 0 0; font-size: 13px;">Check the box below to auto-select our recommended best words for lowest AI score — or pick your own</p>
                  
                  <!-- Select All Toggle -->
                  <div style="margin: 15px 0; text-align: center;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 14px; color: #374151; justify-content: center;">
                      <span style="font-size: 24px; animation: slideRight 2s ease-in-out infinite; line-height: 1; display: flex; align-items: center;">👉</span>
                      <input type="checkbox" id="selectAllFixes" style="margin: 0; transform: scale(1.2); vertical-align: middle;">
                      <span style="font-weight: 600;">QuickFix Mode: Use Best Words</span>
                    </label>
                  </div>
                </div>
              </div>
              <div id="toggleArrowContainer" style="background: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 2px rgba(0,0,0,0.1); cursor: pointer;" onclick="event.stopPropagation(); toggleFixSelection();">
                <span id="toggleArrow" style="font-size: 16px; color: #dc2626; transition: transform 0.3s ease; pointer-events: none;">▼</span>
              </div>
            </div>
            <!-- Real-time Score Preview Box (Banner/Flag Shape) - Points to selected fix option -->
            <div id="scorePreviewBox" style="position: fixed; z-index: 1000; display: none; visibility: hidden; opacity: 0; transition: left 0.3s ease, top 0.3s ease, opacity 0.2s ease, visibility 0s linear 0.2s;">
              <!-- Banner body with flag shape - pointed left, notched right, LONGER -->
              <div id="scorePreviewBanner" style="position: relative; padding: 14px 35px 14px 50px; width: 320px; height: 110px; box-shadow: 0 4px 20px rgba(0,0,0,0.25); clip-path: polygon(25px 0%, 100% 0%, 100% 25%, calc(100% - 20px) 50%, 100% 75%, 100% 100%, 25px 100%, 0% 50%); transition: background 0.3s ease; display: flex; flex-direction: column; justify-content: center;">
                <div id="previewScoreLine" style="font-size: 15px; font-weight: 600; color: #ffffff; margin-bottom: 4px; text-align: left;">Your Current Sus Score: <span id="previewScore" style="font-size: 24px; font-weight: 700; color: #ffffff;">--</span></div>
                <div id="previewAfterFixes" style="font-size: 16px; font-weight: 500; color: #ffffff; text-align: left; opacity: 0.95; margin-bottom: 6px;">After Selected Fix: <span id="previewAfterFixesScore" style="font-size: 22px; font-weight: 700; color: #ffffff;"></span><span id="previewAfterFixesAsterisk" style="font-size: 14px; color: #ffffff; opacity: 0.85;"></span></div>
                <div id="previewImprovement" style="font-size: 12px; font-weight: 700; color: #ffffff; text-align: left; opacity: 0.95; margin-bottom: 0;"></div>
                <div style="position: absolute; bottom: 10px; right: 35px; font-size: 10px; color: #ffffff; opacity: 0.85;">*Estimate</div>
              </div>
              <!-- Pointer triangle removed -->
            </div>
            
            <div id="fixSelection" class="fix-selection" style="display: block; padding: 0; max-height: 400px; overflow-y: scroll; overflow-x: hidden;">
              <div id="fixSelectionInstructionBox" style="background: #f8f9fa; padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                  <div style="background: #00a8e8; color: white; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">✓</div>
                  <p style="color: #374151; font-size: 13px; margin: 0; font-weight: 600;">
                    Select the fixes you want to apply. Choose your own word replacements, or use the checkbox below to auto-select the best words — those with the lowest chance to trigger AI detectors.
                  </p>
                </div>
                <p style="color: #6b7280; font-size: 12px; margin: 0; line-height: 1.4;">
                  Each fix shows the original word → suggested replacement with explanation, AI trigger risk, and estimated score improvement.
                </p>
              </div>
              <div style="padding: 12px 16px;">
            <!-- Fix options will be inserted here -->
              </div>
            </div>
          </div>
          
          <!-- Button group with proper color hierarchy -->
          <div id="quickfixButtonGroup" style="display: flex; gap: 16px; justify-content: center; align-items: center; margin: 0; padding: 48px 0 42px 0; flex-wrap: wrap; line-height: 1;">
            <!-- Animated pointing hand emoji -->
            <span id="quickfixCTAHand" style="font-size: 32px; margin-right: -8px; animation: slideRight 2s ease-in-out infinite; display: inline-block;">👉</span>
            <!-- Safe action = Green -->
            <button id="applySelectedFixes" class="btn-secondary" style="min-width: 300px; background: #ff6b00 !important; color: white !important; margin: 0; padding: 12px 24px; line-height: 1;">
              ✅ Apply QuickFixes (<span id="selectedCount">0</span>) and Get Your New Score
          </button>
          <button id="copyTextButton" class="btn-secondary" style="min-width: 300px; background: white !important; color: #003d7a !important; display: none; border: 1px solid #003d7a !important; border-radius: 8px; padding: 12px 24px; font-size: 16px; font-weight: 600; cursor: pointer; margin: 0; line-height: 1;">
              📋 Copy Text
          </button>
            <!-- Premium feature = Blue -->
          </div>
          <!-- Pro Upsell Section for Hella Sus/Kinda Sus (same as QuickFix Step 1) -->
          <div id="quickfixProUpsellBox" style="display: none; text-align:center; margin: 0; padding:48px 20px 15px 20px; background:#f8f9fa; border-radius:12px; line-height: 1;">
            <p style="margin:0 0 14px 0; color:#374151; font-size:20px; font-weight:800; display:block;">🚨 Don't Risk It. Fix It.</p>
            <p style="margin:0 0 15px 0; color:#6b7280; font-size:13px; line-height:1.5;">Get 500 scans/mo • Deeper Fixes • Real-Time Scoring • Fix the AI flags before the AI flags you.</p>
            <button onclick="handleProUpgrade()" style="background:#00a8e8; color:white; border:none; padding:12px 24px; border-radius:8px; font-weight:700; font-size:14px; cursor:pointer; width:100%;">
              💎 Go Pro - $9.99/mo
            </button>
          </div>
          
          <!-- GO AHEAD! TURN IT IN! moved to white section -->
          <div id="goAheadTurnItIn" style="display: none; text-align: center; margin: 24px 0;">
            <div style="background: #10b981; color: white; border: none; border-radius: 8px; padding: 12px 20px; font-size: 18px; font-weight: 700; width: 100%; pointer-events: none; text-transform: uppercase;">
              🎉 GO AHEAD! TURN IT IN! 🎉
            </div>
          </div>
          
          <!-- New Pro Banner for You're Good case -->
          <div id="quickfixProBanner" style="display: none; background: linear-gradient(135deg, #00d4ff 0%, #00a8e8 100%); border-radius: 16px; padding: 20px 16px; margin: 48px 0 0 0; text-align: center; box-shadow: 0 4px 12px rgba(0, 168, 232, 0.2);">
            <h3 id="proBenefitsText" style="text-align: center; color: white; font-size: 22px; margin: 0 0 12px 0; line-height: 1.4; font-weight: 800;">
              🚨 Don't Risk It. Fix It.
            </h3>
            <p style="text-align: center; color: white; font-size: 13px; margin: 0 0 16px 0; line-height: 1.5; opacity: 0.9;">
              Get 500 scans/mo • Deeper Fixes • Real-Time Scoring • Fix the AI flags before the AI flags you.
            </p>
            <button onclick="showProUpsell()" style="background: white; color: #00a8e8; border: 1px solid #00a8e8; border-radius: 8px; padding: 12px 24px; font-size: 14px; font-weight: 700; cursor: pointer; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); transition: transform 0.2s; margin-bottom: 8px; width: 100%;">
              💎 Go Pro - $9.99/mo
            </button>
          </div>
          
          <!-- Stripe payment text below blue banner -->
          <p id="proStripeText" style="display: none; text-align: center; color: #6b7280; font-size: 12px; margin: 8px 0 0 0;">
            Secure payment by <span style="font-weight: 700; color: #635bff;">Stripe</span>
          </p>
          
          <!-- Trusted by students section - PRO PAGE STEP 2 ONLY -->
          <div id="step2TrustedSection" style="display: none; text-align: center; margin: 0 0 16px 0;">
            <p style="color: #374151; font-size: 14px; font-weight: 600; margin: 0 0 2px 0; line-height: 1.4; display: flex; align-items: center; justify-content: center; gap: 8px;">
              <img src="https://i.postimg.cc/JhsvMWLJ/Lil-Sus-Trans-Bg.png" alt="Lil Sus" style="width: 80px; height: auto; display: inline-block; vertical-align: middle; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">
              Trusted by 10,000+ students who fixed their false flags
            </p>
            <p style="color: #6b7280; font-size: 13px; font-weight: 400; margin: 0 0 6px 0; line-height: 1.4;">
              and turned it in with confidence.
            </p>
          </div>
          
          <!-- Return to Dashboard link - MOVED BELOW STRIPE TEXT FOR CLEAN - NO SUS -->
          <div style="text-align: center; margin-top: 16px;">
            <button id="step2BackToDashboard" class="btn-outline" onclick="hideQuickFixFlow()" style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px 24px; font-size: 14px; font-weight: 600; color: #374151; cursor: pointer; text-transform: uppercase; width: 100%; display: none;">
              🏠 Back To Main Dashboard
            </button>
            <button id="step2BackToProDashboard" class="btn-outline" onclick="backToProDashboard()" style="background: white; border: 1px solid #00a8e8; border-radius: 8px; padding: 12px 24px; font-size: 14px; font-weight: 600; color: #00a8e8; cursor: pointer; text-transform: uppercase; width: 100%; display: none; margin-top: 18px;">
              💎 BACK TO PRO DASHBOARD
            </button>
          </div>
          
        </div>
      </div>
      
      <!-- STEP 3: Rewrite Results (After Fix) -->
      <div id="quickfixStep3" class="quickfix-step">
        <!-- Your Scan Results Title Section - MOVED TO TOP -->
        <div style="text-align: center; margin: -24px 0 24px 0;">
          <h3 style="font-size: 24px; font-weight: 700; color: #374151; margin: 0 0 8px 0; text-align: center; text-transform: uppercase; letter-spacing: 0.5px;">Your Scan Results</h3>
          <p id="quickfixScanResultsSubtitle" style="font-size: 14px; font-weight: 400; color: #6b7280; margin: 0; text-align: center; line-height: 1.4;">Here's your new score after fixing those flags</p>
        </div>
        
        <!-- Header Wrapper with Score and Emoji Inside -->
        <div id="quickfixStep3HeaderWrapper" style="background: white; border-radius: 12px; padding: 12px 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin: 20px 0; border-left: 8px solid #2ecc71; border-right: 8px solid #2ecc71;">
          <div class="score-display" style="display: flex; flex-direction: column; align-items: center; gap: 2px; text-align: center;">
            <span id="resultsEmoji" style="font-size:36px;">✅</span>
            <span class="score-number" id="quickfixNewScore">0%</span>
            <span class="score-label" id="quickfixNewScoreLabel">NEW SUS SCORE</span>
          </div>
        </div>
        
        <!-- Dynamic message banner - MOVED BETWEEN SCORE AND PROGRESS BAR -->
        <div id="dynamicMessageBanner" style="text-align: center; margin: 20px 0; padding: 15px; background: #2ecc71; border-radius: 12px; border-left: 4px solid #059669;">
          <p id="dynamicMessage" style="margin: 0; font-size: 18px; font-weight: 700; color: #ffffff;">
            <!-- Will be updated dynamically based on score -->
          </p>
        </div>
        
        <!-- Progress Bar -->
        <div style="text-align:center; margin:30px 0;">
          <div class="progress-container">
            <div class="progress-bar" id="quickfixNewProgressBar" style="height: 8px; background: transparent; border-radius: 4px; position: relative; overflow: hidden; border: 1px solid #ccc;">
              <div class="progress-fill" id="quickfixNewProgressFill"></div>
              <div class="progress-indicator" id="quickfixNewProgressIndicator"></div>
            </div>
            <div class="progress-endpoints">
              <span>0%</span>
              <span>100%</span>
            </div>
            <div class="progress-labels">
              <span>✅ Clean - No Sus</span>
              <span>⚠️ Kinda Sus</span>
              <span>🚨 Hella Sus</span>
            </div>
          </div>
          
          <!-- Header and Subtitle Below Progress Bar -->
          <div class="lil-sus-header" style="margin-top: 30px;">
            <h2 id="resultsHeader" style="font-size: 18px;">Oof, this is way too sus for your prof 😬</h2>
            <p id="resultsSubtitle">Let's make this 100% false flag free before turning in</p>
          </div>
        </div>
        
        <!-- FIX 11: Side-by-side comparison with tooltip -->
        <div style="text-align:center; margin-bottom:15px; padding-bottom: 24px;">
          <p style="color:#6b7280; font-size:14px; font-style:italic;">
            💡 Wanna see what got fixed? Here's your before & after. 🔍
          </p>
        </div>
        
        <div class="quickfix-comparison">
          <div style="text-align: center; margin-bottom: 8px;">
            <p id="beforeQuickFixScore" style="margin: 0; font-size: 18px; font-weight: 700; color: #dc2626;">Before QuickFix</p>
          </div>
          <div class="comparison-box original-box">
            <div class="box-header original-header">
              <span style="margin-right:8px;">🔴</span> Original (With Flags)
            </div>
            <div class="box-content" id="comparisonOriginal">
              <!-- Original text with red highlights -->
            </div>
          </div>
          
          <div style="text-align: center; margin-bottom: 8px; margin-top: 20px;">
            <p id="afterQuickFixScore" style="margin: 0; font-size: 18px; font-weight: 700; color: #2ecc71;">After QuickFix</p>
          </div>
          <div class="comparison-box fixed-box">
            <div class="box-header fixed-header">
              Pro-Fixed Version
            </div>
            <div class="box-content" id="comparisonFixed">
              <!-- Fixed text with green highlights -->
            </div>
          </div>
          
          <!-- FIX 8: Enhanced success message - MOVED BELOW GREEN BOX -->
          <p id="resultsMessage" style="color:#2ecc71; margin-top:24px; font-size:20px; font-weight:600; text-align: center;">
            That's a solid <strong id="improvementPercent">0%</strong> glow-up! ✨<br>Your essay is looking clean and ready to turn in.
          </p>
        </div>
        
        <!-- NEW: Dynamic CTA Section Based on Score -->
        <div id="quickfixBottomCTA" class="quickfix-bottom-cta">
          <!-- Content will be dynamically generated based on score -->
        </div>
        
        <!-- Back to Dashboard / Pro Dashboard buttons - SWITCHED ORDER -->
        <div style="text-align: center; margin-top: 20px;">
          <button id="step3BackToProDashboard" class="btn-outline" onclick="backToProDashboard()" style="background: white; border: 1px solid #00a8e8; border-radius: 8px; padding: 12px 24px; font-size: 14px; font-weight: 600; color: #00a8e8; cursor: pointer; text-transform: uppercase; width: 100%; display: none;">
            💎 Paste & Scan Another Essay
          </button>
          <button id="step3EditFixes" class="btn-outline" onclick="editProFixes()" style="background: white; border: 1px solid #f5a623; border-radius: 8px; padding: 12px 24px; font-size: 14px; font-weight: 600; color: #f5a623; cursor: pointer; text-transform: uppercase; width: 100%; display: none; margin-top: 12px;">
            ✏️ Get More Fix Suggestions
          </button>
          <button id="step3ViewPastFixes" class="btn-outline" onclick="showProPastFixes()" style="background: white; border: 1px solid #2ecc71; border-radius: 8px; padding: 12px 24px; font-size: 14px; font-weight: 600; color: #2ecc71; cursor: pointer; text-transform: uppercase; width: 100%; display: none; margin-top: 12px;">
            📊 View Past Fixes
          </button>
          <button id="step3BackToDashboard" class="btn-outline" onclick="hideQuickFixFlow()" style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px 24px; font-size: 14px; font-weight: 600; color: #374151; cursor: pointer; text-transform: uppercase; width: 100%; display: none; margin-top: 12px;">
            🏠 Back To Main Dashboard
          </button>
        </div>
        
        <!-- Pro Banner for Step 3 (Summary Page) - Positioned at bottom -->
        <div id="quickfixStep3ProBanner" style="display: none; background: linear-gradient(135deg, #00d4ff 0%, #00a8e8 100%); border-radius: 16px; padding: 20px 16px; margin: 48px 0 0 0; text-align: center; box-shadow: 0 4px 12px rgba(0, 168, 232, 0.2);">
          <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 12px;">
            <span style="font-size: 24px;">🚀</span>
            <h3 style="color: white; font-size: 20px; font-weight: 700; margin: 0;">Go Pro and chill...</h3>
          </div>
          <p id="step3ProBenefitsText" style="text-align: center; color: white; font-size: 14px; margin: 0 0 16px 0; line-height: 1.6; opacity: 0.95;">
            🚨 Don't Risk It. Fix It. Get 500 scans/mo • Deeper Fixes • Real-Time Scoring • Fix the AI flags before the AI flags you.
          </p>
          <button onclick="showProUpsell()" style="background: white; color: #00a8e8; border: 1px solid #00a8e8; border-radius: 8px; padding: 12px 24px; font-size: 14px; font-weight: 700; cursor: pointer; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); transition: transform 0.2s; margin-bottom: 8px; width: 100%;">
            → Get Pro - $9.99/mo
          </button>
          <div style="text-align: center; color: white; font-size: 10px; opacity: 0.9;">
            Cancel Anytime
          </div>
        </div>
        
        </div>
        
      <!-- STEP 4: Pro-Level Scan Results - Found ALL Flags! -->
      <div id="quickfixStep4" class="quickfix-step">
        <div class="container">
          <!-- Pro Member Exclusive Badge -->
          <div style="text-align: center; margin-bottom: 20px;">
            <div style="display: inline-block; background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%); color: white; padding: 8px 20px; border-radius: 20px; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 4px 12px rgba(20, 184, 166, 0.3);">
              ✨ Pro Member Exclusive
            </div>
          </div>
          
          <!-- Hero Header -->
          <div class="hero-header">
            <div id="rotatingMessage" class="rotating-message">💎 Premium Results - Every Flag Found & Fixed ✨</div>
            <p id="step4HeroText">Pro found 3 flags. Pro scan found 12 more! All AI-trigger words now fixed.<br>Ready to TURN IT IN.</p>
          </div>

          <!-- Big Score Display -->
          <div id="bigScoreDisplay" style="
            background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%);
            border: 3px solid #14b8a6;
            border-radius: 20px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
            box-shadow: 0 8px 25px rgba(20, 184, 166, 0.3);
            position: relative;
            overflow: hidden;
          ">
            
            <div style="font-size: 48px; margin-bottom: 15px;">🎉</div>
            <h2 style="color: #0b0646; margin-bottom: 20px; font-size: 28px; font-weight: 700;">
              Pro Scan Complete!
            </h2>
            <div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 15px;">
              <div style="text-align: center;">
                <div style="font-size: 36px; font-weight: 700; color: #dc2626;" id="bigScoreBefore">78%</div>
                <div style="font-size: 14px; color: #6b7280; font-weight: 600;">BEFORE</div>
              </div>
              <div style="font-size: 24px; color: #14b8a6;">→</div>
              <div style="text-align: center;">
                <div style="font-size: 36px; font-weight: 700; color: #14b8a6;" id="bigScoreAfter">12%</div>
                <div style="font-size: 14px; color: #6b7280; font-weight: 600;">AFTER</div>
              </div>
            </div>
            <div style="font-size: 18px; color: #0b0646; font-weight: 600;" id="bigScoreImprovement">
              🚀 66% Score Drop!
            </div>
          </div>

          <!-- Comparison Stats -->
          <div class="stats-grid">
            <div class="stat-card blue">
              <span class="stat-number" id="proFlags">0</span>
              <span class="stat-label">Pro Flags Found</span>
            </div>
            <div class="stat-card green">
              <span class="stat-number" id="quickfixFlags">3</span>
              <span class="stat-label">Flags Fixed</span>
            </div>
            <div class="stat-card orange">
              <span class="stat-number" id="scoreDrop">58%</span>
              <span class="stat-label">SUS Score Drop</span>
            </div>
            <div class="stat-card red">
              <span class="stat-number">0</span>
              <span class="stat-label">Red Flags Left</span>
            </div>
          </div>

          <!-- Pro-Level Detection Explanation -->
          <div style="background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%); border-radius: 12px; padding: 20px; margin: 20px 0; text-align: center; border-left: 4px solid #14b8a6; border-right: 4px solid #14b8a6; box-shadow: 0 4px 12px rgba(20, 184, 166, 0.15);">
            <h3 style="color: #0f766e; margin: 0 0 12px; font-size: 18px; font-weight: 700;">💎 Premium Detection - This is What You Get</h3>
            <p style="color: #134e4a; margin: 0; font-size: 14px; line-height: 1.5; font-weight: 500;">
              Comprehensive flag detection that finds every single AI-trigger word. 
              <span id="step4ProText">Pro found all AI-trigger words in your essay and fixed them all!</span>
            </p>
          </div>

          <!-- Score Transformation -->
          <div class="score-transformation">
            <div class="score-comparison">
              <span class="score-badge score-before">Was: <span id="scoreBefore">75%</span> <span id="scoreBeforeLabel">Hella Sus</span> 🚩</span>
              <span class="score-arrow">→</span>
              <span class="score-badge score-after">Now: <span id="scoreAfter">17%</span> <span id="scoreAfterLabel">Clean - No Sus</span> ✅</span>
            </div>
            
            <div class="sus-meter">
              <div class="meter-labels">
                <span>✅ Clean - No Sus</span>
                <span>⚠️ Kinda Sus</span>
                <span>🚨 Hella Sus</span>
              </div>
              <div class="meter-bar">
                <div class="meter-fill" id="meterFill" style="width: 17%;">
                  <span>17%</span>
                </div>
              </div>
              <p class="meter-message">✅ Ready to Turn In</p>
            </div>

            <!-- Stats Banner -->
            <div class="stats-banner">
              <div class="stat-item">
                <span class="stat-value" id="flagsFixedCount">3</span>
                <span class="stat-text">Flags Fixed</span>
              </div>
              <div class="stat-item">
                <span class="stat-value" id="scoreImprovement">58%</span>
                <span class="stat-text">Score Dropped</span>
              </div>
              <div class="stat-item">
                <span class="stat-value" id="aiTriggerFreeScore">100%</span>
                <span class="stat-text">AI Trigger Free</span>
              </div>
            </div>
          </div>

          <!-- Essay Viewer with Toggle -->
          <div class="essay-viewer">
            <div class="viewer-header" style="justify-content: center; align-items: center; flex-direction: column;">
              <h2 class="viewer-title">Before → After</h2>
              <div style="display: flex; gap: 16px; justify-content: center;">
                <button class="toggle-btn" onclick="showVersion('original')">❌ Original</button>
                <button class="toggle-btn active" onclick="showVersion('rewrite')">✅ My Pro-Fixed Essay</button>
                <button class="toggle-btn" onclick="showVersion('diff')">🔍 Show Fixes</button>
              </div>
            </div>
            
            <div class="essay-display">
              <!-- Original Essay -->
              <div class="essay-content" id="originalEssay">
                <p>The cutting-edge technology landscape demonstrates unprecedented levels of innovation. Furthermore, organizations must leverage their resources to achieve significant competitive advantages in the marketplace. Thus, it is important to note that comprehensive analysis reveals multifaceted approaches to problem-solving.</p>
                <p>Moreover, the data suggests that various industries are experiencing considerable transformation. Consequently, stakeholders must utilize state-of-the-art methodologies to navigate these changes effectively.</p>
              </div>

              <!-- Pro-Fixed Essay -->
              <div class="essay-content active" id="rewriteEssay">
                <p>Modern tech shows incredible innovation. Companies need to use their resources smartly to stay ahead. A closer look shows there are many ways to solve problems.</p>
                <p>Also, evidence shows that different industries are changing fast. Decision-makers should use modern methods to handle these shifts well.</p>
              </div>

              <!-- Diff View -->
              <div class="essay-content" id="diffEssay">
                <p>The <span class="flag-removed">cutting-edge</span> <span class="flag-fixed">modern</span> <span class="flag-removed">technology</span> <span class="flag-fixed">tech</span> landscape <span class="flag-removed">demonstrates unprecedented levels</span> <span class="flag-fixed">shows incredible</span> of innovation. <span class="flag-removed">Furthermore</span> <span class="flag-fixed">Also</span>, organizations must <span class="flag-removed">leverage</span> <span class="flag-fixed">use</span> their resources to achieve <span class="flag-removed">significant</span> competitive advantages in the marketplace.</p>
                <p><span class="flag-removed">Moreover</span> <span class="flag-fixed">Also</span>, the data suggests that <span class="flag-removed">various</span> <span class="flag-fixed">different</span> industries are experiencing <span class="flag-removed">considerable</span> <span class="flag-fixed">big</span> transformation.</p>
              </div>
            </div>
          </div>

          <!-- Primary Action Buttons -->
          <div class="action-buttons">
            <button class="btn btn-success" onclick="copyFullDeFlag()" style="background: #14b8a6 !important; border-color: #14b8a6 !important; color: white !important; box-shadow: 0 4px 12px rgba(20, 184, 166, 0.3) !important;">
              📋 Copy My Fixed Essay
            </button>
            <button class="btn btn-primary" onclick="downloadDocx()" style="background: #14b8a6 !important; border-color: #14b8a6 !important; color: white !important; box-shadow: 0 4px 12px rgba(20, 184, 166, 0.3) !important;">
              ⬇️ Download as .docx
            </button>
            <button class="btn btn-warning" onclick="openStep4FlagsModal()" style="background: #14b8a6 !important; border-color: #14b8a6 !important; color: white !important; box-shadow: 0 4px 12px rgba(20, 184, 166, 0.3) !important;">
              🚩 See All <span id="flagCount">12</span> Fixes
            </button>
          </div>

          <!-- Ethical Disclaimer -->
          <div style="text-align: center; margin-top: 20px; padding: 10px;">
            <p style="font-size: 11px; color: #9ca3af; line-height: 1.4; margin: 0;">
              This tool helps protect legitimate work from false AI detection. 
              Use responsibly and ensure your work meets your institution's academic integrity policies.
            </p>
          </div>

          <!-- Footer -->
          <div class="lil-sus-footer" style="background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%); border: 2px solid #14b8a6; border-radius: 16px; padding: 30px; margin: 30px 0; box-shadow: 0 8px 25px rgba(20, 184, 166, 0.2);">
            <div class="footer-icon" style="font-size: 32px; margin-bottom: 15px;">💎✨🔥</div>
            <h4 class="footer-title" style="color: #0f766e; font-size: 24px; font-weight: 700; margin-bottom: 12px;">You've Earned This! 🎯</h4>
            <p class="footer-text" style="color: #134e4a; font-size: 16px; font-weight: 600; margin: 8px 0;">AI-proof. Professor-ready. Turn-in approved.</p>
            <p class="footer-text" style="color: #134e4a; font-size: 15px; margin: 8px 0;">Your essay is polished and perfect. Time to shine! ✨</p>
            <p class="footer-cta" style="color: #14b8a6; font-size: 20px; font-weight: 800; margin-top: 20px; text-transform: uppercase; letter-spacing: 1px;">Go ahead — TURN 👏 IT 👏 IN 👏</p>
          </div>
          
          <!-- Return To Dashboard Link -->
          <div style="text-align: center; margin-top: 30px; padding: 20px;">
            <button id="step4BackToDashboard" class="btn-outline" onclick="hideQuickFixFlow()" style="padding: 15px 30px; font-size: 16px; display: none;">
              🏠 Back To Main Dashboard
            </button>
            <button id="step4BackToProDashboard" class="btn-outline" onclick="backToProDashboard()" style="padding: 15px 30px; font-size: 16px; background: white !important; border: 2px solid #14b8a6 !important; color: #14b8a6 !important; border-radius: 8px; font-weight: 600; cursor: pointer; display: none; box-shadow: 0 4px 12px rgba(20, 184, 166, 0.2) !important;">
              💎 BACK TO PRO DASHBOARD
            </button>
          </div>
          
          <!-- Disclaimer -->
          <div style="text-align: center; margin-top: 20px; padding: 10px;">
            <p style="font-size: 11px; color: #9ca3af; line-height: 1.4; margin: 0;">
              This AI tool assists with writing improvement but cannot guarantee academic outcomes. Users are responsible for ensuring their work meets institutional standards and policies.
            </p>
          </div>
        </div>

        <!-- Flags Modal -->
        <div class="modal" id="step4FlagsModal">
          <div class="modal-content">
            <div class="modal-header">
              <button class="modal-close" onclick="closeStep4FlagsModal()" onmouseover="this.style.color='#dc2626'; this.style.background='#fee2e2';" onmouseout="this.style.color='#999'; this.style.background='none';">×</button>
              <h3 style="font-size: 1.5em; margin-bottom: 8px;">🔥 I Found & Fixed <span id="modalFlagCount">12</span> AI Triggers</h3>
            </div>
            
            <div class="modal-body" id="step4FlagsList">
              <!-- Flags will be inserted here -->
            </div>
            
            <div class="modal-footer">
              <button class="btn btn-primary" style="flex: 1; background: #14b8a6; border-color: #14b8a6; color: white; box-shadow: 0 4px 12px rgba(20, 184, 166, 0.3);" onclick="copyStep4FlagsList()">📋 Copy This List</button>
              <button class="btn btn-success" style="flex: 1; background: #14b8a6; border-color: #14b8a6; color: white; box-shadow: 0 4px 12px rgba(20, 184, 166, 0.3);" onclick="closeStep4FlagsModal()">Got It ✅</button>
            </div>
          </div>
        </div>

        <!-- Success Toast -->
        <div class="success-toast" id="step4SuccessToast">
          ✅ Copied to clipboard!
        </div>
      </div>
    </div>
  </div>
</div>
<!-- STEP 6: Pro Dashboard - COMPLETELY REDESIGNED -->
<div id="quickfixStep6" class="quickfix-step">
  <style>
    #quickfixStep6 * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    #quickfixStep6 {
      background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
      min-height: 100vh;
      padding: 40px 20px;
    }

    #quickfixStep6 .container {
      max-width: 900px;
      margin: 0 auto;
    }

    #quickfixStep6 .modal-card {
      background: white;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    #quickfixStep6 .header-banner {
      background: linear-gradient(135deg, #00d9ff 0%, #00a8e8 100%);
      height: 200px;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #quickfixStep6 .header-banner::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 200"><defs><pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse"><path d="M 40 0 L 0 0 0 40" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="1200" height="200" fill="url(%23grid)"/></svg>');
      opacity: 0.3;
    }

    #quickfixStep6 .header-content {
      position: relative;
      z-index: 2;
      text-align: center;
      color: white;
    }

    #quickfixStep6 .header-title {
      font-size: 32px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    #quickfixStep6 .header-subtitle {
      font-size: 14px;
      opacity: 0.95;
      margin-top: 6px;
      text-align: center !important;
      width: 100%;
    }

    #quickfixStep6 .gauge-widget {
      position: absolute;
      top: 16px;
      left: 16px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      padding: 12px;
      width: 100px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    #quickfixStep6 .mini-ring {
      width: 70px;
      height: 70px;
      position: relative;
      margin: 0 auto 8px;
    }

    #quickfixStep6 .mini-ring svg {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
    }

    #quickfixStep6 .ring-bg {
      fill: none;
      stroke: #e8e8e8;
      stroke-width: 4;
    }

    #quickfixStep6 .ring-prog {
      fill: none;
      stroke: #00a8e8;
      stroke-width: 4;
      stroke-linecap: round;
      stroke-dasharray: 188;
      stroke-dashoffset: 169;
      animation: fillRing 2s ease-out forwards;
    }

    @keyframes fillRing {
      from {
        stroke-dashoffset: 188;
      }
      to {
        stroke-dashoffset: 169;
      }
    }

    #quickfixStep6 .ring-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }

    #quickfixStep6 .ring-num {
      font-size: 18px;
      font-weight: 700;
      color: #00a8e8;
    }

    #quickfixStep6 .ring-lbl {
      font-size: 9px;
      color: #999;
      font-weight: 600;
      text-transform: uppercase;
    }

    #quickfixStep6 .gauge-text {
      text-align: center;
      font-size: 11px;
      color: #666;
      font-weight: 600;
    }

    #quickfixStep6 .content-section {
      padding: 40px;
      text-align: center;
    }

    #quickfixStep6 .status-badge {
      display: inline-block;
      background: #e8f5f9;
      color: #00a8e8;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
    }

    #quickfixStep6 .status-title {
      font-size: 24px;
      font-weight: 700;
      color: #333;
      margin-bottom: 8px;
    }

    #quickfixStep6 .status-subtitle {
      font-size: 14px;
      color: #666;
      margin-bottom: 32px;
    }

    #quickfixStep6 .input-section {
      margin-bottom: 24px;
    }

    #quickfixStep6 .textarea {
      width: 100%;
      min-height: 180px;
      padding: 16px;
      border: 2px solid #e8e8e8;
      border-radius: 12px;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
      transition: all 0.2s;
    }

    #quickfixStep6 .textarea:focus {
      outline: none;
      border-color: #00a8e8;
      box-shadow: 0 0 0 3px rgba(0, 168, 232, 0.1);
    }

    #quickfixStep6 .char-count {
      text-align: right;
      font-size: 12px;
      color: #999;
      margin-top: 8px;
      margin-bottom: 20px;
    }

    #quickfixStep6 .scan-button {
      width: 100%;
      background: linear-gradient(135deg, #00d9ff 0%, #00a8e8 100%);
      color: white;
      border: none;
      padding: 16px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 24px;
      box-shadow: 0 8px 20px rgba(0, 168, 232, 0.3);
    }

    #quickfixStep6 .scan-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 12px 30px rgba(0, 168, 232, 0.4);
    }

    #quickfixStep6 .scan-button:active:not(:disabled) {
      transform: translateY(0);
    }

    #quickfixStep6 .scan-button:disabled {
      background: #9ca3af !important;
      cursor: not-allowed;
      opacity: 0.6;
    }

    #quickfixStep6 .footer-buttons {
      display: flex;
      gap: 12px;
    }

    #quickfixStep6 .footer-btn {
      flex: 1;
      padding: 12px;
      border: 2px solid #e8e8e8;
      background: white;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      color: #333;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    #quickfixStep6 .footer-btn:hover {
      border-color: #00a8e8;
      color: #00a8e8;
      background: #f9f9f9;
    }

    @media (max-width: 600px) {
      #quickfixStep6 .content-section {
        padding: 24px;
      }

      #quickfixStep6 .header-banner {
        height: 140px;
      }

      #quickfixStep6 .header-title {
        font-size: 22px;
      }

      #quickfixStep6 .gauge-widget {
        width: 90px;
      }

      #quickfixStep6 .mini-ring {
        width: 60px;
        height: 60px;
      }

      #quickfixStep6 .footer-buttons {
        flex-direction: column;
      }

      #quickfixStep6 .status-title {
        font-size: 20px;
      }
    }
    
    #quickfixStep6 .hero-subtitle {
      text-align: center !important;
      margin-left: auto !important;
      margin-right: auto !important;
      width: 100% !important;
      display: block !important;
      position: relative !important;
      left: 0 !important;
      right: 0 !important;
      transform: translateX(0) !important;
      box-sizing: border-box !important;
    }
  </style>

  <div class="hero-section">
    <h1 class="hero-title">False Flag Fixer™ <span class="red-flag-large">💎</span> Pro</h1>
    <p class="hero-subtitle" style="text-align: center !important; padding-top: 0.25in; padding-bottom: 0.5in; margin: 0 auto !important; width: 100%; display: block; box-sizing: border-box; align-self: center;">
      Get 500 scans/mo • Deeper Fixes • Real-Time Scoring<br>Fix the AI flags before the AI flags you.
    </p>
  </div>

  <div class="container">
    <div class="modal-card">
      <div class="header-banner">
        <div class="gauge-widget">
          <div class="mini-ring">
            <svg viewBox="0 0 70 70">
              <circle class="ring-bg" cx="35" cy="35" r="30"></circle>
              <circle class="ring-prog" id="proRingProgress" cx="35" cy="35" r="30"></circle>
            </svg>
            <div class="ring-center">
              <div class="ring-num" id="proRingNumber">5</div>
              <div class="ring-lbl">Used</div>
            </div>
          </div>
          <div class="gauge-text">5/500</div>
        </div>
        <div class="header-content" style="text-align: center !important;">
          <div class="status-badge" style="display: inline-block; background: white; color: #00a8e8; padding: 6px 12px; border-radius: 16px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; border: 2px solid #00a8e8;">💎 Pro Member</div>
          <div class="header-title" style="font-size: 28px; font-weight: 700; margin-bottom: 8px; text-align: center !important;">False Flag Fixer Pro</div>
          <div class="header-subtitle" style="font-size: 14px; opacity: 0.95; text-align: center !important;">Get the tea on every trigger • Turn it in like a boss</div>
        </div>
      </div>

      <div class="content-section">
        
        <!-- Reminder Banner for 5000 Character Limit -->
        <div id="proCharacterReminder" style="background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); border: 2px solid #00a8e8; border-radius: 12px; padding: 16px 20px; margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="font-size: 24px;">💡</div>
            <div style="flex: 1;">
              <p style="color: #0b0646; font-size: 15px; font-weight: 600; margin: 0 0 4px 0;">Pro Tip: You can paste up to 5,000 characters!</p>
              <p style="color: #006064; font-size: 13px; margin: 0; line-height: 1.4;">Scan full assignments, reports, and longer essays — no more character limits holding you back.</p>
            </div>
            <button onclick="document.getElementById('proCharacterReminder').style.display='none'; sessionStorage.setItem('proReminderDismissed', 'true');" style="background: none; border: none; font-size: 20px; color: #006064; cursor: pointer; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; opacity: 0.7;" onmouseover="this.style.opacity='1';" onmouseout="this.style.opacity='0.7';">×</button>
          </div>
        </div>

        <div class="input-section">
          <textarea id="proScanInput" class="textarea" placeholder="Paste your essay here (up to 5,000 characters)..." maxlength="5000"></textarea>
          <div class="char-count" id="proCharCount">0 / 5,000 characters</div>
        </div>

        <button id="proScanButton" class="scan-button" onclick="startProScan()" disabled>🚀 Start Pro Scan</button>

        <div class="footer-buttons">
          <button class="footer-btn" onclick="showManageSubscription()">⚙️ Manage My Subscription</button>
          <button class="footer-btn" onclick="hideProDashboard()">🏠 Back To Main Dashboard</button>
        </div>
      </div>

      <!-- Pro Results Display Area (hidden initially) -->
      <div id="proResultsArea" style="display: none;">
        <!-- Results will be dynamically inserted here -->
      </div>
    </div>
  </div>
</div>

<!-- Manage Subscription Page -->
<div id="manageSubscriptionPage" style="display:none;position:relative;min-height:100vh;background:linear-gradient(135deg, #0b0646 0%, #1a1f6e 100%);padding:40px 20px;">
  <div class="container" style="max-width:1200px;margin:0 auto;padding:30px;position:relative;background:#fff;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.2);">
    
    <!-- Header -->
    <div style="margin-bottom:30px;padding-top:10px;">
      <div style="text-align:center;">
        <h1 style="color:#0b0646;font-size:2em;margin-bottom:10px;">Manage Your Subscription</h1>
        <p style="color:#6b7280;">Manage your Pro subscription and billing</p>
      </div>
    </div>

    <!-- Combined Grid Layout -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:24px;align-items:stretch;margin-bottom:10px;">
      
      <!-- Current Subscription Status -->
      <div style="background:#f8f9fa;border-radius:16px;padding:25px;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
        <h3 style="color:#0b0646;margin-bottom:20px;font-size:1.2em;font-weight:700;">Current Subscription</h3>
        <div style="display:flex;flex-direction:column;gap:15px;">
          <div>
            <p style="color:#6b7280;font-size:13px;margin-bottom:5px;">Plan</p>
            <p style="color:#0b0646;font-size:18px;font-weight:600;" id="subPlan">Pro - $9.99/month</p>
          </div>
          <div>
            <p style="color:#6b7280;font-size:13px;margin-bottom:5px;">Status</p>
            <p style="color:#00a8e8;font-size:18px;font-weight:600;" id="subStatus">Active</p>
          </div>
          <div>
            <p style="color:#6b7280;font-size:13px;margin-bottom:5px;">Next Billing Date</p>
            <p style="color:#0b0646;font-size:18px;font-weight:600;" id="subNextBilling">Dec 15, 2024</p>
          </div>
        </div>
      </div>

      <!-- Billing History -->
      <div style="background:#f8f9fa;border-radius:16px;padding:25px;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
        <h3 style="color:#0b0646;margin-bottom:20px;font-size:1.2em;font-weight:700;">Billing History</h3>
        <div id="billingHistoryList">
          <!-- Billing history will be dynamically inserted here -->
          <div style="padding:15px;background:#fff;border-radius:8px;margin-bottom:10px;border:1px solid #e5e7eb;">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:16px;">
              <div>
                <p style="color:#0b0646;font-weight:600;margin-bottom:5px;">Nov 15, 2024</p>
                <p style="color:#6b7280;font-size:13px;">Pro Subscription</p>
              </div>
              <div style="text-align:right;">
                <p style="color:#0b0646;font-weight:600;margin:0;">$9.99</p>
              </div>
            </div>
          </div>
          <button class="btn-outline" style="padding:6px 12px;font-size:12px;min-width:auto;line-height:1.2;margin-top:5px;align-self:flex-start;">Download</button>
        </div>
      </div>

      <!-- Usage Stats -->
      <div style="background:#f8f9fa;border-radius:16px;padding:25px;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
        <h3 style="color:#0b0646;margin-bottom:20px;font-size:1.2em;font-weight:700;">Usage This Month</h3>
        <div style="margin-bottom:15px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
            <span style="color:#6b7280;">Scans Used</span>
            <span style="color:#0b0646;font-weight:600;" id="subScansUsed">45/500</span>
          </div>
          <div style="background:#e5e7eb;border-radius:8px;height:12px;overflow:hidden;">
            <div id="subUsageBar" style="background:#2ecc71;height:100%;width:9%;transition:width 0.3s;"></div>
          </div>
        </div>
        <p style="color:#6b7280;font-size:13px;margin-top:10px;">Resets on <span id="subResetDate">Dec 1, 2024</span></p>
      </div>

      <!-- Billing Information -->
      <div style="background:#f8f9fa;border-radius:16px;padding:25px;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
        <h3 style="color:#0b0646;margin-bottom:20px;font-size:1.2em;font-weight:700;">Billing Information</h3>
        <div>
          <p style="color:#6b7280;font-size:13px;margin-bottom:5px;">Payment Method</p>
          <p style="color:#0b0646;font-size:16px;font-weight:600;margin-bottom:15px;" id="subPaymentMethod">•••• •••• •••• 4242</p>
          <button onclick="showUpdatePaymentModal()" class="btn-outline" style="padding:10px 20px;width:100%;">
            Update Payment Method
          </button>
        </div>
      </div>

      <!-- Subscription Actions -->
      <div style="background:#f8f9fa;border-radius:16px;padding:25px;box-shadow:0 2px 8px rgba(0,0,0,0.05);grid-column:1 / -1;">
        <h3 style="color:#0b0646;margin-bottom:20px;font-size:1.2em;font-weight:700;text-align:center;">Subscription Actions</h3>
        <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center;">
          <button onclick="showCancelSubscriptionModal()" class="btn-outline" style="padding:12px 24px;color:#dc2626;border-color:#dc2626;min-width:220px;">
            Cancel Subscription
          </button>
          <button onclick="showManageSubscription()" class="btn-outline" style="padding:12px 24px;min-width:220px;">
            Contact Support
          </button>
          <button onclick="hideManageSubscription()" class="btn-outline" style="padding:12px 24px;min-width:220px;">
            💎 Back To Pro Dashboard
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Main Input Section -->
<div id="inputSection" style="display:block;">
  <div class="hero-section">
    <h1 class="hero-title"><span class="red-flag-large">🚩</span> False Flag Fixer™</h1>
    <p class="hero-subtitle" style="padding-bottom: 48px;">
      Clock the AI triggers before your prof does.<br>See what detectors flag in your essay and fix it before you turn it in. False flags, fixed ✅
    </p>
  </div>

  <div class="main-container">
    <div class="input-section" id="upload-section">
      <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
        <div style="font-size:2.5em; margin-bottom:10px;">📄</div>
        <h3 style="margin:0 0 10px; color:#0b0646; font-size:1.2em;">
          <span class="red-flag-large">🚩</span>Drag & Drop Your Essay Here
        </h3>
        <p style="margin:0; color:#6b7280; font-size:0.9em; font-weight:400;">Or upload/paste your text • Click to browse files • Check your work for false flags</p>
      </div>

      <!-- Hidden file input for click-to-upload -->
      <input type="file" id="fileInput" style="display: none;" accept=".txt,.doc,.docx,.rtf,.html,.pdf" onchange="handleFileSelect(event)">

      <textarea id="essayInput" placeholder="Paste your essay content here (minimum 50 characters)..." maxlength="5000"></textarea>
      
      <!-- Authorship Confirmation Checkbox -->
      <div id="authorshipSection" style="margin: 20px 0; padding: 15px; background: #fef2f2; border: 2px solid #fecaca; border-radius: 8px;">
        <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer; font-size: 14px; line-height: 1.4;">
          <input type="checkbox" id="authorshipCheckbox" required style="margin-top: 2px; transform: scale(1.2);">
          <span style="color: #dc2626; font-weight: 600;">
            Hey, you wrote this yourself, right?
            <br>
            <small style="color: #7f1d1d; font-weight: 400; font-size: 12px; margin-top: 4px; display: block;">
              By checking this, you're confirming it's your original work and you're owning it.
            </small>
          </span>
        </label>
      </div>
      
      <div class="char-counter"><span id="charCount">0</span> / 5,000 characters</div>
      <div class="scans-left" id="scansLeft">3 free scans remaining today</div>
      
      <div class="button-group" style="display: flex !important; gap: 16px !important; margin-top: 20px; justify-content: center !important; flex-wrap: nowrap !important;">
        <button id="scanButton" class="btn-primary"
                >🔍 Free Scan (<span id="scanCounter">1/3</span>)</button>
        <button id="emergencyButton" class="btn-secondary" onclick="startQuickFixFlow()"
                data-tooltip="Find ALL AI-trigger words and fix them - $1.99. Scan up to 5000 characters."><span style="color: #ffeb3b !important; display: inline-block; text-shadow: -2px -2px 0px #666, 2px -2px 0px #666, -2px 2px 0px #666, 2px 2px 0px #666, 0 0 15px #ffeb3b, 0 0 25px #ffeb3b, 0 0 35px #ffeb3b; filter: brightness(1.5) saturate(2) !important; font-weight: bold; -webkit-text-stroke: 1px #666; text-stroke: 1px #666;">⚡</span> QuickFix ($1.99)</button>
        <button id="proButton" class="btn-success" onclick="startProCTA()"
                data-tooltip="500 monthly scans + fixes - $9.99/month. Scan up to 5000 characters.">💎 False Flag Fixer Pro ($9.99/mo)</button>
      </div>
      
      <div style="text-align:center; margin-top:12px;">
        <p style="font-size:11px; color:#9ca3af; line-height:1.3;">
          QuickFix™ fixes this essay completely ($1.99 one-time) • Pro includes 500 monthly scans up to 5,000 characters each and can be cancelled anytime
        </p>
      </div>
      <div class="stripe-badge">
        Secure payment by <span class="stripe-logo">Stripe</span>
      </div>
    </div>
  </div>
</div>

<!-- UNLOCK BOX OVERLAY ON TOP OF BLURRED TEXT -->
<div id="resultsContainer" class="results-container">
  <div class="hero-section" style="padding-bottom: 0px;">
    <h1 class="hero-title">False Flag Fixer - <span style="display: inline-block; vertical-align: middle; margin: 0 4px; filter: drop-shadow(0 0 10px #2ecc71) drop-shadow(0 0 20px #2ecc71);"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="11" cy="11" r="7" stroke="#2ecc71" stroke-width="2" fill="none"/><path d="m20 20-4-4" stroke="#2ecc71" stroke-width="2" stroke-linecap="round"/></svg></span> Free</h1>
    <p class="hero-subtitle" style="padding-bottom: 72px;">
      Clock the AI triggers before your prof does.<br>See what detectors flag in your essay and fix it before you turn it in. False flags, fixed ✅
    </p>
  </div>
  <div class="results-wrapper">
    
    <!-- CARD 1: HELLA SUS VERSION (70%+) -->
    <div id="hellaSusCard" class="card warning-card" style="padding: 0; overflow: visible; position: relative; display: none;">
      <button onclick="minimizeResults()" style="position: absolute; top: 12px; right: 15px; background: none; border: none; font-size: 20px; color: #ffe4e4; cursor: pointer; z-index: 2;">×</button>

      <!-- Your AI Sus Score Title - ABOVE THE BOX -->
      <div style="text-align: center; margin: 0 20px 24px 20px; position: relative; z-index: 10; padding-top: 20px;">
        <h3 style="font-size: 24px; font-weight: 700; color: #374151; margin: 0 0 8px 0; text-align: center; text-transform: uppercase; letter-spacing: 0.5px;">Your AI Sus Score</h3>
        <p style="font-size: 14px; font-weight: 400; color: #6b7280; margin: 0; text-align: center; line-height: 1.4;">How suspicious your writing looks to AI detectors — even though it's 100% human 🙄</p>
      </div>

      <!-- HEADER SECTION - NEW STYLE -->
      <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin: 20px; border-left: 8px solid #dc2626; border-right: 8px solid #dc2626;">
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;">
          <div style="width: 60px; height: 60px; background: #fee2e2; border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(220, 38, 38, 0.3); flex-shrink: 0;">
            <span style="font-size: 36px; line-height: 1;">🚩</span>
          </div>
          <div style="text-align: center;">
            <h2 id="hellaSusWarningTitle" style="font-size: 32px; font-weight: 700; margin: 0; line-height: 1; color: #ff4444;">Hella Sus</h2>
            <p id="hellaSusLabel" style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #6b7280; margin-top: 6px;">Major red flags detected</p>
          </div>
        </div>
      </div>

      <!-- WHITE SCORE / BAR SECTION -->
      <div style="background: #ffffff; padding: 24px 28px 22px 28px; text-align: center;">
        <p id="hellaSusDetectorMessage" style="font-size:24px;font-weight:700;color:#ffffff;margin:0 0 48px 0;background:#dc2626;padding:12px 24px;border-radius:10px;text-align:center;">
          Don't Turn It In Yet 🛑
        </p>

        <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 12px;">
          <span id="hellaSusScoreNumber" style="font-size: 40px; font-weight: 900; color: #dc2626;">75%</span>
          <span id="hellaSusScoreLabel" style="font-size: 20px; font-weight: 700; color: #dc2626;">Hella Sus</span>
          <span id="hellaSusScoreEmoji" style="font-size: 34px;">🚨</span>
        </div>

        <div class="progress-container" style="margin: 0 0 10px 0;">
          <div id="hellaSusProgressBar" class="progress-bar" style="height: 8px; background: transparent; border-radius: 4px; position: relative; overflow: hidden; border: 1px solid #ccc;">
            <div class="progress-fill" id="hellaSusProgressFill"></div>
            <div class="progress-indicator" id="hellaSusProgressIndicator"></div>
          </div>
          <div class="progress-endpoints">
            <span>0%</span>
            <span>100%</span>
          </div>
          <div class="progress-labels">
            <span>✅ Clean - No Sus</span>
            <span>⚠️ Kinda Sus</span>
            <span>🚨 Hella Sus</span>
          </div>
        </div>
        <p id="hellaSusMessage" style="font-size: 18px; font-weight: 700; color: #374151; margin: 24px 0 0 0; text-align: center;">
          Your essay needs some fixes before it's safe to submit
        </p>
      </div>
    </div>

    <!-- CARD 1: YOU'RE GOOD VERSION (0-29%) -->
    <div id="youreGoodCard" class="card warning-card" style="padding: 0; overflow: visible; position: relative; display: none;">
      <button onclick="minimizeResults()" style="position: absolute; top: 12px; right: 15px; background: none; border: none; font-size: 20px; color: #d1fae5; cursor: pointer; z-index: 2;">×</button>

      <!-- Your AI Sus Score Title -->
      <div style="text-align: center; margin: 0 20px 48px 20px; position: relative; z-index: 10; padding-top: 20px;">
        <h3 style="font-size: 24px; font-weight: 700; color: #374151; margin: 0 0 8px 0; text-align: center; text-transform: uppercase; letter-spacing: 0.5px;">Your AI Sus Score</h3>
        <p style="font-size: 14px; font-weight: 400; color: #6b7280; margin: 0; text-align: center; line-height: 1.4;">How suspicious your writing looks to AI detectors — even though it's 100% human 🙄</p>
      </div>

      <!-- HEADER SECTION - NEW STYLE -->
      <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin: 20px; border-left: 8px solid #2ecc71; border-right: 8px solid #2ecc71;">
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;">
          <div style="width: 60px; height: 60px; background: #d1fae5; border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(46, 204, 113, 0.3); flex-shrink: 0;">
            <span style="font-size: 36px; line-height: 1;">✅</span>
          </div>
          <div style="text-align: center;">
            <h2 id="youreGoodWarningTitle" style="font-size: 32px; font-weight: 700; margin: 0; line-height: 1; color: #2ecc71;">Clean - No Sus</h2>
            <p id="youreGoodLabel" style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #6b7280; margin-top: 6px;">No AI-trigger words detected</p>
          </div>
        </div>
      </div>

      <!-- WHITE SCORE / BAR SECTION -->
      <div style="background: #ffffff; padding: 24px 28px 22px 28px; text-align: center;">
        <p id="youreGoodDetectorMessage" style="font-size:16px;font-weight:700;color:#ffffff;margin:0 0 24px 0;background:#2ecc71;padding:12px 24px;border-radius:10px;text-align:center;">
          Your professor's AI detector won't flag this →
        </p>
        
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; margin-bottom: 12px;">
          <span id="youreGoodScoreNumber" style="font-size: 40px; font-weight: 900; color: #2ecc71;">18%</span>
        </div>

        <div class="progress-container" style="margin: 0 0 48px 0;">
          <div id="youreGoodProgressBar" class="progress-bar" style="height: 8px; background: transparent; border-radius: 4px; position: relative; overflow: hidden; border: 1px solid #ccc;">
            <div class="progress-fill" id="youreGoodProgressFill"></div>
            <div class="progress-indicator" id="youreGoodProgressIndicator"></div>
          </div>
          <div class="progress-endpoints">
            <span>0%</span>
            <span>100%</span>
          </div>
          <div class="progress-labels">
            <span>✅ Clean - No Sus</span>
            <span>⚠️ Kinda Sus</span>
            <span>🚨 Hella Sus</span>
          </div>
        </div>
        <p id="youreGoodMessage" style="font-size: 18px; font-weight: 700; color: #374151; margin: 0; text-align: center;">
          Your writing is literally immaculate ✨
        </p>
      </div>
    </div>

    <!-- CARD 1: KINDA SUS VERSION (30-69%) -->
    <div id="kindaSusCard" class="card warning-card" style="padding: 0; overflow: visible; position: relative; display: none;">
      <button onclick="minimizeResults()" style="position: absolute; top: 12px; right: 15px; background: none; border: none; font-size: 20px; color: #fef3c7; cursor: pointer; z-index: 2;">×</button>

      <!-- Your AI Sus Score Title - ABOVE THE BOX -->
      <div style="text-align: center; margin: 0 20px 24px 20px; position: relative; z-index: 10; padding-top: 20px;">
        <h3 style="font-size: 24px; font-weight: 700; color: #374151; margin: 0 0 8px 0; text-align: center; text-transform: uppercase; letter-spacing: 0.5px;">Your AI Sus Score</h3>
        <p style="font-size: 14px; font-weight: 400; color: #6b7280; margin: 0; text-align: center; line-height: 1.4;">How suspicious your writing looks to AI detectors — even though it's 100% human 🙄</p>
      </div>

      <!-- HEADER SECTION - NEW STYLE -->
      <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin: 20px; border-left: 8px solid #f5a623; border-right: 8px solid #f5a623;">
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;">
          <div style="width: 60px; height: 60px; background: #fef3c7; border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(245, 166, 35, 0.3); flex-shrink: 0;">
            <span style="font-size: 36px; line-height: 1;">⚠️</span>
          </div>
          <div style="text-align: center;">
            <h2 id="kindaSusWarningTitle" style="font-size: 32px; font-weight: 700; margin: 0; line-height: 1; color: #f5a623;">Kinda Sus</h2>
            <p id="kindaSusLabel" style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #6b7280; margin-top: 6px;">Some wording might come across as AI-generated. Let's fix that.</p>
          </div>
        </div>
      </div>

      <!-- WHITE SCORE / BAR SECTION -->
      <div style="background: #ffffff; padding: 24px 28px 22px 28px; text-align: center;">
        <p id="kindaSusDetectorMessage" style="font-size:24px;font-weight:700;color:#ffffff;margin:0 0 48px 0;background:#fbbf24;padding:12px 24px;border-radius:10px;text-align:center;">
          Don't Turn It In Yet ⚠️
        </p>

        <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 12px;">
          <span id="kindaSusScoreNumber" style="font-size: 40px; font-weight: 900; color: #eed202;">45%</span>
          <span id="kindaSusScoreLabel" style="font-size: 20px; font-weight: 700; color: #eed202;">Kinda Sus</span>
        </div>

        <div class="progress-container" style="margin: 24px 0 10px 0;">
          <div id="kindaSusProgressBar" class="progress-bar" style="height: 8px; background: transparent; border-radius: 4px; position: relative; overflow: hidden; border: 1px solid #ccc;">
            <div class="progress-fill" id="kindaSusProgressFill"></div>
            <div class="progress-indicator" id="kindaSusProgressIndicator"></div>
          </div>
          <div class="progress-endpoints">
            <span>0%</span>
            <span>100%</span>
          </div>
          <div class="progress-labels">
            <span>✅ Clean - No Sus</span>
            <span>⚠️ Kinda Sus</span>
            <span>🚨 Hella Sus</span>
          </div>
        </div>
        <p id="kindaSusMessage" style="font-size: 18px; font-weight: 700; color: #374151; margin: 0; padding-top: 24px; padding-bottom: 24px; text-align: center;">
          A few more fixes and you'll be in the clear. Let's make it perfect!
        </p>
      </div>
    </div>

    <!-- CARD 2: BLURRED TEXT + UNLOCK OVERLAY -->
    <div class="card" style="padding: 0; margin-bottom: 20px; overflow: visible; position: relative; box-shadow: none; background: rgba(255,255,255,0.85);">
      <!-- CONTENT AREA WITH RELATIVE POSITIONING FOR OVERLAY -->
      <div style="padding: 30px 20px 20px 20px; position: relative; min-height: 600px; text-align: center; overflow: visible;">
        <!-- ESSAY SNIPPET PREVIEW - MOVED TO TOP -->
        <div id="freeEssaySnippet" style="background: #f9fafb; border-radius: 8px; padding: 12px 16px; margin: 0 0 20px 0; text-align: left; border-left: 3px solid #eed202; border-right: 3px solid #eed202;">
          <p style="font-size: 18px; color: #374151; margin: 0 0 12px 0; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; text-align: center;">Your essay:</p>
          <p id="freeEssaySnippetText" style="font-size: 18px; color: #374151; margin: 0; line-height: 1.6; font-style: italic;">[Essay preview will appear here]</p>
        </div>
        
        <!-- AI TRIGGER WORDS SECTION -->
        <div style="padding: 24px 0 48px 0;">
          <p id="freeTriggerHeading" style="color: #0b0646; font-size: 20px; font-weight: 800; margin: 0 0 12px 0; display: flex; align-items: center; justify-content: center; gap: 6px;">
            <span id="freeTriggerHeadingText" style="font-size: 24px; font-weight: 800;">⚡ 0 outta 0 AI trigger words were found</span>
          </p>

          <!-- Flag count sentence under heading -->
          <p id="freeFlagCountText" style="font-size: 18px; color: #374151; margin: 0 0 -16px 0; padding-bottom: 48px;">
            <span id="freeFlagCountMessage" style="font-size: 22px; font-weight: 600;">Your writing sounds authentically you. That's the move.</span>
          </p>

          <!-- Zero AI Trigger Words Box - FREE VERSION CLEAN SUS PAGE ONLY -->
          <div id="freeZeroTriggerBox" style="display: none; background: #d1fae5; border: 3px solid #059669; border-radius: 12px; padding: 32px 24px; margin: 24px auto; text-align: center; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.15); max-width: 600px;">
            <div style="margin-bottom: 12px;">
              <img src="https://i.postimg.cc/JhsvMWLJ/Lil-Sus-Trans-Bg.png" alt="Lil Sus" style="width: 300px; height: auto; display: block; margin: 0 auto;">
            </div>
            <h3 style="color: #059669; font-size: 24px; font-weight: 700; margin: 0 0 8px 0; text-transform: uppercase; letter-spacing: 0.5px;">Zero AI Trigger Words Detected</h3>
            <p style="color: #047857; font-size: 16px; font-weight: 600; margin: 0; line-height: 1.4;">Your essay is completely clean — no flags detected! 🎉</p>
          </div>
          
          <!-- TRIGGER WORDS CHIPS - DYNAMIC STYLING -->
          <div id="freeTriggerChips" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; justify-content: center; position: relative; z-index: 2;">
            <!-- Placeholder chips - will be replaced by JavaScript -->
            <span class="trigger-chip" style="background: #fee2e2; border: 2px solid #dc2626; color: #991b1b; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: none;">unprecedented levels</span>
            <span class="trigger-chip" style="background: #fee2e2; border: 2px solid #dc2626; color: #991b1b; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: none;">cutting-edge</span>
            <span class="trigger-chip" style="background: #fee2e2; border: 2px solid #dc2626; color: #991b1b; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: none;">leverage</span>
          </div>
          
          <!-- Trigger words message based on score -->
          <p id="freeTriggerWordsMessage" style="font-size: 16px; font-weight: 700; color: #374151; margin: 24px 0 12px 0; text-align: center; line-height: 1.5;"></p>
        </div>

        <!-- Extra flags summary (only when more are locked) -->
        <p id="freeExtraFlagsSummary" style="font-size: 12px; color: #6b7280; margin: 0 0 16px 0; line-height: 1.5; display: none;"></p>
        
        <!-- BLURRED CONTENT AND LOCK OVERLAY CONTAINER -->
        <div style="position: relative; overflow: visible; margin: 8px 0; min-height: 250px;">
          <!-- HEADING ABOVE LOCK BOX -->
          <h2 id="freeLockHeading" style="font-size: 18px; font-weight: 700; text-align: center; margin: 4px 0 8px 0; padding-bottom: 0.25in; color: #374151;">🔓 Unlock All [TOTAL_TRIGGERS] • One-time with ⚡ QuickFix OR All Month with 💎 Pro</h2>
          
          <!-- BLURRED BACKGROUND - FIRST LAYER -->
          <div class="blurred-content" style="background: #e8e8e8; padding: 14px; border-radius: 8px; filter: blur(5px); -webkit-filter: blur(5px); opacity: 0.7; user-select: none; pointer-events: none; min-height: 280px; position: relative; z-index: 1;">
            <div style="background: #999; height: 12px; margin: 10px 0; border-radius: 4px; opacity: 0.6;"></div>
            <div style="background: #999; height: 12px; margin: 10px 0; border-radius: 4px; opacity: 0.6;"></div>
            <div style="background: #999; height: 12px; margin: 10px 0; border-radius: 4px; opacity: 0.6;"></div>
            <div style="background: #999; height: 12px; margin: 10px 0; border-radius: 4px; opacity: 0.6;"></div>
            <div style="background: #999; height: 12px; margin: 10px 0; border-radius: 4px; opacity: 0.6;"></div>
            <div style="background: #999; height: 12px; margin: 10px 0; border-radius: 4px; opacity: 0.6;"></div>
            <div style="background: #999; height: 12px; margin: 10px 0; border-radius: 4px; opacity: 0.6;"></div>
            <div style="background: #999; height: 12px; margin: 10px 0; border-radius: 4px; opacity: 0.6;"></div>
            <div style="background: #999; height: 12px; margin: 10px 0; border-radius: 4px; opacity: 0.6;"></div>
          </div>
          
          <!-- UNLOCK OVERLAY BOX - SECOND LAYER ON TOP -->
          <div id="freeUnlockOverlay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; width: 90%; max-width: 900px; z-index: 10; background: rgba(255,255,255,0.4); border-radius: 12px; border: 2px dashed #eed202; padding: 32px 20px; overflow: visible;">
            <div id="freeUnlockContent">
              <div style="font-size: 44px; margin-bottom: 16px;">🔒</div>
              <h3 id="unlockOverlayHeading" style="color: #374151; font-size: 16px; font-weight: 800; margin: 0 0 12px 0;">Want to see ALL possible triggers?</h3>
              <p style="color: #374151; font-size: 13px; margin: 0 0 24px 0; line-height: 1.5; max-width: 100%;">
                🚨 Don't Risk It. Fix It. Get 500 scans/mo • Deeper Fixes • Real-Time Scoring • Fix the AI flags before the AI flags you.
              </p>
            </div>
            
            <div style="display: flex; gap: 12px; width: 100%; max-width: 500px; margin: 0 auto; position: relative; z-index: 101;">
              <button id="quickfixUnlockButton" onclick="switchToQuickFix()" style="background: #ff6b00; color: white; border: none; padding: 10px 24px; border-radius: 8px; font-weight: 700; font-size: 14px; cursor: pointer; flex: 1; position: relative; z-index: 101;">
                <span style="color: #ffeb3b !important; display: inline-block; text-shadow: -2px -2px 0px #666, 2px -2px 0px #666, -2px 2px 0px #666, 2px 2px 0px #666, 0 0 15px #ffeb3b, 0 0 25px #ffeb3b, 0 0 35px #ffeb3b; filter: brightness(1.5) saturate(2) !important; font-weight: bold; -webkit-text-stroke: 1px #666; text-stroke: 1px #666;">⚡</span> QuickFix ($1.99)
              </button>
              <button onclick="handleProUpgrade()" style="background: #00a8e8; color: white; border: none; padding: 10px 24px; border-radius: 8px; font-weight: 700; font-size: 14px; cursor: pointer; flex: 1; position: relative; z-index: 101;">
                💎 Go Pro ($9.99/mo)
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- CARD 3: UPSELL SECTION (GREEN) -->
    <div class="card" style="padding: 20px; background: linear-gradient(135deg, #00a8e8, #0087c4); color: white; text-align: center; margin-bottom: 20px;">
      <h3 id="freeUpsellHeading" style="color: #fff; font-weight: 800; font-size: 22px; margin: 0 0 12px 0; display: flex; align-items: center; justify-content: center; gap: 8px;">
        <span id="freeUpsellHeadingText">🚀 Go Pro and chill...</span>
      </h3>
      <p id="freeUpsellText" style="color: #fff; font-size: 13px; margin: 0 0 12px 0; line-height: 1.5;">
        500 monthly scans • Catch ALL triggers before your prof does • 5,000 character limit
      </p>
      <button onclick="handleProUpgrade()" style="background: white; color: #00a8e8; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 700; font-size: 13px; cursor: pointer; width: 100%;">
        → Get Pro - $9.99/mo
      </button>
    </div>

    <!-- CARD 4: BOTTOM ACTION BUTTONS -->
    <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
      <button id="scanAnotherEssayBtn" onclick="scanNewText()" style="padding: 12px 20px; font-size: 13px; font-weight: 600; border-radius: 8px; cursor: pointer; background: white; border: 2px solid #e5e7eb; color: #374151; flex: 1; min-width: 140px;">
        📝 Scan Another Essay
      </button>
      <button onclick="minimizeResults()" style="padding: 12px 20px; font-size: 13px; font-weight: 600; border-radius: 8px; cursor: pointer; background: white; border: 2px solid #e5e7eb; color: #374151; flex: 1; min-width: 140px;">
        🏠 Back To Main Dashboard
      </button>
    </div>

  </div>
</div>

<!-- Stripe Payment Modal -->
<div id="stripePaymentModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100vh;background:rgba(0,0,0,0.8);z-index:10000;align-items:center;justify-content:center;flex-direction:column;">
  <div style="background:#fff;padding:40px;border-radius:20px;max-width:500px;width:90%;position:relative;max-height:90vh;overflow-y:auto;">
    <button onclick="closeStripePaymentModal()" style="position:absolute;top:15px;right:15px;background:none;border:none;font-size:32px;color:#999;cursor:pointer;padding:5px 15px;line-height:1;border-radius:50%;transition:all 0.3s;" onmouseover="this.style.color='#dc2626'; this.style.background='#fee2e2';" onmouseout="this.style.color='#999'; this.style.background='none';">×</button>
    
    <h2 style="color:#0b0646;margin:0 0 10px;font-size:1.8em;font-weight:800;">💎 Upgrade to Pro</h2>
    <p style="color:#666;margin:0 0 25px;font-size:1em;line-height:1.4;">🚨 Don't Risk It. Fix It. Get 500 scans/mo • Deeper Fixes • Real-Time Scoring • Fix the AI flags before the AI flags you.</p>
    
    <div style="background:#f8f9fa;border-radius:12px;padding:20px;margin-bottom:20px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
        <span style="color:#0b0646;font-weight:600;">Pro Subscription</span>
        <span style="color:#0b0646;font-size:24px;font-weight:800;">$9.99/mo</span>
      </div>
      <p style="color:#6b7280;font-size:13px;margin:0;">Billed monthly • Cancel anytime</p>
    </div>
    
    <!-- Stripe Payment Form -->
    <form id="stripePaymentForm">
      <div id="stripeCardElement" style="padding:15px;border:2px solid #e5e7eb;border-radius:8px;margin-bottom:20px;">
        <!-- Stripe Elements will mount here -->
      </div>
      <div id="stripeCardErrors" role="alert" style="color:#dc2626;font-size:14px;margin-bottom:15px;min-height:20px;"></div>
      
      <button type="submit" id="stripeSubmitBtn" class="btn-success btn-block" style="padding:15px;font-size:16px;font-weight:600;margin-bottom:15px;">
        Subscribe for $9.99/month
      </button>
      
      <div class="stripe-badge" style="text-align:center;font-size:12px;color:#6b7280;">
        🔒 Secure payment by <span class="stripe-logo" style="color:#635bff;font-weight:700;">Stripe</span>
      </div>
    </form>
  </div>
</div>

<!-- Update Payment Modal -->
<div id="updatePaymentModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100vh;background:rgba(0,0,0,0.8);z-index:10000;align-items:center;justify-content:center;flex-direction:column;">
  <div style="background:#fff;padding:40px;border-radius:20px;max-width:500px;width:90%;position:relative;">
    <button onclick="closeUpdatePaymentModal()" style="position:absolute;top:15px;right:15px;background:none;border:none;font-size:32px;color:#999;cursor:pointer;padding:5px 15px;line-height:1;border-radius:50%;transition:all 0.3s;" onmouseover="this.style.color='#dc2626'; this.style.background='#fee2e2';" onmouseout="this.style.color='#999'; this.style.background='none';">×</button>
    
    <h2 style="color:#0b0646;margin:0 0 10px;font-size:1.8em;font-weight:800;">💳 Update Payment Method</h2>
    <p style="color:#666;margin:0 0 25px;font-size:1em;">Update your payment information</p>
    
    <form id="updatePaymentForm">
      <div id="updateCardElement" style="padding:15px;border:2px solid #e5e7eb;border-radius:8px;margin-bottom:20px;">
        <!-- Stripe Elements will mount here -->
      </div>
      <div id="updateCardErrors" role="alert" style="color:#dc2626;font-size:14px;margin-bottom:15px;min-height:20px;"></div>
      
      <button type="submit" class="btn-success btn-block" style="padding:15px;font-size:16px;font-weight:600;">
        Update Payment Method
      </button>
    </form>
  </div>
</div>

<!-- Cancel Subscription Modal -->
<div id="cancelSubscriptionModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100vh;background:rgba(0,0,0,0.8);z-index:10000;align-items:center;justify-content:center;flex-direction:column;">
  <div style="background:#fff;padding:40px;border-radius:20px;max-width:500px;width:90%;position:relative;text-align:center;">
    <button onclick="closeCancelSubscriptionModal()" style="position:absolute;top:15px;right:15px;background:none;border:none;font-size:32px;color:#999;cursor:pointer;padding:5px 15px;line-height:1;border-radius:50%;transition:all 0.3s;" onmouseover="this.style.color='#dc2626'; this.style.background='#fee2e2';" onmouseout="this.style.color='#999'; this.style.background='none';">×</button>
    
    <h2 style="color:#0b0646;margin:0 0 15px;font-size:1.8em;font-weight:800;">Cancel Subscription?</h2>
    <p style="color:#666;margin:0 0 25px;font-size:1em;line-height:1.5;">Your Pro access will continue until <span id="cancelEndDate" style="font-weight:600;">Dec 15, 2024</span>. After that, you'll lose access to all Pro features.</p>
    
    <div style="display:flex;gap:15px;justify-content:center;margin-top:30px;">
      <button onclick="closeCancelSubscriptionModal()" class="btn-outline" style="padding:12px 30px;">
        Keep Subscription
      </button>
      <button onclick="confirmCancelSubscription()" class="btn-success" style="padding:12px 30px;background:#dc2626;border-color:#dc2626;">
        Yes, Cancel
      </button>
    </div>
  </div>
</div>
<script>
// Sample data - replace with your actual data
const sampleData = {
  originalScore: 75,
  newScore: 17,
  flagsFixed: 12,
  wordsChanged: 847,
  sentencesRewritten: 23,
  originalEssay: "The cutting-edge technology landscape demonstrates unprecedented levels of innovation. Furthermore, organizations must leverage their resources to achieve significant competitive advantages in the marketplace. Thus, it is important to note that comprehensive analysis reveals multifaceted approaches to problem-solving.\n\nMoreover, the data suggests that various industries are experiencing considerable transformation. Consequently, stakeholders must utilize state-of-the-art methodologies to navigate these changes effectively.",
  rewriteEssay: "Modern tech shows incredible innovation. Companies need to use their resources smartly to stay ahead. A closer look shows there are many ways to solve problems.\n\nAlso, evidence shows that different industries are changing fast. Decision-makers should use modern methods to handle these shifts well.",
  flags: [
    {
      original: "cutting-edge",
      fixed: "modern",
      explanation: "AI detectors flag this as overly formal and commonly used by ChatGPT"
    },
    {
      original: "unprecedented levels",
      fixed: "incredible",
      explanation: "This phrase screams AI - it's one of the most flagged phrases"
    },
    {
      original: "Furthermore",
      fixed: "Also",
      explanation: "Formal transitions like this are AI red flags. More casual = more human"
    },
    {
      original: "leverage",
      fixed: "use",
      explanation: "Corporate buzzword that AI loves. Simple words are more natural"
    },
    {
      original: "significant",
      fixed: "(removed)",
      explanation: "Filler word that adds no value. Humans are more direct"
    },
    {
      original: "it is important to note",
      fixed: "note that",
      explanation: "Classic AI padding phrase. Get straight to the point"
    },
    {
      original: "comprehensive analysis",
      fixed: "closer look",
      explanation: "Too formal. Real students use simpler language"
    },
    {
      original: "multifaceted approaches",
      fixed: "many ways",
      explanation: "Academic jargon that screams bot. Keep it conversational"
    },
    {
      original: "Moreover",
      fixed: "Also",
      explanation: "Another formal transition. Vary your connectors naturally"
    },
    {
      original: "various",
      fixed: "different",
      explanation: "Generic descriptor that AI overuses"
    },
    {
      original: "considerable",
      fixed: "fast",
      explanation: "Vague adjective. Be more specific and direct"
    },
    {
      original: "utilize",
      fixed: "use",
      explanation: "Unnecessarily fancy word. Simple = human"
    }
  ]
};
// Initialize the page with REAL data from appState
function initializeStep4Page() {
  // Use actual data from appState instead of hardcoded sampleData
  const originalScore = appState.quickfixOriginalScore || 75;
  const newScore = appState.quickfixNewScore || 17;
  const flagsFixed = appState.quickfixFlags ? appState.quickfixFlags.length : 0;
  const originalText = appState.quickfixOriginalText || '';
  const fixedText = appState.quickfixFixedText || '';
  
  // Only update elements that actually exist
  const scoreDrop = document.getElementById('scoreDrop');
  if (scoreDrop) scoreDrop.textContent = (originalScore - newScore) + '%';
  
  const scoreBefore = document.getElementById('scoreBefore');
  if (scoreBefore) scoreBefore.textContent = originalScore + '%';
  
  const scoreAfter = document.getElementById('scoreAfter');
  if (scoreAfter) scoreAfter.textContent = newScore + '%';
  
  // Set dynamic tier labels
  const scoreBeforeLabel = document.getElementById('scoreBeforeLabel');
  if (scoreBeforeLabel) {
    if (originalScore >= 71) {
      scoreBeforeLabel.textContent = 'Hella Sus';
    } else if (originalScore >= 31) {
      scoreBeforeLabel.textContent = 'Kinda Sus';
    } else {
      scoreBeforeLabel.textContent = "Clean - No Sus";
    }
  }
  
  const scoreAfterLabel = document.getElementById('scoreAfterLabel');
  if (scoreAfterLabel) {
    if (newScore >= 71) {
      scoreAfterLabel.textContent = 'Hella Sus';
    } else if (newScore >= 31) {
      scoreAfterLabel.textContent = 'Kinda Sus';
    } else {
      scoreAfterLabel.textContent = "Clean - No Sus";
    }
  }
  
  const flagCount = document.getElementById('flagCount');
  if (flagCount) flagCount.textContent = flagsFixed;
  
  const modalFlagCount = document.getElementById('modalFlagCount');
  if (modalFlagCount) modalFlagCount.textContent = flagsFixed;
  
  const proFlags = document.getElementById('proFlags');
  if (proFlags) proFlags.textContent = flagsFixed;
  
  const flagsFixedCount = document.getElementById('flagsFixedCount');
  if (flagsFixedCount) flagsFixedCount.textContent = flagsFixed;
  
  const scoreImprovement = document.getElementById('scoreImprovement');
  if (scoreImprovement) scoreImprovement.textContent = (originalScore - newScore) + '%';
  
  const aiTriggerFreeScore = document.getElementById('aiTriggerFreeScore');
  if (aiTriggerFreeScore) aiTriggerFreeScore.textContent = '100%';
  
  // Update big score display
  const bigScoreBefore = document.getElementById('bigScoreBefore');
  if (bigScoreBefore) bigScoreBefore.textContent = originalScore + '%';
  
  const bigScoreAfter = document.getElementById('bigScoreAfter');
  if (bigScoreAfter) bigScoreAfter.textContent = newScore + '%';
  
  const bigScoreImprovement = document.getElementById('bigScoreImprovement');
  if (bigScoreImprovement) {
    const improvement = originalScore - newScore;
    bigScoreImprovement.textContent = `🚀 ${improvement}% Score Drop!`;
  }
  
  const meterFill = document.getElementById('meterFill');
  if (meterFill) {
    meterFill.style.width = newScore + '%';
    // Update the text inside the progress bar
    const meterText = meterFill.querySelector('span');
    if (meterText) meterText.textContent = newScore + '%';
  }
  
  const originalEssay = document.getElementById('originalEssay');
  if (originalEssay) {
    console.log('Original text:', originalText);
    console.log('Flags:', appState.quickfixFlags);
    originalEssay.innerHTML = formatEssayWithFlags(originalText, appState.quickfixFlags || []);
  }
  
  const rewriteEssay = document.getElementById('rewriteEssay');
  if (rewriteEssay) rewriteEssay.innerHTML = formatEssay(fixedText);
  
  const diffEssay = document.getElementById('diffEssay');
  if (diffEssay) diffEssay.innerHTML = generateDiffView(originalText, appState.quickfixFlags || []);
  
  // Update dynamic text based on actual flag counts - check Pro mode
  const isPro = appState.isProUser || false;
  const step4HeroText = document.getElementById('step4HeroText');
  if (step4HeroText) {
    if (isPro) {
      step4HeroText.innerHTML = `💎 Pro found all ${flagsFixed} AI-trigger words! All fixed.<br>Ready to TURN IT IN.`;
    } else {
      step4HeroText.innerHTML = `QuickFix found all ${flagsFixed} AI-trigger words! All fixed.<br>Ready to TURN IT IN.`;
    }
  }
  
  const step4ProText = document.getElementById('step4ProText');
  if (step4ProText) {
    if (isPro) {
      step4ProText.textContent = `💎 Pro found all ${flagsFixed} AI-trigger words in your essay and fixed them all!`;
    } else {
      step4ProText.textContent = `QuickFix found all ${flagsFixed} AI-trigger words in your essay and fixed them all!`;
    }
  }
  
  // Set premium header for Pro users
  if (isPro) {
    const rotatingMessage = document.getElementById('rotatingMessage');
    if (rotatingMessage) {
      rotatingMessage.textContent = '💎 Premium Results - Every Flag Found & Fixed ✨';
    }
  }
  
  renderStep4FlagsList();
}

function formatEssay(text) {
  return text.split('\n\n').map(p => `<p>${p}</p>`).join('');
}

function formatEssayWithFlags(text, flags) {
  console.log('formatEssayWithFlags called with:', { text, flags });
  let formatted = text;
  flags.forEach((flag, index) => {
    console.log('Processing flag:', flag);
    const regex = new RegExp(flag.phrase.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
    formatted = formatted.replace(regex, `<span class="flag-removed" title="${flag.explanation}">${flag.phrase}</span>`);
  });
  console.log('Formatted result:', formatted);
  return formatted.split('\n\n').map(p => `<p>${p}</p>`).join('');
}

function generateDiffView(text, flags) {
  let formatted = text;
  flags.forEach((flag, index) => {
    const regex = new RegExp(flag.phrase.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
    formatted = formatted.replace(regex, 
      `<span class="flag-removed">${flag.phrase}</span> <span class="flag-fixed">${flag.suggestedFix}</span>`
    );
  });
  return formatted.split('\n\n').map(p => `<p>${p}</p>`).join('');
}

function renderStep4FlagsList() {
  const container = document.getElementById('step4FlagsList');
  const flags = appState.quickfixFlags || [];
  const html = flags.map((flag, index) => `
    <div class="flag-item">
      <div class="flag-number">${index + 1}</div>
      <div class="flag-details">
        <div class="flag-change">
          <span class="flag-original">"${flag.phrase}"</span>
          <span class="flag-arrow">→</span>
          <span class="flag-new">"${flag.suggestedFix}"</span>
        </div>
        <div class="flag-explanation">
          <strong>Why I fixed it:</strong> ${flag.explanation}
        </div>
      </div>
    </div>
  `).join('');
  container.innerHTML = html;
}

function showVersion(version) {
  document.querySelectorAll('.essay-content').forEach(content => {
    content.classList.remove('active');
  });
  document.querySelectorAll('.toggle-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  if (version === 'original') {
    document.getElementById('originalEssay').classList.add('active');
    document.querySelectorAll('.toggle-btn')[0].classList.add('active');
  } else if (version === 'rewrite') {
    document.getElementById('rewriteEssay').classList.add('active');
    document.querySelectorAll('.toggle-btn')[1].classList.add('active');
  } else if (version === 'diff') {
    document.getElementById('diffEssay').classList.add('active');
    document.querySelectorAll('.toggle-btn')[2].classList.add('active');
  }
}

function copyFullDeFlag() {
  const textToCopy = appState.quickfixFixedText || '';
  if (textToCopy) {
    navigator.clipboard.writeText(textToCopy).then(() => {
      showSuccessMessage('✅ Essay copied to clipboard!', '#00a8e8'); // Green for copy button
    }).catch(() => {
      showSuccessMessage('❌ Failed to copy. Please try again.', '#00a8e8'); // Green for copy button
    });
  } else {
    showSuccessMessage('❌ No text to copy. Please scan an essay first.', '#00a8e8'); // Green for copy button
  }
}

function downloadDocx() {
  const textToDownload = appState.quickfixFixedText || '';
  if (textToDownload) {
    // Create a simple text file download (Word would require more complex library)
    const blob = new Blob([textToDownload], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'pro-fixed-essay.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    showSuccessMessage('✅ Essay downloaded as text file!', '#2ecc71'); // Blue for download button
  } else {
    showSuccessMessage('❌ No text to download. Please scan an essay first.', '#2ecc71'); // Blue for download button
  }
}

function openStep4FlagsModal() {
  // Populate the modal with the flagged words list
  const flagsList = document.getElementById('step4FlagsList');
  const flagCount = document.getElementById('modalFlagCount');
  
  if (flagsList && appState.quickfixFlags) {
    let flagsHtml = '';
    appState.quickfixFlags.forEach((flag, index) => {
      flagsHtml += `
        <div class="flag-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; margin: 8px 0; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #dc2626;">
          <div style="flex: 1;">
            <div style="font-weight: 600; color: #dc2626; margin-bottom: 4px;">"${flag.phrase}"</div>
            <div style="font-size: 14px; color: #6b7280;">→ "${flag.suggestedFix}"</div>
            <div style="font-size: 12px; color: #9ca3af; margin-top: 4px;">${flag.explanation}</div>
          </div>
          <div style="background: #dc2626; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700;">
            ${index + 1}
          </div>
        </div>
      `;
    });
    
    flagsList.innerHTML = flagsHtml;
    flagCount.textContent = appState.quickfixFlags.length;
  }
  
  document.getElementById('step4FlagsModal').classList.add('show');
  document.body.classList.add('modal-open');
}

function closeStep4FlagsModal() {
  document.getElementById('step4FlagsModal').classList.remove('show');
  document.body.classList.remove('modal-open');
}

function copyStep4FlagsList() {
  if (!appState.quickfixFlags) return;
  
  let flagsText = 'Flags Fixed:\n\n';
  appState.quickfixFlags.forEach((flag, index) => {
    flagsText += `${index + 1}. "${flag.phrase}" → "${flag.suggestedFix}"\n   ${flag.explanation}\n\n`;
  });
  
  navigator.clipboard.writeText(flagsText).then(() => {
    showStep4Toast('Flags list copied!', 'download');
  }).catch(() => {
    showStep4Toast('Copy failed', 'error');
  });
}


function showStep4Toast(message, type = 'success') {
  const toast = document.getElementById('step4SuccessToast');
  toast.textContent = message;
  toast.className = 'success-toast'; // Reset classes
  if (type === 'download') {
    toast.classList.add('download-toast');
  } else {
    toast.classList.add('success-toast');
  }
  toast.classList.add('show');
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// Initialize Step 4 when shown
function showFullDeFlagPage() {
  console.log('🔄 Showing Pro Scan Page (Step 4)');
  showQuickFixStep(4);
  initializeStep4Page();
  
  // Update labels if in Pro mode
  if (appState.isProUser) {
    setTimeout(() => {
      updateStepLabels(true);
    }, 100);
  }
  
  // Scroll to top of the form
  setTimeout(() => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }, 100);
  
  // No upsell popup for Pro members - they already have Pro!
}

// Gen Z Upsell Popup for Step 4
function showGenZUpsellPopup() {
  // Don't show upsell popup for Pro users - they already have Pro!
  if (appState.isProUser || (appState.proSubscription && appState.proSubscription.active)) {
    return;
  }
  
  const modal = document.createElement('div');
  modal.id = 'genzUpsellModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  `;
  
  const popup = document.createElement('div');
  popup.style.cssText = `
    background: white;
    border-radius: 16px;
    padding: 30px;
    max-width: 400px;
    width: 90%;
    text-align: center;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    position: relative;
  `;
  
  popup.innerHTML = `
    <button onclick="document.getElementById('genzUpsellModal').remove(); document.body.classList.remove('modal-open');" 
            style="position: absolute; top: 15px; right: 20px; background: none; border: none; font-size: 24px; color: #999; cursor: pointer; padding: 5px">×</button>
    
    <div style="font-size: 48px; margin-bottom: 15px;">😏</div>
    
    <h2 style="color: #1f2937; margin: 0 0 15px; font-size: 24px; font-weight: 800;">
      Aren't you glad you used the Pro fix?
    </h2>
    
    <p style="color: #6b7280; margin: 0 0 20px; font-size: 16px; line-height: 1.5;">
      Bestie, that was just <strong>ONE</strong> Pro scan... imagine having <strong>500</strong>! 🔥
    </p>
    
    <p style="color: #374151; margin: 0 0 25px; font-size: 14px; line-height: 1.4;">
      Get Pro & Chill - never stress about AI detection again! 💎
    </p>
    
    <div style="display: flex; flex-direction: column; gap: 12px;">
      <button onclick="document.getElementById('genzUpsellModal').remove(); document.body.classList.remove('modal-open'); window.open('/pro', '_blank');" 
              style="background: #00a8e8; color: white; border: none; padding: 15px 25px; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s;">
        💎 Get Pro & Chill - $9.99/mo
      </button>
      
      <button onclick="document.getElementById('genzUpsellModal').remove(); document.body.classList.remove('modal-open');" 
              style="background: #f3f4f6; color: #6b7280; border: none; padding: 12px 25px; border-radius: 12px; font-size: 14px; cursor: pointer; transition: all 0.2s;">
        Maybe Later
      </button>
    </div>
  `;
  
  modal.appendChild(popup);
  document.body.appendChild(modal);
  document.body.classList.add('modal-open');
  
  // Close on outside click
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      modal.remove();
      document.body.classList.remove('modal-open');
    }
  });
}

const FREE_SCAN_LIMIT = 3; // 3 free scans per day

// NEW: Dynamic messaging system
const dynamicMessages = {
  susFree: {
    headers: [
      "No cap, it's lookin' way cleaner 👌",
      "Fam, this is looking fire 🔥",
      "Bestie, you're in the clear 🙌",
      "This essay is professor-ready 💯",
      "Clean as a whistle! Ready to turn it in ✨",
      "Fam, this is absolutely slaying 🚀"
    ],
    subtitle: "Your essay just got a glow-up. Flag drop confirmed. ✨",
    message: "That's a solid glow-up — ${improvement}% less sus! ✨",
    ctaText: "This essay is professor-ready! But if you want perfection, Pro scan is free!"
  },
  kindaSus: {
    headers: [
      "Not totally sus, but could be cleaner 🤔",
      "You're in the safe zone, but let's make it bulletproof 🛡️",
      "Fam, this is borderline - let's fix it 🎯",
      "Almost there, but your prof might still clock it 👀",
      "This needs a little more work before turning in ✨",
      "Bestie, let's make this 100% professor-proof 💯"
    ],
    subtitle: "You're in the safe zone, but let's make it 100% false flag free",
    message: "A few tweaks away from being totally undetectable — ${improvement}% improvement",
    ctaText: "Almost there, but your prof might still clock it. Pro scan is free!"
  },
  susAf: {
    headers: [
      "Oof, this is way too sus for your prof 😬",
      "Yikes, this is looking sus af 🚨",
      "Fam, this is screaming AI-generated 📢",
      "Bestie, this needs serious work before turning in 🚩",
      "This essay is in the danger zone 🚨",
      "Fam, you're gonna get caught with this one 🔍"
    ],
    subtitle: "Let's make this 100% false flag free before turning in",
    message: "AI detectors would flag this for sure 😬 — only ${improvement}% improvement",
    ctaText: "Fam, this is way too sus for your prof. Pro scan is free!"
  }
};

// Lil' Sus phrases for different score ranges
const lilSusPhrases = {
  lowRisk: [
    "You're in the clear 🙌 – nothing sus here.",
    "Clean as a whistle! Ready to turn it in 💯",
    "No red flags detected – you're good to go! 🎉",
    "This essay is looking human AF – submit with confidence!",
    "Zero AI vibes detected – you're all clear! ✨"
  ],
  mediumRisk: [
    "Hmm... lil sus not gonna lie 👀. Could go either way.",
    "A few sketchy spots but you might get away with it 🤞",
    "Borderline vibes – some parts might raise eyebrows",
    "Not totally sus but not totally safe either 😐",
    "Could pass as human... or could get flagged ⚖️"
  ],
  highRisk: [
    "Yikes. This one's mad sus 😬. Proceed with caution.",
    "🚨 MAJOR AI VIBES DETECTED! Don't submit this yet!",
    "This is screaming AI to detectors – high risk of getting flagged!",
    "Too many AI markers – this needs fixing!",
    "Your professor would flag this in seconds ⏰"
  ]
};

var appState = {
  maxChars: 500, // Free version limited to 500 characters
  minChars: 50,
  scansUsed: 0,
  originalText: '',
  lastClickedFixOption: null, // Track the last clicked fix option for banner pointer
  flagData: [],
  currentScore: 0,
  isProUser: false,
  hasUnlimitedFixes: false,
  freeRewritesUsed: 0,
  maxFreeRewrites: 1,
  isQuickFixUser: false,
  quickfixOriginalText: '',
  quickfixFlags: [],
  quickfixOriginalScore: 0,
  quickfixFixedText: '',
  quickfixNewScore: 0,
  lastClickedFixOption: null, // Track the last clicked fix option element for banner pointer
  // Pro scan data
  proOriginalText: '',
  proFlags: [],
  proOriginalScore: 0,
  proFixedText: '',
  proNewScore: 0,
  // Pro subscription tracking
  proSubscription: {
    active: false,
    scansUsed: 0,
    scansLimit: 500,
    nextBillingDate: null,
    paymentMethod: null,
    subscriptionId: null
  },
  stripe: null, // Stripe instance
  stripeCardElement: null, // Stripe card element
  stripeUpdateCardElement: null, // Stripe update card element
  stripeConfigured: null // Whether Stripe is properly configured (null = not checked, false = not configured, true = configured)
};
// NEW: Dynamic CTA system
function getDynamicCTAs(score) {
  let ctas = '';
  
  if (score <= 30) { // You're Good
    ctas = 
      `<button class="btn-primary" onclick="copyQuickFixResult()">✅ Copy Fixed Text</button>
      <button class="btn-outline" onclick="scanNewText()">📝 Scan Another Essay</button>
      <button class="btn-outline" onclick="hideQuickFixFlow()">🏠 Back To Main Dashboard</button>`;
  } else if (score > 30 && score < 70) { // Kinda Sus (31-69)
    ctas = 
      `<button class="btn-primary" onclick="copyQuickFixResult()">✅ Copy Fixed Text</button>
      <button class="btn-outline" onclick="scanNewText()">📝 Scan Another Essay</button>
      <button class="btn-outline" onclick="hideQuickFixFlow()">🏠 Back To Main Dashboard</button>`;
  } else { // Hella Sus
    ctas = 
      `<button class="btn-primary" onclick="copyQuickFixResult()">✅ Copy Fixed Text</button>
      <button class="btn-outline" onclick="scanNewText()">📝 Scan Another Essay</button>
      <button class="btn-outline" onclick="hideQuickFixFlow()">🏠 Back To Main Dashboard</button>`;
  }
  
  return ctas;
}

// NEW: Dynamic messaging based on score
function updateResultsMessaging(score, improvement) {
  // Clear any existing rotation interval
  if (window.headerRotationInterval) {
    clearInterval(window.headerRotationInterval);
    window.headerRotationInterval = null;
  }
  
  const header = document.getElementById('resultsHeader');
  const subtitle = document.getElementById('resultsSubtitle');
  const message = document.getElementById('resultsMessage');
  const emoji = document.getElementById('resultsEmoji');
  const ctas = document.getElementById('dynamicCTAs');
  
  let messaging;
  
  if (score <= 30) {
    messaging = dynamicMessages.susFree;
    emoji.textContent = '✅';
  } else if (score >= 30 && score < 70) {
    messaging = dynamicMessages.kindaSus;
    emoji.textContent = '🤔';
  } else {
    messaging = dynamicMessages.susAf;
    emoji.textContent = '🚨';
  }
  
  // Set ALL rotating phrases to navy blue - force with !important
  if (score >= 70) {
    header.style.setProperty('color', '#0b0646', 'important'); // Navy for Hella Sus headers
  } else if (score >= 30) {
    header.style.setProperty('color', '#0b0646', 'important'); // Navy for Kinda Sus headers
  } else {
    header.style.setProperty('color', '#0b0646', 'important'); // Navy for You're Good headers
  }
  
  // Make subtitle navy for all tiers (dynamic rotating phrases) - force with !important
  if (subtitle) {
    subtitle.style.setProperty('color', '#0b0646', 'important'); // Navy for subtitle with !important
  }
  
  // Start with first message for the tier
  header.textContent = messaging.headers[0];
  
  // Reduce font size of dynamic phrases
  if (header) {
    header.style.fontSize = '18px';
  }
  
  // Add padding above resultsHeader container
  const headerContainer = header ? header.closest('.lil-sus-header') : null;
  if (headerContainer) {
    headerContainer.style.paddingTop = '24px';
  }
  
  // Rotate through messages within the same score tier every 6 seconds
  let currentIndex = 0;
  const rotationInterval = setInterval(() => {
    currentIndex = (currentIndex + 1) % messaging.headers.length;
    header.textContent = messaging.headers[currentIndex];
  }, 6000);
  
  // Store interval ID so we can clear it if needed
  window.headerRotationInterval = rotationInterval;
  subtitle.textContent = messaging.subtitle;
  // Update message text - different for Clean vs others
  if (score <= 30) {
    // Success message for Clean pages
    message.innerHTML = `That's a solid <strong>${improvement}%</strong> glow-up! ✨<br>Your essay is looking clean and ready to turn in.`;
  } else {
    // Warning message for Kinda Sus/Hella Sus pages
    message.innerHTML = `Detectors would still roast this 😬 — only a <strong>${improvement}%</strong> glow-up so far.<br>Keep fixing to drop your score even lower.`;
  }
  
  // Set color for resultsMessage on QuickFix summary page based on score
  if (message && message.id === 'resultsMessage') {
    if (score <= 30) {
      message.style.color = '#2ecc71'; // Green
    } else if (score > 30 && score < 70) {
      message.style.color = '#fbbf24'; // Yellow
    } else {
      message.style.color = '#dc2626'; // Red
    }
  }
  
  // Update dynamic CTA section based on score tier
  updateQuickFixBottomCTA(score, improvement);
}
function updateQuickFixBottomCTA(score, improvement) {
  const ctaContainer = document.getElementById('quickfixBottomCTA');
  if (!ctaContainer) return;
  
  let riskLevel, urgencyBanner, pitchTitle, pitchCopy, scoreDisplay, buttons, whatHappens, disclaimer;
  
  if (score <= 30) {
    // LOW RISK (You're Good)
    riskLevel = 'low-risk';
    urgencyBanner = ``;
    pitchTitle = "";
    pitchCopy = ``;
    scoreDisplay = `Started at: <span>${score + improvement}%</span> | Now: <span>${score}%</span>`;
    disclaimer = "";
    // Removed upsell section for Pro Summary page
    buttons = ``;
  } else if (score >= 30 && score < 70) {
    // MEDIUM RISK (Kinda Sus)
    riskLevel = 'medium-risk';
    urgencyBanner = ``;
    pitchTitle = "Almost there, but your prof might still clock it.";
    pitchCopy = ``;
    scoreDisplay = `Your score: <span>${score}%</span> | Pro scan gets you to: <span>20% or below</span>`;
    buttons = `
      <div style="display: flex; gap: 12px; width: 100%; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 0;">
          <button class="btn-secondary btn-block" onclick="showGetAnotherQuickFixModal();" style="width: 100%; padding: 14px 24px; font-size: 16px; font-weight: 700; min-width: 0;">
            <span style="color: #ffeb3b !important; display: inline-block; text-shadow: -2px -2px 0px #666, 2px -2px 0px #666, -2px 2px 0px #666, 2px 2px 0px #666, 0 0 15px #ffeb3b, 0 0 25px #ffeb3b, 0 0 35px #ffeb3b; filter: brightness(1.5) saturate(2) !important; font-weight: bold; -webkit-text-stroke: 1px #666; text-stroke: 1px #666;">⚡</span> Get Another QuickFix - $1.99
          </button>
          <p style="margin: 8px 0 0 0; font-size: 12px; color: #6b7280; text-align: center; font-weight: 400;">One-time scan & fix</p>
        </div>
        <div style="flex: 1; min-width: 0;">
          <button class="btn-success btn-block" onclick="showProUpsell();" style="width: 100%; background: #00a8e8; color: white; border: none; padding: 14px 24px; font-size: 16px; font-weight: 700; min-width: 0;">
            💎 Get Pro - $9.99/mo
          </button>
          <p style="margin: 8px 0 0 0; font-size: 12px; color: #6b7280; text-align: center; font-weight: 400;">500 scans/month. Scan & Fix til its Chef's Kiss ✨</p>
        </div>
      </div>
    `;
    disclaimer = "";
  } else {
    // HIGH RISK (Hella Sus)
    riskLevel = 'high-risk';
    urgencyBanner = ``;
    pitchTitle = "";
    pitchCopy = `<div style="text-align: center; margin-bottom: 20px; padding: 16px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
        <p style="margin: 0 0 8px 0; font-size: 14px; font-weight: 400; color: #374151; line-height: 1.5;">⚠️ Your score's still high because some flagged words weren't fixed.</p>
        <p style="margin: 0 0 8px 0; font-size: 14px; font-weight: 400; color: #374151; line-height: 1.5;">QuickFix only works when you apply the suggested swaps — that's how you get the lowest, safest score.</p>
        <p style="margin: 0; font-size: 14px; font-weight: 400; color: #374151; line-height: 1.5;">Run another QuickFix to finish the clean-up, or go Pro and tweak it till it's chef's kiss. ✨</p>
      </div>`;
    scoreDisplay = "";
    buttons = `
      <div style="display: flex; gap: 12px; width: 100%; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 0;">
          <button onclick="showGetAnotherQuickFixModal();" style="width: 100%; padding: 14px 24px; font-size: 16px; font-weight: 700; min-width: 0; background: #ff6b00; color: white; border: none; border-radius: 8px; cursor: pointer;">
            <span style="color: #ffeb3b !important; display: inline-block; text-shadow: -2px -2px 0px #666, 2px -2px 0px #666, -2px 2px 0px #666, 2px 2px 0px #666, 0 0 15px #ffeb3b, 0 0 25px #ffeb3b, 0 0 35px #ffeb3b; filter: brightness(1.5) saturate(2) !important; font-weight: bold; -webkit-text-stroke: 1px #666; text-stroke: 1px #666;">⚡</span> Get Another QuickFix - $1.99
          </button>
          <p style="margin: 8px 0 0 0; font-size: 12px; color: #6b7280; text-align: center; font-weight: 400;">One-time scan & fix</p>
        </div>
        <div style="flex: 1; min-width: 0;">
          <button onclick="showProUpsell();" style="width: 100%; background: #00a8e8; color: white; border: none; padding: 14px 24px; font-size: 16px; font-weight: 700; min-width: 0; border-radius: 8px; cursor: pointer;">
            💎 Get Pro - $9.99/mo
          </button>
          <p style="margin: 8px 0 0 0; font-size: 12px; color: #6b7280; text-align: center; font-weight: 400;">500 scans/month. Scan & Fix til its Chef's Kiss ✨</p>
        </div>
      </div>
    `;
    disclaimer = "";
  }
  
  ctaContainer.innerHTML = `
    ${urgencyBanner ? `<div class="urgency-banner ${riskLevel}">
      <div class="urgency-text">${urgencyBanner}</div>
    </div>` : ''}
    
    ${pitchCopy ? pitchCopy : ''}
    
    <div class="pitch-section">
      <div class="pitch-title">${pitchTitle}</div>
      ${pitchCopy && !pitchCopy.includes('Your score\'s still high') ? `<p class="pitch-copy">${pitchCopy}</p>` : ''}
      <div class="score-display ${riskLevel}">${scoreDisplay}</div>
      ${score <= 30 ? `<div style="text-align: center; margin-top: 44px;">
        <img src="https://i.postimg.cc/JhsvMWLJ/Lil-Sus-Trans-Bg.png" alt="Lil Sus" style="width: 240px; height: auto; display: block; margin: 0 auto 16px auto; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">
        <div style="font-size: 28px; font-weight: 700; color: #2ecc71;">Now, Turn It In! 🎉</div>
      </div>` : ''}
    </div>
    
    ${score > 30 && score < 70 ? `<div style="text-align: center; margin-bottom: 20px; padding: 16px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
        ${(appState.isProUser || false) ? `<p style="margin: 0 0 8px 0; font-size: 14px; font-weight: 400; color: #374151; line-height: 1.5;">⚠️ Your score's still high because some flagged words weren't fixed.</p>
        <p style="margin: 0 0 8px 0; font-size: 14px; font-weight: 400; color: #374151; line-height: 1.5;">Pro only works when you apply the suggested swaps — that's how you get the lowest, safest score.</p>
        <p style="margin: 0; font-size: 14px; font-weight: 400; color: #374151; line-height: 1.5;">Run another scan to tweak it till it's chef's kiss. ✨</p>` : `<p style="margin: 0 0 8px 0; font-size: 14px; font-weight: 400; color: #374151; line-height: 1.5;">⚠️ Your score's still high because some flagged words weren't fixed.</p>
        <p style="margin: 0 0 8px 0; font-size: 14px; font-weight: 400; color: #374151; line-height: 1.5;">QuickFix only works when you apply the suggested swaps — that's how you get the lowest, safest score.</p>
        <p style="margin: 0; font-size: 14px; font-weight: 400; color: #374151; line-height: 1.5;">Run another QuickFix to finish the clean-up, or go Pro and tweak it till it's chef's kiss. ✨</p>`}
      </div>
      <div class="copy-anyway-cta" style="text-align: center; margin: 24px 0 20px 0; padding-bottom: 48px;">
        <button class="copy-btn" onclick="copyQuickFixResult()" style="background: white; color: #0b0646; border: 1px solid #0b0646; padding: 14px 24px; font-size: 16px; font-weight: 700; cursor: pointer; border-radius: 8px; width: 100%; margin-bottom: 8px;">😬 Nah, I'll Copy It Anyway</button>
        <p class="not-recommended" style="margin: 0; font-size: 13px; color: #6b7280; font-weight: 400;">⚠️ Not recommended — detectors can still flag this. You can submit it, but your score isn't fully optimized yet.</p>
      </div>` : ''}
    ${score >= 70 ? `<div class="copy-anyway-cta" style="text-align: center; margin: -52px 0 20px 0; padding-bottom: 48px;">
      <button class="copy-btn" onclick="copyQuickFixResult()" style="background: white; color: #0b0646; border: 1px solid #0b0646; padding: 14px 24px; font-size: 16px; font-weight: 700; cursor: pointer; border-radius: 8px; width: 100%; margin-bottom: 8px;">😬 Nah, I'll Copy It Anyway</button>
      <p class="not-recommended" style="margin: 0; font-size: 13px; color: #6b7280; font-weight: 400;">⚠️ Not recommended — detectors can still flag this. You can submit it, but your score isn't fully optimized yet.</p>
    </div>` : ''}
    
    ${score > 30 && !(appState.isProUser || false) ? `<div style="text-align: center; margin: 0 0 24px 0; padding: 0 0 24px 0;">
      <h3 style="margin: 0; font-size: 20px; font-weight: 700; color: #374151;">So, What's the Move?</h3>
    </div>` : ''}
    
    ${!(appState.isProUser || false) ? `
    <div class="cta-button-group">
      ${buttons}
    </div>
    ` : ''}
    
    <div class="footer-disclaimer">${disclaimer}</div>
    
    <!-- Back buttons removed from here - they're in the static HTML below with correct order -->
  `;
  
  // Re-initialize tooltips for dynamically generated buttons
  setTimeout(() => {
    ctaContainer.querySelectorAll('[data-tooltip]').forEach(button => {
      button.addEventListener('mouseenter', showTooltip);
      button.addEventListener('mouseleave', hideTooltip);
      button.addEventListener('mousemove', updateTooltipPosition);
    });
  }, 100);
}

// PRO: Dynamic messaging for Step 8 (mirrors QuickFix but uses Pro IDs)

// QuickFix AI Detection Engine - IMPROVED
const AIDetectionEngine = {
  patterns: {
    highRisk: [
      { pattern: "unprecedented levels", explanation: "ChatGPT LOVES this one. Detectors might too 👀", fix: "exceptional results", impact: 32 },
      { pattern: "cutting-edge", explanation: "Overused and generic. Screams robot", fix: "innovative", impact: 22 },
      { pattern: "leverage", explanation: "Corporate buzzword that AI detectors flag instantly", fix: "use", impact: 17 },
      { pattern: "utilize", explanation: "Fancy word that AI loves. Sounds robotic", fix: "use", impact: 15 },
      { pattern: "in conclusion", explanation: "Classic essay bot phrase. Too predictable", fix: "to wrap things up", impact: 20 },
      { pattern: "it is important to note", explanation: "AI-generated filler. Get straight to the point", fix: "note that", impact: 18 },
      { pattern: "the data suggests", explanation: "Too formal and AI-sounding", fix: "the evidence shows", impact: 16 }
    ],
    mediumRisk: [
      { pattern: "furthermore", explanation: "Robotic transition word. Try something more natural", fix: "also", impact: 12 },
      { pattern: "thus", explanation: "Too formal for casual writing", fix: "so", impact: 10 },
      { pattern: "however", explanation: "Academic tone that can trigger detectors", fix: "but", impact: 8 },
      { pattern: "demonstrate", explanation: "Academic jargon that AI overuses", fix: "show", impact: 14 },
      { pattern: "significant", explanation: "Common in AI-generated content", fix: "important", impact: 11 }
    ]
  },

  calculateScore(text) {
    console.log('🔍 AIDetectionEngine.calculateScore - input length:', text.length);
    let score = 20; // Base score
    
    let highRiskCount = 0;
    let mediumRiskCount = 0;
    
    this.patterns.highRisk.forEach(item => {
      const regex = new RegExp(item.pattern, 'gi');
      const matches = text.match(regex);
      if (matches) {
        highRiskCount += matches.length;
        score += matches.length * 8;
      }
    });
    
    this.patterns.mediumRisk.forEach(item => {
      const regex = new RegExp(item.pattern, 'gi');
      const matches = text.match(regex);
      if (matches) {
        mediumRiskCount += matches.length;
        score += matches.length * 4;
      }
    });
    
    // Adjust scoring to better detect obviously AI-generated text
    // More flags = higher score, with better mapping to UI thresholds (0-29, 30-69, 70-100)
    const totalFlags = highRiskCount + mediumRiskCount;
    if (totalFlags > 10) {
      // Heavily AI-generated text should score 70+
      score = Math.max(score, 70 + Math.min(20, (totalFlags - 10) * 2));
    } else if (totalFlags > 5) {
      // Moderately AI-generated text should score 30-69
      score = Math.max(score, 30 + Math.min(40, (totalFlags - 5) * 4));
    }
    
    const finalScore = Math.min(100, score);
    console.log('🔍 AIDetectionEngine.calculateScore - high risk:', highRiskCount, 'medium risk:', mediumRiskCount, 'final score:', finalScore);
    return finalScore;
  },

  detectFlags(text) {
    console.log('🔍 AIDetectionEngine.detectFlags - input length:', text.length);
    const flags = [];
    
    this.patterns.highRisk.forEach(item => {
      const regex = new RegExp(item.pattern, 'gi');
      const matches = text.match(regex);
      if (matches) {
        matches.forEach(match => {
          flags.push({
            phrase: match,
            explanation: item.explanation,
            suggestedFix: item.fix,
            severity: 'high',
            impact: item.impact
          });
        });
      }
    });
    
    this.patterns.mediumRisk.forEach(item => {
      const regex = new RegExp(item.pattern, 'gi');
      const matches = text.match(regex);
      if (matches) {
        matches.forEach(match => {
          flags.push({
            phrase: match,
            explanation: item.explanation,
            suggestedFix: item.fix,
            severity: 'medium',
            impact: item.impact
          });
        });
      }
    });
    
    console.log('🔍 AIDetectionEngine.detectFlags - flags found:', flags.length);
    return flags;
  },

  applyFixes(text, flags) {
    let fixedText = text;
    
  flags.forEach((flag, index) => {
    console.log('Applying fix', index, ':', flag.phrase, '→', flag.suggestedFix);
      const regex = new RegExp(flag.phrase.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
      fixedText = fixedText.replace(regex, flag.suggestedFix);
    });
    
    return fixedText;
  },

  // NEW: Complete rewrite function
  completeRewrite(text) {
    // More aggressive rewriting for complete overhaul
    let rewritten = text;
    
    // Replace common AI patterns with more human alternatives
    const rewriteMap = {
      "unprecedented levels": "remarkable results",
      "cutting-edge": "innovative",
      "leverage": "use",
      "utilize": "use", 
      "in conclusion": "to sum up",
      "it is important to note": "note that",
      "the data suggests": "the evidence shows",
      "furthermore": "additionally",
      "thus": "so",
      "however": "but",
      "demonstrate": "show",
      "significant": "important",
      "moreover": "also",
      "consequently": "as a result",
      "nevertheless": "still",
      "therefore": "so",
      "hence": "so"
    };
    
    Object.keys(rewriteMap).forEach(pattern => {
      const regex = new RegExp(pattern, 'gi');
      rewritten = rewritten.replace(regex, rewriteMap[pattern]);
    });
    
    return rewritten;
  }
};

// Update dynamic flag counts across all buttons
function updateDynamicFlagCounts(flagCount) {
  const totalFlagCount1 = document.getElementById('totalFlagCount');
  const totalFlagCount2 = document.getElementById('totalFlagCount2');
  const totalFlagCount3 = document.getElementById('totalFlagCount3');
  const quickfixCount = document.getElementById('quickfixCount');
  const remainingCount = document.getElementById('remainingCount');
  
  // Update button text
  if (totalFlagCount1) totalFlagCount1.textContent = flagCount;
  if (totalFlagCount2) totalFlagCount2.textContent = flagCount;
  if (totalFlagCount3) totalFlagCount3.textContent = flagCount;
  
  // Update banner text - QuickFix finds ALL flags
  if (quickfixCount) {
    quickfixCount.textContent = flagCount;
    // Make count green when it's 0
    if (flagCount === 0) {
      quickfixCount.style.color = '#2ecc71';
    } else {
      quickfixCount.style.color = '#dc2626';
    }
  }
  if (remainingCount) remainingCount.textContent = 0;
  
  // Update banner text
  const disclaimer = document.querySelector('.disclaimer');
  if (disclaimer) {
    disclaimer.innerHTML = `🎉 QuickFix found all ${flagCount} AI-trigger words in your essay. Fix them all and drop your score! 🚀`;
  }
  
  // Update button visibility and text based on flag count
  const completeRewriteButtons = document.querySelectorAll('#completeRewrite, [onclick="completeRewrite()"]');
  completeRewriteButtons.forEach(button => {
    if (flagCount <= 3) {
      // If 3 or fewer flags, hide the Pro scan button and show Pro monthly upsell
      button.style.display = 'none';
    } else {
      // If more than 3 flags, show the Pro scan button
      button.style.display = 'block';
      button.innerHTML = `✨ See All ${flagCount} Flags Fixed 👉 (Your Pro Scan!)`;
    }
  });
  
  // Show Pro monthly upsell button when all flags are found
  if (flagCount <= 3) {
    const upsellSection = document.querySelector('.upsell-section');
    if (upsellSection) {
      upsellSection.style.display = 'block';
    }
  }
}

// FIX 1: Update selected count function - NOW COUNTS WORDS, NOT CHECKBOXES
function updateSelectedCount() {
  // Count how many checkboxes are checked (simplified - just count checked boxes)
  let checkedCount = 0;
  document.querySelectorAll('.fix-option input[type="checkbox"]:checked').forEach(checkbox => {
    checkedCount++;
  });
  
  const totalCount = document.querySelectorAll('.fix-option input[type="checkbox"]').length;
  const selectedCountElement = document.getElementById('selectedCount');
  
  if (selectedCountElement) {
    selectedCountElement.textContent = checkedCount;
  }
  
  // Update apply button text - check if Pro mode
  const isPro = appState.isProUser || false;
  const applyButton = document.getElementById('applySelectedFixes');
  if (applyButton) {
    if (isPro) {
      applyButton.innerHTML = `✅ Apply Pro Fixes (<span id="selectedCount">${checkedCount}</span>) and Get Your New Score`;
      // Change button color to Pro blue
      applyButton.style.setProperty('background', '#00a8e8', 'important');
    } else {
      applyButton.innerHTML = `✅ Apply QuickFixes (<span id="selectedCount">${checkedCount}</span>) and Get Your New Score`;
      // Keep orange for QuickFix
      applyButton.style.setProperty('background', '#ff6b00', 'important');
    }
  }
  
  // Update Select All checkbox state
  const selectAllCheckbox = document.getElementById('selectAllFixes');
  if (selectAllCheckbox) {
    selectAllCheckbox.checked = checkedCount === totalCount && totalCount > 0;
  }
}
// ===== REAL-TIME SCORE PREVIEW =====
// Position banner anchored to the scrollbar position in the container
function positionBannerToTarget(previewBox, targetElement, bannerColor) {
  if (!previewBox || !targetElement) return;
  
  const banner = document.getElementById('scorePreviewBanner');
  if (!banner) return;
  
  // Get the scrollable fixSelection container
  const fixSelectionContainer = document.getElementById('fixSelection');
  if (!fixSelectionContainer) return;
  
  // Check if container is collapsed/hidden - if so, position relative to button group instead
  const isContainerCollapsed = fixSelectionContainer.style.display === 'none' || 
                                fixSelectionContainer.offsetHeight === 0 ||
                                getComputedStyle(fixSelectionContainer).display === 'none';
  
  // Get container position and scroll info (only if visible)
  let containerRect, containerScrollTop, containerScrollHeight, containerClientHeight;
  
  if (isContainerCollapsed) {
    // Container is collapsed - position relative to toggle header or button group
    const toggleHeader = document.querySelector('.toggle-header');
    const buttonGroup = document.getElementById('quickfixButtonGroup');
    
    if (toggleHeader) {
      containerRect = toggleHeader.getBoundingClientRect();
    } else if (buttonGroup) {
      containerRect = buttonGroup.getBoundingClientRect();
    } else {
      return; // Can't position without a reference
    }
    
    containerScrollTop = 0;
    containerScrollHeight = containerRect.height;
    containerClientHeight = containerRect.height;
  } else {
    containerRect = fixSelectionContainer.getBoundingClientRect();
    containerScrollTop = fixSelectionContainer.scrollTop;
    containerScrollHeight = fixSelectionContainer.scrollHeight;
    containerClientHeight = fixSelectionContainer.clientHeight;
  }
  
  // Get target element position relative to viewport
  const targetRect = targetElement.getBoundingClientRect();
  const windowWidth = window.innerWidth;
  
  // Longer banner dimensions
  const bannerWidth = 320;
  const bannerHeight = 90;
  const spacing = 20;
  
  // Calculate target center point
  const targetCenterX = targetRect.left + targetRect.width / 2;
  const targetCenterY = targetRect.top + targetRect.height / 2;
  
  // Position banner to float - aligned with scrollbar thumb center
  let bannerX = containerRect.right + spacing;
  
  // Calculate scrollbar thumb position and align banner with its center
  // The banner should stay in the middle of the scrollbar thumb at all times
  const scrollableHeight = containerScrollHeight - containerClientHeight;
  let scrollbarThumbCenter = 0;
  
  if (scrollableHeight > 0) {
    // Calculate scroll ratio (0 to 1)
    const scrollRatio = containerScrollTop / scrollableHeight;
    // Calculate where the scrollbar thumb center is positioned
    // Thumb typically takes up a percentage of the track based on content ratio
    const contentRatio = containerClientHeight / containerScrollHeight;
    const thumbHeight = containerClientHeight * contentRatio;
    const trackHeight = containerClientHeight;
    const availableTrack = trackHeight - thumbHeight;
    // Thumb center position within the scrollbar track
    scrollbarThumbCenter = containerRect.top + (scrollRatio * availableTrack) + (thumbHeight / 2);
  } else {
    // No scrolling needed, position at middle of container
    scrollbarThumbCenter = containerRect.top + (containerClientHeight / 2);
  }
  
  // Position banner centered on the scrollbar thumb
  let bannerY = scrollbarThumbCenter - (bannerHeight / 2);
  
  // Ensure banner doesn't go off screen to the right
  if (bannerX + bannerWidth > windowWidth - 20) {
    // Position to the left instead
    bannerX = containerRect.left - bannerWidth - spacing;
  }
  
  // Ensure banner stays within viewport horizontally
  bannerX = Math.max(10, Math.min(bannerX, windowWidth - bannerWidth - 10));
  
  // CRITICAL: Constrain banner to stay within the visible container bounds
  // Don't let it go below the container's bottom or above the container's top
  const containerTop = containerRect.top;
  const containerBottom = containerRect.bottom;
  const minBannerY = containerTop + 5; // Stay at least 5px from container top
  const maxBannerY = containerBottom - bannerHeight - 5; // Stay at least 5px from container bottom
  
  // Clamp bannerY to container bounds
  bannerY = Math.max(minBannerY, Math.min(bannerY, maxBannerY));
  
  // Set banner position - floating, moves with scroll
  // Use requestAnimationFrame for smooth updates
  requestAnimationFrame(() => {
    previewBox.style.left = bannerX + 'px';
    previewBox.style.top = bannerY + 'px';
  });
  
  // Pointer removed - no longer needed
  
  // Update banner background color
  banner.style.background = bannerColor;
}

// Calculate and display estimated score based on current selections
function updateScorePreview() {
  // Only show on Step 2 (fix selection page)
  const quickfixStep2 = document.getElementById('quickfixStep2');
  if (!quickfixStep2 || quickfixStep2.style.display === 'none') {
    const previewBox = document.getElementById('scorePreviewBox');
    if (previewBox) {
      previewBox.style.display = 'none';
      previewBox.style.visibility = 'hidden';
      previewBox.style.opacity = '0';
    }
    return;
  }
  
  // Check if we have required data
  if (!appState.quickfixOriginalText || !appState.quickfixFlags || !appState.quickfixOriginalScore) {
    return;
  }
  
  // Get all selected fixes
  const selectedFlags = [];
  document.querySelectorAll('.fix-option input[type="checkbox"]:checked').forEach(checkbox => {
    const index = parseInt(checkbox.closest('.fix-option').dataset.index);
    if (index >= 0 && index < appState.quickfixFlags.length && appState.quickfixFlags[index]) {
      const flag = { ...appState.quickfixFlags[index] };
      
      // Check if user typed a custom word (prioritize custom input over button selection)
      const customInput = document.querySelector(`.custom-word-field[data-flag-index="${index}"]`);
      if (customInput && customInput.value.trim()) {
        flag.suggestedFix = customInput.value.trim();
      } else {
        // Only use button selection if no custom word is entered
        const selectedWordBtn = document.querySelector(`.alt-word-btn[data-flag-index="${index}"].selected-word`);
        if (selectedWordBtn) {
          flag.suggestedFix = selectedWordBtn.getAttribute('data-word');
        }
      }
      
      selectedFlags.push(flag);
    }
  });
  
  // Determine target element to point to - use the visible/selected fix option
  let targetElement = null;
  
  // If fixes are selected, point to the last clicked fix option (if it's visible)
  if (selectedFlags.length > 0 && appState.lastClickedFixOption) {
    const fixOption = document.querySelector(`.fix-option[data-index="${appState.lastClickedFixOption}"]`);
    if (fixOption) {
      const rect = fixOption.getBoundingClientRect();
      // Check if element is visible in viewport
      if (rect.top < window.innerHeight && rect.bottom > 0) {
        targetElement = fixOption;
      }
    }
  }
  
  // If no visible target found, find the first visible checked fix option
  if (!targetElement) {
    document.querySelectorAll('.fix-option input[type="checkbox"]:checked').forEach(checkbox => {
      if (!targetElement) {
        const fixOption = checkbox.closest('.fix-option');
        if (fixOption) {
          const rect = fixOption.getBoundingClientRect();
          // Check if element is visible in viewport
          if (rect.top < window.innerHeight && rect.bottom > 0) {
            targetElement = fixOption;
          }
        }
      }
    });
  }
  
  // If still no target found, find the first visible fix option
  if (!targetElement) {
    document.querySelectorAll('.fix-option').forEach(fixOption => {
      if (!targetElement) {
        const rect = fixOption.getBoundingClientRect();
        // Check if element is visible in viewport
        if (rect.top < window.innerHeight && rect.bottom > 0) {
          targetElement = fixOption;
        }
      }
    });
  }
  
  // If no target found, point to CTA button
  if (!targetElement) {
    targetElement = document.getElementById('quickfixButtonGroup');
  }
  
  // If no fixes selected, show ORIGINAL score (not hide)
  if (selectedFlags.length === 0) {
    const previewBox = document.getElementById('scorePreviewBox');
    const previewScore = document.getElementById('previewScore');
    const previewAfterFixesScore = document.getElementById('previewAfterFixesScore');
    const previewAfterFixesAsterisk = document.getElementById('previewAfterFixesAsterisk');
    const previewImprovement = document.getElementById('previewImprovement');
    
    if (previewBox && previewScore && previewAfterFixesScore && previewAfterFixesAsterisk && previewImprovement && targetElement) {
      // Show ORIGINAL score when nothing is selected
      const originalScore = appState.quickfixOriginalScore;
      previewScore.textContent = `${originalScore}%`;
      
      // Clear the "After Selected Fix" score, asterisk, and improvement when no fixes selected
      previewAfterFixesScore.textContent = '';
      previewAfterFixesAsterisk.textContent = '';
      previewImprovement.textContent = '';
      
      // Color code background based on original score
      let bannerColor = '#2ecc71';
      if (originalScore <= 30) {
        bannerColor = '#2ecc71';
      } else if (originalScore <= 69) {
        bannerColor = '#f5a623';
      } else {
        bannerColor = '#dc2626';
      }
      
      // Position banner pointing to target
      positionBannerToTarget(previewBox, targetElement, bannerColor);
      
      // Show the box with proper visibility and opacity
      previewBox.style.display = 'block';
      previewBox.style.visibility = 'visible';
      previewBox.style.opacity = '1';
    }
    return;
  }
  
  // Apply fixes to get modified text
  const fixedText = AIDetectionEngine.applyFixes(appState.quickfixOriginalText, selectedFlags);
  
  // Calculate new score
  const newScore = AIDetectionEngine.calculateScore(fixedText);
  const improvement = appState.quickfixOriginalScore - newScore;
  const improvementPercent = Math.round((improvement / appState.quickfixOriginalScore) * 100);
  
  // Update preview box
  const previewBox = document.getElementById('scorePreviewBox');
  const previewScore = document.getElementById('previewScore');
  const previewAfterFixesScore = document.getElementById('previewAfterFixesScore');
  const previewAfterFixesAsterisk = document.getElementById('previewAfterFixesAsterisk');
  const previewImprovement = document.getElementById('previewImprovement');
  
  if (previewBox && previewScore && previewAfterFixesScore && previewAfterFixesAsterisk && previewImprovement && targetElement) {
    // Show original score in first line (always shows current score)
    const originalScore = appState.quickfixOriginalScore;
    previewScore.textContent = `${originalScore}%`;
    
    // Show new score in "After Selected Fix" line with asterisk
    previewAfterFixesScore.textContent = `${newScore}%`;
    previewAfterFixesAsterisk.textContent = '*';
    
    // Show improvement percentage
    if (improvement > 0) {
      previewImprovement.textContent = `↓ ${improvement}% improvement`;
      previewImprovement.style.opacity = '0.9';
    } else {
      previewImprovement.textContent = '';
    }
    
    // Color code background based on NEW score (after fixes)
    let bannerColor = '#2ecc71';
    if (newScore <= 30) {
      bannerColor = '#2ecc71';
    } else if (newScore <= 69) {
      bannerColor = '#f5a623';
    } else {
      bannerColor = '#dc2626';
    }
    
    // Position banner pointing to target element
    positionBannerToTarget(previewBox, targetElement, bannerColor);
    
    // Show the box with proper visibility and opacity
    previewBox.style.display = 'block';
    previewBox.style.visibility = 'visible';
    previewBox.style.opacity = '1';
  }
}

// Check if all selected fixes are using their best words
function checkIfAllBestWords() {
  const selectAllCheckbox = document.getElementById('selectAllFixes');
  if (!selectAllCheckbox) return;
  
  // Get all checkboxes (checked and unchecked)
  const allCheckboxes = document.querySelectorAll('.fix-option input[type="checkbox"]');
  const checkedBoxes = document.querySelectorAll('.fix-option input[type="checkbox"]:checked');
  
  // First check: ALL fixes must be checked
  if (checkedBoxes.length === 0 || checkedBoxes.length !== allCheckboxes.length) {
    // Not all fixes are selected - uncheck "Use Best Words"
    selectAllCheckbox.checked = false;
    return;
  }
  
  // Second check: All checked fixes must be using their best words
  let allUsingBestWords = true;
  
  checkedBoxes.forEach(checkbox => {
    const index = parseInt(checkbox.closest('.fix-option').dataset.index);
    if (index >= 0 && index < appState.quickfixFlags.length) {
      const flag = appState.quickfixFlags[index];
      const suggestionsContainer = document.querySelector(`.suggestions-container[data-flag-index="${index}"]`);
      
      if (suggestionsContainer) {
        const originalBestWord = suggestionsContainer.getAttribute('data-original-best-word');
        
        // Check if user typed a custom word
        const customInput = document.querySelector(`.custom-word-field[data-flag-index="${index}"]`);
        if (customInput && customInput.value.trim()) {
          // Custom word = not using best word
          allUsingBestWords = false;
          return;
        }
        
        // Check if a word button is selected
        const selectedWordBtn = document.querySelector(`.alt-word-btn[data-flag-index="${index}"].selected-word`);
        if (selectedWordBtn) {
          const selectedWord = selectedWordBtn.getAttribute('data-word');
          // If selected word doesn't match original best word, not using best word
          if (selectedWord !== originalBestWord) {
            allUsingBestWords = false;
            return;
          }
        } else {
          // No word selected = not using best word
          allUsingBestWords = false;
          return;
        }
      }
    }
  });
  
  // Update checkbox based on whether ALL fixes are checked AND all are using best words
  selectAllCheckbox.checked = allUsingBestWords;
}

// Helper function to select the best word for a specific flag
function selectBestWordForFlag(flagIndex, bestWord) {
  // Find the button with this exact word
  const bestWordBtn = document.querySelector(`.alt-word-btn[data-flag-index="${flagIndex}"][data-word="${bestWord}"]`);
  
  if (bestWordBtn) {
    // Update the flag's suggestedFix
    if (appState.quickfixFlags && appState.quickfixFlags[flagIndex]) {
      appState.quickfixFlags[flagIndex].suggestedFix = bestWord;
    }
    
    // Visual feedback - deselect all buttons for this flag
    const allBtnsForFlag = document.querySelectorAll(`.alt-word-btn[data-flag-index="${flagIndex}"]`);
    allBtnsForFlag.forEach(b => {
      b.style.background = '#e0f2fe';
      b.style.borderColor = '#2ecc71';
      b.style.color = '#0c4a6e';
      b.style.fontWeight = '500';
      b.classList.remove('selected-word');
    });
    
    // Highlight selected button
    bestWordBtn.style.background = '#2ecc71';
    bestWordBtn.style.color = 'white';
    bestWordBtn.style.borderColor = '#2ecc71';
    bestWordBtn.style.fontWeight = '600';
    bestWordBtn.classList.add('selected-word');
  }
}

// Select All functionality
function toggleSelectAll() {
  const selectAllCheckbox = document.getElementById('selectAllFixes');
  const fixCheckboxes = document.querySelectorAll('.fix-option input[type="checkbox"]');
  
  if (selectAllCheckbox) {
    const isChecked = selectAllCheckbox.checked;
    
    if (isChecked) {
      // QuickFix Mode: Ensure the section is expanded first
      const fixSelection = document.getElementById('fixSelection');
      if (fixSelection && fixSelection.style.display === 'none') {
        fixSelection.style.display = 'block';
      }
      
      // Auto-select all checkboxes AND select first word button for each
      fixCheckboxes.forEach((checkbox, index) => {
        checkbox.checked = true;
        
        // Add green background to the fix-option box
        const fixOption = checkbox.closest('.fix-option');
        if (fixOption) {
          fixOption.style.background = '#f0fdf4';
          fixOption.style.borderColor = '#00a8e8';
          fixOption.classList.add('selected');
        }
        
        // Find the ORIGINAL BEST word for this flag
        const suggestionsContainer = document.querySelector(`.suggestions-container[data-flag-index="${index}"]`);
        let originalBestWord = null;
        
        if (suggestionsContainer) {
          // Get the stored original best word
          originalBestWord = suggestionsContainer.getAttribute('data-original-best-word');
        }
        
        // If we have the original best word, try to find and select it
        if (originalBestWord) {
          // Check if the button with the original best word exists
          const bestWordBtn = document.querySelector(`.alt-word-btn[data-flag-index="${index}"][data-word="${originalBestWord}"]`);
          
          if (bestWordBtn) {
            // Button exists - select it directly
            selectBestWordForFlag(index, originalBestWord);
          } else {
            // Button doesn't exist - alternatives are showing, need to restore first
            const originalPhrase = suggestionsContainer ? suggestionsContainer.getAttribute('data-original-phrase') : null;
            if (originalPhrase) {
              restoreOriginalSuggestions(index, originalPhrase, originalBestWord);
              // Wait for DOM to update, then select the best word
              setTimeout(() => {
                selectBestWordForFlag(index, originalBestWord);
              }, 200);
            }
          }
        } else {
          // Fallback: use first button if no original best word stored
          const firstWordBtn = document.querySelector(`.alt-word-btn[data-flag-index="${index}"]`);
          if (firstWordBtn) {
            selectBestWordForFlag(index, firstWordBtn.getAttribute('data-word'));
          }
        }
        
        // Update score preview after selecting best words
        setTimeout(() => {
          updateScorePreview();
          // After selecting all best words, ensure checkbox stays checked
          checkIfAllBestWords();
        }, 200);
      });
    } else {
      // DIY Mode: Uncheck all checkboxes and deselect all words
      // Keep the section visible even when unchecking
      const fixSelection = document.getElementById('fixSelection');
      // Force the section to be visible in DIY mode so users can still see options
      if (fixSelection) {
        fixSelection.style.display = 'block';
      }
      
      fixCheckboxes.forEach((checkbox, index) => {
        checkbox.checked = false;
        
        // Remove green background from the fix-option box
        const fixOption = checkbox.closest('.fix-option');
        if (fixOption) {
          fixOption.style.background = '#f8f9fa';
          fixOption.style.borderColor = '#e5e7eb';
          fixOption.classList.remove('selected');
        }
        
        const allBtnsForFlag = document.querySelectorAll(`.alt-word-btn[data-flag-index="${index}"]`);
        allBtnsForFlag.forEach(b => {
          b.style.background = '#e0f2fe';
          b.style.borderColor = '#2ecc71';
          b.style.color = '#0c4a6e';
          b.style.fontWeight = '500';
          b.classList.remove('selected-word');
        });
      });
      
      // Update score preview after deselecting all
      setTimeout(() => {
        updateScorePreview();
      }, 100);
    }
    
    updateSelectedCount();
  }
}

// QuickFix Flow Functions - IMPROVED
function switchToQuickFix() {
  // Reset to QuickFix mode
  appState.isProUser = false;
  updateStepLabels(false);
  
  // Hide all views
  document.getElementById('inputSection').style.display = 'none';
  document.getElementById('resultsContainer').style.display = 'none';
  document.getElementById('resultsContainer').classList.remove('show');
  document.getElementById('quickfixFlow').style.display = 'block';
  
  document.body.classList.remove('modal-open');
  showQuickFixStep(1);
  
  // Auto-populate QuickFix screen with text from main essay input
  const mainInput = document.getElementById('essayInput');
  const quickfixInput = document.getElementById('quickfixEssayInput');
  let textWasAutoPopulated = false;
  if (mainInput && mainInput.value.trim() && quickfixInput) {
    quickfixInput.value = mainInput.value.trim();
    textWasAutoPopulated = true;
    const charCountEl = document.getElementById('quickfixFlowCharCount');
    if (charCountEl) {
      charCountEl.textContent = quickfixInput.value.length;
    }
  }
  
  // Show reminder modal about 5000 character limit (only if text was auto-populated and might be incomplete)
  if (textWasAutoPopulated && quickfixInput && quickfixInput.value.length <= 500) {
    showQuickFixReminderModal();
  }
  
  document.getElementById('quickfixFlow').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Handle Pro button click from main page
function startProCTA() {
  // Check authorship first
  const authorshipCheckbox = document.getElementById('authorshipCheckbox');
  if (!authorshipCheckbox || !authorshipCheckbox.checked) {
    showAuthorshipReminder();
    return;
  }
  
  // Set Pro mode BEFORE switching
  appState.isProUser = true;
  updateStepLabels(true);
  
  // Now switch to Pro
  switchToPro();
}

// Make sure function is globally accessible
window.startProCTA = startProCTA;

// Pro Flow Functions - Switch to Pro and preserve text
function switchToPro() {
  // Hide all views
  document.getElementById('inputSection').style.display = 'none';
  document.getElementById('resultsContainer').style.display = 'none';
  document.getElementById('resultsContainer').classList.remove('show');
  document.getElementById('quickfixFlow').style.display = 'none';
  
  document.body.classList.remove('modal-open');
  showProDashboard();
  
  // Auto-populate Pro screen with text from main essay input
  const mainInput = document.getElementById('essayInput');
  const proInput = document.getElementById('proScanInput');
  if (mainInput && mainInput.value.trim() && proInput) {
    proInput.value = mainInput.value.trim();
    const charCountEl = document.getElementById('proCharCount');
    if (charCountEl) {
      charCountEl.textContent = `${proInput.value.length} / 5,000 characters`;
    }
    // Auto-check Pro authorship checkbox if main page checkbox was checked
    const mainAuthorshipCheckbox = document.getElementById('authorshipCheckbox');
    const proAuthorshipCheckbox = document.getElementById('proAuthorshipCheckbox');
    if (mainAuthorshipCheckbox && mainAuthorshipCheckbox.checked && proAuthorshipCheckbox) {
      proAuthorshipCheckbox.checked = true;
    }
    
    // Trigger input event to update button state
    const inputEvent = new Event('input', { bubbles: true });
    proInput.dispatchEvent(inputEvent);
    
    // Also manually update button state immediately and after delays to ensure it's updated
    if (typeof updateProScanButtonState === 'function') {
      updateProScanButtonState();
    }
    setTimeout(() => {
      if (typeof updateProScanButtonState === 'function') {
        updateProScanButtonState();
      }
    }, 50);
    setTimeout(() => {
      if (typeof updateProScanButtonState === 'function') {
        updateProScanButtonState();
      }
    }, 300);
  }
  
  // Scroll to Pro dashboard
  const step6 = document.getElementById('quickfixStep6');
  if (step6) {
    step6.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

function showQuickFixFlow() {
  switchToQuickFix();
  
  // Reset rewrite counter
  appState.freeRewritesUsed = 0;
  updateRewriteCounter();
  
  // FIX 2: Auto-populate QuickFix screen with text from main essay input
  const mainInput = document.getElementById('essayInput');
  const quickfixInput = document.getElementById('quickfixEssayInput');
  if (mainInput && mainInput.value.trim()) {
    quickfixInput.value = mainInput.value.trim();
    document.getElementById('quickfixFlowCharCount').textContent = quickfixInput.value.length;
    
    // Auto-check QuickFix authorship checkbox if main page checkbox was checked
    const mainAuthorshipCheckbox = document.getElementById('authorshipCheckbox');
    const quickfixAuthorshipCheckbox = document.getElementById('quickfixAuthorshipCheckbox');
    if (mainAuthorshipCheckbox && mainAuthorshipCheckbox.checked && quickfixAuthorshipCheckbox) {
      quickfixAuthorshipCheckbox.checked = true;
    }
    
    // Update button state based on text length and authorship
    const startButton = document.getElementById('startQuickFix');
    if (startButton) {
      const isAuthorshipConfirmed = quickfixAuthorshipCheckbox && quickfixAuthorshipCheckbox.checked;
      if (quickfixInput.value.length >= 50 && isAuthorshipConfirmed) {
        startButton.disabled = false;
        startButton.style.opacity = '1';
        startButton.style.cursor = 'pointer';
      } else {
        startButton.disabled = true;
        startButton.style.opacity = '0.6';
        startButton.style.cursor = 'not-allowed';
      }
    }
  } else {
    // Show placeholder animation or text
    quickfixInput.placeholder = "Paste your text/essay here to get started.";
  }
  
  // FIX: Scroll to top of QuickFix form (not top of website)
  document.getElementById('quickfixFlow').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function switchToResults() {
  // Hide all views
  document.getElementById('inputSection').style.display = 'none';
  document.getElementById('quickfixFlow').style.display = 'none';
  document.getElementById('resultsContainer').style.display = 'block';
  document.getElementById('resultsContainer').classList.add('show');
  
  // CRITICAL: Remove modal state with delay to ensure it's removed
  setTimeout(() => {
    document.body.classList.remove('modal-open');
    console.log('Removed modal-open from body');
  }, 100);
  
  // Scroll
  document.getElementById('resultsContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function switchToInput() {
  // Hide all views
  document.getElementById('quickfixFlow').style.display = 'none';
  document.getElementById('resultsContainer').style.display = 'none';
  document.getElementById('resultsContainer').classList.remove('show');
  document.getElementById('inputSection').style.display = 'block';
  
  // Uncheck authorship checkbox when returning to form
  const authorshipCheckbox = document.getElementById('authorshipCheckbox');
  if (authorshipCheckbox) {
    authorshipCheckbox.checked = false;
  }
  
  document.body.classList.remove('modal-open');
  document.getElementById('inputSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
  
  // Update counter to reflect unchecked state
  updateCounter();
}

function hideQuickFixFlow() {
  // Reset Pro mode if we're leaving Pro flow
  // Only reset if we're actually in QuickFix mode (not Pro)
  const wasInProFlow = appState.isProUser;
  if (wasInProFlow) {
    // If coming from Pro flow, don't reset - let backToProDashboard handle it
    // But if explicitly called from QuickFix, reset Pro mode
    const isQuickFixUser = !appState.proSubscription || !appState.proSubscription.active;
    if (isQuickFixUser) {
      appState.isProUser = false;
      updateStepLabels(false);
    }
  } else {
    // Definitely QuickFix mode, ensure Pro mode is off
    appState.isProUser = false;
    updateStepLabels(false);
  }
  
  switchToInput();
  showQuickFixStep(1);
  
  // Clear QuickFix essay input completely
  const quickfixInput = document.getElementById('quickfixEssayInput');
  if (quickfixInput) {
    quickfixInput.value = '';
    const quickfixCharCount = document.getElementById('quickfixFlowCharCount');
    if (quickfixCharCount) quickfixCharCount.textContent = '0';
  }
  
  // Clear main essay input completely
  const essayInput = document.getElementById('essayInput');
  if (essayInput) {
    essayInput.value = '';
    updateCounter();
  }
  
  // CRITICAL: Reset appState to prevent stale data from appearing on subsequent scans
  appState.quickfixOriginalText = '';
  appState.quickfixFlags = [];
  appState.quickfixOriginalScore = 0;
  appState.quickfixFixedText = '';
  appState.quickfixNewScore = 0;
  
  // Reset flag data from regular scans too
  appState.flagData = [];
  appState.currentScore = 0;
  appState.originalText = '';
  
  // Reset all checkboxes in QuickFix flow
  const selectAllCheckbox = document.getElementById('selectAllFixes');
  if (selectAllCheckbox) {
    selectAllCheckbox.checked = false;
  }
  
  // Reset all individual fix checkboxes
  document.querySelectorAll('.fix-option input[type="checkbox"]').forEach(checkbox => {
    checkbox.checked = false;
  });
  
  // Reset all word selection buttons
  document.querySelectorAll('.alt-word-btn').forEach(btn => {
    btn.style.background = '#e0f2fe';
    btn.style.borderColor = '#2ecc71';
    btn.style.color = '#0c4a6e';
    btn.style.fontWeight = '500';
    btn.classList.remove('selected-word');
  });
  
  // Reset author checkbox
  const authorshipCheckbox = document.getElementById('authorshipCheckbox');
  if (authorshipCheckbox) {
    authorshipCheckbox.checked = false;
  }
  
}

function showQuickFixStep(stepNumber) {
  console.log('showQuickFixStep called with:', stepNumber);
  
  // FIRST: Hide ALL steps explicitly with display: none
  document.querySelectorAll('.quickfix-step').forEach(step => {
    step.classList.remove('active');
    step.style.setProperty('display', 'none', 'important');
    step.style.setProperty('opacity', '0', 'important');
    step.style.setProperty('visibility', 'hidden', 'important');
  });
  
  const stepElement = document.getElementById('quickfixStep' + stepNumber);
  console.log('Step element found:', stepElement);
  
  // CRITICAL: Clean Step 2 UI if transitioning to Step 2 to prevent stale checkboxes
  if (stepNumber === 2) {
    const fixSelection = document.getElementById('fixSelection');
    if (fixSelection) {
      fixSelection.innerHTML = ''; // Clear old fix options
      fixSelection.style.display = 'none'; // Hide it
    }
  }
  
  if (stepElement) {
    // Show ONLY the target step
    stepElement.classList.add('active');
    stepElement.style.setProperty('display', 'block', 'important');
    stepElement.style.setProperty('opacity', '1', 'important');
    stepElement.style.setProperty('visibility', 'visible', 'important');
    console.log('Step element activated and displayed');
    
    // Start rotating messages if we're on step 4
    if (stepNumber === 4) {
      startRotatingMessages();
    }
  } else {
    console.error('Step element not found for step:', stepNumber);
  }
}

// Rotating messages for step 4
const rotatingMessages = [
  "💎 Premium Results - Every Flag Found & Fixed ✨",
  "💎 Pro Member Exclusive - All Flags Fixed ✨",
  "💎 Premium Detection Complete - Ready to Turn In 🚀",
  "💎 You've Earned This - Essay is Fire 🔥",
  "💎 Pro Member Results - Absolutely Perfect 🌟",
  "Mission Accomplished - Your Essay is Perfect ✨"
];
let currentMessageIndex = 0;

// Rotating messages for clean result subtitle (score <= 30)
const cleanResultMessages = [
  "Ready to turn in! ✅",
  "All clear! 🎉",
  "Nothing to fix here! ✅",
  "You're good to go! ✨"
];
let currentCleanMessageIndex = 0;

function startRotatingMessages() {
  const messageElement = document.getElementById('rotatingMessage');
  if (!messageElement) return;
  
  // For Pro users, set premium message and don't rotate
  if (appState.isProUser || (appState.proSubscription && appState.proSubscription.active)) {
    messageElement.textContent = '💎 Premium Results - Every Flag Found & Fixed ✨';
    return; // Don't start rotation for Pro users
  }
  
  function rotateMessage() {
    // Only rotate if user is NOT in Pro mode (Pro users see premium static message)
    if (appState.isProUser || (appState.proSubscription && appState.proSubscription.active)) {
      return; // Don't rotate for Pro users - keep premium message
    }
    messageElement.style.opacity = '0';
    setTimeout(() => {
      currentMessageIndex = (currentMessageIndex + 1) % rotatingMessages.length;
      messageElement.textContent = rotatingMessages[currentMessageIndex];
      messageElement.style.opacity = '1';
    }, 500);
  }
  
  // Start rotation after 2 seconds, then every 3 seconds
  setTimeout(() => {
    setInterval(rotateMessage, 5000);
  }, 2000);
}

// Rotating messages for clean result subtitle
function startRotatingCleanMessages() {
  const scanResultsSubtitle = document.getElementById('quickfixScanResultsSubtitle');
  if (!scanResultsSubtitle) return;
  
  // Don't rotate if score is not clean
  const headerWrapper = document.getElementById('quickfixStep3HeaderWrapper');
  if (!headerWrapper) return;
  
  function rotateCleanMessage() {
    if (!scanResultsSubtitle) return;
    // Check if we're still on a clean result page
    const currentText = scanResultsSubtitle.textContent;
    if (!cleanResultMessages.includes(currentText) && !currentText.includes("You're all set")) {
      return; // Stop rotating if we're not showing clean messages anymore
    }
    
    scanResultsSubtitle.style.opacity = '0';
    setTimeout(() => {
      currentCleanMessageIndex = (currentCleanMessageIndex + 1) % cleanResultMessages.length;
      scanResultsSubtitle.textContent = cleanResultMessages[currentCleanMessageIndex];
      scanResultsSubtitle.style.opacity = '1';
    }, 300);
  }
  
  // Start rotation after 1 second, then every 3 seconds
  setTimeout(() => {
    setInterval(rotateCleanMessage, 3000);
  }, 1000);
}

// NEW: Update rewrite counter display
function updateRewriteCounter() {
  const remaining = appState.maxFreeRewrites - appState.freeRewritesUsed;
  const counter = document.getElementById('rewriteCounter');
  if (counter) {
    if (remaining > 0) {
      counter.textContent = `✨ ${remaining} free rewrite${remaining > 1 ? 's' : ''} remaining`;
      counter.style.color = '#00a8e8';
    } else {
      counter.textContent = '❌ No free rewrites left - upgrade to Pro';
      counter.style.color = '#dc2626';
    }
  }
  
  // Enable/disable complete rewrite button
  const rewriteBtn = document.getElementById('completeRewrite');
  if (rewriteBtn) {
    if (remaining > 0) {
      rewriteBtn.disabled = false;
      rewriteBtn.style.background = '#ea580c';
      rewriteBtn.innerHTML = '✨ See All <span id="totalFlagCount3">' + (appState.quickfixFlags ? appState.quickfixFlags.length : 0) + '</span> Flags Fixed 👉 (Your Pro Scan!)';
    } else {
      rewriteBtn.disabled = true;
      rewriteBtn.style.background = '#9ca3af';
      rewriteBtn.textContent = '🔒 No Free Rewrites Left';
    }
  }
}

function showWarningModal() {
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:10000;';
  
  const popup = document.createElement('div');
  popup.style.cssText = 'background:#fff;padding:30px 40px;border-radius:16px;max-width:450px;width:90%;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.3);position:relative;';
  
  popup.innerHTML = `
    <div style="font-size:48px;margin-bottom:15px;">⚡</div>
    <h3 style="color:#0b0646;margin-bottom:10px;font-size:20px;font-weight:700;">Hold Up!</h3>
    <p style="color:#6b7280;margin-bottom:10px;font-size:15px;line-height:1.5;">Paste your essay in the box so I can scan, flag & help you fix it!</p>
    <p style="color:#9ca3af;margin-bottom:20px;font-size:13px;">💡 Remember: You can paste up to 5,000 characters here</p>
    <button id="closeWarningBtn" style="background:#ea580c;color:white;border:none;padding:12px 30px;border-radius:8px;font-weight:600;font-size:14px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background='#c2410c'" onmouseout="this.style.background='#ea580c'">Got It!</button>
  `;
  
  modal.appendChild(popup);
  document.body.appendChild(modal);
  
  // Add click listener to close button
  document.getElementById('closeWarningBtn').addEventListener('click', function() {
    modal.remove();
  });
  
  // Also close when clicking outside the modal
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      modal.remove();
    }
  });
}

function startQuickFixAnalysis() {
  const text = document.getElementById('quickfixEssayInput').value.trim();
  
  // FIX: Check if text is empty and show warning
  if (text.length < 50) {
    showWarningModal();
    return;
  }
  
  appState.quickfixOriginalText = text;
  
  // Show loading state
  const button = document.getElementById('startQuickFix');
  const originalText = button.textContent;
  button.textContent = 'Scanning... 🔍';
  button.disabled = true;
  
  setTimeout(() => {
    // FIX: Use the same score calculation as free version
    const analysis = analyzeTextLocally(text);
    const detectionResult = analysis.score;
    console.log('🔍 AIDetectionEngine.detectFlags called - input length:', text.length);
    const flags = AIDetectionEngine.detectFlags(text);
    console.log('🔍 AIDetectionEngine.detectFlags result - flags count:', flags.length);
    
    appState.quickfixFlags = flags;
    appState.quickfixOriginalScore = detectionResult;
    
    console.log('About to show QuickFix Step 2');
    showQuickFixStep(2);
    console.log('About to call displayQuickFixAnalysis with:', text, detectionResult, flags);
    displayQuickFixAnalysis(text, detectionResult, flags);
    
    // Reset button
    button.textContent = originalText;
    button.disabled = false;
  }, 1000);
}
function displayQuickFixAnalysis(text, score, flags) {
  // Hide all QuickFix banner cards first
  const quickfixHellaSusCard = document.getElementById('quickfixHellaSusCard');
  const quickfixKindaSusCard = document.getElementById('quickfixKindaSusCard');
  const quickfixYoureGoodCard = document.getElementById('quickfixYoureGoodCard');
  if (quickfixHellaSusCard) quickfixHellaSusCard.style.display = 'none';
  if (quickfixKindaSusCard) quickfixKindaSusCard.style.display = 'none';
  if (quickfixYoureGoodCard) quickfixYoureGoodCard.style.display = 'none';

  // Get dynamic phrase for this score
  let dynamicPhrase = getDynamicPhrase(score);
  
  // Format phrase for header (add apostrophe for "Bussin", add exclamation)
  let headerPhrase = dynamicPhrase;
  if (dynamicPhrase === "Bussin") {
    headerPhrase = "Bussin'!";
  } else if (dynamicPhrase.includes(" ")) {
    // For phrases with spaces, just add exclamation
    headerPhrase = dynamicPhrase + "!";
  } else {
    // For single words, add exclamation
    headerPhrase = dynamicPhrase + "!";
  }

  // Show appropriate banner card and update dynamic phrase
  if (score >= 70) {
    // Hella Sus - Red banner
    if (quickfixHellaSusCard) quickfixHellaSusCard.style.display = 'block';
    const quickfixHellaSusPhrase = document.getElementById('quickfixHellaSusPhrase');
    if (quickfixHellaSusPhrase) {
      quickfixHellaSusPhrase.textContent = headerPhrase;
    }
    // Restore min-height for other cases
    const quickfixFlow = document.getElementById('quickfixFlow');
    if (quickfixFlow) {
      quickfixFlow.style.minHeight = '100vh';
    }
    const quickfixStep2 = document.getElementById('quickfixStep2');
    if (quickfixStep2) {
      quickfixStep2.style.paddingBottom = '';
      quickfixStep2.style.marginBottom = '';
    }
  } else if (score >= 30) {
    // Kinda Sus - Yellow banner
    if (quickfixKindaSusCard) quickfixKindaSusCard.style.display = 'block';
    const quickfixKindaSusPhrase = document.getElementById('quickfixKindaSusPhrase');
    if (quickfixKindaSusPhrase) {
      quickfixKindaSusPhrase.textContent = headerPhrase;
    }
    // Restore min-height for other cases
    const quickfixFlow = document.getElementById('quickfixFlow');
    if (quickfixFlow) {
      quickfixFlow.style.minHeight = '100vh';
    }
    const quickfixStep2 = document.getElementById('quickfixStep2');
    if (quickfixStep2) {
      quickfixStep2.style.paddingBottom = '';
      quickfixStep2.style.marginBottom = '';
    }
  } else {
    // You're Good - Green banner
    if (quickfixYoureGoodCard) quickfixYoureGoodCard.style.display = 'block';
    const quickfixYoureGoodPhrase = document.getElementById('quickfixYoureGoodPhrase');
    if (quickfixYoureGoodPhrase) {
      quickfixYoureGoodPhrase.textContent = headerPhrase;
    }
    // Reduce bottom padding for Clean - No Sus page to remove blank space
    const inputSection = document.querySelector('.input-section');
    if (inputSection) {
      inputSection.style.paddingBottom = '0px';
    }
  }

  // Update score display - FIXED POSITION
  const quickfixScoreEl = document.getElementById('quickfixOriginalScore');
  const quickfixFillEl = document.getElementById('quickfixProgressFill');
  
  // DON'T set score text here - let animation do it
  // if (quickfixScoreEl) {
  //   quickfixScoreEl.textContent = score + '%';
  // }
  
  // Animate QuickFix progress bar for ALL cards (hellaSus, kindaSus, youreGood)
  // All three cards share the same progress bar elements
  if (quickfixScoreEl && quickfixFillEl && typeof animateProgressBar === 'function') {
    // Clear any existing width that might interfere
    quickfixFillEl.style.width = '';
    quickfixFillEl.removeAttribute('style');
    
    // CRITICAL: Clear the animatedBars Set entry so it can re-animate for different cards
    // All three QuickFix cards share the same elements, so we need to allow re-animation
    if (typeof animatedBars !== 'undefined' && animatedBars instanceof Set) {
      const key = quickfixScoreEl.id + quickfixFillEl.id;
      animatedBars.delete(key);
    }
    
    // Wait for card to be fully displayed - use requestAnimationFrame for better timing
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        // Force a repaint to ensure card is visible
        void quickfixFillEl.offsetHeight;
        
        // Check if card is visible (any of the three)
        const isCardVisible = (quickfixHellaSusCard && quickfixHellaSusCard.style.display !== 'none') ||
                              (quickfixKindaSusCard && quickfixKindaSusCard.style.display !== 'none') ||
                              (quickfixYoureGoodCard && quickfixYoureGoodCard.style.display !== 'none');
        
        if (isCardVisible && quickfixFillEl.offsetParent !== null) {
          console.log('🎬 Animating QuickFix progress bar, score:', Math.round(score), 'card visible:', isCardVisible);
          animateProgressBar(quickfixScoreEl, quickfixFillEl, Math.round(score));
        } else {
          // Retry after a short delay
          setTimeout(() => {
            console.log('🔄 Retrying QuickFix progress bar animation, score:', Math.round(score));
            if (quickfixFillEl.offsetParent !== null) {
              animateProgressBar(quickfixScoreEl, quickfixFillEl, Math.round(score));
            }
          }, 200);
        }
      });
    });
  }
  
  // Update score label with dynamic color
  updateScoreLabelColor(score, 'quickfixScoreLabel');
  
  // Warning message is now in the main title, no need to update separately
  
  // Update flag count
  const flagCount = flags.length;
  const isYoureGood = flagCount === 0 && score < 30;
  
  // Update disclaimer count
  const quickfixCount = document.getElementById('quickfixCount');
  const quickfixCountPlural = document.getElementById('quickfixCountPlural');
  const quickfixCountGreen = document.getElementById('quickfixCountGreen');
  if (quickfixCount) {
    quickfixCount.textContent = flagCount;
    // Make count green when it's 0
    if (flagCount === 0) {
      quickfixCount.style.color = '#2ecc71';
    } else {
      quickfixCount.style.color = '#dc2626';
    }
  }
  if (quickfixCountGreen) {
    quickfixCountGreen.textContent = flagCount;
  }
  if (quickfixCountPlural) {
    quickfixCountPlural.textContent = flagCount === 1 ? '' : 's';
  }
  
  // Update "QuickFix found" → "Pro found" heading based on Pro mode
  const isPro = appState.isProUser || false;
  const quickfixCountHeading = document.getElementById('quickfixCountHeading');
  if (quickfixCountHeading && flagCount > 0) {
    if (isPro) {
      quickfixCountHeading.innerHTML = `🚩 Pro found <span id="quickfixCount" style="color: #dc2626;">${flagCount}</span> AI-trigger word<span id="quickfixCountPlural">${flagCount === 1 ? '' : 's'}</span> in your essay.`;
      quickfixCountHeading.style.color = '#dc2626';
    } else {
      quickfixCountHeading.innerHTML = `🚩 QuickFix found <span id="quickfixCount" style="color: #dc2626;">${flagCount}</span> AI-trigger word<span id="quickfixCountPlural">${flagCount === 1 ? '' : 's'}</span>.`;
      quickfixCountHeading.style.color = '#dc2626';
    }
  }
  
  // Handle "You're Good" case (0 flags)
  const instructionText = document.getElementById('quickfixInstructionText');
  const fixesTitle = document.getElementById('quickfixFixesTitle');
  const fixesSubtitle = document.getElementById('quickfixFixesSubtitle');
  const applyButton = document.getElementById('applySelectedFixes');
  const copyButton = document.getElementById('copyTextButton');
  const oldUpsellSection = document.getElementById('quickfixUpsellSection');
  const proUpsellBox = document.getElementById('quickfixProUpsellBox');
  const newProBanner = document.getElementById('quickfixProBanner');
  const proStripeText = document.getElementById('proStripeText');
  const goAheadTurnItIn = document.getElementById('goAheadTurnItIn');
  const fixSelectionContainer = document.querySelector('.modern-toggle-container');
  
  // ALWAYS hide upsell section for Pro users in Step 2 (PRO RESULTS page)
  if (isPro) {
    if (proUpsellBox) {
      proUpsellBox.style.display = 'none';
      proUpsellBox.style.setProperty('display', 'none', 'important');
    }
    if (newProBanner) {
      newProBanner.style.display = 'none';
      newProBanner.style.setProperty('display', 'none', 'important');
    }
  }
  
  if (isYoureGood) {
    // Hide instruction text and count heading above essay
    if (instructionText) instructionText.style.display = 'none';
    const quickfixCountHeading = document.getElementById('quickfixCountHeading');
    if (quickfixCountHeading) quickfixCountHeading.style.display = 'none';
    
    // Change "Choose Your Fixes" to celebratory message
    if (fixesTitle) {
      fixesTitle.textContent = 'This Essay Is Ready To Turn In';
      fixesTitle.style.color = '#2ecc71';
    }
    if (fixesSubtitle) {
      fixesSubtitle.textContent = 'No AI-trigger words detected. Your essay is good to go!';
      fixesSubtitle.style.color = '#2ecc71';
    }
    
    // Hide fix selection container
    if (fixSelectionContainer) fixSelectionContainer.style.display = 'none';
    
    // Hide Apply button
    if (applyButton) applyButton.style.display = 'none';
    if (copyButton) copyButton.style.display = 'none';
    
    // Show green box and blue banner for "You're Good" - DO NOT CHANGE
    if (oldUpsellSection) {
      oldUpsellSection.style.display = 'block';
      oldUpsellSection.style.visibility = 'visible';
      oldUpsellSection.style.margin = '48px 0 20px 0';
      oldUpsellSection.style.padding = '30px 20px';
      oldUpsellSection.style.height = 'auto';
      oldUpsellSection.style.overflow = 'visible';
    }
    // Hide upsell box for You're Good, and ALWAYS hide for Pro users
    if (proUpsellBox) {
      proUpsellBox.style.display = 'none';
      proUpsellBox.style.setProperty('display', 'none', 'important');
    }
    // Only show banner if NOT Pro user
    if (!isPro) {
      if (newProBanner) newProBanner.style.display = 'block';
    } else {
      if (newProBanner) {
        newProBanner.style.display = 'none';
        newProBanner.style.setProperty('display', 'none', 'important');
      }
    }
    // Stripe text removed for Clean - No Sus case
    if (proStripeText) proStripeText.style.display = 'none';
    // Removed goAheadTurnItIn - no longer needed for Clean - No Sus
    const quickfixCopyTextCTA = document.getElementById('quickfixCopyTextCTA');
    if (quickfixCopyTextCTA) {
      quickfixCopyTextCTA.style.display = 'block';
      // Remove all whitespace - reduce padding/margin from parent containers
      const essayContainer = document.getElementById('quickfixEssayContainer');
      if (essayContainer) {
        essayContainer.style.paddingBottom = '0px';
        essayContainer.style.marginBottom = '0px';
      }
      // Also reduce input-section bottom padding
      const inputSection = document.querySelector('.input-section');
      if (inputSection) {
        inputSection.style.paddingBottom = '0px';
      }
      // Show green CTA box above percentage for Clean No Sus
      const cleanNoSusCTA = document.getElementById('quickfixCleanNoSusCTA');
      if (cleanNoSusCTA) {
        cleanNoSusCTA.style.display = 'block';
      }
      // Hide yellow CTA box for Clean No Sus
      const kindaSusCTA = document.getElementById('quickfixKindaSusCTA');
      if (kindaSusCTA) {
        kindaSusCTA.style.display = 'none';
      }
      // Hide red CTA box for Clean No Sus
      const hellaSusCTA = document.getElementById('quickfixHellaSusCTA');
      if (hellaSusCTA) {
        hellaSusCTA.style.display = 'none';
      }
      // Show green box and move it above the blue Pro banner for Clean No Sus
      const upsellSection = document.getElementById('quickfixUpsellSection');
      const proBanner = document.getElementById('quickfixProBanner');
      if (upsellSection) {
        upsellSection.style.display = 'block';
        // Move green box to be right before the blue Pro banner (only for Clean No Sus)
        setTimeout(() => {
          if (proBanner && proBanner.parentNode && upsellSection.parentNode) {
            // Only move if it's not already in the right position
            if (upsellSection.nextSibling !== proBanner) {
              // Remove from current position
              upsellSection.remove();
              // Insert before the blue Pro banner
              proBanner.parentNode.insertBefore(upsellSection, proBanner);
              // Adjust margins for proper spacing
              upsellSection.style.marginBottom = '16px';
              upsellSection.style.marginTop = '0';
            }
          }
        }, 50);
      }
      // Reduce padding on button group to decrease space - REMOVE ALL PADDING
      const buttonGroup = document.getElementById('quickfixButtonGroup');
      if (buttonGroup) {
        buttonGroup.style.padding = '0px';
        buttonGroup.style.margin = '0px';
        buttonGroup.style.display = 'none'; // Hide it completely for Clean - No Sus
      }
      // Hide the animated hand emoji for Clean No Sus
      const quickfixCTAHand = document.getElementById('quickfixCTAHand');
      if (quickfixCTAHand) {
        quickfixCTAHand.style.display = 'none';
      }
      // Also hide the flag explanations section for Clean - No Sus (no fixes needed)
      const flagExplanationsSection = document.getElementById('flagExplanationsSection');
      if (flagExplanationsSection) {
        flagExplanationsSection.style.display = 'none';
      }
      // Remove margin from essay container (already declared above, just update it)
      if (essayContainer) {
        essayContainer.style.marginBottom = '0px';
      }
    }
  } else {
    // Hide green CTA box for Hella Sus/Kinda Sus
    const cleanNoSusCTA = document.getElementById('quickfixCleanNoSusCTA');
    if (cleanNoSusCTA) {
      cleanNoSusCTA.style.display = 'none';
    }
    // Show yellow CTA box for Kinda Sus (30-69%), hide for Hella Sus (70+)
    const kindaSusCTA = document.getElementById('quickfixKindaSusCTA');
    if (kindaSusCTA) {
      if (score >= 30 && score < 70) {
        kindaSusCTA.style.display = 'block';
      } else {
        kindaSusCTA.style.display = 'none';
      }
    }
    // Show red CTA box for Hella Sus (70+), hide for Kinda Sus
    const hellaSusCTA = document.getElementById('quickfixHellaSusCTA');
    if (hellaSusCTA) {
      if (score >= 70) {
        hellaSusCTA.style.display = 'block';
      } else {
        hellaSusCTA.style.display = 'none';
      }
    }
    // Show the animated hand emoji for Hella Sus/Kinda Sus
    const quickfixCTAHand = document.getElementById('quickfixCTAHand');
    if (quickfixCTAHand) {
      quickfixCTAHand.style.display = 'inline-block';
    }
    // Show normal flow for Hella Sus/Kinda Sus
    if (instructionText) instructionText.style.display = 'block';
    if (fixesTitle) {
      fixesTitle.textContent = 'Choose Your Fixes';
      fixesTitle.style.color = '#dc2626';
    }
    if (fixesSubtitle) {
      fixesSubtitle.textContent = 'Check the box below to auto-select our recommended best words for lowest AI score — or pick your own';
      fixesSubtitle.style.color = '#6b7280';
    }
    if (fixSelectionContainer) fixSelectionContainer.style.display = 'block';
    // FORCE show button group and apply button for Hella Sus/Kinda Sus
    const buttonGroup = document.getElementById('quickfixButtonGroup');
    if (buttonGroup) {
      buttonGroup.style.display = 'flex';
      buttonGroup.style.setProperty('display', 'flex', 'important');
      buttonGroup.style.padding = '48px 0 42px 0';
      buttonGroup.style.margin = '0';
    }
    if (applyButton) {
      applyButton.style.display = 'inline-block';
      applyButton.style.setProperty('display', 'inline-block', 'important');
    }
    if (copyButton) copyButton.style.display = 'none';
    const copyTextContainer = document.getElementById('copyTextContainer');
    if (copyTextContainer) copyTextContainer.style.display = 'none';
    // Hide green box completely for Hella Sus/Kinda Sus, show upsell box
    if (oldUpsellSection) {
      oldUpsellSection.style.display = 'none';
      oldUpsellSection.style.visibility = 'hidden';
      oldUpsellSection.style.margin = '0';
      oldUpsellSection.style.padding = '0';
      oldUpsellSection.style.height = '0';
      oldUpsellSection.style.overflow = 'hidden';
    }
    // Only show upsell if NOT Pro user
    if (!isPro) {
      if (proUpsellBox) proUpsellBox.style.display = 'block';
    } else {
      if (proUpsellBox) {
        proUpsellBox.style.display = 'none';
        proUpsellBox.style.setProperty('display', 'none', 'important');
      }
    }
    if (newProBanner) newProBanner.style.display = 'none';
    if (proStripeText) proStripeText.style.display = 'none';
    // Removed goAheadTurnItIn - no longer exists
    const quickfixCopyTextCTA = document.getElementById('quickfixCopyTextCTA');
    if (quickfixCopyTextCTA) quickfixCopyTextCTA.style.display = 'none';
    // Reset bottom padding for other cases
    const inputSection = document.querySelector('.input-section');
    if (inputSection) {
      inputSection.style.paddingBottom = '';
    }
  }
  
  // Update progress indicator position and color
  updateProgressIndicator(score);
  
  // Create flagged content with CORRECT NUMBERED highlights (in order of appearance)
  let flaggedContent = text;
  
  // Only add sample flags if NOT You're Good (for testing other cases)
  if (flags.length === 0 && !isYoureGood) {
    flags.push({
      phrase: 'leverage',
      explanation: 'Corporate buzzword that AI detectors flag instantly',
      suggestedFix: 'use',
      severity: 'high',
      impact: 17
    });
    flags.push({
      phrase: 'cutting-edge',
      explanation: 'Overused and generic. Screams robot',
      suggestedFix: 'innovative',
      severity: 'high',
      impact: 22
    });
  }
  
  // Sort flags by their position in the text
  const sortedFlags = flags.map(flag => {
    const position = text.toLowerCase().indexOf(flag.phrase.toLowerCase());
    return { ...flag, position };
  }).filter(flag => flag.position !== -1).sort((a, b) => a.position - b.position);
  
  // CRITICAL: Update appState.quickfixFlags to sorted order so indices match
  appState.quickfixFlags = sortedFlags;
  
  // Apply highlights in correct order
  sortedFlags.forEach((flag, index) => {
    const regex = new RegExp(flag.phrase.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
    const highlightClass = flag.severity === 'high' ? 'flag-highlight-red' : 'flag-highlight-orange';
    const riskLevel = flag.severity === 'high' ? 'High risk word' : 'Medium risk word';
    const tooltipText = `${riskLevel} - Click to see fix details`;
    flaggedContent = flaggedContent.replace(regex, 
              `<span class="${highlightClass}" onclick="scrollToFixOption(${index})" style="cursor: pointer;" title="${tooltipText}">${flag.phrase}<span class="flag-number" onclick="scrollToFixOption(${index})" title="${tooltipText}">${index + 1}</span></span>`
    );
  });
  
  console.log('Flagged content:', flaggedContent);
  console.log('Flags found:', flags.length);
  console.log('Sorted flags:', flags.length > 0 ? sortedFlags : 'No flags');
  
  // Update dynamic flag counts
  updateDynamicFlagCounts(flagCount);
  
  const flaggedDiv = document.getElementById('flaggedEssayContent');
  console.log('Flagged div found:', flaggedDiv);
  
  if (flaggedDiv) {
    // Add "YOUR ESSAY:" label and green left border for You're Good case
    if (isYoureGood) {
      flaggedDiv.innerHTML = `<div style="font-weight: 700; color: #374151; margin-bottom: 12px; text-transform: uppercase; font-size: 14px;">YOUR ESSAY:</div><p>${flaggedContent}</p>`;
      flaggedDiv.style.borderLeft = '4px solid #059669';
    } else {
    flaggedDiv.innerHTML = `<p>${flaggedContent}</p>`;
      flaggedDiv.style.borderLeft = '1px solid #d1d5db';
    }
    flaggedDiv.style.display = 'block';
    flaggedDiv.style.visibility = 'visible';
    flaggedDiv.style.opacity = '1';
    console.log('Content set successfully');
  } else {
    console.error('flaggedEssayContent div not found!');
  }
  
  // Create numbered fix options with checkboxes AND ADD ALTERNATIVES
  let fixOptionsHtml = '';
  sortedFlags.forEach((flag, index) => {
    const severityEmoji = flag.severity === 'high' ? '🔴' : '🟠';
    const badgeColor = flag.severity === 'high' ? '#fee2e2' : '#fef3c7'; // Red for high, yellow for medium
    
    // Helper function to generate alternatives HTML with disclaimer and refresh button
    function generateAlternativesHTML(flagIndex, phrase, suggestions, isOriginal = true) {
      const escapedPhrase = phrase.replace(/'/g, "\\'");
      const originalBestWord = suggestions[0]; // Store the first/best word
      const escapedBestWord = originalBestWord.replace(/'/g, "\\'");
      let buttonsHtml = '';
      suggestions.forEach((suggestion, idx) => {
        const escapedSuggestion = suggestion.replace(/'/g, "\\'");
        // Add green flag indicator to the first/best suggestion only for original suggestions
        const bestIndicator = (isOriginal && idx === 0) ? '<span style="color:#2ecc71; font-size:12px; margin-right:4px;" title="Optimized for lowest score">✅</span>' : '';
        buttonsHtml += `<button class="alt-word-btn" data-flag-index="${flagIndex}" data-word="${escapedSuggestion}" style="background:#e0f2fe; border:1px solid #2ecc71; color:#0c4a6e; padding:6px 12px; border-radius:4px; font-size:13px; cursor:pointer; margin:2px; font-weight:500; display:inline-flex; align-items:center;">${bestIndicator}${suggestion}</button> `;
      });
      
      // Store suggestions as JSON string (will be properly escaped by HTML)
      const suggestionsJson = JSON.stringify(suggestions);
      
      return `<div style="margin-top:8px;">
        <p style="font-size:11px; color:#9ca3af; margin:0 0 6px 0; line-height:1.4;">💡 First suggestions are optimized for lowest score. Click 🔄 for alternatives.</p>
        <div style="display:flex; align-items:center; gap:6px; margin-bottom:6px;">
          <span style="font-size:13px; color:#6b7280;">Try:</span>
          <button onclick="refreshSuggestions(${flagIndex}, '${escapedPhrase}')" class="refresh-suggestions-btn" data-flag-index="${flagIndex}" style="background:none; border:none; cursor:pointer; font-size:16px; padding:0; margin:0; color:#6b7280; transition:transform 0.2s;" onmouseover="this.style.transform='rotate(180deg)'; this.style.color='#00a8e8';" onmouseout="this.style.transform='rotate(0deg)'; this.style.color='#6b7280';" title="Get more suggestions">🔄</button>
          <button onclick="restoreOriginalSuggestions(${flagIndex}, '${escapedPhrase}', '${escapedBestWord}')" class="restore-original-btn" data-flag-index="${flagIndex}" style="background:none; border:none; cursor:pointer; font-size:14px; padding:0; margin:0; color:#2ecc71; display:none;" title="Restore original best suggestions">↩️</button>
        </div>
        <div class="suggestions-container" data-flag-index="${flagIndex}" data-original-phrase="${escapedPhrase}" data-original-best-word="${escapedBestWord}" data-original-suggestions='${suggestionsJson}'>
          ${buttonsHtml}
        </div>
      </div>`;
    }
    
    // Add alternative suggestions based on the flagged phrase as clickable buttons
    let alternatives = '';
    if (flag.phrase.toLowerCase().includes('unprecedented')) {
      alternatives = generateAlternativesHTML(index, flag.phrase, ['exceptional results', 'remarkable outcomes', 'significant improvements']);
    } else if (flag.phrase.toLowerCase().includes('cutting-edge') || flag.phrase.toLowerCase().includes('cutting edge') || flag.phrase.toLowerCase() === 'cutting-edge') {
      alternatives = generateAlternativesHTML(index, flag.phrase, ['innovative', 'modern', 'forward-thinking', 'advanced']);
    } else if (flag.phrase.toLowerCase().includes('leverage')) {
      alternatives = generateAlternativesHTML(index, flag.phrase, ['use', 'employ', 'utilize', 'make use of']);
    } else if (flag.phrase.toLowerCase().includes('furthermore')) {
      alternatives = generateAlternativesHTML(index, flag.phrase, ['also', 'plus', 'and']);
    } else if (flag.phrase.toLowerCase().includes('moreover')) {
      alternatives = generateAlternativesHTML(index, flag.phrase, ['plus', 'also', 'and']);
    } else if (flag.phrase.toLowerCase().includes('additionally')) {
      alternatives = generateAlternativesHTML(index, flag.phrase, ['also', 'plus', 'and']);
    } else if (flag.phrase.toLowerCase().includes('therefore')) {
      alternatives = generateAlternativesHTML(index, flag.phrase, ['so', 'that\'s why']);
    } else if (flag.phrase.toLowerCase().includes('consequently')) {
      alternatives = generateAlternativesHTML(index, flag.phrase, ['so', 'as a result']);
    } else {
      // FALLBACK: For ANY flagged word that doesn't match specific phrases, show AT LEAST 3 alternatives
      // This ensures ALL flagged words get multiple alternative buttons dynamically
      if (flag.suggestedFix && flag.suggestedFix !== flag.phrase) {
        // Generate at least 3 alternatives based on the suggested fix
        const suggestedFix = flag.suggestedFix;
        let alt1 = suggestedFix;
        let alt2 = '';
        let alt3 = '';
        
        // Generate additional alternatives based on common patterns
        if (suggestedFix === 'use') {
          alt2 = 'employ';
          alt3 = 'utilize';
        } else if (suggestedFix === 'but') {
          alt2 = 'though';
          alt3 = 'yet';
        } else if (suggestedFix === 'also') {
          alt2 = 'plus';
          alt3 = 'and';
        } else if (suggestedFix === 'important') {
          alt2 = 'key';
          alt3 = 'crucial';
        } else if (suggestedFix === 'show') {
          alt2 = 'demonstrate';
          alt3 = 'reveal';
        } else if (suggestedFix === 'so') {
          alt2 = 'therefore';
          alt3 = 'thus';
        } else {
          // Generic alternatives - add variations
          alt2 = suggestedFix + ' more';
          alt3 = 'better ' + suggestedFix;
        }
        
        alternatives = generateAlternativesHTML(index, flag.phrase, [alt1, alt2, alt3].filter(a => a));
      }
    }
    
    fixOptionsHtml += 
      `<div class="fix-option" data-index="${index}">
        <div class="fix-checkbox">
          <input type="checkbox" id="fix-${index}">
        </div>
        <div class="fix-content">
                  <div class="fix-original" style="font-size: 12px;">
            <span style="background:${badgeColor}; padding:2px 4px; border-radius:3px; margin-right:5px;">${index + 1}</span>
            "${flag.phrase}" → "${flag.suggestedFix}"
          </div>
                  <div class="fix-explanation" style="font-size: 11px;">
            ${severityEmoji} ${flag.explanation}
          </div>
                  ${alternatives ? `<div class="fix-alternatives">${alternatives}</div>` : ''}
                  <div class="custom-word-input" style="margin-top: 12px;">
            <span style="font-size: 13px; color: #6b7280; display: block; margin-bottom: 6px;">Or type your own replacement:</span>
            <p style="font-size: 11px; color: #9ca3af; margin: 0 0 8px 0; line-height: 1.4;">💡 Our suggested words are optimized for the lowest score. Custom words may not reduce it as much.</p>
            <input type="text" class="custom-word-field" data-flag-index="${index}" placeholder="Enter your word here..." style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; font-family: inherit; transition: all 0.2s;" onfocus="this.style.borderColor='#00a8e8'; this.style.outline='none';" onblur="this.style.borderColor='#d1d5db';">
          </div>
        </div>
      </div>`;
  });
  
  // Find the container inside fixSelection where options should go
  const fixSelection = document.getElementById('fixSelection');
  if (fixSelection) {
    fixSelection.style.display = 'block'; // Make sure it's visible
    
    // Hide instruction box for Pro users
    const isPro = appState.isProUser || false;
    const instructionBox = document.getElementById('fixSelectionInstructionBox');
    if (instructionBox) {
      if (isPro) {
        instructionBox.style.display = 'none';
      } else {
        instructionBox.style.display = 'block';
      }
    }
    
    const optionsContainer = fixSelection.querySelector('div:last-child');
    if (optionsContainer) {
      optionsContainer.innerHTML = fixOptionsHtml;
    } else {
      fixSelection.innerHTML += fixOptionsHtml;
    }
  }
  
  const flagExplanationsSection = document.getElementById('flagExplanationsSection');
  if (flagExplanationsSection) {
    flagExplanationsSection.style.display = 'block';
  }
  
  // CRITICAL: Initialize the selected words in QuickFix mode
  setTimeout(() => {
    document.querySelectorAll('.alt-word-btn.selected-word').forEach(btn => {
      const flagIndex = btn.getAttribute('data-flag-index');
      const selectedWord = btn.getAttribute('data-word');
      
      // Update the flag's suggestedFix
      if (appState.quickfixFlags && appState.quickfixFlags[flagIndex]) {
        console.log('Initializing flag', flagIndex, ':', appState.quickfixFlags[flagIndex].phrase, '→', selectedWord);
        appState.quickfixFlags[flagIndex].suggestedFix = selectedWord;
      }
    });
    
    // Initialize score preview after DOM is ready - this will show original score if nothing selected
    setTimeout(() => {
      updateScorePreview();
      
      // Add scroll and resize listeners to update preview box position dynamically
      // Use immediate updates for smooth floating effect
      const updatePreviewPosition = () => {
        const previewBox = document.getElementById('scorePreviewBox');
        const quickfixStep2 = document.getElementById('quickfixStep2');
        if (previewBox && previewBox.style.display !== 'none' && quickfixStep2 && quickfixStep2.style.display !== 'none') {
          // Update immediately for smooth floating
          updateScorePreview();
        }
      };
      
      // CRITICAL: Add scroll listener to the fixSelection container so banner moves with inner scrollbar
      // This updates pointer position when container scrolls internally
      const fixSelectionContainer = document.getElementById('fixSelection');
      if (fixSelectionContainer) {
        // Remove any existing listener first
        fixSelectionContainer.removeEventListener('scroll', updatePreviewPosition);
        // Add scroll listener - this fires when container scrolls internally
        // Banner stays at container.top, but pointer needs to update to point to target
        fixSelectionContainer.addEventListener('scroll', updatePreviewPosition, { passive: true });
      }
      
      // Listen to window scroll/resize to update banner position when container moves
      // Use throttled version to avoid too many updates
      let windowScrollTimeout;
      const handleWindowScroll = () => {
        clearTimeout(windowScrollTimeout);
        windowScrollTimeout = setTimeout(updatePreviewPosition, 10);
      };
      
      // Remove old listeners if they exist
      window.removeEventListener('scroll', handleWindowScroll, true);
      window.removeEventListener('resize', updatePreviewPosition);
      
      // Add new listeners
      window.addEventListener('scroll', handleWindowScroll, true);
      window.addEventListener('resize', updatePreviewPosition);
    }, 400);
  }, 100);
  
  // FIX 1: Initialize selected count
  updateSelectedCount();
  
  // Add event listeners to checkboxes
  document.querySelectorAll('.fix-option input[type="checkbox"]').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const fixOption = this.closest('.fix-option');
      const flagIndex = fixOption.getAttribute('data-index');
      
      // Track this as the last clicked fix option for banner pointer
      appState.lastClickedFixOption = flagIndex;
      
      // Update preview position immediately
      setTimeout(() => updateScorePreview(), 50);
      
      if (this.checked) {
        fixOption.classList.add('selected');
        fixOption.style.background = '#f0fdf4';
        fixOption.style.borderColor = '#00a8e8';
        
        // Auto-select the first/best word button if none selected
        const hasSelectedWord = document.querySelector(`.alt-word-btn[data-flag-index="${flagIndex}"].selected-word`);
        if (!hasSelectedWord) {
          // Auto-select the first word button (usually the suggested fix)
          const firstWordBtn = document.querySelector(`.alt-word-btn[data-flag-index="${flagIndex}"]`);
          if (firstWordBtn) {
            firstWordBtn.click();
          }
        }
      } else {
        fixOption.classList.remove('selected');
        fixOption.style.background = '#f8f9fa';
        fixOption.style.borderColor = '#e5e7eb';
        
        // BONUS: If checkbox is unchecked, deselect all word buttons for this flag
        const allBtnsForFlag = document.querySelectorAll(`.alt-word-btn[data-flag-index="${flagIndex}"]`);
        allBtnsForFlag.forEach(b => {
          b.style.background = '#e0f2fe';
          b.style.borderColor = '#2ecc71';
          b.style.color = '#0c4a6e';
          b.style.fontWeight = '500';
          b.classList.remove('selected-word');
        });
      }
      // Update selected count when selection changes
      updateSelectedCount();
      
      // Check if "Use Best Words" should be unchecked (when checkbox is unchecked, or when selection changes)
      checkIfAllBestWords();
      
      // Update score preview
      updateScorePreview();
    });
  });
  
  // Add event listener for Select All checkbox
  const selectAllCheckbox = document.getElementById('selectAllFixes');
  if (selectAllCheckbox) {
    selectAllCheckbox.addEventListener('change', toggleSelectAll);
  }
  
  // Add event listeners for alternative word buttons
  document.querySelectorAll('.alt-word-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const flagIndex = this.getAttribute('data-flag-index');
      const selectedWord = this.getAttribute('data-word');
      
      // Track this as the last clicked fix option for banner pointer
      appState.lastClickedFixOption = flagIndex;
      
      // Update preview position immediately
      setTimeout(() => updateScorePreview(), 50);
      
      // Update the flag's suggestedFix
      if (appState.quickfixFlags && appState.quickfixFlags[flagIndex]) {
        console.log('User selected word for flag', flagIndex, ':', appState.quickfixFlags[flagIndex].phrase, '→', selectedWord);
        appState.quickfixFlags[flagIndex].suggestedFix = selectedWord;
      }
      
      // FIX: Properly deselect all buttons for this flag and select clicked one
      const allBtnsForFlag = document.querySelectorAll(`.alt-word-btn[data-flag-index="${flagIndex}"]`);
      allBtnsForFlag.forEach(b => {
        // Reset to default state
        b.style.background = '#e0f2fe';
        b.style.borderColor = '#2ecc71';
        b.style.color = '#0c4a6e';
        b.style.fontWeight = '500';
        b.classList.remove('selected-word');
      });
      
      // Highlight selected button properly
      this.style.background = '#2ecc71';
      this.style.color = 'white';
      this.style.borderColor = '#2ecc71';
      this.style.fontWeight = '600';
      this.classList.add('selected-word');
      
      // Clear custom input field when a word button is selected
      const customInput = document.querySelector(`.custom-word-field[data-flag-index="${flagIndex}"]`);
      if (customInput) {
        customInput.value = '';
      }
      
      // CRITICAL: Auto-check the checkbox when user selects a word
      const checkbox = document.getElementById(`fix-${flagIndex}`);
      if (checkbox && !checkbox.checked) {
    checkbox.checked = true;
        // Trigger the checkbox change event to update styling
        checkbox.dispatchEvent(new Event('change'));
      }
      
      // Update the count to reflect word selection
      updateSelectedCount();
      
      // Check if "Use Best Words" should be unchecked (if user selected non-best word)
      checkIfAllBestWords();
      
      // Update score preview
      updateScorePreview();
      
      console.log('Selected word:', selectedWord, 'for flag:', flagIndex);
    });
  });
  
  // Add event listeners for custom word input fields
  document.querySelectorAll('.custom-word-field').forEach(input => {
    input.addEventListener('input', function() {
      const flagIndex = this.getAttribute('data-flag-index');
      const customWord = this.value.trim();
      
      // Track this as the last clicked fix option for banner pointer
      appState.lastClickedFixOption = flagIndex;
      
      if (customWord) {
        // Update the flag's suggestedFix with custom word
        if (appState.quickfixFlags && appState.quickfixFlags[flagIndex]) {
          console.log('User typed custom word for flag', flagIndex, ':', appState.quickfixFlags[flagIndex].phrase, '→', customWord);
          appState.quickfixFlags[flagIndex].suggestedFix = customWord;
        }
        
        // Update score preview
        updateScorePreview();
        
        // Deselect all word buttons for this flag when custom word is entered
        const allBtnsForFlag = document.querySelectorAll(`.alt-word-btn[data-flag-index="${flagIndex}"]`);
        allBtnsForFlag.forEach(b => {
          b.style.background = '#e0f2fe';
          b.style.borderColor = '#2ecc71';
          b.style.color = '#0c4a6e';
          b.style.fontWeight = '500';
          b.classList.remove('selected-word');
        });
        
        // Auto-check the checkbox when user types a custom word
        const checkbox = document.getElementById(`fix-${flagIndex}`);
        if (checkbox && !checkbox.checked) {
          checkbox.checked = true;
          checkbox.dispatchEvent(new Event('change'));
        }
        
        // Update the count to reflect custom word selection
        updateSelectedCount();
        
        // Custom word = not using best word, so uncheck "Use Best Words"
        checkIfAllBestWords();
      }
    });
    
    // Also handle when user clears the input - revert to original suggested fix
    input.addEventListener('blur', function() {
      // Update score preview when input loses focus
      updateScorePreview();
      
      // Check if clearing custom word means we're back to best words
      checkIfAllBestWords();
      
      const flagIndex = this.getAttribute('data-flag-index');
      const customWord = this.value.trim();
      
      if (!customWord && appState.quickfixFlags && appState.quickfixFlags[flagIndex]) {
        // Revert to original suggested fix if input is cleared
        const originalFix = appState.quickfixFlags[flagIndex].suggestedFix;
        // Don't revert if a word button is selected
        const hasSelectedWord = document.querySelector(`.alt-word-btn[data-flag-index="${flagIndex}"].selected-word`);
        if (!hasSelectedWord) {
          // Could restore original, but for now just leave it as is
        }
      }
    });
  });
  
  // Add event listeners for CTA buttons
  const applySelectedBtn = document.getElementById('applySelectedFixes');
  if (applySelectedBtn) {
    applySelectedBtn.addEventListener('click', applySelectedFixes);
    console.log('✅ Apply QuickFixes button listener added');
  }
  
  const completeRewriteBtn = document.getElementById('completeRewrite');
  if (completeRewriteBtn) {
    completeRewriteBtn.addEventListener('click', completeRewrite);
    console.log('✅ See All 15 Flags Fixed button listener added');
  }
  
  // FORCE update button text to "Go Pro" on QuickFix Results page
  setTimeout(() => {
    const proUpsellButton = document.querySelector('#quickfixProUpsellBox button');
    if (proUpsellButton) {
      proUpsellButton.innerHTML = '💎 Go Pro - $9.99/mo';
      proUpsellButton.textContent = '💎 Go Pro - $9.99/mo';
    }
  }, 100);
}

// Function to scroll to specific fix option
function scrollToFixOption(index) {
  // First, make sure the fix selection section is open
  const fixSelection = document.getElementById('fixSelection');
  if (fixSelection && (fixSelection.style.display === 'none' || getComputedStyle(fixSelection).display === 'none')) {
    toggleFixSelection();
  }
  
  const fixOption = document.querySelector(`.fix-option[data-index="${index}"]`);
  if (fixOption) {
    fixOption.scrollIntoView({ 
      behavior: 'smooth', 
      block: 'center' 
    });
    
    // Add a green highlight effect
    fixOption.style.backgroundColor = '#f0fdf4';
    fixOption.style.borderColor = '#00a8e8';
    fixOption.style.transition = 'all 0.3s ease';
    
    // Check the checkbox if not already checked
    const checkbox = fixOption.querySelector('input[type="checkbox"]');
    if (checkbox && !checkbox.checked) {
      checkbox.checked = true;
      checkbox.dispatchEvent(new Event('change'));
    }
    
    // Keep the green highlight (don't remove it after timeout)
  }
}

// Global function to toggle the fix selection section
function toggleFixSelection() {
  const fixSelection = document.getElementById('fixSelection');
  const toggleArrow = document.getElementById('toggleArrow');
  
  if (!fixSelection || !toggleArrow) return;
  
  if (fixSelection.style.display === 'none' || getComputedStyle(fixSelection).display === 'none') {
    fixSelection.style.display = 'block';
    toggleArrow.style.transform = 'rotate(180deg)';
  } else {
    fixSelection.style.display = 'none';
    toggleArrow.style.transform = 'rotate(0deg)';
  }
  
  // Update banner position when container is toggled
  setTimeout(() => {
    updateScorePreview();
  }, 100);
}

// FIXED: Apply QuickFixes - PROPERLY REDIRECTS TO QUICKFIX RESULTS
function applySelectedFixes() {
  // Check if required data exists
  if (!appState.quickfixOriginalText || !appState.quickfixFlags || appState.quickfixFlags.length === 0) {
    console.error('Missing required data for applySelectedFixes:', {
      originalText: appState.quickfixOriginalText,
      flags: appState.quickfixFlags
    });
    showSuccessMessage('Error: Missing essay data. Please go back and try again.');
    return;
  }
  
  const selectedFlags = [];
  console.log('=== DEBUG APPLY FIXES ===');
  console.log('appState.quickfixFlags.length:', appState.quickfixFlags.length);
  document.querySelectorAll('.fix-option input[type="checkbox"]:checked').forEach(checkbox => {
    const index = parseInt(checkbox.closest('.fix-option').dataset.index);
    console.log('Found checked checkbox with index:', index);
    if (index >= 0 && index < appState.quickfixFlags.length && appState.quickfixFlags[index]) {
      console.log('Adding flag:', appState.quickfixFlags[index].phrase);
    selectedFlags.push(appState.quickfixFlags[index]);
    } else {
      console.warn('Skipping invalid checkbox index:', index, 'Available flags:', appState.quickfixFlags.length);
    }
  });
  console.log('Total selectedFlags:', selectedFlags.length);
  
  if (selectedFlags.length === 0) {
    showStyledAlert('Select at least one fix to apply!');
    return;
  }
  
  const button = document.getElementById('applySelectedFixes');
  const originalButtonText = button.textContent;
  button.textContent = 'Applying fixes... ✨';
  button.disabled = true;
  
  // Show scanning/processing modal
  showQuickFixProcessingModal();
  
  // Simulate API call with timeout
  setTimeout(() => {
    try {
      // Apply fixes locally
      const fixedText = AIDetectionEngine.applyFixes(appState.quickfixOriginalText, selectedFlags);
      
      // Calculate new score
      let totalReduction = 0;
      selectedFlags.forEach(flag => {
        totalReduction += flag.impact;
      });
      const estimatedNewScore = Math.max(15, appState.quickfixOriginalScore - totalReduction);
      const improvement = appState.quickfixOriginalScore - estimatedNewScore;
      
      appState.quickfixFixedText = fixedText;
      appState.quickfixNewScore = estimatedNewScore;
      
      // Hide processing modal
      hideQuickFixProcessingModal();
      
      // ✅ CRITICAL FIX: Redirect to QuickFix results page (Step 3)
      showQuickFixStep(3);
      displayQuickFixResults(appState.quickfixOriginalText, fixedText, selectedFlags, estimatedNewScore, improvement);
      
      // Update labels if in Pro mode
      if (appState.isProUser) {
        setTimeout(() => {
          updateStepLabels(true);
        }, 100);
      }
      
      // Scroll to top of the page to show the results
      setTimeout(() => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }, 100);
      
    } catch (error) {
      console.error('Error applying fixes:', error);
      hideQuickFixProcessingModal();
      showSuccessMessage('Error applying fixes. Please try again.');
    } finally {
      // Reset button
      button.textContent = originalButtonText;
      button.disabled = false;
    }
  }, 1500);
}

// Missing function - startQuickFixFlow
function startQuickFixFlow() {
  const essayInput = document.getElementById('essayInput');
  if (!essayInput || !essayInput.value) {
    showSuccessMessage('Please enter your essay first!');
    return;
  }
  
  const text = essayInput.value.trim();
  if (text.length < 50) {
    showSuccessMessage('Essay must be at least 50 characters long!');
    return;
  }
  
  // Store original text and analyze
  appState.quickfixOriginalText = text;
  
  // Show QuickFix Step 1 (payment/confirmation)
  showQuickFixStep(1);
  
  // Scroll to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// FIXED: Apply All Fixes - PROPERLY REDIRECTS TO QUICKFIX RESULTS  
function applyAllFixes() {
  // Check if required data exists
  if (!appState.quickfixOriginalText || !appState.quickfixFlags || appState.quickfixFlags.length === 0) {
    console.error('Missing required data for applyAllFixes:', {
      originalText: appState.quickfixOriginalText,
      flags: appState.quickfixFlags
    });
    showSuccessMessage('Error: Missing essay data. Please go back and try again.');
    return;
  }

  // Check all checkboxes and apply
  document.querySelectorAll('.fix-option input[type="checkbox"]').forEach(checkbox => {
    checkbox.checked = true;
    checkbox.closest('.fix-option').classList.add('selected');
  });
  updateSelectedCount();
  
  const button = document.getElementById('applyAllFixes');
  const originalText = button.textContent;
  button.textContent = 'Applying all fixes... ✨';
  button.disabled = true;
  
  // Simulate API call with timeout
  setTimeout(() => {
    try {
      // Apply all fixes locally
      const fixedText = AIDetectionEngine.applyFixes(appState.quickfixOriginalText, appState.quickfixFlags);
      
      // Calculate new score
      let totalReduction = 0;
      appState.quickfixFlags.forEach(flag => {
        totalReduction += flag.impact;
      });
      const estimatedNewScore = Math.max(15, appState.quickfixOriginalScore - totalReduction);
      const improvement = appState.quickfixOriginalScore - estimatedNewScore;
      
      appState.quickfixFixedText = fixedText;
      appState.quickfixNewScore = estimatedNewScore;
      
      // ✅ CRITICAL FIX: Redirect to QuickFix results page (Step 3)
      showQuickFixStep(3);
      displayQuickFixResults(appState.quickfixOriginalText, fixedText, appState.quickfixFlags, estimatedNewScore, improvement);
      
      // Update labels if in Pro mode
      if (appState.isProUser) {
        setTimeout(() => {
          updateStepLabels(true);
        }, 100);
      }
      
      // Scroll to top of the page to show the results
      setTimeout(() => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }, 100);
      
    } catch (error) {
      console.error('Error applying fixes:', error);
      showSuccessMessage('Error applying fixes. Please try again.');
    } finally {
      // Reset button
      button.textContent = originalText;
      button.disabled = false;
    }
  }, 1500);
}

// Scanning modal functions
function showScanningModal() {
  const modal = document.createElement('div');
  modal.id = 'scanningModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    backdrop-filter: blur(5px);
  `;
  
  modal.innerHTML = `
    <div style="
      background: white;
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    ">
      <img src="https://i.postimg.cc/HsCBbtHt/Generated-Image-September-03-2025-5-35PM.jpg" alt="Lil Sus Character" style="width: 240px; height: auto; margin-bottom: 20px; display: block; margin-left: auto; margin-right: auto;">
      <p style="color: #6b7280; margin-bottom: 25px; font-size: 22px;">
        Scanning for flags... hold up! 🔍
      </p>
      <div style="display: flex; justify-content: center; gap: 4px;">
        <div class="scanning-dot" style="width: 8px; height: 8px; background: #2ecc71; border-radius: 50%; animation: scanningPulse 1.5s infinite;"></div>
        <div class="scanning-dot" style="width: 8px; height: 8px; background: #2ecc71; border-radius: 50%; animation: scanningPulse 1.5s infinite 0.2s;"></div>
        <div class="scanning-dot" style="width: 8px; height: 8px; background: #2ecc71; border-radius: 50%; animation: scanningPulse 1.5s infinite 0.4s;"></div>
      </div>
    </div>
  `;
  
  // Add CSS animation
  const style = document.createElement('style');
  style.textContent = `
    @keyframes scanningPulse {
      0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
      40% { transform: scale(1.2); opacity: 1; }
    }
  `;
  document.head.appendChild(style);
  
  document.body.appendChild(modal);
  document.body.classList.add('modal-open');
}
function hideScanningModal() {
  const modal = document.getElementById('scanningModal');
  if (modal) {
    modal.remove();
    document.body.classList.remove('modal-open');
  }
}

// Lighter modal for "Get More Fix Suggestions" - not a full scan
function showGettingSuggestionsModal() {
  const modal = document.createElement('div');
  modal.id = 'gettingSuggestionsModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    backdrop-filter: blur(3px);
  `;
  
  modal.innerHTML = `
    <div style="
      background: white;
      padding: 32px;
      border-radius: 16px;
      text-align: center;
      max-width: 350px;
      width: 90%;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.2);
    ">
      <div style="font-size: 40px; margin-bottom: 16px;">
        ✏️
      </div>
      <h2 style="color: #0b0646; margin-bottom: 12px; font-size: 20px; font-weight: 600;">
        Getting More Suggestions...
      </h2>
      <p style="color: #6b7280; margin-bottom: 20px; font-size: 14px;">
        Loading alternative word options...
      </p>
      <div style="display: flex; justify-content: center; gap: 4px;">
        <div class="scanning-dot" style="width: 6px; height: 6px; background: #f5a623; border-radius: 50%; animation: scanningPulse 1.5s infinite;"></div>
        <div class="scanning-dot" style="width: 6px; height: 6px; background: #f5a623; border-radius: 50%; animation: scanningPulse 1.5s infinite 0.2s;"></div>
        <div class="scanning-dot" style="width: 6px; height: 6px; background: #f5a623; border-radius: 50%; animation: scanningPulse 1.5s infinite 0.4s;"></div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

function hideGettingSuggestionsModal() {
  const modal = document.getElementById('gettingSuggestionsModal');
  if (modal) {
    modal.remove();
  }
}

// QuickFix Processing Modal (shown when applying fixes)
function showQuickFixProcessingModal() {
  const modal = document.createElement('div');
  modal.id = 'quickfixProcessingModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    backdrop-filter: blur(5px);
  `;
  
  modal.innerHTML = `
    <div style="
      background: white;
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    ">
      <div style="font-size: 48px; margin-bottom: 20px;">
        ✨
      </div>
      <h2 style="color: #0b0646; margin-bottom: 15px; font-size: 24px;">
        Applying Fixes...
      </h2>
      <p style="color: #6b7280; margin-bottom: 25px; font-size: 16px;">
        Updating your essay with the selected fixes. This might take a moment
      </p>
      <div style="display: flex; justify-content: center; gap: 4px;">
        <div class="scanning-dot" style="width: 8px; height: 8px; background: #00a8e8; border-radius: 50%; animation: scanningPulse 1.5s infinite;"></div>
        <div class="scanning-dot" style="width: 8px; height: 8px; background: #00a8e8; border-radius: 50%; animation: scanningPulse 1.5s infinite 0.2s;"></div>
        <div class="scanning-dot" style="width: 8px; height: 8px; background: #00a8e8; border-radius: 50%; animation: scanningPulse 1.5s infinite 0.4s;"></div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  document.body.classList.add('modal-open');
}

function hideQuickFixProcessingModal() {
  const modal = document.getElementById('quickfixProcessingModal');
  if (modal) {
    modal.remove();
    document.body.classList.remove('modal-open');
  }
}

// FIXED: Complete rewrite function - NOW GOES TO STEP 4
function completeRewrite() {
  if (appState.freeRewritesUsed >= appState.maxFreeRewrites) {
    showSuccessMessage('No free rewrites left - upgrade to Pro for 500 monthly scans!');
    return;
  }
  
  // Check if we have the required data - use fallback if QuickFix text not available
  let textToRewrite = appState.quickfixOriginalText;
  if (!textToRewrite) {
    // Fallback to main essay input if QuickFix text not available
    const mainInput = document.getElementById('essayInput');
    textToRewrite = mainInput ? mainInput.value.trim() : null;
  }
  
  if (!textToRewrite) {
    console.error('Missing original text for complete rewrite');
    showSuccessMessage('Error: No text to rewrite. Please paste your essay first.');
    return;
  }
  
  // Show scanning modal first
  showScanningModal();
  
  // Simulate API call for full rewrite
  setTimeout(() => {
    try {
      if (!textToRewrite || textToRewrite.trim() === '') {
        throw new Error('No text provided for rewrite');
      }
      
      const rewrittenText = AIDetectionEngine.completeRewrite(textToRewrite);
      console.log('🔍 AIDetectionEngine.calculateScore called - input length:', rewrittenText.length);
      const newScore = AIDetectionEngine.calculateScore(rewrittenText);
      console.log('🔍 AIDetectionEngine.calculateScore result - score:', newScore);
      const improvement = (appState.quickfixOriginalScore || 75) - newScore;
      
      appState.quickfixFixedText = rewrittenText;
      appState.quickfixNewScore = newScore;
      appState.freeRewritesUsed++;
      
      // Hide scanning modal and show Step 4
      hideScanningModal();
      showFullDeFlagPage();
      updateRewriteCounter();
      
    } catch (error) {
      console.error('Error during rewrite:', error);
      hideScanningModal();
      showSuccessMessage('Error during rewrite. Please try again.');
    }
  }, 3000);
}

function displayQuickFixResults(originalText, fixedText, flags, newScore, improvement) {
  // Add error handling for missing data
  if (!originalText || !fixedText || !flags || !newScore || !improvement) {
    console.error('Missing data for displayQuickFixResults:', { originalText, fixedText, flags, newScore, improvement });
    showSuccessMessage('Error displaying results. Please try again.');
    return;
  }
  
  // Update before/after score labels
  const beforeScoreEl = document.getElementById('beforeQuickFixScore');
  const afterScoreEl = document.getElementById('afterQuickFixScore');
  const originalScore = appState.quickfixOriginalScore || (newScore + improvement);
  const isPro = appState.isProUser || false;
  
  if (beforeScoreEl) {
    if (isPro) {
      beforeScoreEl.textContent = `Before Pro Fix - ${originalScore}%`;
    } else {
      beforeScoreEl.textContent = `Before QuickFix - ${originalScore}%`;
    }
  }
  if (afterScoreEl) {
    if (isPro) {
      afterScoreEl.textContent = `After Pro Fix - ${newScore}%`;
    } else {
      afterScoreEl.textContent = `After QuickFix - ${newScore}%`;
    }
  }
  
  // Update score display
  const newScoreEl = document.getElementById('quickfixNewScore');
  if (newScoreEl) {
    newScoreEl.textContent = newScore + '%';
  }
  
  // Animate progress bar using the same system as other progress bars
  const progressFill = document.getElementById('quickfixNewProgressFill');
  const progressBar = document.getElementById('quickfixNewProgressBar');
  const newIndicator = document.getElementById('quickfixNewProgressIndicator');
  
  if (progressFill && newScoreEl && typeof animateProgressBar === 'function') {
    // Clear any existing width that might interfere
    progressFill.style.width = '';
    progressFill.removeAttribute('style');
    
    // CRITICAL: Clear the animatedBars Set entry so it can re-animate
    if (typeof animatedBars !== 'undefined' && animatedBars instanceof Set) {
      const key = newScoreEl.id + progressFill.id;
      animatedBars.delete(key);
    }
    
    // Wait for content to be fully displayed
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        // Force a repaint to ensure bar is visible
        void progressFill.offsetHeight;
        
        if (progressFill.offsetParent !== null) {
          console.log('🎬 Animating QuickFix Summary progress bar, score:', Math.round(newScore));
          animateProgressBar(newScoreEl, progressFill, Math.round(newScore));
        } else {
          // Retry after a short delay
          setTimeout(() => {
            if (progressFill.offsetParent !== null) {
              console.log('🔄 Retrying QuickFix Summary progress bar animation, score:', Math.round(newScore));
              animateProgressBar(newScoreEl, progressFill, Math.round(newScore));
            }
          }, 200);
        }
      });
    });
  } else if (progressFill) {
    // Fallback: animate manually if animateProgressBar doesn't exist
    progressFill.style.width = '0%';
    setTimeout(() => {
      progressFill.style.width = newScore + '%';
    }, 100);
  }
  
  // Update progress indicator for new score (Step 3) - use same function as Step 2
  updateProgressIndicator(newScore, 'quickfixNewProgressIndicator');
  
  // Update new score label with dynamic color
  updateScoreLabelColor(newScore, 'quickfixNewScoreLabel');
  
  // Update dynamic message based on score
  const dynamicMessage = document.getElementById('dynamicMessage');
  const dynamicMessageBanner = document.getElementById('dynamicMessageBanner');
  if (dynamicMessage) {
    if (newScore <= 30) {
      dynamicMessage.textContent = 'No cap, this one\'s clean. Go send it.';
      if (dynamicMessageBanner) {
        dynamicMessageBanner.style.background = '#2ecc71';
        dynamicMessageBanner.style.borderLeftColor = '#059669';
        dynamicMessage.style.color = '#ffffff';
      }
    } else if (newScore <= 70) {
      dynamicMessage.textContent = `🤔 ${newScore}% Kinda Sus — might work, might not`;
      if (dynamicMessageBanner) {
        dynamicMessageBanner.style.background = '#fbbf24';
        dynamicMessageBanner.style.borderLeftColor = '#f59e0b';
        dynamicMessage.style.color = '#ffffff';
      }
    } else {
      dynamicMessage.textContent = `Fam, this is way too sus for your prof.`;
      if (dynamicMessageBanner) {
        dynamicMessageBanner.style.background = '#dc2626';
        dynamicMessageBanner.style.borderLeftColor = '#991b1b';
        dynamicMessage.style.color = '#ffffff';
      }
    }
  }
  
  // CRITICAL FIX: Render the dynamic CTA buttons
  const quickfixBottomCTA = document.getElementById('quickfixBottomCTA');
  if (quickfixBottomCTA) {
    quickfixBottomCTA.innerHTML = getDynamicCTAs(newScore);
  }
  
  const improvementPercentEl = document.getElementById('improvementPercent');
  if (improvementPercentEl) {
    improvementPercentEl.textContent = improvement + '%';
  }
  
  // Update resultsMessage text if it exists - different message for Clean vs others
  const resultsMessageEl = document.getElementById('resultsMessage');
  if (resultsMessageEl && improvementPercentEl) {
    if (newScore <= 30) {
      // Success message for Clean pages
      resultsMessageEl.innerHTML = `That's a solid <strong>${improvement}%</strong> glow-up! ✨<br>Your essay is looking clean and ready to turn in.`;
    } else {
      // Warning message for Kinda Sus/Hella Sus pages
      resultsMessageEl.innerHTML = `Detectors would still roast this 😬 — only a <strong>${improvement}%</strong> glow-up so far.<br>Keep fixing to drop your score even lower.`;
    }
  }
  
  // Update dynamic messaging
  updateResultsMessaging(newScore, improvement);
  
  // Update "Your Scan Results" subtitle - dynamic for Pro users
  const scanResultsSubtitle = document.getElementById('quickfixScanResultsSubtitle');
  // isPro already declared above at line 7682
  if (scanResultsSubtitle) {
    // For clean scores (<= 30), show rotating celebratory messages
    if (newScore <= 30) {
      // Reset index and start with first message
      currentCleanMessageIndex = 0;
      scanResultsSubtitle.textContent = cleanResultMessages[0];
      scanResultsSubtitle.style.transition = 'opacity 0.3s ease';
      scanResultsSubtitle.style.opacity = '1';
      // Start rotating messages
      startRotatingCleanMessages();
    } else if (isPro && flags && flags.length > 0) {
      scanResultsSubtitle.textContent = `🚩 Pro found ${flags.length} AI-trigger words in your essay`;
    } else {
      scanResultsSubtitle.textContent = "Here's your new score after fixing those flags";
    }
  }
  
  // Save Pro scan to history (localStorage)
  if (isPro) {
    saveProScanToHistory(originalText, fixedText, flags, newScore, improvement);
  }
  
  // Update header wrapper border colors based on score (QuickFix summary page)
  const headerWrapper = document.getElementById('quickfixStep3HeaderWrapper');
  if (headerWrapper) {
    if (newScore <= 30) {
      headerWrapper.style.borderLeftColor = '#2ecc71';
      headerWrapper.style.borderRightColor = '#2ecc71';
    } else if (newScore <= 70) {
      headerWrapper.style.borderLeftColor = '#f5a623';
      headerWrapper.style.borderRightColor = '#f5a623';
    } else {
      headerWrapper.style.borderLeftColor = '#dc2626';
      headerWrapper.style.borderRightColor = '#dc2626';
    }
  }
  
  // Update resultsMessage color based on score (QuickFix summary page only) - set after updateResultsMessaging
  const resultsMessageAfter = document.getElementById('resultsMessage');
  if (resultsMessageAfter) {
    if (newScore <= 30) {
      resultsMessageAfter.style.color = '#2ecc71'; // Green
    } else if (newScore <= 70) {
      resultsMessageAfter.style.color = '#fbbf24'; // Yellow
    } else {
      resultsMessageAfter.style.color = '#dc2626'; // Red
    }
  }
  
  // Check if score is too high and show upsell popup
  if (newScore > 30) {
    setTimeout(() => {
      showScoreUpsellPopup(newScore);
    }, 1500); // Show after 1.5 seconds
  }
  
  let originalWithHighlights = originalText;
  let fixedWithHighlights = fixedText;
  
  // Add numbered flags to both sides for clarity
  if (flags.length > 0) {
    // Sort flags by position for consistent numbering
    const sortedFlags = flags.map(flag => {
      const position = originalText.toLowerCase().indexOf(flag.phrase.toLowerCase());
      return { ...flag, position };
    }).filter(flag => flag.position !== -1).sort((a, b) => a.position - b.position);
    
    sortedFlags.forEach((flag, index) => {
      // Highlight original flags (red numbers)
      const originalRegex = new RegExp(flag.phrase.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
      const highlightClass = flag.severity === 'high' ? 'flag-highlight-red' : 'flag-highlight-orange';
      originalWithHighlights = originalWithHighlights.replace(originalRegex, 
        `<span class="${highlightClass}">${flag.phrase}<span class="flag-number">${index + 1}</span></span>`
      );
      
      // Highlight fixes with green numbers
      const fixRegex = new RegExp(flag.suggestedFix.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
      fixedWithHighlights = fixedWithHighlights.replace(fixRegex, 
        `<span class="fix-highlight">${flag.suggestedFix}<span class="flag-number">${index + 1}</span></span>`
      );
    });
  }
  
  document.getElementById('comparisonOriginal').innerHTML = `<p>${originalWithHighlights}</p>`;
  document.getElementById('comparisonFixed').innerHTML = `<p>${fixedWithHighlights}</p>`;
}

function showScoreUpsellPopup(score) {
  // Make this purely score-based, not dependent on flag counts
  
  // Create modal overlay
  const modal = document.createElement('div');
  modal.id = 'scoreUpsellModal';
  modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;z-index:10000;';
  document.body.classList.add('modal-open');
  
  const popup = document.createElement('div');
  popup.style.cssText = 'background:#fff;padding:30px;border-radius:20px;max-width:450px;width:90%;text-align:center;box-shadow:0 20px 40px rgba(0,0,0,0.3);position:relative';
  
  // Dynamic content based on actual flags AND score
  let headerText, bodyText, remainingText;
  
  // Make popup purely score-based, not dependent on flag count
  if (score <= 30) {
    headerText = `Nice work! You dropped to ${score}% 🎉`;
    bodyText = `Your essay is now professor-ready.`;
    remainingText = `Your current score: <strong style="color:#00a8e8;">${score}%</strong> — Ready to turn it in!`;
  } else if (score > 30 && score < 70) {
    headerText = `Looks like you didn't use all the suggested fixes 👀`;
    bodyText = `Totally fine - but it means your score didn't drop as much as it could've. Upgrade to Pro→Fix everything. Rescan... again and again.`;
    remainingText = ``;
  } else {
    headerText = `Low-key… you skipped some of the best fixes 😂`;
    bodyText = `QuickFix only scans once, and you didn't pick all the glow-up words - so your score stayed sus.<br><br>Need more tries? More fixes? A real score glow-up?<br><br><strong>Pro's the move → see what detectors see, scan on repeat, fix it, then turn it in like a boss.</strong>`;
    remainingText = ``;
  }
  
  if (false) { // Disabled flag-based logic
    // Some flags remain for Pro
    const quickfixShown = Math.min(3, flagsFixed);
    const remaining = flagsFixed - 3;
    
    if (score <= 30) {
      headerText = `Nice work! You fixed ${quickfixShown} flags and dropped to ${score}% 🎉`;
      bodyText = `But wait... there are ${remaining} MORE flags hiding! 👀`;
      remainingText = `Your current score: <strong style="color:#00a8e8;">${score}%</strong> — Ready to turn it in!`;
    } else if (score > 30 && score < 70) {
      headerText = `Oof! Should've applied all fixes... 😅`;
      bodyText = `But don't worry! You can get a FULL PRO SCAN for FREE to find ALL the flags! 🎯`;
      remainingText = `Your current score: <strong style="color:#f59e0b;">${score}%</strong> — Let's get it down to <strong style="color:#00a8e8;">under 20%!</strong>`;
    } else {
      headerText = `Oof! Should've applied all fixes... 😅`;
      bodyText = `But don't worry! You can get a FULL PRO SCAN for FREE to find ALL the flags! 🎯`;
      remainingText = `Your current score: <strong style="color:#dc2626;">${score}%</strong> — Let's get it down to <strong style="color:#00a8e8;">under 20%!</strong>`;
    }
  }
  
  // Determine emoji and label based on score
  let scoreEmoji, scoreLabel, scoreColor;
  if (score <= 30) {
    scoreEmoji = '✅';
    scoreLabel = 'Clean - No Sus';
    scoreColor = '#2ecc71';
  } else if (score > 30 && score < 70) {
    scoreEmoji = '🤔';
    scoreLabel = 'Kinda Sus';
    scoreColor = '#fbbf24';
  } else {
    scoreEmoji = '🚨';
    scoreLabel = 'Hella Sus';
    scoreColor = '#dc2626';
  }
  
  // Only show remainingText box if it has content
  const remainingTextHtml = remainingText ? `<div style="background:#f8f9fa;border-radius:12px;padding:15px;margin:15px 0;"><p style="color:#6b7280;font-size:14px;margin:0;">${remainingText}</p></div>` : '';
  
  popup.innerHTML = '<button onclick="document.getElementById(\'scoreUpsellModal\').remove(); document.body.classList.remove(\'modal-open\');" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:32px;color:#999;cursor:pointer;padding:10px 15px;line-height:1;border-radius:50%;transition:all 0.3s;margin-bottom:24px;" onmouseover="this.style.color=\'#dc2626\'; this.style.background=\'#fee2e2\';" onmouseout="this.style.color=\'#999\'; this.style.background=\'none\';">×</button>' +
    '<div style="text-align:center; margin-top:24px; margin-bottom:20px;">' +
    `<div style="font-size:36px; margin-bottom:6px;">${scoreEmoji}</div>` +
    `<div style="font-size:28px; font-weight:700; color:${scoreColor}; margin-bottom:3px;">${score}%</div>` +
    `<div style="font-size:14px; font-weight:600; color:#6b7280;">${scoreLabel}</div>` +
    '</div>' +
    '<h2 style="margin-bottom:12px;font-size:1.4em;color:#0b0646;">' + headerText + '</h2>' +
    '<p style="color:#374151;line-height:1.5;margin-bottom:15px;font-size:0.95em;">' + bodyText + '</p>' +
    remainingTextHtml +
    '<button class="btn-success btn-block" onclick="document.getElementById(\'scoreUpsellModal\').remove(); document.body.classList.remove(\'modal-open\'); window.open(\'/pro\',\'_blank\');" style="margin:8px 0; background: #00a8e8; color: white; border: none;">💎 Upgrade to Pro - $9.99/mo</button>' +
    '<a href="javascript:void(0)" onclick="document.getElementById(\'scoreUpsellModal\').remove(); document.body.classList.remove(\'modal-open\');" style="display:block;text-align:center;margin-top:12px;color:#9ca3af;font-size:13px;text-decoration:underline;cursor:pointer">No thanks, I\'ll pray instead 🙏🏽</a>';
  
  modal.appendChild(popup);
  document.body.appendChild(modal);
  
  // Add click-outside-to-close functionality
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      modal.remove();
      document.body.classList.remove('modal-open');
    }
  });
}

function showQuickFixReminderModal() {
  // Check if modal already exists
  if (document.getElementById('quickfixReminderModal')) {
    return;
  }
  
  // Create modal overlay
  const modal = document.createElement('div');
  modal.id = 'quickfixReminderModal';
  modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;justify-content:center;align-items:center;z-index:10000;animation:fadeIn 0.3s ease;';
  document.body.classList.add('modal-open');
  
  const popup = document.createElement('div');
  popup.style.cssText = 'background:#fff;padding:25px 30px;border-radius:20px;max-width:420px;width:90%;text-align:center;box-shadow:0 20px 40px rgba(0,0,0,0.3);position:relative;animation:slideUp 0.3s ease;';
  
  function closeModal() {
    const modalEl = document.getElementById('quickfixReminderModal');
    if (modalEl) {
      modalEl.remove();
      document.body.classList.remove('modal-open');
    }
  }
  
  popup.innerHTML = '<button onclick="document.getElementById(\'quickfixReminderModal\').remove(); document.body.classList.remove(\'modal-open\');" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:28px;color:#999;cursor:pointer;padding:8px 12px;line-height:1;border-radius:50%;transition:all 0.3s;" onmouseover="this.style.color=\'#dc2626\'; this.style.background=\'#fee2e2\';" onmouseout="this.style.color=\'#999\'; this.style.background=\'none\';">×</button>' +
    '<div style="font-size:48px;margin-bottom:15px;">💡</div>' +
    '<h2 style="margin-bottom:12px;font-size:1.5em;color:#0b0646;font-weight:700;">Quick Reminder!</h2>' +
    '<p style="color:#374151;line-height:1.6;margin-bottom:20px;font-size:16px;">You can paste up to <strong style="color:#00a8e8;">5,000 characters</strong> here — way more than the free 500! If your full essay didn\'t fit before, paste it all now. 🚀</p>' +
    '<button class="btn-primary" onclick="document.getElementById(\'quickfixReminderModal\').remove(); document.body.classList.remove(\'modal-open\');" style="padding:12px 30px;font-size:16px;font-weight:600;border-radius:10px;cursor:pointer;border:none;background:#ff6b00;color:white;transition:all 0.3s;" onmouseover="this.style.background=\'#ea580c\';" onmouseout="this.style.background=\'#ff6b00\';">Got it! 👍</button>';
  
  modal.appendChild(popup);
  document.body.appendChild(modal);
  
  // Auto-dismiss after 7 seconds
  setTimeout(() => {
    closeModal();
  }, 7000);
  
  // Close on background click
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      closeModal();
    }
  });
}

// REMOVED: Old "READY TO TURN IT IN?" modal - no longer used
// Replaced with: returnToMainDashboard() to go back to input
function showFreeScanModal() {
  // Redirect to input section instead of showing old modal
  returnToMainDashboard();
}

// Show modal after first free scan (only once per day)
function showFirstScanUpsellModal() {
  // Check if modal has already been shown today
  const today = new Date().toDateString();
  const firstScanModalKey = 'firstScanModalShown_' + today;
  const firstScanModalShown = localStorage.getItem(firstScanModalKey);
  console.log('🔍 Checking firstScanModalShown for today:', today, 'value:', firstScanModalShown);
  if (firstScanModalShown === 'true') {
    console.log('🔍 Modal already shown today, skipping');
    return; // Don't show again today
  }
  
  console.log('🔍 Showing first scan modal');
  // Mark as shown for today
  localStorage.setItem(firstScanModalKey, 'true');
  
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100vh;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;';
  document.body.classList.add('modal-open');
  
  const popup = document.createElement('div');
  popup.style.cssText = 'background:#fff;padding:40px;border-radius:20px;max-width:450px;width:90%;text-align:center;box-shadow:0 20px 40px rgba(0,0,0,0.3);position:relative';

  popup.innerHTML = '<button onclick="this.parentElement.parentElement.remove(); document.body.classList.remove(\'modal-open\');" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:32px;color:#999;cursor:pointer;padding:10px 15px;line-height:1;border-radius:50%;transition:all 0.3s;" onmouseover="this.style.color=\'#dc2626\'; this.style.background=\'#fee2e2\';" onmouseout="this.style.color=\'#999\'; this.style.background=\'none\';">×</button>' +
    '<h2 style="color:#0b0646;margin:0 0 20px;font-size:1.8em;font-weight:800">3 free scans per day — that\'s it, fr 📄</h2>' +
    '<p style="color:#666;margin:0 0 28px;font-size:1em;line-height:1.4">Need a quick Pro-level fix?</p>' +
    '<button class="btn-secondary btn-block" onclick="this.parentElement.parentElement.remove(); document.body.classList.remove(\'modal-open\'); setTimeout(switchToQuickFix, 100);" style="margin:12px 0;font-size:1.1em;background:#ea580c;color:white;border:none;padding:12px 20px;border-radius:8px;font-weight:700;cursor:pointer;"><span style="color: #ffeb3b !important; display: inline-block; text-shadow: -2px -2px 0px #666, 2px -2px 0px #666, -2px 2px 0px #666, 2px 2px 0px #666, 0 0 15px #ffeb3b, 0 0 25px #ffeb3b, 0 0 35px #ffeb3b; filter: brightness(1.5) saturate(2) !important; font-weight: bold; -webkit-text-stroke: 1px #666; text-stroke: 1px #666;">⚡</span> QuickFix - $1.99</button>' +
    '<p style="color:#666;margin:8px 0 16px 0;font-size:0.85em;">Find and fix this essay (one-time)</p>' +
    '<button class="btn-success btn-block" onclick="this.parentElement.parentElement.remove(); document.body.classList.remove(\'modal-open\'); handleProUpgrade();" style="margin:12px 0;font-size:1.1em;background:#00a8e8;color:white;border:none;padding:12px 20px;border-radius:8px;font-weight:700;cursor:pointer;">💎 Pro - $9.99/mo</button>' +
    '<p style="color:#666;margin:8px 0 20px 0;font-size:0.85em;">Get best word suggestions less likely to trigger detectors • Up to 500 scans and fixes • Cancel anytime</p>' +
    '<a href="javascript:void(0)" onclick="this.parentElement.parentElement.remove(); document.body.classList.remove(\'modal-open\');" style="display:block;text-align:center;margin-top:20px;color:#9ca3af;font-size:13px;text-decoration:underline;cursor:pointer">Nah, I\'ll risk it with free</a>';
  
  modal.appendChild(popup);
  document.body.appendChild(modal);
  console.log('🔍 Modal appended to body. Modal element:', modal);
  console.log('🔍 Modal display style:', modal.style.display);
  console.log('🔍 Modal z-index:', modal.style.zIndex);
  console.log('🔍 Body has modal-open class:', document.body.classList.contains('modal-open'));

  modal.onclick = function (e) {
    if (e.target === modal) {
      modal.remove();
      document.body.classList.remove('modal-open');
    }
  };
}

// Show modal on last free scan (scan 3) - Gen Z style
function showLastScanUpsellModal() {
  // Check if modal has already been shown today (prevent multiple shows)
  const today = new Date().toDateString();
  const lastScanModalKey = 'lastScanModalShown_' + today;
  const lastScanModalShown = localStorage.getItem(lastScanModalKey);
  if (lastScanModalShown === 'true') {
    console.log('🔍 Last scan modal already shown today, skipping');
    return;
  }
  
  console.log('🔍 Showing last scan modal');
  // Mark as shown for today
  localStorage.setItem(lastScanModalKey, 'true');
  
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100vh;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;';
  document.body.classList.add('modal-open');

  const popup = document.createElement('div');
  popup.style.cssText = 'background:#fff;padding:40px;border-radius:20px;max-width:450px;width:90%;text-align:center;box-shadow:0 20px 40px rgba(0,0,0,0.3);position:relative';

  popup.innerHTML = '<button onclick="this.parentElement.parentElement.remove(); document.body.classList.remove(\'modal-open\');" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:32px;color:#999;cursor:pointer;padding:10px 15px;line-height:1;border-radius:50%;transition:all 0.3s;" onmouseover="this.style.color=\'#dc2626\'; this.style.background=\'#fee2e2\';" onmouseout="this.style.color=\'#999\'; this.style.background=\'none\';">×</button>' +
    '<h2 style="color:#0b0646;margin:0 0 20px;font-size:1.8em;font-weight:800">💀 You\'re outta free scans, fam</h2>' +
    '<p style="color:#666;margin:0 0 28px;font-size:1em;line-height:1.4">No cap, you\'ve used all 3. Time to level up and keep catching those AI triggers before your prof does.</p>' +
    '<button class="btn-secondary btn-block" onclick="this.parentElement.parentElement.remove(); document.body.classList.remove(\'modal-open\'); setTimeout(switchToQuickFix, 100);" style="margin:12px 0;font-size:1.1em;background:#ea580c;color:white;border:none;padding:12px 20px;border-radius:8px;font-weight:700;cursor:pointer;"><span style="color: #ffeb3b !important; display: inline-block; text-shadow: -2px -2px 0px #666, 2px -2px 0px #666, -2px 2px 0px #666, 2px 2px 0px #666, 0 0 15px #ffeb3b, 0 0 25px #ffeb3b, 0 0 35px #ffeb3b; filter: brightness(1.5) saturate(2) !important; font-weight: bold; -webkit-text-stroke: 1px #666; text-stroke: 1px #666;">⚡</span> QuickFix - $1.99</button>' +
    '<p style="color:#666;margin:8px 0 16px 0;font-size:0.85em;">Find and fix this essay (one-time)</p>' +
    '<button class="btn-success btn-block" onclick="this.parentElement.parentElement.remove(); document.body.classList.remove(\'modal-open\'); handleProUpgrade();" style="margin:12px 0;font-size:1.1em;background:#00a8e8;color:white;border:none;padding:12px 20px;border-radius:8px;font-weight:700;cursor:pointer;">💎 Pro - $9.99/mo</button>' +
    '<p style="color:#666;margin:8px 0 20px 0;font-size:0.85em;">Get best word suggestions less likely to trigger detectors • Up to 500 scans and fixes • Cancel anytime</p>' +
    '<a href="javascript:void(0)" onclick="this.parentElement.parentElement.remove(); document.body.classList.remove(\'modal-open\');" style="display:block;text-align:center;margin-top:20px;color:#9ca3af;font-size:13px;text-decoration:underline;cursor:pointer">Nah, I\'ll risk it with free....again 🤦</a>';

  modal.appendChild(popup);
  document.body.appendChild(modal);

  modal.onclick = function (e) {
    if (e.target === modal) {
      modal.remove();
      document.body.classList.remove('modal-open');
    }
  };
}

// Show modal for "Get Another QuickFix" button
function showGetAnotherQuickFixModal() {
  const modal = document.createElement('div');
  modal.id = 'getAnotherQuickFixModal';
  modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100vh;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;';
  document.body.classList.add('modal-open');

  const popup = document.createElement('div');
  popup.style.cssText = 'background:#fff;padding:30px;border-radius:20px;max-width:450px;width:90%;text-align:center;box-shadow:0 20px 40px rgba(0,0,0,0.3);position:relative';

  popup.innerHTML = '<button onclick="document.getElementById(\'getAnotherQuickFixModal\').remove(); document.body.classList.remove(\'modal-open\');" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:32px;color:#999;cursor:pointer;padding:10px 15px;line-height:1;border-radius:50%;transition:all 0.3s;" onmouseover="this.style.color=\'#dc2626\'; this.style.background=\'#fee2e2\';" onmouseout="this.style.color=\'#999\'; this.style.background=\'none\';">×</button>' +
    '<h2 style="color:#0b0646;margin:0 0 12px;font-size:1.8em;font-weight:800"><span style="color: #ffeb3b !important; display: inline-block; text-shadow: -2px -2px 0px #666, 2px -2px 0px #666, -2px 2px 0px #666, 2px 2px 0px #666, 0 0 15px #ffeb3b, 0 0 25px #ffeb3b, 0 0 35px #ffeb3b; filter: brightness(1.5) saturate(2) !important; font-weight: bold; -webkit-text-stroke: 1px #666; text-stroke: 1px #666;">⚡</span> Need Another QuickFix?</h2>' +
    '<p style="color:#666;margin:0 0 20px;font-size:1em;line-height:1.4">Your QuickFix purchase was for one essay only. Want to scan and fix another one?</p>' +
    '<button class="btn-secondary btn-block" onclick="handleGetAnotherQuickFix();" style="margin:8px 0;font-size:1.1em;background:#ea580c;color:white;border:none;padding:12px 20px;border-radius:8px;font-weight:700;cursor:pointer;"><span style="color: #ffeb3b !important; display: inline-block; text-shadow: -2px -2px 0px #666, 2px -2px 0px #666, -2px 2px 0px #666, 2px 2px 0px #666, 0 0 15px #ffeb3b, 0 0 25px #ffeb3b, 0 0 35px #ffeb3b; filter: brightness(1.5) saturate(2) !important; font-weight: bold; -webkit-text-stroke: 1px #666; text-stroke: 1px #666;">⚡</span> Get Another QuickFix - $1.99</button>' +
    '<button class="btn-success btn-block" onclick="document.getElementById(\'getAnotherQuickFixModal\').remove(); document.body.classList.remove(\'modal-open\'); handleProUpgrade();" style="margin:8px 0;font-size:1.1em;background:#00a8e8;color:white;border:none;padding:12px 20px;border-radius:8px;font-weight:700;cursor:pointer;">💎 Go Pro - 500 Scans/Month</button>' +
    '<p style="color:#666;margin:4px 0 8px 0;font-size:0.85em;">Find ALL AI trigger words • 500 monthly scans • Cancel anytime</p>' +
    '<a href="javascript:void(0)" onclick="document.getElementById(\'getAnotherQuickFixModal\').remove(); document.body.classList.remove(\'modal-open\');" style="display:block;text-align:center;margin-top:12px;color:#9ca3af;font-size:13px;text-decoration:underline;cursor:pointer">Cancel</a>';

  modal.appendChild(popup);
  document.body.appendChild(modal);

  modal.onclick = function (e) {
    if (e.target === modal) {
      modal.remove();
      document.body.classList.remove('modal-open');
    }
  };
}

// Handle "Get Another QuickFix" confirmation - clear form and go to QuickFix
function handleGetAnotherQuickFix() {
  // Remove modal
  const modal = document.getElementById('getAnotherQuickFixModal');
  if (modal) {
    modal.remove();
    document.body.classList.remove('modal-open');
  }
  
  // Clear all form inputs
  const essayInput = document.getElementById('essayInput');
  const quickfixInput = document.getElementById('quickfixEssayInput');
  if (essayInput) essayInput.value = '';
  if (quickfixInput) quickfixInput.value = '';
  
  // Reset counters
  const charCount = document.getElementById('charCount');
  const quickfixCharCount = document.getElementById('quickfixFlowCharCount');
  if (charCount) charCount.textContent = '0';
  if (quickfixCharCount) quickfixCharCount.textContent = '0';
  
  // Reset appState
  appState.quickfixOriginalText = '';
  appState.quickfixFlags = [];
  appState.quickfixOriginalScore = 0;
  
  // Reset authorship checkbox
  const authorshipCheckbox = document.getElementById('authorshipCheckbox');
  if (authorshipCheckbox) authorshipCheckbox.checked = false;
  
  const quickfixAuthorshipCheckbox = document.getElementById('quickfixAuthorshipCheckbox');
  if (quickfixAuthorshipCheckbox) quickfixAuthorshipCheckbox.checked = false;
  
  // Update counter
  updateCounter();
  
  // Go to QuickFix step 1
  switchToQuickFix();
}

// FIXED: Simple working copy function
function copyQuickFixResult() {
  
  // Get text from the comparisonFixed element
  const comparisonElement = document.getElementById('comparisonFixed');
  if (!comparisonElement) {
    showSuccessMessage('❌ No text found');
    return;
  }
  
  // Let's try a completely different approach - get the original text from appState
  let textToCopy = '';
  
  // First try to get from appState if available
  if (appState.quickfixFixedText && appState.quickfixFixedText.trim()) {
    textToCopy = appState.quickfixFixedText;
    console.log('Using appState text:', textToCopy);
  } else {
    // Fallback to DOM element but with aggressive cleaning
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = comparisonElement.innerHTML;
    
    // Remove ALL HTML tags completely
    const allElements = tempDiv.querySelectorAll('*');
    allElements.forEach(el => {
      const textNode = document.createTextNode(el.textContent);
      el.parentNode.replaceChild(textNode, el);
    });
    
    textToCopy = tempDiv.textContent || tempDiv.innerText || '';
    console.log('Using DOM text:', textToCopy);
  }
  
  // Clean up the text aggressively
  textToCopy = textToCopy
    .replace(/<[^>]*>/g, '')  // Remove any remaining HTML tags
    .replace(/&nbsp;/g, ' ')
    .replace(/&amp;/g, '&')
    .replace(/&lt;/g, '<')
    .replace(/&gt;/g, '>')
    .replace(/&quot;/g, '"')
    .replace(/&#39;/g, "'")
    .replace(/\s+/g, ' ')
    .trim();
  
  if (!textToCopy) {
    showSuccessMessage('❌ No text to copy');
    return;
  }
  
  console.log('Final text to copy:', textToCopy);
  
  // Copy to clipboard using a more reliable method
  try {
    // Create a temporary textarea element
    const textArea = document.createElement('textarea');
    textArea.value = textToCopy;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    // Execute the copy command
    const successful = document.execCommand('copy');
    document.body.removeChild(textArea);
    
    if (successful) {
      showSuccessMessage('✅ Text Copied to Clipboard');
      // Change button to green after clicking
      const copyButtons = document.querySelectorAll('button[onclick="copyQuickFixResult()"]');
      copyButtons.forEach(btn => {
        if (btn.textContent.includes('Copy Text')) {
          btn.style.background = '#2ecc71';
          btn.style.color = '#003d7a';
          btn.style.border = '2px solid #2ecc71';
        }
      });
    } else {
      showSuccessMessage('❌ Failed to Copy');
    }
  } catch (err) {
    showSuccessMessage('❌ Failed to Copy');
  }
}

function sendAsIs() {
  // Get text from the comparisonFixed element
  const comparisonElement = document.getElementById('comparisonFixed');
  if (!comparisonElement) {
    showSuccessMessage('❌ No text found');
    return;
  }
  
  // Get clean text by creating a temporary element and stripping all formatting
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = comparisonElement.innerHTML;
  
  // Remove all span elements with classes (these contain the green highlighting)
  const spans = tempDiv.querySelectorAll('span[class]');
  spans.forEach(span => {
    const textNode = document.createTextNode(span.textContent);
    span.parentNode.replaceChild(textNode, span);
  });
  
  // Get the clean text
  let textToCopy = tempDiv.textContent || tempDiv.innerText;
  
  // Clean up the text
  textToCopy = textToCopy
    .replace(/&nbsp;/g, ' ')
    .replace(/&amp;/g, '&')
    .replace(/&lt;/g, '<')
    .replace(/&gt;/g, '>')
    .replace(/&quot;/g, '"')
    .replace(/&#39;/g, "'")
    .replace(/\s+/g, ' ')
    .trim();
  
  if (!textToCopy) {
    showSuccessMessage('❌ No text to copy');
    return;
  }
  
  // Copy to clipboard
  navigator.clipboard.writeText(textToCopy).then(() => {
    showSuccessMessage('✅ Text Copied to Clipboard');
  }).catch(() => {
    showSuccessMessage('❌ Failed to Copy');
  });
}

function showProUpsell() {
  handleProUpgrade();
}
// Modern Gen Z-friendly authorship reminder
function showAuthorshipReminder() {
  const checkboxContainer = document.querySelector('#authorshipCheckbox').closest('div');
  if (!checkboxContainer) return;
  
  // Remove any existing reminder
  const existingReminder = document.getElementById('authorshipReminder');
  if (existingReminder) {
    existingReminder.remove();
  }
  
  // Create the reminder tooltip
  const reminder = document.createElement('div');
  reminder.id = 'authorshipReminder';
  reminder.innerHTML = `
    <div style="
      position: absolute;
      top: -50px;
      left: 0;
      right: 0;
      background: #dc2626;
      color: white;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 8px 25px rgba(220, 38, 38, 0.3);
      z-index: 1000;
      animation: slideDown 0.3s ease-out;
    ">
      <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
        <span style="font-size: 18px;">👇</span>
        <span>Hey! Check this first</span>
      </div>
      <div style="
        position: absolute;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 8px solid #dc2626;
      "></div>
    </div>
  `;
  
  // Add CSS animation
  if (!document.getElementById('authorshipReminderStyles')) {
    const style = document.createElement('style');
    style.id = 'authorshipReminderStyles';
    style.textContent = `
      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
      }
    `;
    document.head.appendChild(style);
  }
  
  // Add pulse animation to checkbox container
  checkboxContainer.style.position = 'relative';
  checkboxContainer.style.animation = 'pulse 0.6s ease-in-out 2';
  checkboxContainer.style.transformOrigin = 'center';
  
  // Insert the reminder
  checkboxContainer.appendChild(reminder);
  
  // Auto-remove after 4 seconds
  setTimeout(() => {
    if (reminder.parentNode) {
      reminder.style.animation = 'slideDown 0.3s ease-out reverse';
      setTimeout(() => {
        if (reminder.parentNode) {
          reminder.remove();
        }
      }, 300);
    }
    checkboxContainer.style.animation = '';
  }, 4000);
}

function getDynamicMessage(score) {
  // Kinda Sus messages (30-69)
  const kindaSusMessages = [
    "Close, but let's make this chef's kiss 👌",
    "You're almost there, just needs a lil finesse ✨",
    "Few tweaks and this goes hard 🔥",
    "One more pass and you're untouchable 💯",
    "Nearly there, let's polish this up ⚡"
  ];
  
  // You're Good messages (0-29)
  const youreGoodMessages = [
    "Your writing is literally immaculate ✨",
    "This essay just hits different 🔥",
    "You cooked with this one fr fr 👌",
    "No notes, this is pure 🧬",
    "This is giving main character energy 💅"
  ];
  
  // Hella Sus messages (70-100)
  const hellaSusMessages = [
    "Nah this is giving ChatGPT energy 😬",
    "Yeah nah, your prof's gonna catch this one 🚩",
    "This is sus as hell, we gotta fix it 💀",
    "Not the vibe, let's start over bestie 😭",
    "Yo this is cooked, big yikes energy 📉"
  ];
  
  let messages;
  if (score >= 70) {
    messages = hellaSusMessages;
  } else if (score >= 30) {
    messages = kindaSusMessages;
  } else {
    messages = youreGoodMessages;
  }
  
  // Return random message from the appropriate array
  return messages[Math.floor(Math.random() * messages.length)];
}

function getDynamicPhrase(score) {
  // You're Good phrases (0-29)
  const youreGoodPhrases = [
    "Slay",
    "Ate",
    "Bussin",
    "Unmatched",
    "Immaculate"
  ];
  
  // Kinda Sus phrases (30-69)
  const kindaSusPhrases = [
    "Close",
    "Almost",
    "Nearly",
    "Halfway",
    "Getting there"
  ];
  
  // Hella Sus phrases (70-100)
  const hellaSusPhrases = [
    "Yikes",
    "Nope",
    "Yikes",
    "Cooked",
    "Oof"
  ];
  
  let phrases;
  if (score >= 70) {
    phrases = hellaSusPhrases;
  } else if (score >= 30) {
    phrases = kindaSusPhrases;
  } else {
    phrases = youreGoodPhrases;
  }
  
  // Return random phrase from the appropriate array
  return phrases[Math.floor(Math.random() * phrases.length)];
}

// Get emoji for dynamic phrase
function getPhraseEmoji(phrase) {
  const emojiMap = {
    // You're Good phrases
    "Slay": "✨",
    "Ate": "🍽️",
    "Bussin": "🔥",
    "Unmatched": "👑",
    "Immaculate": "💎",
    // Kinda Sus phrases
    "Close": "🎯",
    "Almost": "📈",
    "Nearly": "⚡",
    "Halfway": "⏳",
    "Getting there": "🚀",
    // Hella Sus phrases
    "Yikes": "😬",
    "Nope": "🚫",
    "Cooked": "💀",
    "Oof": "😅"
  };
  return emojiMap[phrase] || "✨";
}

function updateSusBar(score, cardType) {
  // Clamp score between 0 and 100
  const clamped = Math.max(0, Math.min(score, 100));
  
  // Determine which indicator to update based on card type
  let indicatorId;
  if (cardType === 'youreGood') {
    indicatorId = 'youreGoodProgressIndicator';
  } else if (cardType === 'kinda') {
    indicatorId = 'kindaSusProgressIndicator';
  } else if (cardType === 'hella') {
    indicatorId = 'hellaSusProgressIndicator';
  } else {
    // Try all indicators if cardType not specified
    indicatorId = null;
  }
  
  // Use the unified updateProgressIndicator function
  if (indicatorId) {
    updateProgressIndicator(clamped, indicatorId);
  } else {
    // Update all indicators
    ['youreGoodProgressIndicator', 'kindaSusProgressIndicator', 'hellaSusProgressIndicator'].forEach(id => {
      updateProgressIndicator(clamped, id);
    });
  }
}

function updateScoreLabelColor(score, labelElementId) {
  const label = document.getElementById(labelElementId);
  if (!label) return;
  
  // Find the corresponding score number element
  const scoreNumber = label.parentElement.querySelector('.score-number');
  
  label.classList.remove('sus-af', 'kinda-sus', 'sus-free');
  
  // Unified thresholds: 0-29 = "You're Good", 30-69 = "Kinda Sus", 70-100 = "Hella Sus"
  if (score >= 70) {
    label.textContent = 'Hella Sus';
    label.classList.add('sus-af');
    if (scoreNumber) scoreNumber.style.color = '#dc2626'; // Dark orange/red
  } else if (score >= 30) {
    label.textContent = 'Kinda Sus';
    label.classList.add('kinda-sus');
    if (scoreNumber) scoreNumber.style.color = '#eed202'; // Warning yellow
  } else {
    label.textContent = "Clean - No Sus";
    label.classList.add('sus-free');
    label.style.color = '#6b7280'; // GRAY
    label.style.fontSize = '14px'; // SMALLER FONT
    if (scoreNumber) scoreNumber.style.color = '#2ecc71'; // GREEN
  }
}

function updateProgressIndicator(score, indicatorId) {
  // Default to Step 2 indicator if no ID specified (for backward compatibility)
  const id = indicatorId || 'quickfixProgressIndicator';
  const indicator = document.getElementById(id);
  if (!indicator) return;
  
  // Reset classes
  indicator.classList.remove('high-sus', 'medium-sus', 'low-sus');
  
  // Set position based on score (0-100%)
  indicator.style.left = score + '%';
  
  // Set color based on score tier
  if (score >= 71) {
    indicator.classList.add('high-sus');
  } else if (score >= 31) {
    indicator.classList.add('medium-sus');
  } else {
    indicator.classList.add('low-sus');
  }
}

function updateWarningMessage(score, containerId, titleId, subtitleId) {
  const container = document.getElementById(containerId);
  const title = document.getElementById(titleId);
  const subtitle = document.getElementById(subtitleId);
  
  if (!container || !title || !subtitle) return;
  
  // Always show the container
  container.style.display = 'block';
  
  if (score <= 30) {
    // You're Good - Ready to turn in
    title.textContent = '✅ Ready To Turn In';
    title.style.color = '#00a8e8'; // Green
    subtitle.textContent = 'But if you want your score even lower, consider fixing the trigger words below';
    subtitle.style.display = 'block';
  } else if (score >= 31 && score < 60) {
    // Kinda Sus - Almost there
    title.textContent = '⚠️ Almost There';
    title.style.color = '#eed202'; // Warning yellow
    subtitle.textContent = 'A few more fixes and you\'ll be in the clear. Let\'s make it perfect!';
    subtitle.style.display = 'block';
  } else {
    // Hella Sus - Don't turn it in yet
    title.textContent = '✋ Don\'t Turn It In Yet';
    title.style.color = '#00a8e8'; // Blue
    subtitle.textContent = 'Your essay needs some fixes before it\'s safe to submit';
    subtitle.style.display = 'block';
  }
}

// FIXED TOOLTIP FUNCTIONS - WORKING PROPERLY
function showTooltip(event, message) {
  let tooltip = document.getElementById('tooltip');
  if (!tooltip) {
    tooltip = document.createElement('div');
    tooltip.id = 'tooltip';
    tooltip.className = 'tooltip';
    document.body.appendChild(tooltip);
  }

  tooltip.innerHTML = message;
  tooltip.classList.add('show');
  
  // Position tooltip near cursor
  const x = event.clientX + 15;
  const y = event.clientY + 15;
  
  tooltip.style.left = x + 'px';
  tooltip.style.top = y + 'px';
}

function hideTooltip() {
  const tooltip = document.getElementById('tooltip');
  if (tooltip) {
    tooltip.classList.remove('show');
  }
}

// NEW: Better tooltip system using data attributes
function initTooltips() {
  const tooltipElements = document.querySelectorAll('[data-tooltip]');
  
  tooltipElements.forEach(element => {
    element.addEventListener('mouseenter', function(e) {
      // Check if authorship checkbox is checked before showing tooltip
      const authorshipCheckbox = document.getElementById('authorshipCheckbox');
      if (authorshipCheckbox && !authorshipCheckbox.checked) {
        return; // Hide tooltip if checkbox is not checked
      }
      
      const message = this.getAttribute('data-tooltip');
      showTooltip(e, message);
    });
    
    element.addEventListener('mouseleave', hideTooltip);
    element.addEventListener('mousemove', function(e) {
      const tooltip = document.getElementById('tooltip');
      if (tooltip && tooltip.classList.contains('show')) {
        tooltip.style.left = (e.clientX + 15) + 'px';
        tooltip.style.top = (e.clientY + 15) + 'px';
      }
    });
  });
  
  // FIX 5: Add progress bar tooltips
  const progressLabels = document.querySelectorAll('.progress-labels span');
  progressLabels.forEach((label, index) => {
    let tooltipText = '';
    if (index === 0) tooltipText = "Clean - No Sus = Human AF";
    if (index === 1) tooltipText = 'Kinda Sus = Might pass, might not';
    if (index === 2) tooltipText = 'Hella Sus = Robot vibes detected';
    
    label.setAttribute('data-tooltip', tooltipText);
    label.style.cursor = 'help';
    
    label.addEventListener('mouseenter', function(e) {
      showTooltip(e, tooltipText);
    });
    
    label.addEventListener('mouseleave', hideTooltip);
  });
}

// FIXED: Success Message with Dynamic Color Theming
function showSuccessMessage(message, color = '#00a8e8') {
  const existing = document.getElementById('successMessage');
  if (existing) existing.remove();

  const successMsg = document.createElement('div');
  successMsg.id = 'successMessage';
  successMsg.className = 'tooltip'; // Use tooltip class for consistency
  successMsg.textContent = message;
  
  // Add border class for consistent styling
  successMsg.classList.add('colored-border');
  successMsg.classList.add('show');
  
  // Style it as a toast (centered, fixed position) with dynamic color
  successMsg.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10001;
    background: white;
    color: ${color};
    padding: 16px 24px;
    border-radius: 12px;
    border: 2px solid ${color};
    font-weight: 600;
    box-shadow: 0 10px 30px ${color}33;
    max-width: 300px;
    text-align: center;
    word-wrap: break-word;
  `;

  document.body.appendChild(successMsg);

  setTimeout(() => {
    if (successMsg.parentNode) {
      successMsg.classList.remove('show');
      setTimeout(() => successMsg.remove(), 300);
    }
  }, 2000);
}

// Styled Alert Modal - Replaces browser alert() with styled modal
function showStyledAlert(message) {
  // Remove any existing styled alert
  const existing = document.getElementById('styledAlertModal');
  if (existing) existing.remove();

  // Create modal overlay
  const modalOverlay = document.createElement('div');
  modalOverlay.id = 'styledAlertModal';
  modalOverlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 10002;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    animation: fadeIn 0.3s ease;
  `;

  // Create modal content
  const modalContent = document.createElement('div');
  modalContent.style.cssText = `
    background: white;
    border-radius: 20px;
    max-width: 400px;
    width: 100%;
    padding: 0;
    position: relative;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: slideUp 0.3s ease;
  `;

  // Create modal header
  const modalHeader = document.createElement('div');
  modalHeader.style.cssText = `
    background: linear-gradient(135deg, #ff6b00 0%, #ff8c42 100%);
    color: white;
    padding: 24px 30px;
    text-align: center;
    border-radius: 20px 20px 0 0;
    font-size: 20px;
    font-weight: 700;
  `;
  modalHeader.textContent = '⚠️ Select a Fix';

  // Create modal body
  const modalBody = document.createElement('div');
  modalBody.style.cssText = `
    padding: 30px;
    text-align: center;
    color: #374151;
    font-size: 16px;
    line-height: 1.6;
  `;
  modalBody.textContent = message;

  // Create OK button
  const okButton = document.createElement('button');
  okButton.style.cssText = `
    background: linear-gradient(135deg, #ff6b00 0%, #ff8c42 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 12px 32px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    margin: 0 auto 20px;
    display: block;
    transition: transform 0.2s, box-shadow 0.2s;
    box-shadow: 0 4px 12px rgba(255, 107, 0, 0.3);
  `;
  okButton.textContent = 'OK';
  okButton.onmouseover = function() {
    this.style.transform = 'translateY(-2px)';
    this.style.boxShadow = '0 6px 16px rgba(255, 107, 0, 0.4)';
  };
  okButton.onmouseout = function() {
    this.style.transform = 'translateY(0)';
    this.style.boxShadow = '0 4px 12px rgba(255, 107, 0, 0.3)';
  };
  okButton.onclick = function() {
    modalOverlay.style.animation = 'fadeOut 0.3s ease';
    modalContent.style.animation = 'slideDown 0.3s ease';
    setTimeout(() => {
      if (modalOverlay.parentNode) {
        modalOverlay.remove();
      }
    }, 300);
  };

  // Close on overlay click
  modalOverlay.onclick = function(e) {
    if (e.target === modalOverlay) {
      okButton.click();
    }
  };

  // Assemble modal
  modalContent.appendChild(modalHeader);
  modalContent.appendChild(modalBody);
  modalContent.appendChild(okButton);
  modalOverlay.appendChild(modalContent);
  document.body.appendChild(modalOverlay);

  // Focus the button for keyboard accessibility
  okButton.focus();
}

// FIX 6: Updated Scan New Text Function with Pro Upsell
function scanNewText() {
  // Check if we're on free results page - if so, skip QuickFix modal check
  const hellaSusCard = document.getElementById('hellaSusCard');
  const kindaSusCard = document.getElementById('kindaSusCard');
  const youreGoodCard = document.getElementById('youreGoodCard');
  
  // Check display style - need to check computed style, not just inline style
  const hellaSusVisible = hellaSusCard && window.getComputedStyle(hellaSusCard).display !== 'none';
  const kindaSusVisible = kindaSusCard && window.getComputedStyle(kindaSusCard).display !== 'none';
  const youreGoodVisible = youreGoodCard && window.getComputedStyle(youreGoodCard).display !== 'none';
  
  const isOnFreeResults = hellaSusVisible || kindaSusVisible || youreGoodVisible;
  
  console.log('🔍 scanNewText called:', {
    isQuickFixUser: appState.isQuickFixUser,
    isOnFreeResults: isOnFreeResults,
    hellaSusVisible: hellaSusVisible,
    kindaSusVisible: kindaSusVisible,
    youreGoodVisible: youreGoodVisible
  });
  
  // Only show QuickFix modal if NOT on free results page
  if (appState.isQuickFixUser && !isOnFreeResults) {
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100vh;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;';
    document.body.classList.add('modal-open');

    const popup = document.createElement('div');
    popup.style.cssText = 'background:#fff;padding:30px;border-radius:20px;max-width:450px;width:90%;text-align:center;box-shadow:0 20px 40px rgba(0,0,0,0.3);position:relative';

    popup.innerHTML = '<button onclick="this.parentElement.parentElement.remove(); document.body.classList.remove(\'modal-open\');" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:32px;color:#999;cursor:pointer;padding:10px 15px;line-height:1;border-radius:50%;transition:all 0.3s;" onmouseover="this.style.color=\'#dc2626\'; this.style.background=\'#fee2e2\';" onmouseout="this.style.color=\'#999\'; this.style.background=\'none\';">×</button>' +
      '<h2 style="color:#0b0646;margin:0 0 12px;font-size:1.8em;font-weight:800"><span style="color: #ffeb3b !important; display: inline-block; text-shadow: -2px -2px 0px #666, 2px -2px 0px #666, -2px 2px 0px #666, 2px 2px 0px #666, 0 0 15px #ffeb3b, 0 0 25px #ffeb3b, 0 0 35px #ffeb3b; filter: brightness(1.5) saturate(2) !important; font-weight: bold; -webkit-text-stroke: 1px #666; text-stroke: 1px #666;">⚡</span> Need Another QuickFix?</h2>' +
      '<p style="color:#666;margin:0 0 20px;font-size:1em;line-height:1.4">Your QuickFix purchase was for one essay only. Want to scan and fix another one?</p>' +
      '<button class="btn-secondary btn-block" onclick="this.parentElement.parentElement.remove(); setTimeout(switchToQuickFix, 100);" style="margin:8px 0;font-size:1.1em;"><span style="color: #ffeb3b !important; display: inline-block; text-shadow: -2px -2px 0px #666, 2px -2px 0px #666, -2px 2px 0px #666, 2px 2px 0px #666, 0 0 15px #ffeb3b, 0 0 25px #ffeb3b, 0 0 35px #ffeb3b; filter: brightness(1.5) saturate(2) !important; font-weight: bold; -webkit-text-stroke: 1px #666; text-stroke: 1px #666;">⚡</span> Get Another QuickFix - $1.99</button>' +
      // FIX 6: Added Pro Upsell CTA
      '<button class="btn-success btn-block" onclick="this.parentElement.parentElement.remove();handleProUpgrade();" style="margin:8px 0;" data-tooltip="Find ALL AI trigger words + 500 monthly scans - Only $9.99/month">💎 Go Pro - 500 Scans/Month</button>' +
      '<p style="color:#666;margin:4px 0 8px 0;font-size:0.85em;">Find ALL AI trigger words • 500 monthly scans • Cancel anytime</p>' +
      '<button class="btn-outline btn-block" onclick="this.parentElement.parentElement.remove();clearFormAndReturnToTop();" style="margin:8px 0;">Just Scan (Free)</button>' +
      '<a href="javascript:void(0)" onclick="this.parentElement.parentElement.remove();" style="display:block;text-align:center;margin-top:12px;color:#9ca3af;font-size:13px;text-decoration:underline;cursor:pointer">Cancel</a>';

    modal.appendChild(popup);
    document.body.appendChild(modal);

    modal.onclick = function (e) {
      if (e.target === modal) {
        modal.remove();
        document.body.classList.remove('modal-open');
      }
    };
  } else {
    // Free version: Show upsell modal if they have 2 or fewer scans remaining
    const remaining = Math.max(0, FREE_SCAN_LIMIT - appState.scansUsed);
    
    console.log('🔍 scanNewText - Free version check:', {
      scansUsed: appState.scansUsed,
      remaining: remaining,
      isOnFreeResults: isOnFreeResults,
      FREE_SCAN_LIMIT: FREE_SCAN_LIMIT
    });
    
    if (remaining <= 2) {
      // Show upsell modal
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100vh;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;';
      document.body.classList.add('modal-open');

      const popup = document.createElement('div');
      popup.style.cssText = 'background:#fff;padding:30px;border-radius:20px;max-width:450px;width:90%;text-align:center;box-shadow:0 20px 40px rgba(0,0,0,0.3);position:relative';

      const scansUsed = appState.scansUsed;
      const totalScans = FREE_SCAN_LIMIT;
      
      popup.innerHTML = '<button onclick="this.parentElement.parentElement.remove(); document.body.classList.remove(\'modal-open\');" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:32px;color:#999;cursor:pointer;padding:10px 15px;line-height:1;border-radius:50%;transition:all 0.3s;" onmouseover="this.style.color=\'#dc2626\'; this.style.background=\'#fee2e2\';" onmouseout="this.style.color=\'#999\'; this.style.background=\'none\';">×</button>' +
        '<h2 style="color:#0b0646;margin:0 0 12px;font-size:1.8em;font-weight:800">Running Low on Free Scans?</h2>' +
        '<p style="color:#666;margin:0 0 20px;font-size:1em;line-height:1.4">You\'ve used ' + scansUsed + ' of ' + totalScans + ' free scans today. Upgrade to get 500 scans a month and fix all AI-trigger words.</p>' +
        '<button class="btn-secondary btn-block" onclick="this.parentElement.parentElement.remove(); document.body.classList.remove(\'modal-open\'); setTimeout(switchToQuickFix, 100);" style="margin:8px 0;font-size:1.1em;background:#ea580c;color:white;border:none;padding:12px 20px;border-radius:8px;font-weight:700;cursor:pointer;"><span style="color: #ffeb3b !important; display: inline-block; text-shadow: -2px -2px 0px #666, 2px -2px 0px #666, -2px 2px 0px #666, 2px 2px 0px #666, 0 0 15px #ffeb3b, 0 0 25px #ffeb3b, 0 0 35px #ffeb3b; filter: brightness(1.5) saturate(2) !important; font-weight: bold; -webkit-text-stroke: 1px #666; text-stroke: 1px #666;">⚡</span> QuickFix - $1.99</button>' +
        '<p style="color:#666;margin:4px 0 8px 0;font-size:0.85em;">Fix this essay now</p>' +
        '<button class="btn-success btn-block" onclick="this.parentElement.parentElement.remove(); document.body.classList.remove(\'modal-open\'); handleProUpgrade();" style="margin:8px 0;font-size:1.1em;background:#00a8e8;color:white;border:none;padding:12px 20px;border-radius:8px;font-weight:700;cursor:pointer;">💎 Pro - $9.99/mo</button>' +
        '<p style="color:#666;margin:4px 0 8px 0;font-size:0.85em;">500 scans/month + all fixes</p>' +
        '<button class="btn-outline btn-block" onclick="this.parentElement.parentElement.remove(); document.body.classList.remove(\'modal-open\'); clearFormAndReturnToTop();" style="margin:8px 0;background:white;color:#374151;border:2px solid #e5e7eb;padding:12px 20px;border-radius:8px;font-weight:600;cursor:pointer;">' + (remaining === 1 ? 'Use Last Free Scan' : 'Continue with Free') + '</button>' +
        '<a href="javascript:void(0)" onclick="this.parentElement.parentElement.remove(); document.body.classList.remove(\'modal-open\');" style="display:block;text-align:center;margin-top:12px;color:#9ca3af;font-size:13px;text-decoration:underline;cursor:pointer">Cancel</a>';

      modal.appendChild(popup);
      document.body.appendChild(modal);

      modal.onclick = function (e) {
        if (e.target === modal) {
          modal.remove();
          document.body.classList.remove('modal-open');
        }
      };
    } else {
      // They have more than 2 scans left, just clear and return
    clearFormAndReturnToTop();
      // Uncheck authorship checkbox
      const authorshipCheckbox = document.getElementById('authorshipCheckbox');
      if (authorshipCheckbox) {
        authorshipCheckbox.checked = false;
        updateCounter(); // Update button state
      }
    }
  }
}

// NEW: Clear form and return to top function
function clearFormAndReturnToTop() {
  switchToInput();

  const panicBanner = document.getElementById('panicBanner');
  if (panicBanner) panicBanner.style.display = 'none';

  // Clear all form inputs
  const essayInput = document.getElementById('essayInput');
  if (essayInput) essayInput.value = '';
  const quickfixInput = document.getElementById('quickfixEssayInput');
  if (quickfixInput) quickfixInput.value = '';
  
  // Reset counters
  const charCount = document.getElementById('charCount');
  if (charCount) charCount.textContent = '0';
  const quickfixCharCount = document.getElementById('quickfixFlowCharCount');
  if (quickfixCharCount) quickfixCharCount.textContent = '0';
  
  // Uncheck authorship checkbox
  const authorshipCheckbox = document.getElementById('authorshipCheckbox');
  if (authorshipCheckbox) {
    authorshipCheckbox.checked = false;
  }
  
  updateCounter();
  
  // Scroll to top of form
  const inputSection = document.getElementById('inputSection');
  if (inputSection) inputSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
  
  showSuccessMessage('Form cleared! Ready for your next essay 📝');
}


// Character limit popup functions
function showCharacterLimitModal() {
  const essayInputEl = document.getElementById('essayInput');
  const charCount = essayInputEl ? essayInputEl.value.length : 0;
  
  const modal = document.createElement('div');
  modal.id = 'characterLimitModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    backdrop-filter: blur(5px);
  `;
  
  modal.innerHTML = `
    <div id="characterLimitModalContent" style="
      background: white;
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      position: relative;
    ">
      <button onclick="hideCharacterLimitModal();" style="
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        font-size: 28px;
        color: #6b7280;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s;
      " onmouseover="this.style.background='#f3f4f6'; this.style.color='#374151';" onmouseout="this.style.background='none'; this.style.color='#6b7280';">
        ×
      </button>
      <div style="font-size: 48px; margin-bottom: 20px;">
        📝
      </div>
      <h2 style="color: #0b0646; margin-bottom: 15px; font-size: 24px;">
        Your essay is too long for a free scan
      </h2>
      <p style="color: #6b7280; margin-bottom: 15px; font-size: 16px; line-height: 1.6;">
        You've pasted <strong>${charCount.toLocaleString()}</strong> characters.<br>
        The free scan covers up to 500 characters.
      </p>
      <p style="color: #6b7280; margin-bottom: 20px; font-size: 16px; line-height: 1.6;">
        Choose how you want to continue:
      </p>
      
      <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
        <button class="btn-secondary" onclick="handleModalQuickFix();" style="
          background: #ea580c;
          color: white;
          border: none;
          padding: 15px 25px;
          border-radius: 12px;
          font-weight: 700;
          cursor: pointer;
          font-size: 16px;
        ">
          <span style="color: #ffeb3b !important; display: inline-block; text-shadow: -2px -2px 0px #666, 2px -2px 0px #666, -2px 2px 0px #666, 2px 2px 0px #666, 0 0 15px #ffeb3b, 0 0 25px #ffeb3b, 0 0 35px #ffeb3b; filter: brightness(1.5) saturate(2) !important; font-weight: bold; -webkit-text-stroke: 1px #666; text-stroke: 1px #666;">⚡</span> Upgrade to QuickFix ($1.99)
        </button>
        <button class="btn-success" onclick="handleModalPro();" style="
          background: #00a8e8;
          color: white;
          border: none;
          padding: 15px 25px;
          border-radius: 12px;
          font-weight: 700;
          cursor: pointer;
          font-size: 16px;
        ">
          💎 Upgrade to False Flag Fixer Pro ($9.99/mo)
        </button>
        <button class="btn-outline" onclick="trimTextAndScanFree();" style="
          background: transparent;
          color: #6b7280;
          border: 2px solid #e5e7eb;
          padding: 15px 25px;
          border-radius: 12px;
          font-weight: 600;
          cursor: pointer;
          font-size: 16px;
        ">
          Scan only the first 500 characters for free
        </button>
      </div>
      
      <!-- Authorship Confirmation (Read-only) - Moved to bottom -->
      <div style="margin-top: 20px; padding: 12px; background: #f0fdf4; border: 2px solid #86efac; border-radius: 8px; text-align: left;">
        <p style="color: #166534; font-size: 14px; margin: 0; font-weight: 600;">
          ✅ You've confirmed that you are the original author of this work.
        </p>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  document.body.classList.add('modal-open');
  
  // Add click-outside-to-close functionality
  modal.addEventListener('click', function(e) {
    // Close if clicking on the backdrop (not on the modal content)
    if (e.target === modal) {
      hideCharacterLimitModal();
    }
  });
  
  // Prevent clicks inside modal content from closing
  const modalContent = modal.querySelector('#characterLimitModalContent');
  if (modalContent) {
    modalContent.addEventListener('click', function(e) {
      e.stopPropagation();
    });
  }
}

function hideCharacterLimitModal() {
  const modal = document.getElementById('characterLimitModal');
  if (modal) {
    modal.remove();
    document.body.classList.remove('modal-open');
  }
}

// Handle Free Scan button click
function handleFreeScan() {
  const essayInput = document.getElementById('essayInput');
  const authorshipCheckbox = document.getElementById('authorshipCheckbox');
  
  if (!essayInput || !authorshipCheckbox) return;
  
  const text = essayInput.value.trim();
  const len = text.length;
  
  // Check authorship (should already be checked due to button state, but double-check)
  if (!authorshipCheckbox.checked) {
    showAuthorshipReminder();
    return;
  }
  
  // Check minimum length (should already be valid, but double-check)
  if (len < appState.minChars) {
    showSuccessMessage('Please paste at least 50 characters to continue.');
    return;
  }
  
  // Free Scan logic: ≤ 500 chars → scan directly, > 500 chars → show upgrade modal
  if (len <= 500) {
    // Scan directly - no modal needed
    scanEssay();
  } else {
    // Show upgrade modal
    showCharacterLimitModal();
  }
}

function trimTextAndScanFree() {
  const essayInput = document.getElementById('essayInput');
  if (essayInput) {
    // Trim text to 500 characters
    const trimmedText = essayInput.value.substring(0, 500);
    essayInput.value = trimmedText;
    // Update counter immediately to reflect trimmed length
    const charCount = document.getElementById('charCount');
    if (charCount) {
      charCount.textContent = trimmedText.length;
    }
    // Update counter function to sync everything
    updateCounter();
    // Hide modal
    hideCharacterLimitModal();
    // Scroll back to input section
    const inputSection = document.getElementById('inputSection');
    if (inputSection) {
      inputSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    // Show success message
    showSuccessMessage('Text trimmed to 500 characters. Click "Free Scan" to continue! 📝');
    // DO NOT automatically scan - let user click Free Scan button manually
  }
}

// Handle QuickFix button click from upgrade modal
function handleModalQuickFix() {
  // Authorship already confirmed (shown in modal)
  hideCharacterLimitModal();
  // Preserve text and redirect to QuickFix page
  appState.isQuickFixUser = true;
  switchToQuickFix();
}

// Handle Pro button click from upgrade modal
function handleModalPro() {
  // Authorship already confirmed (shown in modal)
  hideCharacterLimitModal();
  // Preserve text and redirect to Pro dashboard
  switchToPro();
}

// ===== WORKING DRAG & DROP FUNCTIONALITY =====
function handleDragOver(event) {
  event.preventDefault();
  event.stopPropagation();
  event.dataTransfer.dropEffect = 'copy';
  const uploadArea = event.currentTarget;
  uploadArea.style.backgroundColor = '#f0f9ff';
  uploadArea.style.borderColor = '#2ecc71';
  uploadArea.style.borderWidth = '3px';
}

function handleDragEnter(event) {
  event.preventDefault();
  event.stopPropagation();
  const uploadArea = event.currentTarget;
  uploadArea.style.backgroundColor = '#f0f9ff';
  uploadArea.style.borderColor = '#2ecc71';
  uploadArea.style.borderWidth = '3px';
}

function handleDragLeave(event) {
  event.preventDefault();
  event.stopPropagation();
  // Only reset if leaving the upload area itself, not its children
  if (event.currentTarget === event.target) {
    const uploadArea = event.currentTarget;
    uploadArea.style.backgroundColor = '';
    uploadArea.style.borderColor = '';
    uploadArea.style.borderWidth = '';
  }
}
function handleFileDrop(event) {
  event.preventDefault();
  event.stopPropagation();
  
  const uploadArea = event.currentTarget;
  uploadArea.style.backgroundColor = '';
  uploadArea.style.borderColor = '';
  uploadArea.style.borderWidth = '';
  
  const files = event.dataTransfer.files;
  
  if (files.length === 0) {
    showSuccessMessage('No files found');
    return;
  }
  
  const file = files[0];
  
  // Accept text files and documents
  const acceptedTypes = [
    'text/plain',
    'application/msword',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    'text/html',
    'application/rtf'
  ];
  
  const acceptedExtensions = ['.txt', '.doc', '.docx', '.pdf', '.rtf'];
  
  const isAcceptedType = acceptedTypes.includes(file.type) || 
    acceptedExtensions.some(ext => file.name.toLowerCase().endsWith(ext));
  
  if (!isAcceptedType) {
    showSuccessMessage('Please upload a text file (.txt) or Word document (.doc/.docx)');
    return;
  }
  
  const reader = new FileReader();
  
  reader.onload = function(e) {
    try {
      const text = e.target.result;
      const essayInput = document.getElementById('essayInput');
      
      if (essayInput) {
        essayInput.value = text;
        updateCounter();
        showSuccessMessage('✅ File uploaded successfully! ' + Math.round(text.length) + ' characters');
      }
    } catch (error) {
      console.error('Error processing file:', error);
      showSuccessMessage('❌ Error reading file');
    }
  };
  
  reader.onerror = function() {
    showSuccessMessage('❌ Error reading file. Please try again.');
  };
  
  // Handle PDF files specially
  if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
    showSuccessMessage('PDF files require special processing. Please convert to .txt or .docx first.');
    return;
  }
  
  reader.readAsText(file);
}

// Handle file selection from file input
function handleFileSelect(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  console.log('File selected:', file.name, file.type);
  
  // Accept text files and documents
  const acceptedTypes = [
    'text/plain',
    'application/msword',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    'text/html',
    'application/rtf'
  ];
  
  const acceptedExtensions = ['.txt', '.doc', '.docx', '.pdf', '.rtf'];
  
  const isAcceptedType = acceptedTypes.includes(file.type) || 
    acceptedExtensions.some(ext => file.name.toLowerCase().endsWith(ext));
  
  if (!isAcceptedType) {
    showSuccessMessage('Please upload a text file (.txt) or Word document (.doc/.docx)');
    return;
  }
  
  const reader = new FileReader();
  
  reader.onload = function(e) {
    try {
      const text = e.target.result;
      const essayInput = document.getElementById('essayInput');
      
      if (essayInput) {
        essayInput.value = text;
        updateCounter();
        showSuccessMessage('✅ File uploaded successfully! ' + Math.round(text.length) + ' characters');
      }
    } catch (error) {
      console.error('Error processing file:', error);
      showSuccessMessage('❌ Error reading file');
    }
  };
  
  reader.onerror = function() {
    showSuccessMessage('❌ Error reading file. Please try again.');
  };
  
  // Handle PDF files specially
  if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
    showSuccessMessage('PDF files require special processing. Please convert to .txt or .docx first.');
    return;
  }
  
  reader.readAsText(file);
}

// FIXED: Initialize everything when page loads
document.addEventListener('DOMContentLoaded', function() {
  console.log('=== DOM LOADED - INITIALIZING EVENT LISTENERS ===');
  
  // CRITICAL: Ensure only one QuickFix step is visible on page load
  // Hide all steps first, then show only Step 1 (if QuickFix flow is active)
  document.querySelectorAll('.quickfix-step').forEach(step => {
    if (!step.classList.contains('active') || step.id !== 'quickfixStep1') {
      step.style.setProperty('display', 'none', 'important');
      step.style.setProperty('opacity', '0', 'important');
      step.style.setProperty('visibility', 'hidden', 'important');
    }
  });
  
  // Auto-activate Pro test mode on localhost only (development override)
  if (location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.hostname === '') {
    console.log('🧪 Localhost detected - auto-activating Pro test mode');
    activateProTestMode();
  } else if (appState.isProUser && appState.proSubscription.active) {
    // For production: if user is already Pro, show dashboard
    console.log('✅ Pro user detected - showing Pro Dashboard');
    showProDashboard();
  }
  
  // Reset scan count to 0 on page load/refresh
  // Clear sessionStorage to ensure fresh start
  try {
    const today = new Date().toDateString();
    const key = 'scans_' + today;
    sessionStorage.removeItem(key);
  } catch (e) {
    console.error('Error clearing scan count:', e);
  }
  appState.scansUsed = 0;
  console.log('🔄 Page loaded - scan count reset to 0');
  
  // Initialize free version functionality
  updateCounter();
  updateScanButton();
  initTooltips();
  
  // Character limit detection is handled by updateCounter() function
  
  // ===== WORKING DRAG-DROP EVENT LISTENERS =====
  const uploadArea = document.getElementById('uploadArea');
  if (uploadArea) {
    uploadArea.addEventListener('dragover', handleDragOver, false);
    uploadArea.addEventListener('dragenter', handleDragEnter, false);
    uploadArea.addEventListener('dragleave', handleDragLeave, false);
    uploadArea.addEventListener('drop', handleFileDrop, false);
    console.log('✅ Drag-drop listeners attached');
  } else {
    console.error('❌ Upload area not found');
  }
  
  // FIXED: Main navigation buttons - ADDED PROPER EVENT LISTENERS
  const quickfixBtn = document.getElementById('emergencyButton');
  if (quickfixBtn) {
    quickfixBtn.addEventListener('click', function() {
      // Check authorship first (should already be checked due to button state, but double-check)
      const authorshipCheckbox = document.getElementById('authorshipCheckbox');
      if (!authorshipCheckbox || !authorshipCheckbox.checked) {
        showAuthorshipReminder();
        return;
      }
      
      // Preserve text and redirect to QuickFix page
      appState.isQuickFixUser = true;
      switchToQuickFix();
    });
    console.log('✅ QuickFix button listener added');
  } else {
    console.log('❌ QuickFix button NOT FOUND');
  }
  
  const scanBtn = document.getElementById('scanButton');
  if (scanBtn) {
    scanBtn.addEventListener('click', function() {
      console.log('🔍 Scan button clicked - calling scanEssay()');
      scanEssay();
    });
    console.log('✅ Scan button listener added');
  } else {
    console.log('❌ Scan button NOT FOUND');
  }
  
  const proBtn = document.getElementById('proButton');
  if (proBtn) {
    proBtn.addEventListener('click', function() {
      // Check authorship first
      const authorshipCheckbox = document.getElementById('authorshipCheckbox');
      if (!authorshipCheckbox || !authorshipCheckbox.checked) {
        showAuthorshipReminder();
        return;
      }
      
      handleProUpgrade();
    });
    console.log('✅ Pro button listener added');
  }
  
  // QuickFix flow buttons
  const startBtn = document.getElementById('startQuickFix');
  if (startBtn) {
    startBtn.addEventListener('click', startQuickFixAnalysis);
    console.log('✅ Start QuickFix button listener added');
  }
  
  const applySelectedBtn = document.getElementById('applySelectedFixes');
  if (applySelectedBtn) {
    applySelectedBtn.addEventListener('click', applySelectedFixes);
    console.log('✅ Apply QuickFixes button listener added');
  }
  
  const applyAllBtn = document.getElementById('applyAllFixes');
  if (applyAllBtn) {
    applyAllBtn.addEventListener('click', applyAllFixes);
    console.log('✅ Apply All Fixes button listener added');
  }
  
  // NEW: Complete rewrite button
  const completeRewriteBtn = document.getElementById('completeRewrite');
  if (completeRewriteBtn) {
    completeRewriteBtn.addEventListener('click', completeRewrite);
    console.log('✅ Complete Rewrite button listener added');
  }
  
  // Character counter
  const quickfixInput = document.getElementById('quickfixEssayInput');
  if (quickfixInput) {
    quickfixInput.addEventListener('input', function() {
      const count = this.value.length;
      document.getElementById('quickfixFlowCharCount').textContent = count;
    });
  }
  
  // FIXED: Add event listener for main essay input
  const essayInput = document.getElementById('essayInput');
  if (essayInput) {
    essayInput.addEventListener('input', updateCounter);
  }
  
  // Add event listener for authorship checkbox
  const authorshipCheckbox = document.getElementById('authorshipCheckbox');
  if (authorshipCheckbox) {
    authorshipCheckbox.addEventListener('change', updateCounter);
  }

  // Add responsive behavior for Step 4
  // window.addEventListener('resize', initStep4Responsive);
  
  console.log('=== ALL EVENT LISTENERS INITIALIZED ===');
});

// ... (rest of your existing functions remain exactly the same)
// getScansUsed, incrementScans, updateScansDisplay, updateCounter, analyzeTextLocally, getExplanation, scanEssay, showFreeUserModal, showFreeUserResult, minimizeResults, handleProUpgrade, getRandomPhrase, analyzeTextWithAPI, updateScanButton
// ALL THESE FUNCTIONS REMAIN EXACTLY AS THEY WERE IN YOUR ORIGINAL CODE

function getScansUsed() {
  try {
    const today = new Date().toDateString();
    const key = 'scans_' + today;
    // Use sessionStorage so it resets when tab is closed/refreshed
    // Change to localStorage if you want it to persist across browser sessions
    return parseInt(sessionStorage.getItem(key) || '0', 10);
  } catch (e) {
    return 0;
  }
}

// Guard to prevent double-incrementing
let isIncrementing = false;

function incrementScans() {
  // Prevent double-incrementing if already in progress
  if (isIncrementing) {
    console.warn('⚠️ incrementScans already in progress, skipping');
    return;
  }
  
  try {
    isIncrementing = true;
    const today = new Date().toDateString();
    const key = 'scans_' + today;
    // Use sessionStorage so it resets when tab is closed/refreshed
    // Change to localStorage if you want it to persist across browser sessions
    const currentScans = parseInt(sessionStorage.getItem(key) || '0', 10);
    appState.scansUsed = currentScans + 1;
    sessionStorage.setItem(key, appState.scansUsed.toString());
    console.log('📊 incrementScans - incremented from', currentScans, 'to:', appState.scansUsed, 'key:', key);
    updateScansDisplay();
  } catch (e) {
    console.error('Error saving scan count:', e);
  } finally {
    // Reset flag after a short delay to allow the increment to complete
    setTimeout(() => {
      isIncrementing = false;
    }, 100);
  }
}

// TESTING FUNCTION: Reset or set scan count for testing
function resetScanCount(count = 0) {
  if (count < 0) count = 0;
  if (count > FREE_SCAN_LIMIT) count = FREE_SCAN_LIMIT;
  
  const today = new Date().toDateString();
  const key = 'scans_' + today;
  sessionStorage.setItem(key, count.toString());
  
  // Sync appState
  appState.scansUsed = count;
  
  // Update all displays
  updateScansDisplay();
  updateCounter();
  
  // Update button text and state if it exists
  const scanButton = document.getElementById('scanButton');
  if (scanButton) {
    const nextScan = Math.min(count + 1, FREE_SCAN_LIMIT);
    const scanCounter = document.getElementById('scanCounter');
    if (scanCounter) {
      scanCounter.textContent = nextScan + '/' + FREE_SCAN_LIMIT;
    }
    scanButton.textContent = '🔍 Free Scan (' + nextScan + '/' + FREE_SCAN_LIMIT + ')';
    
    // Disable button if they've used all scans
    if (count >= FREE_SCAN_LIMIT && !appState.isProUser) {
      scanButton.disabled = true;
      scanButton.style.opacity = '0.6';
    } else {
      scanButton.disabled = false;
      scanButton.style.opacity = '1';
    }
  }
  
  const remaining = FREE_SCAN_LIMIT - count;
  console.log('✅ Scan count reset to:', count, '| Remaining:', remaining, '| Next scan will be:', Math.min(count + 1, FREE_SCAN_LIMIT));
  return `✅ Scan count: ${count}/${FREE_SCAN_LIMIT} | Remaining: ${remaining} | Next: ${Math.min(count + 1, FREE_SCAN_LIMIT)}`;
}

// TESTING FUNCTION: Clear modal flags so modals can show again
function clearModalFlags() {
  const today = new Date().toDateString();
  localStorage.removeItem('firstScanModalShown_' + today);
  localStorage.removeItem('lastScanModalShown_' + today);
  console.log('✅ Modal flags cleared for today. Modals will show again.');
  return 'Modal flags cleared. Modals will show again on next scan.';
}

// Make functions available globally for console testing
window.resetScanCount = resetScanCount;
window.clearModalFlags = clearModalFlags;

function updateScansDisplay() {
  const remaining = Math.max(0, FREE_SCAN_LIMIT - appState.scansUsed);
  const scansLeftEl = document.getElementById('scansLeft');
  const panicScansLeft = document.getElementById('panicScansLeft');
  const scanCounter = document.getElementById('scanCounter');

  if (!scansLeftEl) return;

  if (scanCounter) {
    const currentScan = Math.min(appState.scansUsed + 1, FREE_SCAN_LIMIT);
    scanCounter.textContent = currentScan + '/' + FREE_SCAN_LIMIT;
  }

  scansLeftEl.classList.remove('warning', 'danger');
  if (remaining === 0) {
    scansLeftEl.classList.add('danger');
    scansLeftEl.textContent = 'Daily limit reached - Upgrade to Pro for 500 monthly scans!';
  } else if (remaining === 1) {
    scansLeftEl.classList.add('warning');
    scansLeftEl.textContent = remaining + ' free scan remaining today';
  } else {
    scansLeftEl.textContent = remaining + ' free scans remaining today';
  }

  if (panicScansLeft) {
    panicScansLeft.textContent = remaining;
  }
}

function updateCounter() {
  // Always sync scan count from localStorage first
  appState.scansUsed = getScansUsed();
  
  const essayInput = document.getElementById('essayInput');
  const charCount = document.getElementById('charCount');
  const scanButton = document.getElementById('scanButton');
  const quickFixButton = document.getElementById('emergencyButton');
  const proButton = document.getElementById('proButton');
  const authorshipCheckbox = document.getElementById('authorshipCheckbox');

  if (!essayInput || !charCount || !scanButton || !authorshipCheckbox) return;

  let len = essayInput.value.length;
  
  // Enforce 5000 character maximum
  if (len > 5000) {
    essayInput.value = essayInput.value.substring(0, 5000);
    len = 5000;
    showSuccessMessage('Text limited to 5,000 characters maximum.');
  }
  
  // Show count with proper formatting (e.g., 5,000 instead of 5000)
  charCount.textContent = len.toLocaleString();

  // REMOVED: Auto-popup when exceeding 500 characters (only show when clicking Free Scan)

  const counter = document.querySelector('.char-counter');
  if (counter) {
    counter.classList.remove('warning', 'danger');
    if (len >= appState.maxChars) {
      counter.classList.add('danger');
    } else if (len > 450) {
      counter.classList.add('warning');
    }
  }

  // Form validation: essay ≥ 50 chars AND authorship confirmed
  const isValidLength = len >= appState.minChars;
  const hasScansLeft = appState.scansUsed < FREE_SCAN_LIMIT || appState.isProUser;
  const isAuthorshipConfirmed = authorshipCheckbox.checked;
  const isFormValid = isValidLength && isAuthorshipConfirmed;
  
  // Add/remove pulsing red animation on authorship section
  const authorshipSection = document.getElementById('authorshipSection');
  if (authorshipSection) {
    if (!isAuthorshipConfirmed) {
      authorshipSection.classList.add('authorship-section-pulse');
    } else {
      authorshipSection.classList.remove('authorship-section-pulse');
    }
  }
  
  // Update Free Scan button
  if (isFormValid && hasScansLeft) {
    scanButton.disabled = false;
    scanButton.style.background = '#2ecc71';
    scanButton.style.cursor = 'pointer';
    scanButton.title = '';
  } else {
    scanButton.disabled = true;
    scanButton.style.background = '#9ca3af';
    scanButton.style.cursor = 'not-allowed';
    if (!isAuthorshipConfirmed) {
      scanButton.title = 'Please confirm you\'re the original author to continue.';
    } else if (!isValidLength) {
      scanButton.title = 'Please paste at least 50 characters to continue.';
    } else {
      scanButton.title = 'Daily scan limit reached. Upgrade to Pro for 500 monthly scans.';
    }
  }
  
  // Update QuickFix button
  if (quickFixButton) {
    if (isFormValid) {
      quickFixButton.disabled = false;
      quickFixButton.style.opacity = '1';
      quickFixButton.style.cursor = 'pointer';
      quickFixButton.title = '';
    } else {
      quickFixButton.disabled = true;
      quickFixButton.style.opacity = '0.6';
      quickFixButton.style.cursor = 'not-allowed';
      if (!isAuthorshipConfirmed) {
        quickFixButton.title = 'Please confirm you\'re the original author to continue.';
      } else {
        quickFixButton.title = 'Please paste at least 50 characters to continue.';
      }
    }
  }
  
  // Update Pro button
  if (proButton) {
    if (isFormValid) {
      proButton.disabled = false;
      proButton.style.opacity = '1';
      proButton.style.cursor = 'pointer';
      proButton.title = '';
    } else {
      proButton.disabled = true;
      proButton.style.opacity = '0.6';
      proButton.style.cursor = 'not-allowed';
      if (!isAuthorshipConfirmed) {
        proButton.title = 'Please confirm you\'re the original author to continue.';
      } else {
        proButton.title = 'Please paste at least 50 characters to continue.';
      }
    }
  }
  
  // Always update scan display to ensure front page shows correct count
  updateScansDisplay();
  
  // Also update the scan button text to match
  if (scanButton) {
    const displayCount = Math.min(appState.scansUsed + 1, FREE_SCAN_LIMIT);
    scanButton.innerHTML = '🔍 Free Scan (<span id="scanCounter">' + displayCount + '/' + FREE_SCAN_LIMIT + '</span>)';
  }
}

function analyzeTextLocally(text) {
  const issues = [];
  const textLower = text.toLowerCase();
  const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
  const words = textLower.split(/\s+/);

  // Simple pattern matching for demo
  const patterns = {
    transitions: ['furthermore', 'moreover', 'additionally', 'consequently', 'nevertheless', 'therefore', 'thus', 'hence'],
    formal: ['cutting-edge', 'state-of-the-art', 'comprehensive analysis', 'paradigm shift', 'multifaceted approach', 'synergistic', 'leverage'],
    generic: ['various', 'numerous', 'extensive', 'comprehensive', 'significant', 'substantial', 'considerable', 'multiple'],
    passive: ['was done', 'is seen', 'can be found', 'it is believed', 'it is known', 'has been shown', 'was observed']
  };

  Object.keys(patterns).forEach(category => {
    patterns[category].forEach(word => {
      const regex = new RegExp('\\b' + word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'gi');
      const matches = text.match(regex);
      if (matches && matches.length > 0) {
        const severity = category === 'formal' ? 'high' : 'medium';
        issues.push({
          phrase: matches[0],
          severity,
          explanation: getExplanation(category),
          type: category
        });
      }
    });
  });

  let baseScore = 15;
  issues.forEach(issue => {
    if (issue.severity === 'high') baseScore += 25;
    else if (issue.severity === 'medium') baseScore += 15;
    else baseScore += 8;
  });

  return {
    score: Math.min(95, Math.max(20, baseScore)),
    issues: issues.slice(0, 3),
  };
}

function getExplanation(category) {
  const explanations = {
    transitions: 'Try varying your transitions for more natural flow. Consider alternatives like "Also," "Next," or "In addition."',
    formal: 'This formal language might trigger AI detectors. Try more conversational alternatives.',
    generic: 'Be more specific instead of using generic terms. Give concrete examples or numbers.',
    passive: 'Try active voice for stronger writing. "Researchers found" instead of "it was found."'
  };
  return explanations[category] || 'This phrase might trigger AI detection tools.';
}

async function scanEssay() {
  console.log('🔍 scanEssay() function called');
  const essayInput = document.getElementById('essayInput');
  const scanButton = document.getElementById('scanButton');
  const text = essayInput.value.trim();
  
  // CRITICAL: Check character limit for free scans - show modal if > 500 chars
  if (text.length > 500) {
    console.log('⚠️ Text exceeds 500 character limit:', text.length);
    showCharacterLimitModal();
    return;
  }

  // ============================
  // DEV-ONLY TEST OVERRIDES (DISABLED BY DEFAULT - Use ?dev=true in URL to enable)
  // ============================
  // Only use presets if explicitly enabled via URL parameter ?dev=true
  const useDevPresets = new URLSearchParams(window.location.search).get('dev') === 'true' && 
                        (location.hostname === 'localhost' || location.hostname === '127.0.0.1');
  
  if (useDevPresets) {
    console.log('🧪 DEV MODE: Checking for test presets. Hostname:', location.hostname);
    
    // Normalize function to handle whitespace and case
    const normalize = (str) => str.trim().replace(/\s+/g, ' ').toLowerCase();
    const trimmed = normalize(text);

    const devPresets = [
      // 1) LOW RISK – "You're Good" (0–29)
      {
        text: "Yesterday I went to the park after class, read a book on a bench, and talked with my friend about our weekend plans.",
        score: 18,
        flags: []
      },
      // 2) MEDIUM RISK – "Kinda Sus" (30–69)
      {
        text: "In today's world, technology is becoming more important in education, helping students access information faster and collaborate in new ways.",
        score: 55,
        flags: [
          { phrase: "more important", severity: "medium" },
          { phrase: "in new ways", severity: "medium" }
        ]
      },
      // 3) HIGH RISK – "Hella Sus" (70–100)
      {
        text: "In today's rapidly evolving digital landscape, organizations must leverage cutting-edge solutions to achieve unprecedented levels of efficiency and innovation.",
        score: 92,
        flags: [
          { phrase: "rapidly evolving digital landscape", severity: "high" },
          { phrase: "leverage", severity: "high" },
          { phrase: "cutting-edge", severity: "high" },
          { phrase: "unprecedented levels", severity: "high" }
        ]
      }
    ];

    // Find matching preset using normalized comparison
    const preset = devPresets.find(p => normalize(p.text) === trimmed);
    
    console.log('🧪 DEV MODE: Input text length:', trimmed.length);
    console.log('🧪 DEV MODE: Input text (first 100 chars):', trimmed.substring(0, 100));
    console.log('🧪 DEV MODE: Preset match found:', !!preset);
    if (preset) {
      console.log('🧪 DEV MODE: Matched preset score:', preset.score);
    }
    
    if (preset) {
      console.log("🧪 DEV OVERRIDE ACTIVE – using preset for test paragraph, score:", preset.score);
      
      // Make sure appState gets the expected values for the FREE view
      appState.originalText   = text;
      appState.currentScore   = preset.score;
      appState.originalScore  = preset.score;
      appState.quickfixFlags  = preset.flags; // reuse for free previews
      appState.freeFlags      = preset.flags; // if you have a separate freeFlags, set it too

      // IMPORTANT: skip the real AI/detector logic when a preset matches
      // Increment scans BEFORE showing results
      incrementScans();
      console.log('🔍 Dev mode - After incrementScans, appState.scansUsed:', appState.scansUsed);

      // Skip the old modal, go straight to results
      showFreeUserResult();
      
      // Show upsell modals based on scan count
      // For testing: show modal 1 at 1 scan, modal 2 at 3 scans (even if they have 99 total)
      const remaining = Math.max(0, FREE_SCAN_LIMIT - appState.scansUsed);
      console.log('🔍 Modal check - scansUsed:', appState.scansUsed, 'remaining:', remaining);
      if (appState.scansUsed === 1) {
        // First scan - show reminder modal (delayed to allow progress bar animation to complete - 1.5s animation + 300ms buffer)
        console.log('🔍 Triggering first scan modal');
        setTimeout(() => showFirstScanUpsellModal(), 1800);
      } else if (appState.scansUsed === FREE_SCAN_LIMIT) {
        // Last scan (scan 3) - show final upsell modal (delayed to allow progress bar animation to complete)
        console.log('🔍 Triggering last scan modal - scansUsed:', appState.scansUsed);
        setTimeout(() => showLastScanUpsellModal(), 1800);
      }

      // Reset scan button - sync from localStorage first
      appState.scansUsed = getScansUsed();
      scanButton.textContent = '🔍 Free Scan (' + (appState.scansUsed + 1) + '/' + FREE_SCAN_LIMIT + ')';
      scanButton.disabled = false;
      updateScansDisplay(); // Update scan counter display

      // IMPORTANT: return early to prevent double-increment
      return;
    } else {
      console.log('🧪 DEV MODE: No preset match. Will use real API. Text was:', trimmed.substring(0, 100));
    }
  }
  
  // PRODUCTION MODE: Always use real Haiku API (default behavior)
  console.log('🌐 Using real Haiku API for analysis');
  // ============================
  // EXISTING REAL LOGIC BELOW
  // ============================

  console.log('Text length:', text.length);
  console.log('Min chars required:', appState.minChars);

  if (text.length < appState.minChars) {
    showSuccessMessage('Please enter at least ' + appState.minChars + ' characters');
    return;
  }

  if (appState.scansUsed >= FREE_SCAN_LIMIT && !appState.isProUser) {
    handleProUpgrade();
    return;
  }

  appState.originalText = text;
  scanButton.textContent = '🔍 Scanning...';
  scanButton.disabled = true;

  try {
    // Always increment free scans, regardless of Pro status
    // This ensures the "Scan Another Essay" button shows correct count
      incrementScans();
    console.log('🔍 After incrementScans, appState.scansUsed:', appState.scansUsed, 'isProUser:', appState.isProUser);

    // Use API for real analysis (fallback to local if API fails)
    const analysis = await analyzeTextWithAPI(text);
    appState.flagData = analysis.issues;
    appState.currentScore = analysis.score;

    // DEBUG: Log what we received from API
    console.log('🔍 API Analysis Result:', {
      score: analysis.score,
      issuesCount: analysis.issues?.length || 0,
      flagCount: analysis.flagCount,
      issues: analysis.issues,
      flagData: appState.flagData
    });

    console.log('🔍 Before showFreeUserResult, appState.scansUsed:', appState.scansUsed);
    showFreeUserResult();
    
    // Show upsell modals based on scan count
    // For testing: show modal 1 at 1 scan, modal 2 at 3 scans (even if they have 99 total)
    const remaining = Math.max(0, FREE_SCAN_LIMIT - appState.scansUsed);
    console.log('🔍 Modal check - scansUsed:', appState.scansUsed, 'remaining:', remaining);
    if (appState.scansUsed === 1) {
      // First scan - show reminder modal (delayed to allow progress bar animation to complete - 1.5s animation + 300ms buffer)
      console.log('🔍 Triggering first scan modal');
      setTimeout(() => showFirstScanUpsellModal(), 1800);
    } else if (appState.scansUsed === FREE_SCAN_LIMIT) {
      // Last scan (scan 3) - show final upsell modal (delayed to allow progress bar animation to complete)
      console.log('🔍 Triggering last scan modal - scansUsed:', appState.scansUsed);
      setTimeout(() => showLastScanUpsellModal(), 1800);
    }

  } catch (error) {
    console.error('Analysis failed:', error);
    showSuccessMessage('Analysis failed. Please try again.');
  } finally {
    // Always sync from localStorage to ensure front page shows correct count
    appState.scansUsed = getScansUsed();
    scanButton.textContent = '🔍 Free Scan (' + (appState.scansUsed + 1) + '/' + FREE_SCAN_LIMIT + ')';
    scanButton.disabled = false;
    updateCounter();
    updateScansDisplay(); // Update scan counter display
  }
}
// REMOVED: Old "READY TO TURN IT IN?" modal - no longer used
// function showFreeUserModal(score) { ... }

function showFreeUserResult() {
  // Always sync from localStorage to ensure we have the latest value
  appState.scansUsed = getScansUsed();
  console.log('🔍 showFreeUserResult - appState.scansUsed synced from localStorage:', appState.scansUsed);
  
  // Close free modal if it exists
  const modal = document.getElementById('freeModal');
  if (modal) {
    modal.remove();
  }
  document.body.classList.remove('modal-open');

  // Ensure results view is visible
  if (typeof FreePageViewManager !== 'undefined') {
    FreePageViewManager.show('results');
  } else if (typeof switchToResults === 'function') {
    switchToResults();
  } else {
    const resultsContainer = document.getElementById('resultsContainer');
    const inputSection = document.getElementById('inputSection');
    if (resultsContainer) resultsContainer.classList.add('show');
    if (inputSection) inputSection.style.display = 'none';
  }

  const text = appState.originalText || '';
  // Use API response flags (stored in appState.flagData) instead of fallback detection
  let analysisFlags = appState.flagData || [];
  const score = typeof appState.currentScore === 'number'
    ? appState.currentScore
    : (AIDetectionEngine.calculateScore ? AIDetectionEngine.calculateScore(text) : 0);

  let flagCount = analysisFlags.length;
  
  // DEBUG: Log what we have for rendering
  console.log('🔍 renderFreeUserAnalysis - Data check:', {
    score: score,
    flagCount: flagCount,
    analysisFlags: analysisFlags,
    flagData: appState.flagData,
    currentScore: appState.currentScore,
    originalTextLength: text.length
  });
  
  // CRITICAL: If API returned a score >= 30 but 0 flags, this is a bug
  // The API should ALWAYS return at least 1-3 flags for scores >= 30
  // Log this for debugging
  if (score >= 30 && flagCount === 0) {
    console.error('❌ CRITICAL BUG: API returned score', score, 'but 0 flags. This should not happen - API should return flags for scores >= 30.');
    console.error('Full appState:', {
      flagData: appState.flagData,
      currentScore: appState.currentScore,
      originalText: appState.originalText?.substring(0, 100) + '...'
    });
  }

  // TEMP FALLBACK: until the real AI engine is wired,
  // If API returns 0 flags but score suggests AI patterns, trust the API
  // Don't add fake flags - the API should always return flags if score >= 30
  // If it doesn't, that means the text genuinely has no specific flaggable phrases
  // (which is possible - score can be high due to overall patterns, not specific phrases)
  // For Kinda Sus: show 2-3 trigger words, for others show 3
  const previewCount = (score >= 30 && score < 70) ? Math.min(3, flagCount) : 3;
  const previewFlags = analysisFlags.slice(0, previewCount);
  const extraCount = Math.max(flagCount - previewFlags.length, 0);

  // Unified thresholds: 0–29, 30–69, 70–100
  let label = "Clean - No Sus";
  let emoji = '✅';
  let color = '#2ecc71';
  let cardToShow = '';

  if (score >= 70) {
    label = 'Hella Sus';
    emoji = '🚨';
    color = '#dc2626';
    cardToShow = 'hellaSus';
  } else if (score >= 30) {
    label = 'Kinda Sus';
    emoji = '⚠️';
    color = '#eed202';
    cardToShow = 'kindaSus';
  } else {
    cardToShow = 'youreGood'; // Will implement later
  }

  // Hide all cards first
  const hellaSusCard = document.getElementById('hellaSusCard');
  const kindaSusCard = document.getElementById('kindaSusCard');
  const youreGoodCard = document.getElementById('youreGoodCard');
  if (hellaSusCard) hellaSusCard.style.display = 'none';
  if (kindaSusCard) kindaSusCard.style.display = 'none';
  if (youreGoodCard) youreGoodCard.style.display = 'none';

  // Show the appropriate card and update its elements
  if (cardToShow === 'hellaSus') {
    if (hellaSusCard) hellaSusCard.style.display = 'block';
    
    const scoreNumberEl = document.getElementById('hellaSusScoreNumber');
    const scoreLabelEl = document.getElementById('hellaSusScoreLabel');
    const scoreEmojiEl = document.getElementById('hellaSusScoreEmoji');
    const progressFill = document.getElementById('hellaSusProgressFill');
    
    // Set color and label first (these don't interfere)
    if (scoreLabelEl) {
      scoreLabelEl.textContent = label;
      scoreLabelEl.style.color = color;
    }
    if (scoreEmojiEl) {
      scoreEmojiEl.textContent = emoji;
    }
    // DON'T set scoreNumberEl.textContent here - let animation do it
    if (scoreNumberEl) {
      scoreNumberEl.style.color = color;
    }
    // Update dynamic message
    const hellaSusMessageEl = document.getElementById('hellaSusMessage');
    if (hellaSusMessageEl) {
      hellaSusMessageEl.textContent = getDynamicMessage(score);
      // Add 1/4" padding above dynamic phrase for Hella Sus
      hellaSusMessageEl.style.marginTop = '24px';
    }
  } else if (cardToShow === 'kindaSus') {
    if (kindaSusCard) kindaSusCard.style.display = 'block';
    
    const scoreNumberEl = document.getElementById('kindaSusScoreNumber');
    const scoreLabelEl = document.getElementById('kindaSusScoreLabel');
    const scoreEmojiEl = document.getElementById('kindaSusScoreEmoji');
    const progressFill = document.getElementById('kindaSusProgressFill');
    
    // Set color and label first (these don't interfere)
    if (scoreLabelEl) {
      scoreLabelEl.textContent = label;
      scoreLabelEl.style.color = color;
    }
    if (scoreEmojiEl) {
      scoreEmojiEl.textContent = emoji;
    }
    // DON'T set scoreNumberEl.textContent here - let animation do it
    if (scoreNumberEl) {
      scoreNumberEl.style.color = color;
    }
    // Update dynamic message
    const kindaSusMessageEl = document.getElementById('kindaSusMessage');
    if (kindaSusMessageEl) {
      kindaSusMessageEl.textContent = getDynamicMessage(score);
      // Add 1/4" padding above and below the dynamic phrase
      kindaSusMessageEl.style.paddingTop = '24px';
      kindaSusMessageEl.style.paddingBottom = '24px';
    }
    updateSusBar(score, 'kinda');
  } else if (cardToShow === 'youreGood') {
    console.log('🎯 Displaying You\'re Good card');
    if (youreGoodCard) {
      youreGoodCard.style.display = 'block';
      console.log('🎯 You\'re Good card displayed');
    } else {
      console.error('❌ You\'re Good card not found!');
    }
    
    const scoreNumberEl = document.getElementById('youreGoodScoreNumber');
    const scoreLabelEl = document.getElementById('youreGoodScoreLabel');
    const scoreEmojiEl = document.getElementById('youreGoodScoreEmoji');
    const progressFill = document.getElementById('youreGoodProgressFill');
    
    // Set color and label first (these don't interfere)
    if (scoreLabelEl) {
      scoreLabelEl.textContent = label;
      scoreLabelEl.style.color = color;
    }
    if (scoreEmojiEl) {
      scoreEmojiEl.textContent = emoji;
    }
    // DON'T set scoreNumberEl.textContent here - let animation do it
    if (scoreNumberEl) {
      scoreNumberEl.style.color = color;
    }
    // Update dynamic message
    const youreGoodMessageEl = document.getElementById('youreGoodMessage');
    if (youreGoodMessageEl) {
      youreGoodMessageEl.textContent = getDynamicMessage(score);
    }
    updateSusBar(score, 'youreGood');
  }

  // Start progress bar animations
  setTimeout(() => {
    if (typeof startProgressAnimations === 'function') {
      startProgressAnimations(score);
    }
  }, 200);

  // Common elements for all cards
  const flagCountEl = document.getElementById('freeFlagCountText');
  const triggerHeadingEl = document.getElementById('freeTriggerHeading');
  const extraFlagsSummaryEl = document.getElementById('freeExtraFlagsSummary');
  const unlockOverlayHeading = document.getElementById('unlockOverlayHeading');
  const quickfixUnlockButton = document.getElementById('quickfixUnlockButton');
  
  // Update unlock overlay heading color based on score
  if (unlockOverlayHeading) {
    if (score >= 70) {
      unlockOverlayHeading.style.color = '#dc2626'; // Red for Hella Sus
    } else if (score >= 30) {
      unlockOverlayHeading.style.color = '#374151'; // Black for Kinda Sus
    } else {
      unlockOverlayHeading.style.color = '#dc2626'; // Red for You're Good (as shown in design)
    }
  }

  // Show/hide QuickFix button based on score
  if (quickfixUnlockButton) {
    // Hide QuickFix button for all cases - Pro button will be changed to QuickFix
    quickfixUnlockButton.style.display = 'none';
    quickfixUnlockButton.style.visibility = 'hidden';
    quickfixUnlockButton.style.opacity = '0';
  }
  
  // For Hella Sus, also immediately hide and update buttons
  if (score >= 70) {
    setTimeout(() => {
      const quickfixBtn = document.getElementById('quickfixUnlockButton');
      if (quickfixBtn) {
        quickfixBtn.style.display = 'none';
        quickfixBtn.style.visibility = 'hidden';
        quickfixBtn.style.opacity = '0';
      }
    }, 50);
  }
  
  
  // Update "Scan Another Essay" button with dynamic scan count
  // Use the current appState.scansUsed (already incremented by incrementScans())
  // Function to update the button
  function updateScanAnotherButton() {
    const scanAnotherButton = document.getElementById('scanAnotherEssayBtn');
    if (scanAnotherButton) {
      // Use the value already synced in showFreeUserResult()
      // Match the front page format: scanCounter shows scansUsed + 1
      const displayCount = Math.min(appState.scansUsed + 1, FREE_SCAN_LIMIT);
      scanAnotherButton.textContent = `📝 Scan Another Essay (${displayCount}/${FREE_SCAN_LIMIT})`;
      console.log('✅ Updated Scan Another Essay button:', displayCount, '/', FREE_SCAN_LIMIT, 'appState.scansUsed:', appState.scansUsed);
      return true;
    }
    console.warn('⚠️ scanAnotherEssayBtn button not found');
    return false;
  }
  
  // Try to update immediately
  if (!updateScanAnotherButton()) {
    // If button not found yet, try after a short delay
    setTimeout(function() {
      if (!updateScanAnotherButton()) {
        // Try one more time after longer delay
        setTimeout(updateScanAnotherButton, 500);
      }
    }, 100);
  }

  // Get dynamic phrase for this score
  let dynamicPhrase = getDynamicPhrase(score);
  
  // Format phrase for header (add apostrophe for "Bussin", add exclamation)
  let headerPhrase = dynamicPhrase;
  if (dynamicPhrase === "Bussin") {
    headerPhrase = "Bussin'!";
  } else if (dynamicPhrase.includes(" ")) {
    // For phrases with spaces, just add exclamation
    headerPhrase = dynamicPhrase + "!";
  } else {
    // For single words, add exclamation
    headerPhrase = dynamicPhrase + "!";
  }
  
  // Update headers with dynamic phrase
  if (score >= 70) {
    // Hella Sus
    const hellaSusPhrase = document.getElementById('hellaSusPhrase');
    if (hellaSusPhrase) {
      hellaSusPhrase.textContent = headerPhrase;
    }
  } else if (score >= 30) {
    // Kinda Sus
    const kindaSusPhrase = document.getElementById('kindaSusPhrase');
    if (kindaSusPhrase) {
      kindaSusPhrase.textContent = headerPhrase;
    }
  } else {
    // You're Good
    const youreGoodPhrase = document.getElementById('youreGoodPhrase');
    if (youreGoodPhrase) {
      youreGoodPhrase.textContent = headerPhrase;
    }
  }
  
  // Update trigger heading
  if (triggerHeadingEl) {
    const headingText = document.getElementById('freeTriggerHeadingText');
    if (headingText) {
      const shownCount = Math.min(3, flagCount);
      
      // Determine box color based on score range
      let boxBgColor = '#d1fae5'; // Light green background for Clean - No Sus (0-29%)
      let boxBorderColor = '#2ecc71'; // Green border
      let boxTextColor = '#047857'; // Dark green text
      
      if (score >= 70) {
        boxBgColor = '#fee2e2'; // Light red background for Hella Sus (70-100%)
        boxBorderColor = '#dc2626'; // Red border
        boxTextColor = '#991b1b'; // Dark red text
      } else if (score >= 30) {
        boxBgColor = '#fef3c7'; // Light yellow background for Kinda Sus (30-69%)
        boxBorderColor = '#eed202'; // Yellow border
        boxTextColor = '#92400e'; // Dark yellow/brown text
      }
      
      // Consistent format: "AI Trigger Words: X shown / Y detected" with numbers in colored boxes
      headingText.innerHTML = `⚡ AI Trigger Words: <span style="background: ${boxBgColor}; border: 2px solid ${boxBorderColor}; color: ${boxTextColor}; padding: 4px 10px; border-radius: 6px; font-weight: 800; display: inline-block; margin: 0 2px;">${shownCount}</span> shown / <span style="background: ${boxBgColor}; border: 2px solid ${boxBorderColor}; color: ${boxTextColor}; padding: 4px 10px; border-radius: 6px; font-weight: 800; display: inline-block; margin: 0 2px;">${flagCount}</span> detected`;
      // Ensure font size is preserved
      headingText.style.fontSize = '24px';
      headingText.style.fontWeight = '800';
    }
    // Add 1/4" padding (24px) for Kinda Sus page (30-69%)
    if (score >= 30 && score < 70) {
      triggerHeadingEl.style.paddingTop = '24px';
    } else {
      triggerHeadingEl.style.paddingTop = '0';
    }
  }
  
  // Update lock heading above lock box
  const lockHeading = document.getElementById('freeLockHeading');
  if (lockHeading) {
    if (score >= 30) {
      // Show on Hella Sus + Kinda Sus
      lockHeading.textContent = `🔓 Unlock All ${flagCount} • One-time with ⚡ QuickFix OR All Month with 💎 Pro`;
      lockHeading.style.display = 'block';
    } else {
      // Hide on You're Good results page
      lockHeading.textContent = '';
      lockHeading.style.display = 'none';
    }
  }

  // Update flag count message - show dynamic phrase with emoji
  if (flagCountEl) {
    const flagCountMessage = document.getElementById('freeFlagCountMessage');
    if (flagCountMessage) {
      const emoji = getPhraseEmoji(dynamicPhrase);
      flagCountMessage.textContent = `${emoji} ${dynamicPhrase}`;
      // Ensure font size is preserved
      flagCountMessage.style.fontSize = '22px';
      flagCountMessage.style.fontWeight = '600';
    }
    // For Hella Sus only: Add 1/4" padding below "Nope" dynamic word
    if (score >= 70) {
      flagCountEl.style.marginBottom = '8px';
      flagCountEl.style.paddingBottom = '24px';
    } else if (score >= 30) {
      // Kinda Sus: Add 1/2" padding (48px) + 1/4" additional (24px) = 72px total at the bottom of dynamic phrase
      flagCountEl.style.paddingBottom = '72px';
    } else {
      // Reduce padding below by 1/4" (24px) for other cases
      flagCountEl.style.marginBottom = '-16px';
    }
  }

  // Show/hide Zero AI Trigger Words box - only for clean scores (0-29%)
  const freeZeroTriggerBox = document.getElementById('freeZeroTriggerBox');
  if (freeZeroTriggerBox) {
    if (score < 30) {
      // Show the green box for clean scores
      freeZeroTriggerBox.style.display = 'block';
    } else {
      // Hide for other score ranges
      freeZeroTriggerBox.style.display = 'none';
    }
  }

  if (extraFlagsSummaryEl) {
    if (extraCount > 0) {
      extraFlagsSummaryEl.style.display = 'block';
      extraFlagsSummaryEl.textContent =
        `${extraCount} more AI-trigger word${extraCount === 1 ? '' : 's'} were found in your text — ` +
        `but they're locked in free mode. Unlock QuickFix to see them all and reduce your AI detection risk.`;
    } else {
      extraFlagsSummaryEl.style.display = 'none';
      extraFlagsSummaryEl.textContent = '';
    }
  }

  // ========= MIDDLE CARD: TRIGGER CHIPS =========
  const chipsContainer = document.getElementById('freeTriggerChips');
  if (chipsContainer) {
    chipsContainer.innerHTML = '';
    // Determine chip colors based on score range
    let chipBgColor = '#fee2e2'; // Red for Hella Sus
    let chipBorderColor = '#dc2626';
    let chipTextColor = '#991b1b';
    
    // For Kinda Sus: show 2-3 trigger words visible, rest gated
    let flagsToShow = previewFlags;
    if (score >= 30 && score < 70) {
      // Red for Kinda Sus (Free version)
      chipBgColor = '#fee2e2';
      chipBorderColor = '#dc2626';
      chipTextColor = '#991b1b';
      // Show 2-3 trigger words for Kinda Sus
      flagsToShow = analysisFlags.slice(0, Math.min(3, analysisFlags.length));
      
      // If no flags detected, show placeholder trigger words for Kinda Sus
      if (flagsToShow.length === 0) {
        flagsToShow = [
          { phrase: 'more important', word: 'more important' },
          { phrase: 'in new ways', word: 'in new ways' }
        ];
      }
    }
    
    // Tooltip explanations fallback for common trigger words (if explanation not in flag data)
    const tooltipMap = {
      'unprecedented levels': 'Overly formal phrasing commonly generated by AI models',
      'unprecedented': 'Overly formal phrasing commonly generated by AI models',
      'cutting-edge': 'Buzzword frequently used in AI-generated content',
      'leverage': 'Corporate jargon that AI models overuse',
      'more important': 'Generic transition phrase common in AI writing',
      'in new ways': 'Vague phrasing typical of AI-generated text',
      'synergy': 'Corporate buzzword often found in AI content',
      'utilize': 'Overly formal alternative to "use" favored by AI',
      'furthermore': 'Transition word AI models overuse',
      'moreover': 'Formal transition common in AI writing',
      'consequently': 'Formal connector frequently used by AI',
      'thus': 'Formal transition word typical of AI content'
    };
    
    flagsToShow.forEach((flag, index) => {
      const chip = document.createElement('span');
      chip.className = 'trigger-chip';
      const phrase = flag.phrase || flag.word || flag.text || 'AI-trigger phrase';
      
      // Create number badge with color based on score range
      const numberBadge = document.createElement('span');
      numberBadge.className = 'flag-number';
      numberBadge.textContent = index + 1;
      // Use red background with white text for Kinda Sus (Free version), red for Hella Sus
      const badgeBgColor = (score >= 30 && score < 70) ? '#dc2626' : '#dc2626';
      const badgeTextColor = (score >= 30 && score < 70) ? 'white' : 'white';
      numberBadge.style.cssText = `background: ${badgeBgColor}; color: ${badgeTextColor}; border-radius: 50%; width: 18px; height: 18px; display: inline-flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; margin-right: 6px; flex-shrink: 0;`;
      
      // Add number and phrase to chip
      chip.appendChild(numberBadge);
      chip.appendChild(document.createTextNode(phrase));
      
      // Use dynamic explanation from flag data, fallback to map, then default
      const tooltipText = flag.explanation || tooltipMap[phrase] || tooltipMap[phrase.toLowerCase()] || 'This phrase is commonly flagged by AI detection tools';
      
      chip.style.cssText = `background: ${chipBgColor}; border: 2px solid ${chipBorderColor}; color: ${chipTextColor}; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: help; position: relative; display: inline-flex; align-items: center;`;
      // Remove title attribute to prevent native browser tooltip
      chip.removeAttribute('title');
      
      // Add custom tooltip on hover
      chip.addEventListener('mouseenter', function(e) {
        // Remove any existing tooltip first
        const existingTooltip = document.getElementById('triggerTooltip');
        if (existingTooltip) existingTooltip.remove();
        
        const tooltip = document.createElement('div');
        tooltip.id = 'triggerTooltip';
        tooltip.textContent = tooltipText;
        
        // Create arrow element
        const arrow = document.createElement('div');
        arrow.className = 'trigger-tooltip-arrow';
        
        tooltip.style.cssText = `
          position: fixed;
          background: #0b0646;
          color: white;
          padding: 6px 8px;
          border-radius: 6px;
          font-size: 12px;
          font-weight: 500;
          letter-spacing: 0.3px;
          max-width: 200px;
          white-space: normal;
          word-wrap: break-word;
          z-index: 10000;
          box-shadow: 0 2px 8px rgba(0,0,0,0.3);
          pointer-events: none;
          text-align: left;
          line-height: 1.4;
          opacity: 0;
          transition: opacity 0.2s ease;
        `;
        
        tooltip.appendChild(arrow);
        document.body.appendChild(tooltip);
        
        // Position tooltip relative to chip
        setTimeout(() => {
          const chipRect = chip.getBoundingClientRect();
          const tooltipRect = tooltip.getBoundingClientRect();
          const spaceAbove = chipRect.top;
          const spaceBelow = window.innerHeight - chipRect.bottom;
          
          let tooltipTop, tooltipLeft, arrowStyle;
          
          // Determine if tooltip should go above or below
          if (spaceAbove >= tooltipRect.height + 20 || spaceAbove >= spaceBelow) {
            // Show above
            tooltipTop = chipRect.top - tooltipRect.height - 8;
            arrowStyle = `
              position: absolute;
              bottom: -6px;
              left: 50%;
              transform: translateX(-50%);
              width: 0;
              height: 0;
              border-left: 6px solid transparent;
              border-right: 6px solid transparent;
              border-top: 6px solid #0b0646;
            `;
          } else {
            // Show below
            tooltipTop = chipRect.bottom + 8;
            arrowStyle = `
              position: absolute;
              top: -6px;
              left: 50%;
              transform: translateX(-50%);
              width: 0;
              height: 0;
              border-left: 6px solid transparent;
              border-right: 6px solid transparent;
              border-bottom: 6px solid #0b0646;
            `;
          }
          
          arrow.style.cssText = arrowStyle;
          
          // Center horizontally, but adjust if it would go off-screen
          tooltipLeft = chipRect.left + (chipRect.width / 2) - (tooltipRect.width / 2);
          
          if (tooltipLeft < 10) {
            tooltipLeft = 10;
            arrow.style.left = `${chipRect.left + (chipRect.width / 2) - 10}px`;
          } else if (tooltipLeft + tooltipRect.width > window.innerWidth - 10) {
            tooltipLeft = window.innerWidth - tooltipRect.width - 10;
            arrow.style.left = `${chipRect.right - (window.innerWidth - tooltipLeft - tooltipRect.width)}px`;
          }
          
          tooltip.style.left = tooltipLeft + 'px';
          tooltip.style.top = tooltipTop + 'px';
          tooltip.style.opacity = '1';
        }, 10);
      });
      
      chip.addEventListener('mouseleave', function() {
        const tooltip = document.getElementById('triggerTooltip');
        if (tooltip) {
          tooltip.style.opacity = '0';
          setTimeout(() => tooltip.remove(), 200);
        }
      });
      
      chipsContainer.appendChild(chip);
    });
  }
  
  // ========= TRIGGER WORDS MESSAGE =========
  const triggerWordsMessageEl = document.getElementById('freeTriggerWordsMessage');
  if (triggerWordsMessageEl && flagCount > 0) {
    if (score >= 70) {
      triggerWordsMessageEl.innerHTML = "These words are AI red flags.<br>Your prof's detector will catch them in seconds. Upgrade to see exactly which sentences need fixing.";
      triggerWordsMessageEl.style.color = '#dc2626';
      triggerWordsMessageEl.style.fontSize = '16px';
      triggerWordsMessageEl.style.fontWeight = '700';
      triggerWordsMessageEl.style.paddingTop = '0';
      triggerWordsMessageEl.style.paddingBottom = '0';
    } else if (score >= 30) {
      triggerWordsMessageEl.innerHTML = "These words are AI red flags.<br>Your prof's detector will catch them in seconds. Upgrade to see exactly which sentences need fixing.";
      triggerWordsMessageEl.style.color = '#dc2626';
      triggerWordsMessageEl.style.fontSize = '16px';
      triggerWordsMessageEl.style.fontWeight = '700';
      // Add 1/8" padding (12px) top and 1/4" padding (24px) bottom for Kinda Sus page
      triggerWordsMessageEl.style.paddingTop = '12px';
      triggerWordsMessageEl.style.paddingBottom = '24px';
    }
  } else if (triggerWordsMessageEl) {
    triggerWordsMessageEl.textContent = '';
  }
  
  // ========= ESSAY SNIPPET PREVIEW =========
  const essaySnippetEl = document.getElementById('freeEssaySnippetText');
  const essaySnippetContainer = document.getElementById('freeEssaySnippet');
  const unlockOverlayEl = document.getElementById('freeUnlockOverlay');
  
  // Determine border color based on score range
  let borderColor = '#eed202'; // Default yellow
  if (score >= 70) {
    borderColor = '#dc2626'; // Red for Hella Sus
  } else if (score >= 30) {
    borderColor = '#eed202'; // Yellow for Kinda Sus
  } else {
    borderColor = '#2ecc71'; // Green for You're Good
  }
  
  // Update essay snippet border colors (both sides)
  if (essaySnippetContainer) {
    essaySnippetContainer.style.borderLeftColor = borderColor;
    essaySnippetContainer.style.borderRightColor = borderColor;
  }
  
  // Update unlock overlay border color
  if (unlockOverlayEl) {
    unlockOverlayEl.style.borderColor = borderColor;
  }
  
  // Show full essay text with highlighted flags
  if (essaySnippetEl) {
    if (text && text.trim().length > 0) {
      // Calculate preview count (same logic as above)
      const previewCount = (score >= 30 && score < 70) ? Math.min(3, flagCount) : 3;
      const previewFlags = analysisFlags.slice(0, previewCount);
      
      // Highlight AI trigger words - blur everything except the 3 "shown" flags
      let highlightedText = text.trim();
      const previewPhrases = previewFlags.map(f => f.phrase.toLowerCase());
      
      if (analysisFlags && analysisFlags.length > 0) {
        // CRITICAL FIX: Only highlight the FIRST 3 instances TOTAL across all preview flag phrases
        // Find all matches for preview phrases and sort by position
        let workingText = highlightedText;
        const previewPhraseList = previewFlags.map(f => f.phrase);
        const allMatches = [];
        
        // Find all matches for each preview phrase (case-insensitive)
        previewPhraseList.forEach((phrase) => {
          const lowerText = workingText.toLowerCase();
          const lowerPhrase = phrase.toLowerCase();
          let searchIndex = 0;
          
          // Find all case-insensitive matches
          while ((searchIndex = lowerText.indexOf(lowerPhrase, searchIndex)) !== -1) {
            // Get the actual matched text (preserve original case)
            const actualMatch = workingText.substring(searchIndex, searchIndex + phrase.length);
            allMatches.push({
              phrase: phrase,
              index: searchIndex,
              length: phrase.length,
              match: actualMatch
            });
            searchIndex += phrase.length; // Move past this match
          }
        });
        
        // Sort by position in text (earliest first)
        allMatches.sort((a, b) => a.index - b.index);
        
        // Only take the first 3 matches total
        const matchesToHighlight = allMatches.slice(0, previewCount);
        
        // Replace in reverse order (from end to start) to preserve indices
        matchesToHighlight.reverse().forEach((match) => {
          const before = workingText.substring(0, match.index);
          const after = workingText.substring(match.index + match.length);
          workingText = before + `<span class="flag-preview-clear" data-flag-phrase="${match.phrase}">${match.match}</span>` + after;
        });
        
        highlightedText = workingText;
        
        // DO NOT highlight other flags - they should just be blurred with the rest of the text
      }
      
      // Now wrap all text segments in blurred spans, except preview flags
      // Split by preview flags and wrap non-preview parts
      const parts = highlightedText.split(/(<span class="flag-preview-clear"[^>]*>.*?<\/span>)/gi);
      let finalText = '';
      
      parts.forEach((part, index) => {
        if (part.match(/<span class="flag-preview-clear"/i)) {
          // This is a preview flag - keep it clear with full styling
          const flagMatch = part.match(/data-flag-phrase="([^"]+)"/);
          const flagPhrase = flagMatch ? flagMatch[1] : '';
          finalText += `<span class="flag-preview-clear" style="background: #fee2e2; border: 2px solid #dc2626; padding: 2px 6px; border-radius: 4px; font-weight: 600; color: #991b1b; position: relative; z-index: 10; filter: blur(0); opacity: 1;">${flagPhrase}</span>`;
        } else if (part.trim()) {
          // This is regular text or other flags - blur it
          finalText += `<span style="filter: blur(2.5px); opacity: 0.6; display: inline;">${part}</span>`;
        }
      });
      
      essaySnippetEl.innerHTML = finalText;
    } else {
      // Placeholder for testing
      if (score >= 70) {
        essaySnippetEl.textContent = 'In today\'s rapidly evolving digital landscape, organizations must leverage cutting-edge solutions to achieve unprecedented levels of efficiency and innovation. Furthermore, comprehensive analysis reveals multifaceted approaches to problem-solving. Moreover, the data suggests that various industries are experiencing considerable transformation.';
      } else if (score >= 30) {
        essaySnippetEl.textContent = 'In today\'s world, technology is becoming more important in education, helping students access information faster and collaborate in new ways. This transformation has created opportunities for enhanced learning experiences and improved educational outcomes.';
      } else {
        essaySnippetEl.textContent = 'Yesterday I went to the park after class, read a book on a bench, and talked with my friend about our weekend plans. It was a nice afternoon and we enjoyed the weather together.';
      }
    }
  }
  
  // ========= UNLOCK OVERLAY: Update copy based on score =========
  const unlockOverlay = document.getElementById('freeUnlockOverlay');
  const unlockContent = document.getElementById('freeUnlockContent');
  const totalTriggers = flagCount; // Total number of triggers found
  
  if (unlockContent) {
    if (score >= 70) {
      // HELLA SUS (70%+)
      const remainingTriggers = Math.max(0, totalTriggers - 3);
      unlockContent.innerHTML = `
        <div style="font-size: 44px; margin-bottom: 16px;">🔒</div>
        <h3 id="unlockOverlayHeading" style="color: #374151; font-size: 16px; font-weight: 800; margin: 0 0 36px 0;">Your writing's legit human, but detectors might still flag parts as low-key sus as AI. Get QuickFix and Fix it fast. Zero commitment. Zero Panic. Zero F's.</h3>
      `;
      
      // Update button after content is set - same as Clean No Sus
      setTimeout(() => {
        // Hide the quickfixUnlockButton first - force it
        const quickfixBtn = document.getElementById('quickfixUnlockButton');
        if (quickfixBtn) {
          quickfixBtn.style.display = 'none';
          quickfixBtn.style.visibility = 'hidden';
          quickfixBtn.style.opacity = '0';
        }
        
        const proButton = document.querySelector('#freeUnlockOverlay button[onclick="handleProUpgrade()"]');
        const buttonContainer = proButton ? proButton.parentElement : null;
        if (proButton && buttonContainer) {
          // Remove any existing hand emoji first
          const existingEmoji = buttonContainer.querySelector('span[data-hand-emoji="true"]');
          if (existingEmoji) existingEmoji.remove();
          
          // Create hand emoji before button
          const handEmoji = document.createElement('span');
          handEmoji.textContent = '👉';
          handEmoji.setAttribute('data-hand-emoji', 'true');
          handEmoji.style.fontSize = '32px';
          handEmoji.style.marginRight = '12px';
          handEmoji.style.verticalAlign = 'middle';
          handEmoji.style.display = 'inline-flex';
          handEmoji.style.alignItems = 'center';
          handEmoji.style.animation = 'pointBackForth 1s ease-in-out infinite';
          handEmoji.style.cursor = 'pointer';
          buttonContainer.insertBefore(handEmoji, proButton);
          // Change container to align items center
          buttonContainer.style.alignItems = 'center';
          
          // Update button text
          proButton.innerHTML = '<span style="color: #ffeb3b !important; display: inline-block; text-shadow: -2px -2px 0px #666, 2px -2px 0px #666, -2px 2px 0px #666, 2px 2px 0px #666, 0 0 15px #ffeb3b, 0 0 25px #ffeb3b, 0 0 35px #ffeb3b; filter: brightness(1.5) saturate(2) !important; font-weight: bold; -webkit-text-stroke: 1px #666; text-stroke: 1px #666;">⚡</span> Unlock QuickFix ($1.99)';
          proButton.style.background = '#ff6b00';
          proButton.style.color = 'white';
          proButton.onclick = function() { switchToQuickFix(); };
        }
      }, 100);
    } else if (score >= 30) {
      // KINDA SUS (30-69%)
      unlockContent.innerHTML = `
        <div style="font-size: 44px; margin-bottom: 16px;">🔒</div>
        <h3 id="unlockOverlayHeading" style="color: #374151; font-size: 16px; font-weight: 800; margin: 0 0 36px 0;">Your writing's legit human, but detectors might still flag parts as low-key sus as AI. Get QuickFix and Fix it fast. Zero commitment. Zero Panic. Zero F's.</h3>
      `;
      
      // Update button for Kinda Sus - change Pro button to orange QuickFix button
      setTimeout(() => {
        // Hide the quickfixUnlockButton first
        const quickfixBtn = document.getElementById('quickfixUnlockButton');
        if (quickfixBtn) {
          quickfixBtn.style.display = 'none';
          quickfixBtn.style.visibility = 'hidden';
          quickfixBtn.style.opacity = '0';
        }
        
        const proButton = document.querySelector('#freeUnlockOverlay button[onclick="handleProUpgrade()"]');
        const buttonContainer = proButton ? proButton.parentElement : null;
        if (proButton && buttonContainer) {
          // Remove any existing hand emoji first
          const existingEmoji = buttonContainer.querySelector('span[data-hand-emoji="true"]');
          if (existingEmoji) existingEmoji.remove();
          
          // Update button text and style to orange QuickFix
          proButton.innerHTML = '<span style="color: #ffeb3b !important; display: inline-block; text-shadow: -2px -2px 0px #666, 2px -2px 0px #666, -2px 2px 0px #666, 2px 2px 0px #666, 0 0 15px #ffeb3b, 0 0 25px #ffeb3b, 0 0 35px #ffeb3b; filter: brightness(1.5) saturate(2) !important; font-weight: bold; -webkit-text-stroke: 1px #666; text-stroke: 1px #666;">⚡</span> QuickFix $1.99';
          proButton.style.background = '#ff6b00';
          proButton.style.color = 'white';
          proButton.onclick = function() { switchToQuickFix(); };
        }
      }, 100);
    } else {
      // YOU'RE GOOD (Under 30%)
      unlockContent.innerHTML = `
        <div style="font-size: 44px; margin-bottom: 16px;">🔒</div>
        <h3 id="unlockOverlayHeading" style="color: #374151; font-size: 16px; font-weight: 800; margin: 0 0 12px 0;">This essay's clean. Love that for you. But one sus AI phrase can flip that fast. QuickFix catches it and fixes it — fast.</h3>
        <p style="color: #374151; font-size: 13px; margin: 0 0 24px 0; line-height: 1.5; max-width: 100%; font-weight: 400;">
          Zero commitment. Zero Panic. Zero F's.
        </p>
      `;
      
      // Update button after content is set
      setTimeout(() => {
        const proButton = document.querySelector('#freeUnlockOverlay button[onclick="handleProUpgrade()"]');
        const buttonContainer = proButton ? proButton.parentElement : null;
        if (proButton && buttonContainer) {
          // Check if hand emoji already exists
          const existingEmoji = buttonContainer.querySelector('span[data-hand-emoji="true"]');
          if (!existingEmoji) {
            // Create hand emoji before button
            const handEmoji = document.createElement('span');
            handEmoji.textContent = '👉';
            handEmoji.setAttribute('data-hand-emoji', 'true');
            handEmoji.style.fontSize = '32px';
            handEmoji.style.marginRight = '12px';
            handEmoji.style.verticalAlign = 'middle';
            handEmoji.style.display = 'inline-flex';
            handEmoji.style.alignItems = 'center';
            handEmoji.style.animation = 'pointBackForth 1s ease-in-out infinite';
            handEmoji.style.cursor = 'pointer';
            buttonContainer.insertBefore(handEmoji, proButton);
            // Change container to align items center
            buttonContainer.style.alignItems = 'center';
          } else {
            // Update existing emoji
            existingEmoji.style.fontSize = '32px';
            existingEmoji.style.marginRight = '12px';
            existingEmoji.style.animation = 'pointBackForth 1s ease-in-out infinite';
          }
          
          // Update button text
          proButton.innerHTML = '<span style="color: #ffeb3b !important; display: inline-block; text-shadow: -2px -2px 0px #666, 2px -2px 0px #666, -2px 2px 0px #666, 2px 2px 0px #666, 0 0 15px #ffeb3b, 0 0 25px #ffeb3b, 0 0 35px #ffeb3b; filter: brightness(1.5) saturate(2) !important; font-weight: bold; -webkit-text-stroke: 1px #666; text-stroke: 1px #666;">⚡</span> Unlock QuickFix ($1.99)';
          proButton.style.background = '#ff6b00';
          proButton.style.color = 'white';
          proButton.onclick = function() { switchToQuickFix(); };
        }
      }, 100);
    }
  }
  
  // ========= GREEN UPSELL SECTION: Update copy based on score =========
  const upsellHeading = document.getElementById('freeUpsellHeadingText');
  const upsellText = document.getElementById('freeUpsellText');
  
  // Always show the heading with "🚀 Go Pro and chill..."
  if (upsellHeading) {
    upsellHeading.textContent = '🚀 Go Pro and chill...';
    upsellHeading.style.display = 'block';
  }
  
  if (upsellText) {
    if (score >= 70) {
      // HELLA SUS (70%+)
      upsellText.textContent = 'Get 500 scans/mo • Deeper Fixes • Real-Time Scoring • Fix the AI flags before the AI flags you.';
    } else if (score >= 30) {
      // KINDA SUS (30-69%)
      upsellText.textContent = 'Get 500 scans/mo • Deeper Fixes • Real-Time Scoring • Fix the AI flags before the AI flags you.';
    } else {
      // YOU'RE GOOD (Under 30%)
      upsellText.textContent = 'You nailed this one. Lock in the wins with Pro • Catch triggers on EVERY essay before your prof does • 500 monthly scans • Stay undefeated';
    }
  }

  // ========= BLURRED ESSAY SNIPPET =========
  const sentencesContainer = document.getElementById('freeFlagSentences');
  if (sentencesContainer) {
    sentencesContainer.innerHTML = '';
    previewFlags.forEach(flag => {
      const phrase = flag.phrase || flag.word || flag.text || '';
      const lowerText = text.toLowerCase();
      const lowerPhrase = phrase.toLowerCase();
      const idx = phrase ? lowerText.indexOf(lowerPhrase) : -1;

      let sentence = text;
      if (idx !== -1) {
        let start = text.lastIndexOf('.', idx);
        let newlineStart = text.lastIndexOf('\n', idx);
        if (newlineStart > start) start = newlineStart;
        start = start === -1 ? 0 : start + 1;

        let end = text.indexOf('.', idx + phrase.length);
        let newlineEnd = text.indexOf('\n', idx + phrase.length);
        if (newlineEnd !== -1 && (end === -1 || newlineEnd < end)) end = newlineEnd;
        end = end === -1 ? Math.min(text.length, idx + phrase.length + 120) : end + 1;

        sentence = text.slice(start, end).trim();
      }

      const safeSentence = sentence || text;
      let highlighted = safeSentence;
      if (phrase) {
        const escaped = phrase.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        highlighted = safeSentence.replace(
          new RegExp(escaped, 'gi'),
          match => `<span class="trigger-chip">${match}</span>`
        );
      }

      const row = document.createElement('div');
      row.className = 'free-flag-row';
      row.innerHTML = `
        <p class="free-flag-sentence" style="font-size:13px;color:#4b5563;line-height:1.6;margin:0 0 8px 0;text-align:left;">
          ${highlighted}
        </p>
      `;
      sentencesContainer.appendChild(row);
    });

    if (extraCount > 0) {
      const extra = document.createElement('p');
      extra.style.cssText = 'font-size:12px;color:#6b7280;line-height:1.5;margin:4px 0 0 0;text-align:left;';
      extra.textContent =
        `We found ${extraCount} more AI-trigger word${extraCount === 1 ? '' : 's'} in your text — they’re locked in Free mode.`;
      sentencesContainer.appendChild(extra);
    }
  }

  const blurredTextEl = document.getElementById('freeBlurredText');
  if (blurredTextEl) {
    const snippet = text.length > 600 ? text.slice(0, 600) + '…' : text;
    blurredTextEl.innerHTML =
      `<p style="color:#6b7280;font-size:13px;line-height:1.6;margin:0;">${snippet.replace(/\n/g, '<br>')}</p>`;
  }

  // Scroll to results section, not top of page
  const resultsContainer = document.getElementById('resultsContainer');
  if (resultsContainer) {
    resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

function minimizeResults() {
  const resultsContainer = document.getElementById('resultsContainer');
  if (resultsContainer) {
    resultsContainer.classList.remove('show');
    resultsContainer.style.display = 'none';
  }
  document.getElementById('inputSection').style.display = 'block';
  
  // Clear the form completely
  const essayInput = document.getElementById('essayInput');
  if (essayInput) {
    essayInput.value = '';
  }
  
  // Reset authorship checkbox
  const authorshipCheckbox = document.getElementById('authorshipCheckbox');
  if (authorshipCheckbox) {
    authorshipCheckbox.checked = false;
  }
  
  // Sync scan count from localStorage when returning to front page
  appState.scansUsed = getScansUsed();
  updateCounter();
  updateScansDisplay();
}

function handleProUpgrade() {
  // Show welcome modal first, before payment
  showProWelcomeModal(true); // Pass true to indicate it's for upgrade (not dashboard welcome)
}

// ==================== STEP 6: PRO DASHBOARD FUNCTIONS ====================

function showProDashboard() {
  console.log('🔄 showProDashboard() called');
  
  // Set Pro mode flag
  appState.isProUser = true;
  
  // Update labels from QuickFix to Pro
  updateStepLabels(true);
  
  // Show reminder about 5000 character limit (unless user dismissed it)
  const proCharacterReminder = document.getElementById('proCharacterReminder');
  if (proCharacterReminder) {
    // Hide if user previously dismissed it, otherwise show it
    if (sessionStorage.getItem('proReminderDismissed')) {
      proCharacterReminder.style.display = 'none';
    } else {
      proCharacterReminder.style.display = 'block';
    }
  }
  
  // Hide all other sections FIRST
  const inputSection = document.getElementById('inputSection');
  if (inputSection) {
    inputSection.style.display = 'none';
    console.log('✅ Input section hidden');
  }
  
  // Hide QuickFix flow container
  const quickfixFlow = document.getElementById('quickfixFlow');
  if (quickfixFlow) {
    quickfixFlow.style.display = 'none';
    console.log('✅ QuickFix flow hidden');
  }
  
  // Hide all QuickFix steps
  document.querySelectorAll('.quickfix-step').forEach(step => {
    if (step.id !== 'quickfixStep6') {
      step.style.display = 'none';
      step.classList.remove('active');
    }
  });
  
  const managePage = document.getElementById('manageSubscriptionPage');
  if (managePage) managePage.style.display = 'none';
  
  // Hide results container if visible
  const resultsContainer = document.getElementById('resultsContainer');
  if (resultsContainer) {
    resultsContainer.classList.remove('show');
    resultsContainer.style.display = 'none';
  }
  
  // Show Step 6 - make sure it's visible
  const step6 = document.getElementById('quickfixStep6');
  if (!step6) {
    console.error('❌ Step 6 element not found!');
    return;
  }
  
  // Remove any inline display:none styles
  let currentStyle = step6.getAttribute('style') || '';
  currentStyle = currentStyle.replace(/display\s*:\s*none\s*;?/gi, '');
  if (currentStyle.trim()) {
    step6.setAttribute('style', currentStyle);
  } else {
    step6.removeAttribute('style');
  }
  
  // Force show Step 6 with multiple methods to ensure visibility
  step6.style.setProperty('display', 'block', 'important');
  step6.style.setProperty('opacity', '1', 'important');
  step6.style.setProperty('visibility', 'visible', 'important');
  step6.classList.add('active');
  
  // Double-check it's visible after a brief delay
  setTimeout(() => {
    const computedDisplay = window.getComputedStyle(step6).display;
    if (computedDisplay === 'none') {
      console.error('❌ Step 6 still hidden after show attempt!');
      step6.style.setProperty('display', 'block', 'important');
      step6.style.setProperty('opacity', '1', 'important');
      step6.style.setProperty('visibility', 'visible', 'important');
    }
  }, 100);
  
  console.log('✅ Step 6 displayed');
  console.log('Step 6 computed style:', window.getComputedStyle(step6).display);
  console.log('Step 6 has active class:', step6.classList.contains('active'));
  console.log('Step 6 innerHTML length:', step6.innerHTML.length);
  
  // Update usage stats
  updateProUsageStats();
  
  // Initialize character counter for Pro scan input
  const proInput = document.getElementById('proScanInput');
  if (proInput) {
    // Remove old listeners first
    const newInput = proInput.cloneNode(true);
    proInput.parentNode.replaceChild(newInput, proInput);
    
    document.getElementById('proScanInput').addEventListener('input', function() {
      const count = this.value.length;
      const countEl = document.getElementById('proCharCount');
      if (countEl) {
        countEl.textContent = count.toLocaleString() + '/5,000 characters';
      }
      
      // Update button state using helper function (checks both text length and authorship)
      if (typeof updateProScanButtonState === 'function') {
        updateProScanButtonState();
      }
    });
    
    // Also listen for authorship checkbox changes
    const proAuthorshipCheckbox = document.getElementById('proAuthorshipCheckbox');
    if (proAuthorshipCheckbox) {
      proAuthorshipCheckbox.addEventListener('change', function() {
        if (typeof updateProScanButtonState === 'function') {
          updateProScanButtonState();
        }
      });
    }
  }
  
  // Scroll to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
  
  // Show welcome modal on first visit (only for existing Pro users, not during upgrade flow)
  const hasSeenProWelcome = localStorage.getItem('proWelcomeSeen');
  if (!hasSeenProWelcome) {
    setTimeout(() => {
      showProWelcomeModal(false); // false = dashboard welcome, not upgrade
    }, 500);
  }
  
  console.log('✅ Pro Dashboard ready');
}

// Pro Welcome Modal - Shows Pro features before payment or on first dashboard visit
function showProWelcomeModal(isUpgrade = false) {
  const modal = document.createElement('div');
  modal.id = 'proWelcomeModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    backdrop-filter: blur(5px);
  `;
  
  const title = isUpgrade ? 'Upgrade to Pro ✨' : 'Welcome to Pro! 🎉';
  const subtitle = isUpgrade ? 'Full protection from false AI flags — see your exact score, catch every trigger, and fix it before you submit' : 'Here\'s what you can do with your Pro subscription';
  const buttonText = isUpgrade ? 'Continue to Pro ✨' : 'Start Scanning ✨';
  const buttonOnClick = isUpgrade ? 'proWelcomeToPayment()' : 'closeProWelcomeModal()';
  
  modal.innerHTML = `
    <div style="
      background: white;
      border-radius: 24px;
      padding: 40px;
      max-width: 900px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      position: relative;
    ">
      <button onclick="closeProWelcomeModal()" style="
        position: absolute;
        top: 15px;
        right: 20px;
        background: none;
        border: none;
        font-size: 32px;
        color: #9ca3af;
        cursor: pointer;
        padding: 5px;
        line-height: 1;
        transition: color 0.2s;
      " onmouseover="this.style.color='#dc2626';" onmouseout="this.style.color='#9ca3af';">×</button>
      
      <div style="text-align: center; margin-bottom: 30px;">
        <h2 class="modal-title" style="color: #0b0646; margin: 0 0 10px; font-size: 28px; font-weight: 800;">
          ${title}
        </h2>
        <p class="modal-subtitle" style="color: #6b7280; font-size: 16px; margin: 0;">
          ${subtitle}
        </p>
      </div>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 18px; margin-bottom: 30px;">
        <div class="pro-feature" style="background: #f8f9fa; padding: 20px; border-radius: 14px; border: 2px solid #e5e7eb;">
          <div class="pro-feature-icon" style="font-size: 36px; margin-bottom: 10px;">🧠</div>
          <div class="pro-feature-title" style="color: #0b0646; margin: 0 0 8px; font-size: 16px; font-weight: 700;">Professor-Level Scan</div>
          <div class="pro-feature-desc" style="color: #6b7280; font-size: 13px; line-height: 1.5; margin: 0;">Emulates real university AI detectors for the most accurate risk prediction.</div>
        </div>
        
        <div class="pro-feature" style="background: #f8f9fa; padding: 20px; border-radius: 14px; border: 2px solid #e5e7eb;">
          <div class="pro-feature-icon" style="font-size: 36px; margin-bottom: 10px;">📉</div>
          <div class="pro-feature-title" style="color: #0b0646; margin: 0 0 8px; font-size: 16px; font-weight: 700;">AI Risk Score</div>
          <div class="pro-feature-desc" style="color: #6b7280; font-size: 13px; line-height: 1.5; margin: 0;">See your exact AI detection risk level after applying fixes — know if it's safe to submit before you turn it in.</div>
        </div>
        
        <div class="pro-feature" style="background: #f8f9fa; padding: 20px; border-radius: 14px; border: 2px solid #e5e7eb;">
          <div class="pro-feature-icon" style="font-size: 36px; margin-bottom: 10px;">🔀</div>
          <div class="pro-feature-title" style="color: #0b0646; margin: 0 0 8px; font-size: 16px; font-weight: 700;">Multiple Fix Options</div>
          <div class="pro-feature-desc" style="color: #6b7280; font-size: 13px; line-height: 1.5; margin: 0;">Pick from options that are less likely to get flagged, or write your own replacement that matches your vibe.</div>
        </div>
        
        <div class="pro-feature" style="background: #f8f9fa; padding: 20px; border-radius: 14px; border: 2px solid #e5e7eb;">
          <div class="pro-feature-icon" style="font-size: 36px; margin-bottom: 10px;">💡</div>
          <div class="pro-feature-title" style="color: #0b0646; margin: 0 0 8px; font-size: 16px; font-weight: 700;">Risk Explanations</div>
          <div class="pro-feature-desc" style="color: #6b7280; font-size: 13px; line-height: 1.5; margin: 0;">See exactly why detectors flag certain phrases — and how to rewrite them.</div>
        </div>
        
        <div class="pro-feature" style="background: #f8f9fa; padding: 20px; border-radius: 14px; border: 2px solid #e5e7eb;">
          <div class="pro-feature-icon" style="font-size: 36px; margin-bottom: 10px;">📝</div>
          <div class="pro-feature-title" style="color: #0b0646; margin: 0 0 8px; font-size: 16px; font-weight: 700;">5,000 Characters</div>
          <div class="pro-feature-desc" style="color: #6b7280; font-size: 13px; line-height: 1.5; margin: 0;">Scan full assignments and reports with expanded character limits.</div>
        </div>
        
        <div class="pro-feature" style="background: #f8f9fa; padding: 20px; border-radius: 14px; border: 2px solid #e5e7eb;">
          <div class="pro-feature-icon" style="font-size: 36px; margin-bottom: 10px;">📊</div>
          <div class="pro-feature-title" style="color: #0b0646; margin: 0 0 8px; font-size: 16px; font-weight: 700;">500 Monthly Scans + Fix History</div>
          <div class="pro-feature-desc" style="color: #6b7280; font-size: 13px; line-height: 1.5; margin: 0;">Scan on repeat and check your last 10 fixes — compare versions and track your improvements.</div>
        </div>
      </div>
      
      ${isUpgrade ? `
      <div style="text-align: center; margin: 20px 0;">
        <p style="color: #6b7280; font-size: 16px; margin: 0 0 8px 0; font-weight: 500;">
          Trusted by students everywhere.
        </p>
        <p style="color: #0b0646; font-size: 15px; margin: 0; font-weight: 600;">
          Join thousands of students using False Flag Fixer Pro ★★★★★
        </p>
      </div>
      ` : ''}
      
      <div style="text-align: center;">
        <button onclick="${buttonOnClick}" class="pro-upgrade-btn btn-success" style="padding: 12px 32px; font-size: 16px !important; font-weight: 600 !important; box-shadow: 0 4px 15px rgba(0, 168, 232, 0.3); margin-bottom: 15px;">
          ${buttonText}
        </button>
        ${isUpgrade ? '<a href="javascript:void(0)" onclick="closeProWelcomeModal(); hideProDashboard();" class="modal-dismiss" style="display:block;text-align:center;color:#9ca3af;font-size:14px;text-decoration:underline;cursor:pointer;margin-top:10px;">Not now — I\'ll risk it 😬</a>' : ''}
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  document.body.classList.add('modal-open');
  
  // Close on backdrop click
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      closeProWelcomeModal();
    }
  });
}

function closeProWelcomeModal() {
  const modal = document.getElementById('proWelcomeModal');
  if (modal) {
    modal.remove();
    document.body.classList.remove('modal-open');
    localStorage.setItem('proWelcomeSeen', 'true');
  }
  // Re-check button state after modal closes
  updateProScanButtonState();
}

// Helper function to update Pro scan button state
function updateProScanButtonState() {
  const proInput = document.getElementById('proScanInput');
  const proScanButton = document.getElementById('proScanButton');
  const proAuthorshipCheckbox = document.getElementById('proAuthorshipCheckbox');
  
  if (proInput && proScanButton) {
    const textLength = proInput.value.trim().length;
    const isAuthorshipConfirmed = proAuthorshipCheckbox ? proAuthorshipCheckbox.checked : true; // Default to true if checkbox doesn't exist
    
    console.log('updateProScanButtonState called:', { textLength, isAuthorshipConfirmed, buttonExists: !!proScanButton });
    
    // For Pro, only check text length (>= 50 chars) - no authorship checkbox required
    if (textLength >= 50) {
      proScanButton.disabled = false;
      proScanButton.style.background = 'linear-gradient(135deg, #00d9ff 0%, #00a8e8 100%)';
      proScanButton.style.opacity = '1';
      proScanButton.style.cursor = 'pointer';
      console.log('Button enabled - blue');
    } else {
      proScanButton.disabled = true;
      proScanButton.style.background = '#9ca3af';
      proScanButton.style.opacity = '0.6';
      proScanButton.style.cursor = 'not-allowed';
      console.log('Button disabled - grey (text too short:', textLength, ')');
    }
  } else {
    console.log('updateProScanButtonState: elements not found', { proInput: !!proInput, proScanButton: !!proScanButton });
  }
}

function proWelcomeToPayment() {
  closeProWelcomeModal();
  showStripePaymentModal();
}

function hideProDashboard() {
  console.log('🔄 hideProDashboard() called');
  const step6 = document.getElementById('quickfixStep6');
  if (step6) {
    step6.style.display = 'none';
    step6.classList.remove('active');
  }
  const inputSection = document.getElementById('inputSection');
  if (inputSection) {
    inputSection.style.display = 'block';
  }
  
  // Trim text back to 500 characters for free scan limit
  const essayInput = document.getElementById('essayInput');
  if (essayInput && essayInput.value.length > 500) {
    essayInput.value = essayInput.value.substring(0, 500);
    updateCounter();
  }
  
  console.log('✅ Returned to main dashboard');
}

function updateProUsageStats() {
  const scansUsed = appState.proSubscription.scansUsed || 0;
  const scansLimit = appState.proSubscription.scansLimit || 500;
  
  // Update ring number
  const ringNumber = document.getElementById('proRingNumber');
  if (ringNumber) {
    ringNumber.textContent = scansUsed;
  }
  
  // Update ring progress
  const ringProgress = document.getElementById('proRingProgress');
  if (ringProgress) {
    const percentage = Math.min(100, (scansUsed / scansLimit) * 100);
    const circumference = 2 * Math.PI * 75; // radius is 75
    const offset = circumference - (percentage / 100) * circumference;
    ringProgress.style.strokeDashoffset = offset;
  }
}

function startProScan() {
  const text = document.getElementById('proScanInput').value.trim();
  
  if (text.length < 50) {
    showWarningModal();
    return;
  }
  
  if (text.length > 5000) {
    showSuccessMessage('Text exceeds 5,000 character limit');
    return;
  }
  
  // CRITICAL: Set Pro mode flag
  appState.isProUser = true;
  
  // Update labels from QuickFix to Pro
  updateStepLabels(true);
  
  // 1. Hide Pro Dashboard (Step 6)
  const step6 = document.getElementById('quickfixStep6');
  if (step6) {
    step6.style.setProperty('display', 'none', 'important');
    step6.classList.remove('active');
  }
  
  // 2. Show quickfixFlow (step 2 is inside it) but hide quickfixStep1
  const quickfixFlow = document.getElementById('quickfixFlow');
  if (quickfixFlow) {
    quickfixFlow.style.setProperty('display', 'block', 'important');
  }
  const quickfixStep1 = document.getElementById('quickfixStep1');
  if (quickfixStep1) {
    quickfixStep1.style.setProperty('display', 'none', 'important');
    quickfixStep1.classList.remove('active');
  }
  
  // Hide input section
  const inputSection = document.getElementById('inputSection');
  if (inputSection) {
    inputSection.style.setProperty('display', 'none', 'important');
  }
  
  // Scroll to top of page immediately
  window.scrollTo({ top: 0, behavior: 'instant' });
  
  // 3. Change labels from QuickFix to Pro
  updateStepLabels(true);
  
  // Show scanning modal
  showScanningModal();
  
  // Simulate scan (replace with actual Pro scan logic)
  setTimeout(() => {
    hideScanningModal();
    
    // Run Pro scan (finds ALL flags)
    console.log('🔍 AIDetectionEngine.detectFlags called (Pro scan) - input length:', text.length);
    const flags = AIDetectionEngine.detectFlags(text);
    console.log('🔍 AIDetectionEngine.detectFlags result (Pro scan) - flags count:', flags.length);
    console.log('🔍 AIDetectionEngine.calculateScore called (Pro scan) - input length:', text.length);
    const score = AIDetectionEngine.calculateScore(text);
    console.log('🔍 AIDetectionEngine.calculateScore result (Pro scan) - score:', score);
    
    // Store Pro scan data (also store in quickfix state for compatibility)
    appState.proOriginalText = text;
    appState.proFlags = flags;
    appState.proOriginalScore = score;
    appState.proFixedText = '';
    appState.proNewScore = 0;
    
    // Also store in quickfix state so displayQuickFixAnalysis works
    appState.quickfixOriginalText = text;
    appState.quickfixFlags = flags;
    appState.quickfixOriginalScore = score;
    
    // Increment Pro scans used
    if (appState.proSubscription.active) {
      appState.proSubscription.scansUsed++;
      updateProUsageStats();
    }
    
    // 4. Show quickfixStep2 and populate with Pro data
    showProStep(2);
    displayQuickFixAnalysis(text, score, flags);
    
    // 5. Update labels after content renders and FORCE hide upsell
    setTimeout(() => {
      // Hide instruction box for Pro users
      const instructionBox = document.getElementById('fixSelectionInstructionBox');
      if (instructionBox) {
        instructionBox.style.display = 'none';
      }
      updateStepLabels(true);
      
      // Only show button group if there are flags to fix (not for clean results)
      const buttonGroup = document.getElementById('quickfixButtonGroup');
      const applyButton = document.getElementById('applySelectedFixes');
      const flagCount = flags && flags.length > 0 ? flags.length : 0;
      const isCleanResult = flagCount === 0 && score < 30;
      
      if (isCleanResult) {
        // Hide button for Pro clean results (no flags detected)
        if (buttonGroup) {
          buttonGroup.style.display = 'none';
          buttonGroup.style.setProperty('display', 'none', 'important');
        }
        if (applyButton) {
          applyButton.style.display = 'none';
          applyButton.style.setProperty('display', 'none', 'important');
        }
      } else {
        // Show button group only if there are flags to fix
        if (buttonGroup) {
          buttonGroup.style.display = 'flex';
          buttonGroup.style.setProperty('display', 'flex', 'important');
        }
        if (applyButton) {
          applyButton.style.display = 'block';
          applyButton.style.setProperty('display', 'block', 'important');
        }
      }
      
      // FORCE hide upsell for Pro users after content renders
      const proUpsellBox = document.getElementById('quickfixProUpsellBox');
      const newProBanner = document.getElementById('quickfixProBanner');
      if (appState.isProUser) {
        if (proUpsellBox) {
          proUpsellBox.style.display = 'none';
          proUpsellBox.style.setProperty('display', 'none', 'important');
        }
        if (newProBanner) {
          newProBanner.style.display = 'none';
          newProBanner.style.setProperty('display', 'none', 'important');
        }
      }
      
      // Scroll to top after content loads
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 100);
  }, 2000);
}

// ==================== PRO FLOW FUNCTIONS ====================

// Function to swap labels between QuickFix and Pro modes
function updateStepLabels(isPro) {
  // Check appState.isProUser as fallback if isPro not explicitly passed
  if (isPro === undefined) {
    isPro = appState.isProUser || false;
  }
  
  const steps = [2, 3, 4];
  const replacements = [
    { quickfix: 'QuickFix', pro: 'Pro' },
    { quickfix: 'quickfix', pro: 'Pro' },
    { quickfix: 'Quick Fix', pro: 'Pro' },
    { quickfix: 'Quick Fix™', pro: 'Pro' }
  ];
  
  steps.forEach(stepNum => {
    const stepElement = document.getElementById('quickfixStep' + stepNum);
    if (!stepElement) return;
    
    // Update all text content in the step
    const walker = document.createTreeWalker(
      stepElement,
      NodeFilter.SHOW_TEXT,
      null,
      false
    );
    
    const textNodes = [];
    let node;
    while (node = walker.nextNode()) {
      if (node.textContent.trim()) {
        textNodes.push(node);
      }
    }
    
    textNodes.forEach(textNode => {
      let text = textNode.textContent;
      if (isPro) {
        // Change QuickFix to Pro
        replacements.forEach(repl => {
          text = text.replace(new RegExp(repl.quickfix, 'gi'), repl.pro);
        });
      } else {
        // Change Pro back to QuickFix (only if it was originally QuickFix)
        // This is a simplified version - in practice, you might want to store original text
        replacements.forEach(repl => {
          text = text.replace(new RegExp('\\b' + repl.pro + '\\b', 'gi'), repl.quickfix);
        });
      }
      textNode.textContent = text;
    });
    
    // Also update element attributes and titles
    stepElement.querySelectorAll('[title*="QuickFix"], [title*="quickfix"], [title*="Pro"]').forEach(el => {
      if (isPro) {
        el.title = el.title.replace(/QuickFix/gi, 'Pro').replace(/quickfix/gi, 'Pro');
      } else {
        el.title = el.title.replace(/\bPro\b/gi, 'QuickFix');
      }
    });
  });
  
  // MAIN HEADER: Update "False Flag Fixer - QuickFix" → "False Flag Fixer - Pro" and change emoji
  const mainHeaderTitle = document.getElementById('mainHeaderTitle');
  if (mainHeaderTitle) {
    if (isPro) {
      // Change QuickFix to Pro and lightning emoji to diamond emoji
      let headerText = mainHeaderTitle.innerHTML;
      headerText = headerText.replace(/QuickFix/gi, 'Pro');
      headerText = headerText.replace(/quickfix/gi, 'Pro');
      // Replace lightning emoji with diamond emoji and remove yellow glow, add white outline
      headerText = headerText.replace(/⚡/g, '💎');
      mainHeaderTitle.innerHTML = headerText;
      
      // Update the span element directly to remove yellow glow and add white outline
      setTimeout(() => {
        const span = mainHeaderTitle.querySelector('span');
        if (span && (span.textContent.includes('💎') || span.innerHTML.includes('💎'))) {
          span.style.color = 'white';
          span.style.textShadow = '0 0 4px white, 0 0 8px white, 0 0 12px white';
          span.style.filter = 'none';
          span.style.display = 'inline-block';
          span.style.fontWeight = 'bold';
        }
      }, 50);
    } else {
      // Change Pro back to QuickFix and diamond emoji back to lightning emoji
      let headerText = mainHeaderTitle.innerHTML;
      headerText = headerText.replace(/\bPro\b/gi, 'QuickFix');
      // Replace diamond emoji with lightning emoji
      headerText = headerText.replace(/💎/g, '⚡');
      mainHeaderTitle.innerHTML = headerText;
    }
  }
  
  // STEP 2: Update "QuickFix found" → "Pro found" heading
  const quickfixCountHeading = document.getElementById('quickfixCountHeading');
  if (quickfixCountHeading) {
    quickfixCountHeading.style.color = '#dc2626';
    if (isPro) {
      let headingText = quickfixCountHeading.innerHTML;
      headingText = headingText.replace(/QuickFix found/gi, 'Pro found');
      headingText = headingText.replace(/quickfix found/gi, 'Pro found');
      quickfixCountHeading.innerHTML = headingText;
    } else {
      let headingText = quickfixCountHeading.innerHTML;
      headingText = headingText.replace(/Pro found/gi, 'QuickFix found');
      quickfixCountHeading.innerHTML = headingText;
    }
  }
  
  // STEP 2 & 3: Update "Apply QuickFixes" → "Apply Pro Fixes" button
  const applyButton = document.getElementById('applySelectedFixes');
  if (applyButton) {
    const selectedCount = document.getElementById('selectedCount')?.textContent || '0';
    if (isPro) {
      applyButton.innerHTML = `✅ Apply Pro Fixes (<span id="selectedCount">${selectedCount}</span>) and Get Your New Score`;
      // Change button color to Pro blue
      applyButton.style.background = '#00a8e8 !important';
      applyButton.style.setProperty('background', '#00a8e8', 'important');
    } else {
      applyButton.innerHTML = `✅ Apply QuickFixes (<span id="selectedCount">${selectedCount}</span>) and Get Your New Score`;
      // Keep orange for QuickFix
      applyButton.style.background = '#ff6b00 !important';
      applyButton.style.setProperty('background', '#ff6b00', 'important');
    }
  }
  
  // STEP 4: Update Pro-themed header (if Step 4 exists)
  if (isPro) {
    const step4Header = document.getElementById('rotatingMessage');
    if (step4Header) {
      // Keep Pro-themed premium header
      step4Header.textContent = '💎 Premium Results - Every Flag Found & Fixed ✨';
    }
    const step4HeroText = document.getElementById('step4HeroText');
    if (step4HeroText) {
      step4HeroText.innerHTML = step4HeroText.innerHTML.replace(/QuickFix found/gi, 'Pro found');
    }
    const step4ProText = document.getElementById('step4ProText');
    if (step4ProText) {
      step4ProText.textContent = step4ProText.textContent.replace(/QuickFix found/gi, 'Pro found');
    }
  }
  
  // Always keep Pro banner text as "Pro" (not "QuickFix") - this is a Pro upsell banner
  const proBanner = document.getElementById('quickfixProBanner');
  if (proBanner) {
    const bannerButton = proBanner.querySelector('button');
    if (bannerButton && bannerButton.textContent.includes('QuickFix')) {
      bannerButton.textContent = '💎 Go Pro - $9.99/mo';
    }
    const proBenefitsText = document.getElementById('proBenefitsText');
    if (proBenefitsText && proBenefitsText.textContent.includes('QuickFix')) {
      proBenefitsText.textContent = '🚨 Don\'t Risk It. Fix It.';
      proBenefitsText.style.fontSize = '22px';
      proBenefitsText.style.fontWeight = '800';
    }
  }
  
  // Show/hide appropriate back buttons
  const step2BackToDashboard = document.getElementById('step2BackToDashboard');
  const step2BackToProDashboard = document.getElementById('step2BackToProDashboard');
  const step3BackToDashboard = document.getElementById('step3BackToDashboard');
  const step3BackToProDashboard = document.getElementById('step3BackToProDashboard');
  const step3ViewPastFixes = document.getElementById('step3ViewPastFixes');
  const step3EditFixes = document.getElementById('step3EditFixes');
  const step4BackToDashboard = document.getElementById('step4BackToDashboard');
  const step4BackToProDashboard = document.getElementById('step4BackToProDashboard');
  
  if (isPro) {
    // Show Pro dashboard buttons, hide regular dashboard buttons
    if (step2BackToDashboard) step2BackToDashboard.style.display = 'none';
    if (step2BackToProDashboard) step2BackToProDashboard.style.display = 'block';
    // Show trusted section on Pro Step 2
    const step2TrustedSection = document.getElementById('step2TrustedSection');
    if (step2TrustedSection) step2TrustedSection.style.display = 'block';
    // For Step 3: Show all four buttons - "Paste & Scan Another Essay", "View Past Fixes", "Edit Fixes", "Back to Main Homepage"
    if (step3BackToDashboard) step3BackToDashboard.style.display = 'block';
    if (step3BackToProDashboard) step3BackToProDashboard.style.display = 'block';
    if (step3ViewPastFixes) step3ViewPastFixes.style.display = 'block';
    if (step3EditFixes) step3EditFixes.style.display = 'block';
    if (step4BackToDashboard) step4BackToDashboard.style.display = 'none';
    if (step4BackToProDashboard) step4BackToProDashboard.style.display = 'block';
  } else {
    // Show regular dashboard buttons, hide Pro dashboard buttons
    if (step2BackToDashboard) step2BackToDashboard.style.display = 'block';
    if (step2BackToProDashboard) step2BackToProDashboard.style.display = 'none';
    // Hide trusted section on free version
    const step2TrustedSection = document.getElementById('step2TrustedSection');
    if (step2TrustedSection) step2TrustedSection.style.display = 'none';
    if (step3BackToDashboard) step3BackToDashboard.style.display = 'block';
    if (step3BackToProDashboard) step3BackToProDashboard.style.display = 'none';
    if (step3ViewPastFixes) step3ViewPastFixes.style.display = 'none';
    if (step3EditFixes) step3EditFixes.style.display = 'none';
    if (step4BackToDashboard) step4BackToDashboard.style.display = 'block';
    if (step4BackToProDashboard) step4BackToProDashboard.style.display = 'none';
  }
}

function showProStep(stepNumber) {
  console.log('showProStep called with:', stepNumber);
  
  // Hide Pro Dashboard (Step 6)
  const step6 = document.getElementById('quickfixStep6');
  if (step6) {
    step6.style.setProperty('display', 'none', 'important');
    step6.classList.remove('active');
  }
  
  // Hide input section
  const inputSection = document.getElementById('inputSection');
  if (inputSection) {
    inputSection.style.setProperty('display', 'none', 'important');
  }
  
  // For steps 2, 3, 4: Show quickfixFlow (they're inside it) but hide step 1
  if (stepNumber === 2 || stepNumber === 3 || stepNumber === 4) {
    const quickfixFlow = document.getElementById('quickfixFlow');
    if (quickfixFlow) {
      quickfixFlow.style.setProperty('display', 'block', 'important');
    }
    
    // Hide step 1
    const quickfixStep1 = document.getElementById('quickfixStep1');
    if (quickfixStep1) {
      quickfixStep1.style.setProperty('display', 'none', 'important');
      quickfixStep1.classList.remove('active');
    }
  } else {
    // For other steps, hide quickfixFlow
    const quickfixFlow = document.getElementById('quickfixFlow');
    if (quickfixFlow) {
      quickfixFlow.style.setProperty('display', 'none', 'important');
    }
  }
  
  // Hide all other steps
  document.querySelectorAll('.quickfix-step').forEach(step => {
    if (step.id !== 'quickfixStep' + stepNumber && step.id !== 'quickfixStep6') {
      step.style.display = 'none';
      step.classList.remove('active');
    }
  });
  
  const stepElement = document.getElementById('quickfixStep' + stepNumber);
  if (stepElement) {
    // Remove any inline display:none
    let currentStyle = stepElement.getAttribute('style') || '';
    currentStyle = currentStyle.replace(/display\s*:\s*none\s*;?/gi, '');
    if (currentStyle.trim()) {
      stepElement.setAttribute('style', currentStyle);
    }
    
    // Force show the step
    stepElement.style.setProperty('display', 'block', 'important');
    stepElement.style.setProperty('opacity', '1', 'important');
    stepElement.style.setProperty('visibility', 'visible', 'important');
    stepElement.classList.add('active');
    
    // Ensure proper styling for steps 2, 3, 4
    if (stepNumber === 2 || stepNumber === 3 || stepNumber === 4) {
      stepElement.style.setProperty('padding', '60px 20px 40px 20px', 'important');
      stepElement.style.setProperty('background', '#ffffff', 'important');
      stepElement.style.setProperty('min-height', '100vh', 'important');
    }
    
    console.log('Pro Step ' + stepNumber + ' displayed');
    console.log('Step element computed display:', window.getComputedStyle(stepElement).display);
    
    // Scroll to top to show the step
    setTimeout(() => {
      stepElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
  } else {
    console.error('Pro Step element not found for step:', stepNumber);
  }
}

function hideProFlow() {
  // Hide QuickFix steps 2, 3, 4 (which are reused for Pro)
  // Reset labels back to QuickFix mode
  updateStepLabels(false);
  
  document.querySelectorAll('.quickfix-step').forEach(step => {
    if (step.id === 'quickfixStep2' || step.id === 'quickfixStep3' || step.id === 'quickfixStep4') {
      step.style.display = 'none';
      step.classList.remove('active');
    }
  });
  
  // Show Pro Dashboard
  showProDashboard();
}

// Function to go back to Pro Dashboard from any Pro step
function backToProDashboard() {
  // Reset labels back to QuickFix mode first
  updateStepLabels(false);
  
  // Hide all QuickFix steps
  document.querySelectorAll('.quickfix-step').forEach(step => {
    if (step.id === 'quickfixStep2' || step.id === 'quickfixStep3' || step.id === 'quickfixStep4') {
      step.style.display = 'none';
      step.classList.remove('active');
    }
  });
  
  // Hide quickfixFlow (which contains steps 2, 3, 4)
  const quickfixFlow = document.getElementById('quickfixFlow');
  if (quickfixFlow) {
    quickfixFlow.style.setProperty('display', 'none', 'important');
  }
  
  // Show Pro Dashboard (which will set Pro mode again)
  showProDashboard();
}

function returnToProDashboardWithEssay() {
  // Hide all Pro steps
  hideProFlow();
  
  // Auto-populate the textarea with the fixed essay
  const proScanInput = document.getElementById('proScanInput');
  if (proScanInput && appState.proFixedText) {
    proScanInput.value = appState.proFixedText;
    // Trigger input event to update character count
    const inputEvent = new Event('input', { bubbles: true });
    proScanInput.dispatchEvent(inputEvent);
  }
}

function returnToMainDashboard() {
  // Hide all Pro sections
  const quickfixStep6 = document.getElementById('quickfixStep6');
  if (quickfixStep6) {
    quickfixStep6.style.display = 'none';
    quickfixStep6.classList.remove('active');
  }
  
  // Hide Pro steps (which reuse QuickFix steps 2, 3, 4)
  // Reset labels back to QuickFix mode
  updateStepLabels(false);
  
  document.querySelectorAll('.quickfix-step').forEach(step => {
    if (step.id === 'quickfixStep2' || step.id === 'quickfixStep3' || step.id === 'quickfixStep4') {
      step.style.display = 'none';
      step.classList.remove('active');
    }
  });
  
  // Show main input section
  const inputSection = document.getElementById('inputSection');
  if (inputSection) {
    inputSection.style.display = 'block';
  }
  
  // Trim text back to 500 characters for free scan limit
  const essayInput = document.getElementById('essayInput');
  if (essayInput && essayInput.value.length > 500) {
    essayInput.value = essayInput.value.substring(0, 500);
    updateCounter();
  }
  
  // Hide other sections
  const quickfixFlow = document.getElementById('quickfixFlow');
  if (quickfixFlow) quickfixFlow.style.display = 'none';
  
  const resultsContainer = document.getElementById('resultsContainer');
  if (resultsContainer) resultsContainer.style.display = 'none';
  
  const managePage = document.getElementById('manageSubscriptionPage');
  if (managePage) managePage.style.display = 'none';
}


// Pro Step 9 helper functions


function showProScanHistory() {
  console.log('🔄 showProScanHistory() called');
  showSuccessMessage('Scan history coming soon!');
}

// ==================== STRIPE PAYMENT FUNCTIONS ====================

function initializeStripe() {
  // Load Stripe.js library
  if (typeof Stripe === 'undefined') {
    const script = document.createElement('script');
    script.src = 'https://js.stripe.com/v3/';
    script.onload = function() {
      setupStripe();
    };
    document.head.appendChild(script);
  } else {
    setupStripe();
  }
}

function setupStripe() {
  // TODO: Replace with your actual Stripe publishable key
  const stripeKey = 'pk_test_YOUR_STRIPE_KEY_HERE';
  
  if (!stripeKey || stripeKey.includes('YOUR_STRIPE_KEY')) {
    console.warn('Stripe key not configured. Payment will not work until key is set.');
    // Set a flag so we know Stripe isn't configured
    appState.stripeConfigured = false;
    return;
  }
  
  appState.stripe = Stripe(stripeKey);
  appState.stripeConfigured = true;
  
  // Setup card element for payment modal
  const elements = appState.stripe.elements();
  appState.stripeCardElement = elements.create('card', {
    style: {
      base: {
        fontSize: '16px',
        color: '#0b0646',
        '::placeholder': {
          color: '#9ca3af',
        },
      },
    },
  });
  
  // Setup card element for update payment modal
  appState.stripeUpdateCardElement = elements.create('card', {
    style: {
      base: {
        fontSize: '16px',
        color: '#0b0646',
        '::placeholder': {
          color: '#9ca3af',
        },
      },
    },
  });
}

function showStripePaymentModal() {
  const modal = document.getElementById('stripePaymentModal');
  if (!modal) return;
  
  // TEST MODE: Only allow on localhost/dev environments
  const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.hostname === '';
  
  // TEST MODE: Check if Stripe is configured
  if (!appState.stripe) {
    initializeStripe();
    // Give it a moment to initialize
    setTimeout(() => {
      // If Stripe still not configured or setupStripe returned early (key is placeholder)
      if (!appState.stripe || appState.stripeConfigured === false) {
        // Stripe not configured - only activate test mode on localhost
        if (isLocalhost) {
          console.log('🧪 TEST MODE: Stripe not configured. Activating Pro mode for testing (localhost only)...');
          activateProTestMode();
        } else {
          console.error('❌ Stripe is not configured. Please configure Stripe keys for production.');
          showSuccessMessage('Payment system is not configured. Please contact support.', '#dc2626');
        }
        return;
      } else {
        // Stripe initialized, show payment modal
        showStripePaymentModal();
      }
    }, 100);
    return;
  }
  
  // If we already checked and Stripe isn't configured, only activate test mode on localhost
  if (appState.stripeConfigured === false) {
    if (isLocalhost) {
      console.log('🧪 TEST MODE: Stripe not configured. Activating Pro mode for testing (localhost only)...');
      activateProTestMode();
    } else {
      console.error('❌ Stripe is not configured. Please configure Stripe keys for production.');
      showSuccessMessage('Payment system is not configured. Please contact support.', '#dc2626');
    }
    return;
  }
  
  modal.style.display = 'flex';
  document.body.classList.add('modal-open');
  
  // Mount Stripe card element
  if (appState.stripeCardElement && document.getElementById('stripeCardElement')) {
    // Unmount first if already mounted
    try {
      appState.stripeCardElement.unmount();
    } catch(e) {}
    appState.stripeCardElement.mount('#stripeCardElement');
  }
  
  // Setup form submission
  const form = document.getElementById('stripePaymentForm');
  if (form) {
    // Remove old listeners
    const newForm = form.cloneNode(true);
    form.parentNode.replaceChild(newForm, form);
    document.getElementById('stripePaymentForm').addEventListener('submit', handleStripePayment);
  }
  
  // Close on outside click
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      closeStripePaymentModal();
    }
  });
}

function closeStripePaymentModal() {
  const modal = document.getElementById('stripePaymentModal');
  if (modal) {
    modal.style.display = 'none';
    document.body.classList.remove('modal-open');
    
    if (appState.stripeCardElement) {
      appState.stripeCardElement.unmount();
    }
  }
}
async function handleStripePayment(event) {
  event.preventDefault();
  
  const submitBtn = document.getElementById('stripeSubmitBtn');
  const errorDiv = document.getElementById('stripeCardErrors');
  
  if (submitBtn) {
    submitBtn.disabled = true;
    submitBtn.textContent = 'Processing...';
  }
  
  // TODO: Replace with your backend endpoint that creates a PaymentIntent or Subscription
  // This should call your backend API which then creates the Stripe subscription
  try {
    // Mock payment for now - replace with actual API call
    // const response = await fetch('/api/create-subscription', {
    //   method: 'POST',
    //   headers: { 'Content-Type': 'application/json' },
    //   body: JSON.stringify({})
    // });
    
    // For now, simulate successful payment
    setTimeout(() => {
      // Activate Pro subscription
      appState.isProUser = true;
      appState.proSubscription.active = true;
      appState.maxChars = 5000;
      
      // Calculate next billing date (30 days from now)
      const nextBilling = new Date();
      nextBilling.setDate(nextBilling.getDate() + 30);
      appState.proSubscription.nextBillingDate = nextBilling;
      
      // Close modal and redirect to Pro Dashboard
      closeStripePaymentModal();
      showSuccessMessage('Welcome to Pro! 🎉');
      showProDashboard();
    }, 1500);
    
  } catch (error) {
    console.error('Payment error:', error);
    if (errorDiv) {
      errorDiv.textContent = error.message || 'Payment failed. Please try again.';
    }
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Subscribe for $9.99/month';
    }
  }
}

// ==================== MANAGE SUBSCRIPTION FUNCTIONS ====================

function showManageSubscription() {
  console.log('🔄 showManageSubscription() called');
  
  // Hide ALL other sections with !important to override any previous !important rules
  const step6 = document.getElementById('quickfixStep6');
  if (step6) {
    step6.style.setProperty('display', 'none', 'important');
    step6.style.setProperty('opacity', '0', 'important');
    step6.style.setProperty('visibility', 'hidden', 'important');
    step6.classList.remove('active');
    console.log('✅ Step 6 (Pro Dashboard) hidden');
  }
  const inputSection = document.getElementById('inputSection');
  if (inputSection) {
    inputSection.style.setProperty('display', 'none', 'important');
  }
  const quickfixFlow = document.getElementById('quickfixFlow');
  if (quickfixFlow) {
    quickfixFlow.style.setProperty('display', 'none', 'important');
  }
  const resultsContainer = document.getElementById('resultsContainer');
  if (resultsContainer) {
    resultsContainer.style.setProperty('display', 'none', 'important');
    resultsContainer.classList.remove('show');
  }
  
  // Show manage subscription page with !important
  const managePage = document.getElementById('manageSubscriptionPage');
  if (managePage) {
    managePage.style.setProperty('display', 'block', 'important');
    managePage.style.setProperty('opacity', '1', 'important');
    managePage.style.setProperty('visibility', 'visible', 'important');
    updateManageSubscriptionPage();
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
    console.log('✅ Manage subscription page shown');
  } else {
    console.error('❌ Manage subscription page element not found!');
  }
}

function hideManageSubscription() {
  document.getElementById('manageSubscriptionPage').style.display = 'none';
  if (appState.isProUser) {
    showProDashboard();
  } else {
    document.getElementById('inputSection').style.display = 'block';
  }
}

function updateManageSubscriptionPage() {
  if (!appState.proSubscription.active) return;
  
  // Update subscription info
  const nextBilling = appState.proSubscription.nextBillingDate || new Date();
  document.getElementById('subNextBilling').textContent = nextBilling.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  
  // Update usage
  const scansUsed = appState.proSubscription.scansUsed || 0;
  const scansLimit = appState.proSubscription.scansLimit || 500;
  document.getElementById('subScansUsed').textContent = `${scansUsed}/${scansLimit}`;
  
  const usagePercent = (scansUsed / scansLimit) * 100;
  const usageBar = document.getElementById('subUsageBar');
  if (usageBar) {
    usageBar.style.width = Math.min(100, usagePercent) + '%';
  }
  
  // Update reset date (first of next month)
  const resetDate = new Date();
  resetDate.setMonth(resetDate.getMonth() + 1, 1);
  document.getElementById('subResetDate').textContent = resetDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function showUpdatePaymentModal() {
  const modal = document.getElementById('updatePaymentModal');
  if (!modal) return;
  
  if (!appState.stripe) {
    initializeStripe();
    setTimeout(() => showUpdatePaymentModal(), 500);
    return;
  }
  
  modal.style.display = 'flex';
  document.body.classList.add('modal-open');
  
  if (appState.stripeUpdateCardElement && document.getElementById('updateCardElement')) {
    // Unmount first if already mounted
    try {
      appState.stripeUpdateCardElement.unmount();
    } catch(e) {}
    appState.stripeUpdateCardElement.mount('#updateCardElement');
  }
  
  const form = document.getElementById('updatePaymentForm');
  if (form) {
    // Remove old listeners
    const newForm = form.cloneNode(true);
    form.parentNode.replaceChild(newForm, form);
    document.getElementById('updatePaymentForm').addEventListener('submit', handleUpdatePayment);
  }
  
  // Close on outside click
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      closeUpdatePaymentModal();
    }
  });
}

function closeUpdatePaymentModal() {
  const modal = document.getElementById('updatePaymentModal');
  if (modal) {
    modal.style.display = 'none';
    document.body.classList.remove('modal-open');
    
    if (appState.stripeUpdateCardElement) {
      appState.stripeUpdateCardElement.unmount();
    }
  }
}

async function handleUpdatePayment(event) {
  event.preventDefault();
  
  // TODO: Replace with actual backend API call to update payment method
  showSuccessMessage('Payment method updated!');
  closeUpdatePaymentModal();
}

function showCancelSubscriptionModal() {
  const modal = document.getElementById('cancelSubscriptionModal');
  if (!modal) return;
  
  const nextBilling = appState.proSubscription.nextBillingDate || new Date();
  document.getElementById('cancelEndDate').textContent = nextBilling.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  
  modal.style.display = 'flex';
  document.body.classList.add('modal-open');
  
  // Close on outside click
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      closeCancelSubscriptionModal();
    }
  });
}

function closeCancelSubscriptionModal() {
  const modal = document.getElementById('cancelSubscriptionModal');
  if (modal) {
    modal.style.display = 'none';
    document.body.classList.remove('modal-open');
  }
}

async function confirmCancelSubscription() {
  // TODO: Replace with actual backend API call to cancel subscription
  appState.proSubscription.active = false;
  appState.isProUser = false;
  appState.maxChars = 500;
  
  closeCancelSubscriptionModal();
  showSuccessMessage('Subscription cancelled. Access continues until billing period ends.');
  hideManageSubscription();
}

// ==================== TESTING: ACTIVATE PRO MODE ====================
// For testing purposes - activates Pro subscription without payment
// Call this from browser console: activateProTestMode()
function activateProTestMode() {
  appState.isProUser = true;
  appState.proSubscription.active = true;
  appState.maxChars = 5000;
  
  // Set next billing date (30 days from now)
  const nextBilling = new Date();
  nextBilling.setDate(nextBilling.getDate() + 30);
  appState.proSubscription.nextBillingDate = nextBilling;
  
  // Set some usage
  appState.proSubscription.scansUsed = 5; // 5/500 scans used
  
  showSuccessMessage('Pro mode activated for testing! 🎉');
  showProDashboard();
  
  console.log('✅ Pro mode activated. You can now access Step 6 Pro Dashboard.');
  return 'Pro mode activated!';
}

// Alternative: Add a hidden test button (remove in production)
// You can temporarily add this button anywhere to test
function addProTestButton() {
  // Only add if it doesn't exist
  if (document.getElementById('proTestBtn')) return;
  
  const btn = document.createElement('button');
  btn.id = 'proTestBtn';
  btn.textContent = '🧪 TEST: Activate Pro';
  btn.style.cssText = 'position:fixed;bottom:20px;right:20px;background:#00a8e8;color:white;padding:12px 20px;border:none;border-radius:8px;cursor:pointer;z-index:9999;font-weight:600;box-shadow:0 4px 12px rgba(0,0,0,0.2);';
  btn.onclick = function() {
    activateProTestMode();
    this.remove();
  };
  document.body.appendChild(btn);
}

function getRandomPhrase(phrases) {
  return phrases[Math.floor(Math.random() * phrases.length)];
}

async function analyzeTextWithAPI(text) {
  const BACKEND_URL = 'https://dtiiy.onrender.com';
  const API_ENDPOINT = `${BACKEND_URL}/analyze`;
  
  try {
    console.log('🌐 Making API call to backend:', API_ENDPOINT);
    console.log('📝 Text length:', text.length);
    
    const response = await fetch(API_ENDPOINT, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ essay: text })
    });
    
    console.log('📡 Response status:', response.status, response.statusText);
    
    // Check for errors
    if (!response.ok) {
      let errorData;
      try {
        errorData = await response.json();
      } catch (e) {
        errorData = { error: await response.text() };
      }
      console.error('❌ Backend API Error Response:', {
        status: response.status,
        statusText: response.statusText,
        body: errorData
      });
      throw new Error(`Backend API request failed: ${response.status} ${response.statusText}`);
    }
    
    // Parse successful response
    const data = await response.json();
    console.log('✅ Backend API Success Response:', data);
    
    // Extract and return the expected format
    return {
      score: data.score || 50,
      issues: data.issues || [],
      flagCount: data.flagCount || data.issues?.length || 0
    };
    
  } catch (error) {
    console.error('❌ API call failed with full error details:', {
      name: error.name,
      message: error.message,
      stack: error.stack,
      cause: error.cause
    });
    
    // Check for connection error (backend not running or network issue)
    if (error.message.includes('Failed to fetch') || error.message.includes('ERR_CONNECTION_REFUSED') || error.message.includes('NetworkError')) {
      console.error('🚫 Connection Error - Cannot reach backend server');
      console.error('💡 Check if backend is running at:', BACKEND_URL);
    }
    
    // Check for CORS error
    if (error.message.includes('CORS')) {
      console.error('🚫 CORS Error detected');
      console.error('💡 Make sure your backend has CORS enabled for your domain');
    }
    
    // Fallback to local analysis if API fails
    console.log('🔄 Falling back to local analysis');
    return analyzeTextLocally(text);
  }
}

function updateScanButton() {
  // This function is called by updateCounter
}

// ===== UNIFIED TOOLTIP SYSTEM =====
let tooltip = null;

function createTooltip() {
  if (tooltip) return;
  tooltip = document.createElement('div');
  tooltip.className = 'tooltip';
  document.body.appendChild(tooltip);
}

function getTooltipColorClass(button) {
  // New unified classes
  if (button.classList.contains('btn-primary')) return 'blue-border';
  if (button.classList.contains('btn-secondary')) return 'orange-border';
  if (button.classList.contains('btn-success')) return 'green-border';
  // Old classes (for backwards compatibility)
  if (button.classList.contains('scan-button')) return 'blue-border';
  if (button.classList.contains('emergency-button')) return 'orange-border';
  if (button.classList.contains('pro-button')) return 'green-border';
  if (button.classList.contains('btn-quickfix')) return 'orange-border';
  if (button.classList.contains('btn-pro')) return 'green-border';
  return '';
}

function showTooltip(event) {
  // Check if authorship checkbox is checked before showing tooltip
  const authorshipCheckbox = document.getElementById('authorshipCheckbox');
  if (authorshipCheckbox && !authorshipCheckbox.checked) {
    return; // Hide tooltip if checkbox is not checked
  }
  
  createTooltip();
  
  const button = event.currentTarget;
  const message = button.getAttribute('data-tooltip') || button.getAttribute('title');
  
  if (!message) return;
  
  // Set content
  tooltip.textContent = message;
  
  // Remove old color classes
  tooltip.classList.remove('blue-border', 'orange-border', 'green-border');
  
  // Add appropriate color class
  const colorClass = getTooltipColorClass(button);
  if (colorClass) {
    tooltip.classList.add(colorClass);
  }
  
  // Show tooltip
  tooltip.classList.add('show');
  
  // Position tooltip above the button
  positionTooltip(button);
}

function positionTooltip(button) {
  const rect = button.getBoundingClientRect();
  const tooltipRect = tooltip.getBoundingClientRect();
  
  // Center horizontally on button
  let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
  
  // Position above button with 10px gap
  let top = rect.top - tooltipRect.height - 10;
  
  // Prevent tooltip from going off-screen (left)
  if (left < 10) {
    left = 10;
  }
  
  // Prevent tooltip from going off-screen (right)
  if (left + tooltipRect.width > window.innerWidth - 10) {
    left = window.innerWidth - tooltipRect.width - 10;
  }
  
  // If tooltip would go above viewport, show it below instead
  if (top < 10) {
    top = rect.bottom + 10;
  }
  
  tooltip.style.left = left + 'px';
  tooltip.style.top = top + 'px';
}

function hideTooltip() {
  if (tooltip) {
    tooltip.classList.remove('show');
  }
}

function updateTooltipPosition() {
  const activeButton = document.querySelector('[data-tooltip]:hover, [title]:hover');
  if (activeButton && tooltip && tooltip.classList.contains('show')) {
    positionTooltip(activeButton);
  }
}

function initializeTooltips() {
  document.querySelectorAll('[data-tooltip], [title]').forEach(button => {
    button.addEventListener('mouseenter', showTooltip);
    button.addEventListener('mouseleave', hideTooltip);
    button.addEventListener('mousemove', updateTooltipPosition);
  });
}

// Initialize tooltips on page load
document.addEventListener('DOMContentLoaded', initializeTooltips);

// ===== ALTERNATIVE SUGGESTIONS GENERATOR =====
// Generates alternative suggestions for words/phrases (for refresh functionality)
function generateAlternativeSuggestions(phrase) {
  const phraseLower = phrase.toLowerCase();
  let alternatives = [];
  
  // Handle specific phrases (multi-word)
  if (phraseLower.includes('unprecedented')) {
    alternatives = ['outstanding results', 'impressive achievements', 'notable progress', 'substantial gains', 'considerable advances'];
  } else if (phraseLower.includes('cutting-edge') || phraseLower.includes('cutting edge')) {
    alternatives = ['state-of-the-art', 'contemporary', 'current', 'up-to-date', 'latest'];
  } else if (phraseLower.includes('leverage')) {
    alternatives = ['take advantage of', 'harness', 'capitalize on', 'tap into', 'draw on'];
  } else if (phraseLower.includes('furthermore')) {
    alternatives = ['what\'s more', 'in addition', 'on top of that', 'besides', 'additionally'];
  } else if (phraseLower.includes('moreover')) {
    alternatives = ['what\'s more', 'in addition', 'on top of that', 'besides', 'furthermore'];
  } else if (phraseLower.includes('additionally')) {
    alternatives = ['also', 'plus', 'on top of that', 'what\'s more', 'furthermore'];
  } else if (phraseLower.includes('therefore')) {
    alternatives = ['that\'s why', 'for that reason', 'as a result', 'hence', 'thus'];
  } else if (phraseLower.includes('consequently')) {
    alternatives = ['as a result', 'so', 'that\'s why', 'for that reason', 'hence'];
  } else {
    // Generic fallback - generate variations based on the phrase
    const words = phrase.split(' ');
    if (words.length > 1) {
      // Multi-word phrase - try different combinations
      alternatives = [
        words[0] + ' different',
        'alternative ' + words.join(' '),
        words[words.length - 1] + ' instead',
        'other ' + words.join(' ')
      ];
    } else {
      // Single word - try synonyms/variations
      alternatives = [phrase + ' differently', 'alternative ' + phrase, 'other ' + phrase, 'different ' + phrase];
    }
  }
  
  // Return 3-4 random alternatives (shuffle and take first few)
  const shuffled = alternatives.sort(() => 0.5 - Math.random());
  return shuffled.slice(0, Math.min(4, shuffled.length));
}

// Refresh suggestions for a specific flag
function refreshSuggestions(flagIndex, originalPhrase) {
  const container = document.querySelector(`.suggestions-container[data-flag-index="${flagIndex}"]`);
  if (!container) return;
  
  // Show loading state
  container.innerHTML = '<span style="color:#6b7280; font-size:13px;">Loading alternatives...</span>';
  
  // Show the restore button
  const restoreBtn = document.querySelector(`.restore-original-btn[data-flag-index="${flagIndex}"]`);
  if (restoreBtn) {
    restoreBtn.style.display = 'inline-block';
  }
  
  // Generate new alternatives
  setTimeout(() => {
    const newAlternatives = generateAlternativeSuggestions(originalPhrase);
    
    // Create new button HTML (without green flag since these are alternatives)
    let buttonsHtml = '';
    newAlternatives.forEach(alt => {
      const escapedAlt = alt.replace(/'/g, "\\'");
      buttonsHtml += `<button class="alt-word-btn" data-flag-index="${flagIndex}" data-word="${escapedAlt}" style="background:#e0f2fe; border:1px solid #2ecc71; color:#0c4a6e; padding:6px 12px; border-radius:4px; font-size:13px; cursor:pointer; margin:2px; font-weight:500; display:inline-flex; align-items:center;">${alt}</button> `;
    });
    
    container.innerHTML = buttonsHtml;
    
    // Re-attach event listeners to new buttons
    container.querySelectorAll('.alt-word-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const flagIdx = this.getAttribute('data-flag-index');
        const selectedWord = this.getAttribute('data-word');
        
        // Update the flag's suggestedFix
        if (appState.quickfixFlags && appState.quickfixFlags[flagIdx]) {
          console.log('User selected word for flag', flagIdx, ':', appState.quickfixFlags[flagIdx].phrase, '→', selectedWord);
          appState.quickfixFlags[flagIdx].suggestedFix = selectedWord;
        }
        
        // Deselect all buttons for this flag and select clicked one
        const allBtnsForFlag = document.querySelectorAll(`.alt-word-btn[data-flag-index="${flagIdx}"]`);
        allBtnsForFlag.forEach(b => {
          b.style.background = '#e0f2fe';
          b.style.borderColor = '#2ecc71';
          b.style.color = '#0c4a6e';
          b.style.fontWeight = '500';
          b.classList.remove('selected-word');
        });
        
        // Highlight selected button
        this.style.background = '#2ecc71';
        this.style.color = 'white';
        this.style.borderColor = '#2ecc71';
        this.style.fontWeight = '600';
        this.classList.add('selected-word');
        
        // Clear custom input field when a word button is selected
        const customInput = document.querySelector(`.custom-word-field[data-flag-index="${flagIdx}"]`);
        if (customInput) {
          customInput.value = '';
        }
        
        // Auto-check the checkbox when user selects a word
        const checkbox = document.getElementById(`fix-${flagIdx}`);
        if (checkbox && !checkbox.checked) {
          checkbox.checked = true;
          checkbox.dispatchEvent(new Event('change'));
        }
        
        updateSelectedCount();
        
        // Check if "Use Best Words" should be unchecked (if user selected non-best word from alternatives)
        checkIfAllBestWords();
      });
    });
  }, 500); // Small delay for UX
}

// Restore original best suggestions for a specific flag
function restoreOriginalSuggestions(flagIndex, originalPhrase, originalBestWord) {
  const container = document.querySelector(`.suggestions-container[data-flag-index="${flagIndex}"]`);
  if (!container) return;
  
  // Get stored original suggestions
  const originalSuggestionsJson = container.getAttribute('data-original-suggestions');
  if (!originalSuggestionsJson) return;
  
  let originalSuggestions;
  try {
    originalSuggestions = JSON.parse(originalSuggestionsJson);
  } catch (e) {
    console.error('Error parsing original suggestions:', e);
    return;
  }
  
  // Hide the restore button
  const restoreBtn = document.querySelector(`.restore-original-btn[data-flag-index="${flagIndex}"]`);
  if (restoreBtn) {
    restoreBtn.style.display = 'none';
  }
  
  // Rebuild the original buttons with ✅ on the first one
  let buttonsHtml = '';
  originalSuggestions.forEach((suggestion, idx) => {
    const escapedSuggestion = suggestion.replace(/'/g, "\\'");
    const bestIndicator = (idx === 0) ? '<span style="color:#2ecc71; font-size:12px; margin-right:4px;" title="Optimized for lowest score">✅</span>' : '';
    buttonsHtml += `<button class="alt-word-btn" data-flag-index="${flagIndex}" data-word="${escapedSuggestion}" style="background:#e0f2fe; border:1px solid #2ecc71; color:#0c4a6e; padding:6px 12px; border-radius:4px; font-size:13px; cursor:pointer; margin:2px; font-weight:500; display:inline-flex; align-items:center;">${bestIndicator}${suggestion}</button> `;
  });
  
  container.innerHTML = buttonsHtml;
  
  // Re-attach event listeners to restored buttons
  container.querySelectorAll('.alt-word-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const flagIdx = this.getAttribute('data-flag-index');
      const selectedWord = this.getAttribute('data-word');
      
      // Update the flag's suggestedFix
      if (appState.quickfixFlags && appState.quickfixFlags[flagIdx]) {
        console.log('User selected word for flag', flagIdx, ':', appState.quickfixFlags[flagIdx].phrase, '→', selectedWord);
        appState.quickfixFlags[flagIdx].suggestedFix = selectedWord;
      }
      
      // Deselect all buttons for this flag and select clicked one
      const allBtnsForFlag = document.querySelectorAll(`.alt-word-btn[data-flag-index="${flagIdx}"]`);
      allBtnsForFlag.forEach(b => {
        b.style.background = '#e0f2fe';
        b.style.borderColor = '#2ecc71';
        b.style.color = '#0c4a6e';
        b.style.fontWeight = '500';
        b.classList.remove('selected-word');
      });
      
      // Highlight selected button
      this.style.background = '#2ecc71';
      this.style.color = 'white';
      this.style.borderColor = '#2ecc71';
      this.style.fontWeight = '600';
      this.classList.add('selected-word');
      
      // Clear custom input field when a word button is selected
      const customInput = document.querySelector(`.custom-word-field[data-flag-index="${flagIdx}"]`);
      if (customInput) {
        customInput.value = '';
      }
      
      // Auto-check the checkbox when user selects a word
      const checkbox = document.getElementById(`fix-${flagIdx}`);
      if (checkbox && !checkbox.checked) {
        checkbox.checked = true;
        checkbox.dispatchEvent(new Event('change'));
      }
      
      updateSelectedCount();
      
      // Check if "Use Best Words" should be checked (if user restored to best words)
      checkIfAllBestWords();
    });
  });
}

// ===== PRO EDIT FIXES FUNCTION =====
// Takes Pro users back to Step 2 with the same essay to edit fixes
function editProFixes() {
  // Check if we have the original essay text stored
  if (!appState.quickfixOriginalText) {
    showSuccessMessage('Original essay not found. Please start a new scan.');
    return;
  }
  
  // Store flag that we're editing (for future use to generate more suggestions)
  appState.isEditingFixes = true;
  
  // Get the original text
  const originalText = appState.quickfixOriginalText;
  
  // Ensure Pro mode is set
  appState.isProUser = true;
  updateStepLabels(true);
  
  // Hide Step 3, show quickfixFlow
  const quickfixFlow = document.getElementById('quickfixFlow');
  if (quickfixFlow) {
    quickfixFlow.style.setProperty('display', 'block', 'important');
  }
  
  // Hide input section
  const inputSection = document.getElementById('inputSection');
  if (inputSection) {
    inputSection.style.setProperty('display', 'none', 'important');
  }
  
  // Show lighter modal for getting more suggestions (not a full scan)
  showGettingSuggestionsModal();
  
  // Re-run the analysis on the original essay to get fresh flags and suggestions
  // This allows the code to be configured to give more/different suggestions
  setTimeout(() => {
    hideGettingSuggestionsModal();
    
    // Run Pro scan (finds ALL flags) - this can be configured to give more suggestions
    console.log('🔍 Re-running Pro scan for edit fixes - input length:', originalText.length);
    const flags = AIDetectionEngine.detectFlags(originalText);
    const score = AIDetectionEngine.calculateScore(originalText);
    
    // Store Pro scan data
    appState.proOriginalText = originalText;
    appState.proFlags = flags;
    appState.proOriginalScore = score;
    
    // Also store in quickfix state so displayQuickFixAnalysis works
    appState.quickfixOriginalText = originalText;
    appState.quickfixFlags = flags;
    appState.quickfixOriginalScore = score;
    
    // Show Step 2 and populate with Pro data
    showProStep(2);
    displayQuickFixAnalysis(originalText, score, flags);
    
    // Update labels and hide instruction box
    setTimeout(() => {
      const instructionBox = document.getElementById('fixSelectionInstructionBox');
      if (instructionBox) {
        instructionBox.style.display = 'none';
      }
      updateStepLabels(true);
      
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 100);
  }, 2000);
}

// ===== PRO PAST FIXES HISTORY SYSTEM =====
// Save Pro scan to localStorage (max 10 scans)
function saveProScanToHistory(originalText, fixedText, flags, newScore, improvement) {
  try {
    const originalScore = appState.quickfixOriginalScore || (newScore + improvement);
    const scanData = {
      id: Date.now(),
      date: new Date().toLocaleString('en-US', { 
        month: 'short', 
        day: 'numeric', 
        year: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      }),
      timestamp: Date.now(),
      originalScore: originalScore,
      newScore: newScore,
      improvement: improvement,
      flagsCount: flags ? flags.length : 0,
      originalText: originalText.substring(0, 500), // Store first 500 chars for preview
      fixedText: fixedText.substring(0, 500),
      fullOriginalText: originalText,
      fullFixedText: fixedText,
      flags: flags || []
    };
    
    // Get existing history
    let history = JSON.parse(localStorage.getItem('proScanHistory') || '[]');
    
    // Add new scan to beginning
    history.unshift(scanData);
    
    // Keep only last 10 scans
    if (history.length > 10) {
      history = history.slice(0, 10);
    }
    
    // Save back to localStorage
    localStorage.setItem('proScanHistory', JSON.stringify(history));
    console.log('✅ Pro scan saved to history. Total scans:', history.length);
  } catch (error) {
    console.error('Error saving Pro scan to history:', error);
  }
}

// Show Pro Past Fixes modal
function showProPastFixes() {
  const history = JSON.parse(localStorage.getItem('proScanHistory') || '[]');
  
  if (history.length === 0) {
    showSuccessMessage('No past fixes found. Your scan history will appear here after you complete scans.');
    return;
  }
  
  // Create modal HTML
  const modalHTML = `
    <div id="proPastFixesModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;">
      <div style="background: white; border-radius: 16px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); position: relative;">
        <button onclick="closeProPastFixesModal()" style="position: absolute; top: 16px; right: 16px; background: #f3f4f6; border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 24px; color: #6b7280; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='#e5e7eb'; this.style.color='#374151';" onmouseout="this.style.background='#f3f4f6'; this.style.color='#6b7280';">×</button>
        
        <div style="padding: 32px 24px 24px 24px;">
          <h2 style="margin: 0 0 8px 0; font-size: 28px; font-weight: 700; color: #0b0646; text-align: center;">📊 Your Past Fixes</h2>
          <p style="margin: 0 0 24px 0; font-size: 14px; color: #6b7280; text-align: center;">View and copy your last ${history.length} Pro scans</p>
          
          <div id="proPastFixesList" style="display: flex; flex-direction: column; gap: 12px;">
            ${history.map((scan, index) => `
              <div style="background: #f8f9fa; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; transition: all 0.2s;" onmouseover="this.style.borderColor='#00a8e8'; this.style.boxShadow='0 2px 8px rgba(0, 168, 232, 0.15)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none';">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; flex-wrap: wrap;">
                  <div style="flex: 1; min-width: 200px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                      <span style="font-size: 20px;">${index === 0 ? '🆕' : '📄'}</span>
                      <div>
                        <div style="font-size: 14px; font-weight: 600; color: #374151;">${scan.date}</div>
                        <div style="font-size: 12px; color: #6b7280;">${scan.flagsCount} flags fixed</div>
                      </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                      <span style="font-size: 18px; font-weight: 700; color: #dc2626;">${scan.originalScore}%</span>
                      <span style="color: #9ca3af;">→</span>
                      <span style="font-size: 18px; font-weight: 700; color: #2ecc71;">${scan.newScore}%</span>
                      <span style="font-size: 12px; color: #6b7280; margin-left: 4px;">(${scan.improvement}% improvement)</span>
                    </div>
                  </div>
                  <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button onclick="viewProPastFixDetails(${scan.id})" style="background: #00a8e8; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#0099d4';" onmouseout="this.style.background='#00a8e8';">View Details</button>
                    <button onclick="copyProPastFix(${scan.id})" style="background: white; color: #00a8e8; border: 1px solid #00a8e8; padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f0f9ff';" onmouseout="this.style.background='white';">Copy Text</button>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Remove existing modal if any
  const existingModal = document.getElementById('proPastFixesModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  // Add modal to page
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  document.body.style.overflow = 'hidden';
}

// Close Pro Past Fixes modal
function closeProPastFixesModal() {
  const modal = document.getElementById('proPastFixesModal');
  if (modal) {
    modal.remove();
    document.body.style.overflow = '';
  }
}

// View details of a past fix
function viewProPastFixDetails(scanId) {
  const history = JSON.parse(localStorage.getItem('proScanHistory') || '[]');
  const scan = history.find(s => s.id === scanId);
  
  if (!scan) {
    showSuccessMessage('Scan not found.');
    return;
  }
  
  // Close the list modal
  closeProPastFixesModal();
  
  // Create detail modal
  const detailModalHTML = `
    <div id="proPastFixDetailModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 20px;">
      <div style="background: white; border-radius: 16px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); position: relative;">
        <button onclick="closeProPastFixDetailModal()" style="position: absolute; top: 16px; right: 16px; background: #f3f4f6; border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 24px; color: #6b7280; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='#e5e7eb'; this.style.color='#374151';" onmouseout="this.style.background='#f3f4f6'; this.style.color='#6b7280';">×</button>
        
        <div style="padding: 32px 24px 24px 24px;">
          <h2 style="margin: 0 0 8px 0; font-size: 24px; font-weight: 700; color: #0b0646;">Scan Details - ${scan.date}</h2>
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
            <div>
              <div style="font-size: 14px; color: #6b7280; margin-bottom: 4px;">Score Improvement</div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 32px; font-weight: 700; color: #dc2626;">${scan.originalScore}%</span>
                <span style="color: #9ca3af; font-size: 20px;">→</span>
                <span style="font-size: 32px; font-weight: 700; color: #2ecc71;">${scan.newScore}%</span>
                <span style="font-size: 16px; color: #6b7280; margin-left: 8px;">(${scan.improvement}% improvement)</span>
              </div>
            </div>
            <div style="margin-left: auto; text-align: right;">
              <div style="font-size: 14px; color: #6b7280;">Flags Fixed</div>
              <div style="font-size: 24px; font-weight: 700; color: #00a8e8;">${scan.flagsCount}</div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
            <div>
              <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 700; color: #dc2626;">Before Pro - ${scan.originalScore}%</h3>
              <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 16px; max-height: 300px; overflow-y: auto; font-size: 14px; line-height: 1.6; color: #374151;">
                ${scan.fullOriginalText || scan.originalText}
              </div>
            </div>
            <div>
              <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 700; color: #2ecc71;">After Pro - ${scan.newScore}%</h3>
              <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 16px; max-height: 300px; overflow-y: auto; font-size: 14px; line-height: 1.6; color: #374151;">
                ${scan.fullFixedText || scan.fixedText}
              </div>
            </div>
          </div>
          
          <div style="display: flex; gap: 12px; justify-content: center;">
            <button onclick="copyProPastFix(${scan.id})" style="background: #00a8e8; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#0099d4';" onmouseout="this.style.background='#00a8e8';">📋 Copy Fixed Text</button>
            <button onclick="closeProPastFixDetailModal(); showProPastFixes();" style="background: white; color: #00a8e8; border: 1px solid #00a8e8; padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f0f9ff';" onmouseout="this.style.background='white';">← Back to List</button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', detailModalHTML);
  document.body.style.overflow = 'hidden';
}

// Close detail modal
function closeProPastFixDetailModal() {
  const modal = document.getElementById('proPastFixDetailModal');
  if (modal) {
    modal.remove();
    document.body.style.overflow = '';
  }
}

// Copy past fix text
function copyProPastFix(scanId) {
  const history = JSON.parse(localStorage.getItem('proScanHistory') || '[]');
  const scan = history.find(s => s.id === scanId);
  
  if (!scan) {
    showSuccessMessage('Scan not found.');
    return;
  }
  
  const textToCopy = scan.fullFixedText || scan.fixedText;
  
  navigator.clipboard.writeText(textToCopy).then(() => {
    showSuccessMessage('✅ Fixed text copied to clipboard!');
  }).catch(() => {
    // Fallback for older browsers
    const textArea = document.createElement('textarea');
    textArea.value = textToCopy;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    showSuccessMessage('✅ Fixed text copied to clipboard!');
  });
}

// For testing: Add Pro test button (REMOVE IN PRODUCTION)
document.addEventListener('DOMContentLoaded', function() {
  // Uncomment the line below to show test button automatically
  // addProTestButton();
  
  // Or just call activateProTestMode() from browser console
});

// Update position on window resize/scroll
window.addEventListener('resize', updateTooltipPosition);
window.addEventListener('scroll', updateTooltipPosition);
</script>
</div> <!-- Close page-wrapper -->
<script src="progress-bars.js"></script>
</body>
</html>

